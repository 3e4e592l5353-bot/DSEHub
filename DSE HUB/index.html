<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v47 - åº•éƒ¨å›ºå®šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= ğŸ¨ è§†è§‰é£æ ¼ ================= */
        :root { 
            --primary: #4F46E5; 
            --primary-light: #EEF2FF;
            --bg-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --text-main: #1F2937;
            --sidebar-width: 260px;
        }

        body { 
            margin: 0; font-family: 'Noto Sans SC', sans-serif; 
            background: var(--bg-gradient); color: var(--text-main); 
            height: 100vh; display: flex; overflow: hidden; 
        }
        
        /* === ä¾§è¾¹æ å¸ƒå±€ (Flex Column) === */
        .sidebar { 
            width: var(--sidebar-width); background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            display: flex; flex-direction: column; /* å‚ç›´æ’åˆ— */
            border-right: var(--glass-border); 
            flex-shrink: 0; z-index: 50; transition: transform 0.3s ease;
            height: 100%; 
        }

        /* 1. ä¸ŠåŠéƒ¨åˆ†ï¼šLogo + å¯¼èˆªèœå• (å¯æ»šåŠ¨åŒºåŸŸ) */
        .sidebar-scroll-area {
            flex: 1; /* å æ®å‰©ä½™æ‰€æœ‰ç©ºé—´ */
            overflow-y: auto; /* å†…å®¹å¤šäº†å¯ä»¥æ»šåŠ¨ */
            padding: 30px 20px 10px 20px;
            -webkit-overflow-scrolling: touch;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒåŠŸèƒ½ */
        .sidebar-scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .sidebar-scroll-area::-webkit-scrollbar-track { background: transparent; }

        /* 2. ä¸‹åŠéƒ¨åˆ†ï¼šå›ºå®šåº•éƒ¨ (åå°ç®¡ç†) */
        .sidebar-footer {
            flex-shrink: 0; /* ä¸ä¼šè¢«å‹ç¼© */
            padding: 20px;
            border-top: 1px solid rgba(0,0,0,0.06); /* æ·¡æ·¡çš„åˆ†å‰²çº¿ */
            background: rgba(255,255,255,0.5); /* ç¨å¾®æ·±ä¸€ç‚¹çš„èƒŒæ™¯ */
        }

        .logo { font-size: 22px; font-weight: 900; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; }
        
        .nav-item { 
            padding: 14px 18px; margin-bottom: 8px; cursor: pointer; border-radius: 12px; 
            font-weight: 600; color: #666; transition: 0.3s; display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover { background: #fff; color: var(--primary); transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }

        /* ä¸»ä½“å†…å®¹ */
        .main { flex: 1; padding: 0; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page { display: none; padding: 40px 60px; max-width: 900px; margin: 0 auto; animation: slideUp 0.3s ease; }
        .page.active { display: block; }
        @keyframes slideUp { from{opacity:0; transform:translateY(10px)} to{opacity:1; transform:translateY(0)} }
        
        .card { 
            background: var(--glass); backdrop-filter: blur(10px); padding: 35px; 
            border-radius: 24px; box-shadow: var(--shadow); border: var(--glass-border); margin-bottom: 25px; 
        }

        h1 { font-size: 32px; font-weight: 800; margin-bottom: 25px; color: #111; }
        
        input, textarea, select { 
            width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid transparent; 
            background: #fff; border-radius: 12px; box-sizing: border-box; font-size: 15px; 
            font-family: inherit; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary); }
        
        .format-toolbar { display: flex; gap: 15px; margin-bottom: 10px; font-size: 13px; color: #666; background: rgba(255,255,255,0.5); padding: 8px 15px; border-radius: 8px; overflow-x: auto;}
        .format-code { font-family: monospace; background: #eee; padding: 2px 6px; border-radius: 4px; color: #d63384; font-weight: bold; cursor:pointer; white-space: nowrap;}

        button { 
            background: var(--primary); color: white; border: none; padding: 14px 28px; 
            border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 15px; 
            transition: 0.2s; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); 
        }
        button:hover { transform: translateY(-2px); }
        button.secondary { background: #fff; color: #333; }

        .item { padding: 20px; background: rgba(255,255,255,0.7); border-radius: 16px; margin-bottom: 12px; cursor: pointer; transition: 0.2s; border: 1px solid transparent;}
        .item:hover { background: #fff; transform: scale(1.01); border-color: #eee; }
        .tag { font-size: 10px; padding: 4px 8px; background: var(--primary); color: #fff; border-radius: 6px; font-weight: 700; margin-right: 10px; }
        .item-detail { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 16px; line-height: 1.8; color: #333; white-space: pre-wrap; }
        .item.open .item-detail { display: block; }
        .fmt-bold { font-weight: 900; background: linear-gradient(to top, #ffeb3b 40%, transparent 0); }
        .fmt-under { text-decoration: underline; text-decoration-color: var(--primary); text-underline-offset: 4px; }
        .fmt-italic { font-style: italic; color: #555; font-family: serif; }

        /* æ¸¸æˆ */
        .g-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; }
        .g-card { 
            aspect-ratio: 1; background: #fff; border-radius: 16px; 
            display: flex; align-items: center; justify-content: center; text-align: center; 
            cursor: pointer; padding: 8px; font-size: 12px; font-weight: 600; 
            box-shadow: 0 4px 0 #e5e7eb; border: 1px solid #eee; transition: 0.1s; 
            overflow: hidden; word-break: break-word;
        }
        .g-card:active { transform: translateY(4px); box-shadow: none; }
        .g-card.sel { background: var(--primary); color: #fff; box-shadow: 0 4px 0 #3730a3; border:none; }
        .g-card.topic { background: #EEF2FF; color: var(--primary); border: 2px solid var(--primary); }
        .g-card.success { background: #dcfce7 !important; border-color: #22c55e !important; transform: scale(1.05); }
        .g-card.done { transform: scale(0); opacity: 0; transition: 0.4s; }

        /* ğŸ“± ç§»åŠ¨ç«¯é€‚é… */
        .menu-btn {
            display: none; position: fixed; top: 15px; left: 15px; z-index: 40;
            background: #fff; border: 1px solid #eee; padding: 8px 12px; 
            border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 20px; color: var(--primary);
        }

        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 45; backdrop-filter: blur(2px);
            opacity: 0; transition: opacity 0.3s;
        }
        .overlay.active { display: block; opacity: 1; }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; height: 100%; width: 260px;
                transform: translateX(-100%); 
                box-shadow: 5px 0 25px rgba(0,0,0,0.1);
            }
            .sidebar.active { transform: translateX(0); }
            
            .menu-btn { display: block; }
            
            .page { padding: 80px 20px 20px 20px; } 
            .card { padding: 20px; }
            h1 { font-size: 24px; margin-top: 0; }
            
            /* æ‰‹æœºç«¯åº•éƒ¨å®‰å…¨è·ç¦»ï¼Œé˜²æ­¢ iPhone æ¨ªæ¡é®æŒ¡ */
            .sidebar-footer { padding-bottom: 30px; }
        }
    </style>
</head>
<body>
    <div id="config-alert" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:100; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:20px; text-align:center;">
            <h2 style="color:#EF4444">âš ï¸ æœªé…ç½® API</h2>
            <button onclick="location.reload()">åˆ·æ–°</button>
        </div>
    </div>

    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    <div class="overlay" onclick="toggleSidebar()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-scroll-area">
            <div class="logo">
                <span>ğŸš€ DSE HUB <span style="font-size:12px; background:#333; color:#fff; padding:2px 6px; border-radius:4px; margin-left:8px;">v47</span></span>
                <span style="font-size:24px; cursor:pointer; display:none;" class="mobile-close" onclick="toggleSidebar()">Ã—</span>
            </div>
            
            <div class="nav-item active" onclick="nav('home')">ğŸ“š çŸ¥è¯†å®åº“</div>
            <div class="nav-item" onclick="nav('game')">ğŸ® è¿è¿çœ‹</div>
            <div class="nav-item" onclick="nav('submit')">ğŸ“ æŠ•ç¨¿</div>
            <div class="nav-item" onclick="nav('chat')">ğŸ’¬ ç•™è¨€æ¿</div>
            </div>

        <div class="sidebar-footer">
            <div class="nav-item" onclick="checkAdmin()" style="margin-bottom:0;">ğŸ›¡ï¸ åå°ç®¡ç†</div>
        </div>
    </div>

    <div class="main">
        <div id="view-home" class="page active">
            <h1>çŸ¥è¯†å®åº“</h1>
            <div class="card">
                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:5px;">
                    <select id="filter-cat" onchange="renderKnowledge()" style="flex:1; min-width:120px; margin-bottom:15px; background:#F3F4F6;">
                        <option value="all">ğŸ“Œ æ‰€æœ‰ç§‘ç›®</option>
                    </select>
                    <input id="search" placeholder="ğŸ” æœç´¢å…³é”®è¯..." onkeyup="renderKnowledge()" style="flex:2; min-width:150px;">
                </div>
                <div id="list"></div>
            </div>
        </div>

        <div id="view-game" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <div><h1 style="font-size:24px; margin-bottom:5px;">âš¡ è¿è¿çœ‹</h1><p style="color:#666; margin:0; font-size:12px;">è§„åˆ™ï¼šæ¶ˆé™¤æ‰€æœ‰å­ä¾‹å­ï¼Œæ¯é¢˜æ‰æ¶ˆå¤±ã€‚</p></div>
                    <button class="secondary" onclick="initGame()" style="padding:8px 15px;">ğŸ”„</button>
                </div>
                <div id="game-board" class="g-grid"></div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>æŠ•ç¨¿</h1>
            <div class="card">
                <div class="format-toolbar">
                    <span class="format-code" onclick="insertFmt('*')">*åŠ ç²—*</span>
                    <span class="format-code" onclick="insertFmt('_')">_ä¸‹åˆ’çº¿_</span>
                    <span class="format-code" onclick="insertFmt('\\')">\æ–œä½“\</span>
                </div>
                
                <select id="sub-sub"></select>
                <input id="sub-t" placeholder="ğŸ“Œ æ ‡é¢˜">
                <textarea id="sub-d" rows="5" placeholder="ğŸ“ è¯¦ç»†è§£é‡Š"></textarea>
                <textarea id="sub-ex" rows="3" placeholder="ğŸ’¡ ä¾‹å­ (ä½¿ç”¨ // æˆ– æ¢è¡Œ åˆ†éš”)" style="border: 2px solid #FCD34D; background:#FFFBEB;"></textarea>
                <button id="btn-submit" onclick="submitData('KNOWLEDGE')" style="width:100%">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-chat" class="page">
            <h1>ç•™è¨€æ¿</h1>
            <div class="card">
                <input id="chat-search" placeholder="ğŸ” æœç´¢ç‰¹å®šæ˜µç§°..." oninput="renderChat()" style="background:#F3F4F6; border:1px solid #E5E7EB; margin-bottom:15px;">
                <div id="chat-box" style="height:400px; overflow-y:auto; margin-bottom:15px; padding-right:10px;"></div>
                <div style="display:flex; gap:10px; border-top:1px solid #eee; padding-top:15px;">
                    <input id="chat-u" placeholder="æ˜µç§°" style="width:30%">
                    <input id="chat-m" placeholder="å†…å®¹...">
                    <button onclick="submitData('GB_MSG')">ğŸš€</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1>ç®¡ç†åå°</h1>
            <div class="card">
                <button class="secondary" onclick="importDefaults()">ğŸ“¥ å¯¼å…¥æ¼”ç¤ºæ•°æ®</button>
                <div id="admin-list" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // =================âš ï¸ é…ç½® KEY =================
        const CONFIG = {
            URL: 'https://alsalyskulozwakhmzoa.supabase.co',
            KEY: 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr'
        };

        const SUBJECTS = [
            {code:"chi",name:"ä¸­æ–‡"}, {code:"eng",name:"è‹±æ–‡"}, {code:"math",name:"æ•°å­¦"}, 
            {code:"cs",name:"å…¬ç¤¾ç§‘"}, {code:"phy",name:"ç‰©ç†"}, {code:"chem",name:"åŒ–å­¦"}, 
            {code:"bio",name:"ç”Ÿç‰©"}, {code:"econ",name:"ç»æµ"}, {code:"bafs",name:"ä¼ä¼šè´¢"}, 
            {code:"ict",name:"ICT"}, {code:"hist",name:"å†å²"}, {code:"geog",name:"åœ°ç†"}, 
            {code:"m1",name:"M1"}, {code:"m2",name:"M2"}, {code:"lit",name:"æ–‡å­¦"}, {code:"other",name:"å…¶ä»–"}
        ];

        const DEFAULT_DATA = [
            { id: 'd1', cat: 'eng', t: 'Layout Fix', d: 'Admin is pinned to bottom', ex: 'Clean // Solid', status: 'approved' },
            { id: 'm1', cat: 'GB_MSG', t: 'System', d: 'Welcome!', status: 'approved', created_at: new Date().toISOString() }
        ];

        let appData = [];
        let db = null;
        let isOnline = false;
        let isAdminLoggedIn = false; 

        window.onload = async () => {
            const subOptions = SUBJECTS.map(s=>`<option value="${s.code}">${s.name}</option>`).join('');
            document.getElementById('sub-sub').innerHTML = subOptions;
            document.getElementById('filter-cat').innerHTML = `<option value="all">ğŸ“Œ æ‰€æœ‰ç§‘ç›®</option>` + subOptions;

            if(CONFIG.URL.includes('YOUR_')) { document.getElementById('config-alert').style.display='flex'; return; }

            try {
                // @ts-ignore
                const client = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
                const { data } = await client.from('submissions').select('*').order('created_at',{ascending:false});
                db = client; isOnline = true;
                appData = (data && data.length) ? data : [...DEFAULT_DATA];
            } catch(e) { 
                console.error(e); appData = [...DEFAULT_DATA]; 
            }
            renderKnowledge(); renderChat();
        };

        function fmt(text) {
            if(!text) return '';
            return text.replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/\*(.*?)\*/g, '<span class="fmt-bold">$1</span>')
                .replace(/_(.*?)_/g, '<span class="fmt-under">$1</span>')
                .replace(/\\(.*?)\\/g, '<span class="fmt-italic">$1</span>');
        }

        // ================= ğŸ“± ä¾§è¾¹æ æ§åˆ¶ =================
        function toggleSidebar() {
            const btn = document.querySelector('.menu-btn');
            if(getComputedStyle(btn).display === 'none') return;

            const sb = document.getElementById('sidebar');
            const ov = document.querySelector('.overlay');
            const isClosed = !sb.classList.contains('active');
            
            if(isClosed) {
                sb.classList.add('active');
                ov.classList.add('active');
            } else {
                sb.classList.remove('active');
                ov.classList.remove('active');
            }
        }

        function nav(id) { 
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
            document.getElementById('view-'+id).classList.add('active'); 
            event.currentTarget?.classList.add('active'); 
            toggleSidebar();
            if(id==='game') initGame(); 
        }

        function renderKnowledge() {
            const kw = document.getElementById('search').value.toLowerCase();
            const catFilter = document.getElementById('filter-cat').value;
            const list = appData.filter(i => {
                const isApproved = i.status==='approved' && i.cat!=='GB_MSG';
                const matchText = (i.t.toLowerCase().includes(kw) || i.d.toLowerCase().includes(kw));
                const matchCat = (catFilter === 'all' || i.cat === catFilter); 
                return isApproved && matchText && matchCat;
            });

            document.getElementById('list').innerHTML = list.map(i => `
                <div class="item" onclick="this.classList.toggle('open')">
                    <div style="display:flex; align-items:center;">
                        <span class="tag">${i.cat}</span> <b>${i.t}</b>
                    </div>
                    <div class="item-detail">${fmt(i.d)} ${i.ex?`<div style="margin-top:10px;padding:5px;background:#FFF8E1;font-size:13px;">ğŸ’¡ ${fmt(i.ex)}</div>`:''}</div>
                </div>`).join('') || '<p style="text-align:center;color:#999">æ— å†…å®¹</p>';
        }

        function renderChat() {
            const kw = document.getElementById('chat-search').value.toLowerCase().trim();
            const list = appData.filter(i => i.cat === 'GB_MSG' && i.status === 'approved' && (kw === '' || i.t.toLowerCase().includes(kw)));
            document.getElementById('chat-box').innerHTML = list.map(i => `
                <div style="background:#fff; padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between;">
                        <b style="color:${kw?'#D946EF':'#4F46E5'}">${i.t}</b>
                        <span style="font-size:10px; color:#ccc;">${i.created_at?new Date(i.created_at).toLocaleDateString():''}</span>
                    </div>
                    <div style="margin-top:4px;">${fmt(i.d)}</div>
                </div>`).join('') || '<p style="text-align:center;color:#999">æš‚æ— ç•™è¨€</p>';
        }

        async function submitData(mode) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "æäº¤ä¸­..."; btn.disabled = true;

            const p = {status:'pending', created_at:new Date().toISOString()};
            if(mode==='GB_MSG'){ 
                p.cat='GB_MSG'; p.t=document.getElementById('chat-u').value||'åŒ¿å'; 
                p.d=document.getElementById('chat-m').value; 
            } else { 
                p.cat=document.getElementById('sub-sub').value; p.t=document.getElementById('sub-t').value; 
                p.d=document.getElementById('sub-d').value; p.ex=document.getElementById('sub-ex').value; 
            }
            
            if(!p.d) { alert("å†…å®¹ä¸ºç©º"); btn.innerText = originalText; btn.disabled = false; return; }

            if(isOnline){ 
                const { data, error } = await db.from('submissions').insert([p]).select();
                if(!error && data) {
                    if(mode === 'GB_MSG') {
                        document.getElementById('chat-m').value = '';
                        alert("ç•™è¨€å·²æäº¤ï¼Œå®¡æ ¸é€šè¿‡åæ˜¾ç¤ºï¼");
                    } else {
                        document.getElementById('sub-t').value = '';
                        document.getElementById('sub-d').value = '';
                        document.getElementById('sub-ex').value = '';
                        alert("æŠ•ç¨¿æˆåŠŸï¼æ„Ÿè°¢åˆ†äº«ã€‚");
                    }
                } else {
                    alert("æäº¤å¤±è´¥");
                }
            } else {
                alert("ç¦»çº¿æ¼”ç¤ºï¼šæ•°æ®å·²æš‚å­˜æœ¬åœ°");
                appData.unshift({...p, id:'tmp_'+Date.now(), status:'approved'});
                renderKnowledge(); renderChat();
                if(mode==='GB_MSG') document.getElementById('chat-m').value = '';
            }
            btn.innerText = originalText; btn.disabled = false;
        }

        function initGame() {
            const b = document.getElementById('game-board');
            const pool = appData.filter(i => i.status === 'approved' && i.cat !== 'GB_MSG' && i.ex);
            if(pool.length < 2) { b.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999">é¢˜ç›®ä¸è¶³</div>'; return; }
            let cards = [];
            pool.sort(()=>0.5-Math.random()).slice(0,4).forEach(item => {
                cards.push({id:item.id+'_m', t:item.t, gid:item.id, isM:true});
                let exs = item.ex.split(/(?:\/\/|\n)+/).filter(e=>e.trim()).slice(0,3);
                exs.forEach((e,i)=>cards.push({id:item.id+'_e_'+i, t:e, gid:item.id, isM:false}));
            });
            cards.sort(()=>0.5-Math.random());
            b.innerHTML = cards.map((c,i)=>`<div id="c-${i}" class="g-card ${c.isM?'topic':''}" onclick="tap(${i})">${c.t}</div>`).join('');
            window.gState = { cards, sel: null };
        }
        
        function tap(idx) {
            const el = document.getElementById(`c-${idx}`);
            if(el.classList.contains('done')) return;
            const s = window.gState;
            const clickedCard = s.cards[idx];

            if(!s.sel) { 
                s.sel = {idx, ...clickedCard}; el.classList.add('sel'); 
            } else {
                const prevEl = document.getElementById(`c-${s.sel.idx}`);
                const prevCard = s.sel;
                if (clickedCard.gid === prevCard.gid && clickedCard.isM !== prevCard.isM) {
                    const exIdx = clickedCard.isM ? prevCard.idx : idx;
                    const mIdx = clickedCard.isM ? idx : prevCard.idx;
                    const mEl = document.getElementById(`c-${mIdx}`);
                    const exEl = document.getElementById(`c-${exIdx}`);
                    exEl.classList.remove('sel'); exEl.classList.add('done'); s.cards[exIdx].done = true;
                    prevEl.classList.remove('sel'); el.classList.remove('sel');
                    mEl.classList.add('success'); setTimeout(() => mEl.classList.remove('success'), 300);
                    const remainingExamples = s.cards.some(c => c.gid === clickedCard.gid && !c.isM && !c.done);
                    if (!remainingExamples) { setTimeout(() => { mEl.classList.add('done'); s.cards[mIdx].done = true; }, 400); }
                } else {
                    el.classList.add('sel'); el.style.borderColor='red'; prevEl.style.borderColor='red';
                    setTimeout(()=>{ el.classList.remove('sel'); prevEl.classList.remove('sel'); el.style.borderColor=''; prevEl.style.borderColor=''; }, 400);
                }
                s.sel = null;
            }
        }

        function checkAdmin(){ 
            if (isAdminLoggedIn) {
                nav('admin');
                renderAdminList();
                return;
            }
            const pwd = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ");
            if(pwd === 'admin'){ 
                isAdminLoggedIn = true;
                nav('admin');
                renderAdminList();
            } else if (pwd !== null) {
                alert("å¯†ç é”™è¯¯");
            }
        }

        function renderAdminList() {
            const container = document.getElementById('admin-list');
            if(!appData.length) { container.innerHTML = '<p style="text-align:center;color:#999">æš‚æ— æ•°æ®</p>'; return; }
            container.innerHTML = appData.map(i => `
                <div class="item" id="admin-row-${i.id}">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div><span class="tag" style="background:${i.status==='approved'?'#10B981':'#F59E0B'}">${i.status}</span><b>[${i.cat}] ${i.t}</b></div>
                        <div style="display:flex; gap:5px;"><button onclick="audit('${i.id}', 1)" style="padding:5px 10px; font-size:12px; background:#10B981;">é€šè¿‡</button><button onclick="audit('${i.id}', 0)" style="padding:5px 10px; font-size:12px; background:#EF4444;">åˆ é™¤</button></div>
                    </div>
                    <div style="font-size:12px; color:#666; margin-top:5px;">${fmt(i.d).substring(0,60)}...</div>
                </div>`).join('');
        }
        
        async function audit(id, pass){ 
            const row = document.getElementById(`admin-row-${id}`);
            if(row) row.style.opacity = '0.5'; 
            if(isOnline) {
                if(pass) {
                    const { error } = await db.from('submissions').update({status:'approved'}).eq('id',id);
                    if(error) { alert("æ“ä½œå¤±è´¥"); if(row) row.style.opacity='1'; return; }
                    const item = appData.find(i => String(i.id) === String(id));
                    if(item) item.status = 'approved';
                    renderAdminList(); 
                } else {
                    const { error } = await db.from('submissions').delete().eq('id',id);
                    if(error) { alert("åˆ é™¤å¤±è´¥"); if(row) row.style.opacity='1'; return; }
                    appData = appData.filter(i => String(i.id) !== String(id));
                    if(row) { row.style.transition = 'all 0.3s'; row.style.transform = 'translateX(50px)'; row.style.opacity = '0'; setTimeout(() => row.remove(), 300); }
                }
            } else {
                if(pass) { const item = appData.find(i => String(i.id) === String(id)); if(item) item.status = 'approved'; renderAdminList(); } 
                else { appData = appData.filter(i => String(i.id) !== String(id)); if(row) row.remove(); }
            }
            renderKnowledge(); renderChat();
        }

        function insertFmt(symbol) { const area = document.getElementById('sub-d'); area.value += `${symbol}æ–‡å­—${symbol}`; }
        async function importDefaults(){ if(isOnline && confirm("å¯¼å…¥æ¼”ç¤ºæ•°æ®?")) { await db.from('submissions').insert(DEFAULT_DATA.map(({id,...r})=>({...r,created_at:new Date()}))); location.reload(); } }
    </script>
</body>
</html>