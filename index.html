<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub - é¦™æ¸¯ä¸­å­¸æ–‡æ†‘å­¸ç¿’å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= ä¸»é¡Œç³»çµ± ================= */
        :root {
            /* é»˜èªè—è‰²ä¸»é¡Œ */
            --accent: #007AFF;
            --accent-light: #66B3FF;
            --accent-dark: #0056CC;
            --bg-grad: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            --text: #1d1d1f;
            --text-sub: #555555;
            --text-light: #888888;
            --glass-bg: rgba(255, 255, 255, 0.92);
            --glass-border: rgba(255, 255, 255, 0.8);
            --menu-bg: rgba(255, 255, 255, 0.95);
            --menu-text: #333333;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow: 0 8px 32px rgba(0,0,0,0.08);
            --radius: 20px;
            --transition: all 0.3s ease;
        }

        /* ç™½è‰²ä¸»é¡Œ */
        .theme-white {
            --accent: #666666;
            --accent-light: #999999;
            --accent-dark: #444444;
            --bg-grad: linear-gradient(135deg, #f5f5f7 0%, #e8e8e8 100%);
            --text: #1d1d1f;
            --text-sub: #666666;
            --text-light: #888888;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(0, 0, 0, 0.1);
            --menu-bg: rgba(255, 255, 255, 0.98);
            --menu-text: #333333;
            --card-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 8px 32px rgba(0,0,0,0.05);
        }

        /* æ·±è‰²ä¸»é¡Œ */
        .theme-dark {
            --accent: #0A84FF;
            --accent-light: #3C9BFF;
            --accent-dark: #0066CC;
            --bg-grad: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%);
            --text: #ffffff;
            --text-sub: #98989d;
            --text-light: #727276;
            --glass-bg: rgba(40, 40, 40, 0.92);
            --glass-border: rgba(60, 60, 60, 0.8);
            --menu-bg: rgba(30, 30, 32, 0.95);
            --menu-text: #ffffff;
            --card-bg: rgba(50, 50, 52, 0.85);
            --shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        /* ç¶ è‰²ä¸»é¡Œ */
        .theme-green {
            --accent: #34C759;
            --accent-light: #5CD987;
            --accent-dark: #28A745;
            --bg-grad: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            --text: #155724;
            --text-sub: #28A745;
            --text-light: #6FBF73;
            --glass-bg: rgba(212, 237, 218, 0.92);
            --glass-border: rgba(195, 230, 203, 0.8);
            --menu-bg: rgba(220, 240, 225, 0.95);
            --menu-text: #155724;
            --card-bg: rgba(230, 245, 233, 0.85);
        }

        /* æ©™è‰²ä¸»é¡Œ */
        .theme-orange {
            --accent: #FF9500;
            --accent-light: #FFAD33;
            --accent-dark: #CC7700;
            --bg-grad: linear-gradient(135deg, #ffe5cc 0%, #ffd9b3 100%);
            --text: #663300;
            --text-sub: #CC6600;
            --text-light: #E68A00;
            --glass-bg: rgba(255, 229, 204, 0.92);
            --glass-border: rgba(255, 217, 179, 0.8);
            --menu-bg: rgba(255, 235, 215, 0.95);
            --menu-text: #663300;
            --card-bg: rgba(255, 242, 230, 0.85);
        }

        /* ç´«è‰²ä¸»é¡Œ */
        .theme-purple {
            --accent: #AF52DE;
            --accent-light: #C87BED;
            --accent-dark: #8A2DBE;
            --bg-grad: linear-gradient(135deg, #e6ccff 0%, #d9b3ff 100%);
            --text: #4B0082;
            --text-sub: #8A2DBE;
            --text-light: #AF52DE;
            --glass-bg: rgba(230, 204, 255, 0.92);
            --glass-border: rgba(217, 179, 255, 0.8);
            --menu-bg: rgba(240, 225, 255, 0.95);
            --menu-text: #4B0082;
            --card-bg: rgba(245, 235, 255, 0.85);
        }

        /* ç²‰è‰²ä¸»é¡Œ */
        .theme-pink {
            --accent: #FF2D55;
            --accent-light: #FF6680;
            --accent-dark: #CC2244;
            --bg-grad: linear-gradient(135deg, #ffccdd 0%, #ffb3d9 100%);
            --text: #990033;
            --text-sub: #CC3366;
            --text-light: #FF6699;
            --glass-bg: rgba(255, 204, 221, 0.92);
            --glass-border: rgba(255, 179, 217, 0.8);
            --menu-bg: rgba(255, 230, 240, 0.95);
            --menu-text: #990033;
            --card-bg: rgba(255, 242, 247, 0.85);
        }

        /* ================= åŸºç¤æ¨£å¼ ================= */
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", "PingFang TC", sans-serif; 
            background-image: var(--bg-grad); 
            background-attachment: fixed; 
            background-size: cover; 
            color: var(--text); 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            transition: var(--transition);
        }
        
        * { 
            box-sizing: border-box; 
            outline: none; 
            -webkit-tap-highlight-color: transparent; 
        }

        /* ç»ç’ƒæ“¬æ…‹ */
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border); 
            border-radius: var(--radius); 
            box-shadow: var(--shadow); 
            transition: var(--transition);
        }

        /* ================= ä½ˆå±€ ================= */
        .sidebar { 
            width: 280px; 
            padding: 25px 20px; 
            display: flex; 
            flex-direction: column; 
            z-index: 100; 
            background: var(--menu-bg); 
            backdrop-filter: blur(30px) saturate(200%);
            border-right: 1px solid var(--glass-border);
            transition: var(--transition);
        }
        
        .main { 
            flex: 1; 
            overflow-y: auto; 
            padding: 30px 5%; 
            position: relative; 
            scroll-behavior: smooth; 
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.4s; 
            max-width: 900px; 
            margin: 0 auto; 
        }
        
        .page.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px) } 
            to { opacity: 1; transform: translateY(0) } 
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* ================= å°èˆª ================= */
        .nav-item { 
            padding: 14px 18px; 
            margin-bottom: 6px; 
            border-radius: 14px; 
            cursor: pointer; 
            color: var(--menu-text); 
            display: flex; 
            align-items: center; 
            gap: 14px; 
            font-weight: 600; 
            transition: var(--transition);
            animation: slideIn 0.3s ease-out;
            animation-fill-mode: both;
        }
        
        .nav-item:hover { 
            background: rgba(var(--accent-rgb), 0.1); 
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .nav-item.active { 
            background: var(--accent); 
            color: white; 
            box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.3);
            transform: translateX(5px);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        /* ================= è¡¨å–®å…ƒç´  ================= */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            border-radius: 12px; 
            border: 2px solid rgba(0,0,0,0.1); 
            background: var(--card-bg); 
            margin-bottom: 12px; 
            font-size: 15px; 
            color: var(--text); 
            font-family: inherit;
            transition: var(--transition);
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            box-shadow: 0 0 0 4px rgba(var(--accent-rgb), 0.15);
            outline: none;
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-light);
        }

        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 14px 24px; 
            border-radius: 12px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 15px;
        }
        
        button:hover { 
            background: var(--accent-dark); 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.3);
        }
        
        button:active { 
            transform: translateY(0); 
        }
        
        button.danger { 
            background: #FF3B30; 
        }
        
        button.danger:hover {
            background: #D70015;
        }
        
        button.success {
            background: #34C759;
        }
        
        button.success:hover {
            background: #28A745;
        }
        
        button.warning {
            background: #FF9500;
        }
        
        button.warning:hover {
            background: #E68A00;
        }
        
        button.ghost { 
            background: transparent; 
            color: var(--text-sub); 
            border: 2px solid rgba(0,0,0,0.1); 
        }
        
        button.ghost:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(var(--accent-rgb), 0.05);
        }
        
        button.small { 
            padding: 8px 16px; 
            font-size: 14px; 
        }

        /* ================= è† å›Šé¸æ“‡å™¨ ================= */
        .capsule-scroll { 
            display: flex; 
            overflow-x: auto; 
            gap: 10px; 
            padding: 12px 0; 
            margin-bottom: 20px; 
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }
        
        .capsule-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .capsule-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 3px;
        }
        
        .capsule-scroll::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }
        
        .capsule { 
            padding: 10px 20px; 
            border-radius: 25px; 
            background: var(--card-bg); 
            border: 2px solid rgba(0,0,0,0.05); 
            white-space: nowrap; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600; 
            color: var(--text-sub);
            transition: var(--transition);
            flex-shrink: 0;
            animation: slideIn 0.3s ease-out;
            animation-fill-mode: both;
        }
        
        .capsule:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .capsule.active { 
            background: var(--accent); 
            color: white; 
            border-color: transparent; 
            box-shadow: 0 6px 20px rgba(var(--accent-rgb), 0.25);
            transform: translateY(-2px);
        }

        /* ================= çŸ¥è­˜å¡ç‰‡ ================= */
        .k-item { 
            padding: 22px; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            cursor: pointer; 
            background: var(--card-bg); 
            margin-bottom: 15px; 
            border-radius: 16px; 
            transition: var(--transition);
            animation: slideIn 0.4s ease-out;
            animation-fill-mode: both;
        }
        
        .k-item:hover { 
            background: var(--glass-bg); 
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        
        .k-body { 
            max-height: 0; 
            overflow: hidden; 
            opacity: 0; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            margin-top: 0; 
            color: var(--text-sub); 
            line-height: 1.7; 
        }
        
        .k-item.open .k-body { 
            max-height: 2000px; 
            opacity: 1; 
            margin-top: 20px; 
            padding-top: 20px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }

        /* ================= éŠæˆ²å€åŸŸ ================= */
        .game-container {
            padding: 25px;
            border-radius: 20px;
            background: var(--card-bg);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0,0,0,0.05);
        }

        .game-info {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .game-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 20px;
            background: rgba(var(--accent-rgb), 0.1);
            border-radius: 12px;
            min-width: 100px;
        }

        .game-stat-label {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .game-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
        }

        /* ================= é€£é€£çœ‹éŠæˆ² ================= */
        #link-game-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            padding: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 16px;
            margin: 20px 0;
        }

        .link-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--glass-bg), var(--card-bg));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }

        .link-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .link-card:hover::before {
            opacity: 1;
        }

        .link-card:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--accent-light);
        }

        .link-card.selected {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.15), rgba(var(--accent-rgb), 0.25));
            transform: scale(0.95);
            animation: pulse 1s infinite;
        }

        .link-card.removed {
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }

        .link-card.matched {
            background: linear-gradient(135deg, rgba(52,199,89,0.2), rgba(52,199,89,0.3));
            border-color: #34C759;
        }

        .link-card.knowledge {
            background: linear-gradient(135deg, rgba(0,122,255,0.15), rgba(0,122,255,0.25));
            border: 2px dashed var(--accent);
        }

        .link-card.example {
            background: linear-gradient(135deg, rgba(255,149,0,0.15), rgba(255,149,0,0.25));
            border: 2px solid #FF9500;
        }

        .link-line {
            position: absolute;
            background: var(--accent);
            height: 4px;
            pointer-events: none;
            z-index: 100;
            transform-origin: 0 0;
            box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
        }

        /* ================= è¨˜æ†¶éŠæˆ² ================= */
        #memory-game-board {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--glass-bg), var(--card-bg));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            transform-style: preserve-3d;
            position: relative;
            border: 2px solid transparent;
        }

        .memory-card .front,
        .memory-card .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .memory-card .front {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            transform: rotateY(180deg);
        }

        .memory-card .back {
            background: linear-gradient(135deg, var(--card-bg), var(--glass-bg));
            color: var(--text);
        }

        .memory-card.flipped {
            transform: rotateY(180deg);
        }

        .memory-card.matched {
            border-color: #34C759;
            background: linear-gradient(135deg, rgba(52,199,89,0.2), rgba(52,199,89,0.3));
        }

        /* ================= é…å°éŠæˆ² ================= */
        #match-game-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 25px;
        }

        .match-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .match-item {
            padding: 18px;
            background: var(--card-bg);
            border-radius: 14px;
            cursor: grab;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-weight: 500;
        }

        .match-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            border-color: var(--accent-light);
        }

        .match-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .match-item.matched {
            background: linear-gradient(135deg, rgba(52,199,89,0.2), rgba(52,199,89,0.3));
            border-color: #34C759;
            cursor: default;
        }

        /* ================= æ‰“å­—éŠæˆ² ================= */
        #typing-game-container {
            padding: 30px;
            text-align: center;
        }

        #typing-text {
            font-size: 28px;
            line-height: 1.5;
            margin-bottom: 30px;
            color: var(--text);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 16px;
            border: 2px solid transparent;
        }

        #typing-text.active {
            border-color: var(--accent);
            animation: pulse 2s infinite;
        }

        #typing-input {
            font-size: 20px;
            padding: 15px 25px;
            text-align: center;
            letter-spacing: 2px;
        }

        .typing-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 25px;
        }

        /* ================= ç§»å‹•ç«¯é©é… ================= */
        .mobile-bar { 
            display: none; 
            padding: 12px 18px; 
            align-items: center; 
            justify-content: space-between; 
            position: fixed; 
            top: 0; 
            width: 100%; 
            z-index: 200; 
            background: var(--menu-bg); 
            backdrop-filter: blur(15px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; 
                left: -100%; 
                height: 100%; 
                width: 85%; 
                box-shadow: 30px 0 60px rgba(0,0,0,0.25); 
                transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .sidebar.open { 
                left: 0; 
            }
            
            .mobile-bar { 
                display: flex; 
            }
            
            .main { 
                padding-top: 80px; 
                padding-left: 5%;
                padding-right: 5%;
            }
            
            #link-game-board {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                padding: 15px;
            }
            
            .link-card {
                font-size: 18px;
            }
            
            #memory-game-board {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
            }
            
            #match-game-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .game-info {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .game-stat {
                min-width: 80px;
                padding: 8px 15px;
            }
            
            .game-stat-value {
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            #link-game-board {
                grid-template-columns: repeat(4, 1fr);
            }
            
            #memory-game-board {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .game-stat {
                min-width: 70px;
                padding: 6px 12px;
            }
            
            .game-stat-value {
                font-size: 18px;
            }
        }

        /* ================= å½ˆçª— ================= */
        .modal-mask { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(10px); 
            z-index: 999; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
            animation: fadeIn 0.3s;
        }
        
        .modal-box { 
            width: 400px; 
            max-width: 90%;
            padding: 35px; 
            background: var(--glass-bg); 
            border-radius: 24px; 
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ================= ä¸»é¡Œè‰²å¡Š ================= */
        .theme-colors {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .theme-color {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .theme-color::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .theme-color.active {
            border-color: var(--text);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .theme-color.active::after {
            opacity: 1;
        }

        .theme-color:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .theme-default { background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        .theme-white { background: linear-gradient(135deg, #f5f5f7 0%, #e8e8e8 100%); }
        .theme-dark { background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%); }
        .theme-green { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); }
        .theme-orange { background: linear-gradient(135deg, #ffe5cc 0%, #ffd9b3 100%); }
        .theme-purple { background: linear-gradient(135deg, #e6ccff 0%, #d9b3ff 100%); }
        .theme-pink { background: linear-gradient(135deg, #ffccdd 0%, #ffb3d9 100%); }

        /* ================= åˆ†æ•¸å‹•ç•« ================= */
        @keyframes scorePop {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-40px) scale(1); opacity: 0; }
        }

        .score-popup {
            position: absolute;
            color: var(--accent);
            font-weight: bold;
            font-size: 22px;
            animation: scorePop 1s forwards;
            pointer-events: none;
            z-index: 1000;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* ================= é€²åº¦æ¢ ================= */
        .progress-bar {
            height: 10px;
            background: rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 5px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ================= æ’è¡Œæ¦œ ================= */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            background: var(--card-bg);
            border-radius: 14px;
            margin-bottom: 10px;
            transition: all 0.3s;
            animation: slideIn 0.3s ease-out;
            animation-fill-mode: both;
        }

        .leaderboard-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            background: var(--glass-bg);
        }

        .leaderboard-rank {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 18px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .leaderboard-rank.top-1 { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .leaderboard-rank.top-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); }
        .leaderboard-rank.top-3 { background: linear-gradient(135deg, #CD7F32, #B56924); }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-meta {
            font-size: 13px;
            color: var(--text-light);
        }

        .leaderboard-score {
            font-weight: bold;
            color: var(--accent);
            font-size: 20px;
            margin-left: 15px;
        }

        /* ================= éŠæˆ²å¡ç‰‡ ================= */
        .game-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .game-selector-card {
            padding: 30px 25px;
            text-align: center;
            border-radius: 20px;
            background: var(--card-bg);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            border: 2px solid transparent;
            animation: slideIn 0.4s ease-out;
            animation-fill-mode: both;
        }

        .game-selector-card:nth-child(2) { animation-delay: 0.1s; }
        .game-selector-card:nth-child(3) { animation-delay: 0.2s; }
        .game-selector-card:nth-child(4) { animation-delay: 0.3s; }
        .game-selector-card:nth-child(5) { animation-delay: 0.4s; }

        .game-selector-card:hover {
            background: var(--glass-bg);
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            border-color: var(--accent-light);
        }

        .game-selector-card i {
            font-size: 48px;
            color: var(--accent);
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .game-selector-card:hover i {
            transform: scale(1.2) rotate(5deg);
            color: var(--accent-dark);
        }

        .game-selector-card h3 {
            margin: 0;
            color: var(--text);
            font-size: 20px;
        }

        .game-selector-card p {
            margin: 0;
            color: var(--text-sub);
            font-size: 14px;
            line-height: 1.6;
        }

        .game-selector-card .game-difficulty {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            background: rgba(var(--accent-rgb), 0.1);
            color: var(--accent);
        }

        /* ================= é€šçŸ¥ ================= */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: var(--glass-bg);
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 400px;
            border-left: 4px solid var(--accent);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification i {
            font-size: 20px;
            color: var(--accent);
        }

        .notification.success { border-left-color: #34C759; }
        .notification.success i { color: #34C759; }

        .notification.error { border-left-color: #FF3B30; }
        .notification.error i { color: #FF3B30; }

        .notification.warning { border-left-color: #FF9500; }
        .notification.warning i { color: #FF9500; }

        .notification.info { border-left-color: var(--accent); }

        /* ================= åŠ è¼‰å‹•ç•« ================= */
        .loading {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(var(--accent-rgb), 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ================= éŸ¿æ‡‰å¼å·¥å…·é¡ ================= */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-10 { gap: 10px; }
        .gap-15 { gap: 15px; }
        .gap-20 { gap: 20px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .mt-10 { margin-top: 10px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .p-20 { padding: 20px; }
        .p-30 { padding: 30px; }
        
        /* ================= ç§å¯†ç•™è¨€æ¨™è¨˜ ================= */
        .private-message {
            position: relative;
            border-left: 4px solid #AF52DE !important;
            background: rgba(175, 82, 222, 0.05) !important;
        }
        
        .private-message::before {
            content: "ğŸ”’ ç§å¯†ç•™è¨€";
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #AF52DE;
            background: rgba(175, 82, 222, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* ================= ç®¡ç†å“¡æ“ä½œæŒ‰éˆ• ================= */
        .admin-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .admin-item {
            padding: 20px;
            background: var(--card-bg);
            border-radius: 14px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease-out;
        }
        
        .admin-item:hover {
            background: var(--glass-bg);
        }
    </style>
</head>
<body class="theme-default">

    <!-- ç§»å‹•ç«¯å°èˆªæ¬„ -->
    <div class="mobile-bar glass">
        <button class="ghost" style="border: none; background: transparent; padding: 8px;" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <b style="color: var(--menu-text); font-size: 18px;">DSEå­¸ç¿’ä¸­å¿ƒ</b>
        <div style="width: 44px;"></div>
    </div>

    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar glass" id="sidebar">
        <div style="margin-bottom: 30px; padding: 0 10px;">
            <h2 style="margin: 0 0 10px 0; color: var(--accent); display: flex; align-items: center; gap: 12px; font-size: 22px;">
                <i class="fas fa-graduation-cap"></i> DSE Hub
            </h2>
            <p style="margin: 0; color: var(--text-light); font-size: 13px;">é¦™æ¸¯ä¸­å­¸æ–‡æ†‘å­¸ç¿’å¹³å°</p>
        </div>
        
        <div class="nav-item active" onclick="nav('home', this)" data-delay="0">
            <i class="fas fa-book-open"></i> çŸ¥è­˜åº«
        </div>
        <div class="nav-item" onclick="nav('chat', this)" data-delay="1">
            <i class="fas fa-comments"></i> ç•™è¨€æ¿
        </div>
        <div class="nav-item" onclick="nav('games', this)" data-delay="2">
            <i class="fas fa-gamepad"></i> å­¸ç¿’éŠæˆ²
        </div>
        <div class="nav-item" onclick="nav('duel', this)" data-delay="3">
            <i class="fas fa-bolt"></i> ç·šä¸Šå°æ±º
        </div>
        <div class="nav-item" onclick="nav('submit', this)" data-delay="4">
            <i class="fas fa-edit"></i> æŠ•ç¨¿ä¸­å¿ƒ
        </div>
        <div class="nav-item" onclick="nav('settings', this)" data-delay="5">
            <i class="fas fa-sliders-h"></i> è¨­å®š
        </div>
        <div class="nav-item" id="nav-admin" onclick="nav('admin', this)" style="display: none; color: #FF9500;" data-delay="6">
            <i class="fas fa-shield-alt"></i> ç®¡ç†å¾Œå°
        </div>

        <div style="flex: 1"></div>
        
        <!-- ç”¨æˆ¶ä¿¡æ¯ -->
        <div class="glass" style="padding: 20px; border: none; margin-top: 20px; background: var(--card-bg);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                    display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; font-weight: bold;">
                    <span id="user-avatar">ç”¨</span>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: bold; color: var(--menu-text); font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="u-nm">è«‹ç™»å…¥</div>
                    <div style="font-size: 13px; color: var(--text-sub);" id="u-sc">- åˆ†</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <button class="small ghost" onclick="switchToLogin()">
                    <i class="fas fa-sign-in-alt"></i> ç™»å…¥
                </button>
                <button class="small ghost" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main">

        <!-- çŸ¥è­˜åº«é é¢ -->
        <div id="view-home" class="page active">
            <div class="flex items-center justify-between mb-30">
                <div>
                    <h1 style="margin: 0 0 8px 0; color: var(--text);">ğŸ“š çŸ¥è­˜åº«</h1>
                    <p style="margin: 0; color: var(--text-sub); font-size: 15px;">æ¢ç´¢å„ç§‘ç›®çŸ¥è­˜é»</p>
                </div>
                <button onclick="refreshKnowledge()" class="ghost small" style="width: auto;">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°
                </button>
            </div>
            
            <!-- ç§‘ç›®è† å›Šé¸æ“‡å™¨ -->
            <div class="capsule-scroll" id="subject-capsules">
                <!-- ç”±JSå‹•æ…‹ç”Ÿæˆ -->
            </div>

            <!-- æœç´¢æ¡† -->
            <div class="glass" style="padding: 18px; margin-bottom: 25px; display: flex; gap: 12px; align-items: center;">
                <i class="fas fa-search" style="color: var(--text-light);"></i>
                <input id="search-k" placeholder="æœç´¢çŸ¥è­˜é»æ¨™é¡Œæˆ–å…§å®¹..." 
                       style="margin: 0; border: none; background: transparent; color: var(--text); padding: 0; font-size: 15px;"
                       onkeyup="fetchHome()">
                <button onclick="clearSearch()" class="ghost small" style="width: auto; padding: 6px 12px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- çŸ¥è­˜åˆ—è¡¨ -->
            <div id="home-list"></div>
            
            <div id="home-loading" style="text-align: center; padding: 40px 20px; display: none;">
                <div class="loading"></div>
                <p style="color: var(--text-sub); margin-top: 15px;">åŠ è¼‰ä¸­...</p>
            </div>
        </div>

        <!-- ç•™è¨€æ¿é é¢ -->
        <div id="view-chat" class="page">
            <h1 style="margin-bottom: 25px; color: var(--text);">ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="glass" style="height: 60vh; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;" id="chat-list"></div>
            <div class="glass" style="padding: 20px; display: flex; gap: 12px; margin-top: 20px;">
                <input id="chat-input" placeholder="è¼¸å…¥ä½ çš„ç•™è¨€..." style="margin: 0; color: var(--text); flex: 1;">
                <button onclick="sendChat()" style="width: auto; padding: 12px 25px;">
                    <i class="fas fa-paper-plane"></i> ç™¼é€
                </button>
            </div>
            <!-- ç§å¯†ç•™è¨€è¨­ç½® -->
            <div class="glass" style="padding: 20px; margin-top: 15px;">
                <div style="font-size: 14px; color: var(--text-sub); margin-bottom: 10px; font-weight: 500;">ç•™è¨€éš±ç§è¨­ç½®ï¼š</div>
                <div style="display: flex; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="visibility" value="public" checked>
                        <span style="color: var(--text);">å…¬é–‹ç•™è¨€</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="visibility" value="private">
                        <span style="color: var(--text);">ç§å¯†ç•™è¨€</span>
                    </label>
                </div>
                <div id="private-settings" style="margin-top: 15px; display: none;">
                    <div style="font-size: 14px; color: var(--text-sub); margin-bottom: 8px;">æŒ‡å®šæ¥æ”¶ç”¨æˆ¶ï¼ˆç”¨æˆ¶åï¼‰ï¼š</div>
                    <input id="target-user" placeholder="è¼¸å…¥ç”¨æˆ¶åï¼Œç•™ç©ºå‰‡ç‚ºåƒ…è‡ªå·±å¯è¦‹" style="margin: 0; color: var(--text);">
                </div>
            </div>
        </div>

        <!-- å­¸ç¿’éŠæˆ²é é¢ -->
        <div id="view-games" class="page">
            <div class="flex items-center justify-between mb-30">
                <div>
                    <h1 style="margin: 0 0 8px 0; color: var(--text);">ğŸ® å­¸ç¿’éŠæˆ²</h1>
                    <p style="margin: 0; color: var(--text-sub); font-size: 15px;">é€šééŠæˆ²éå›ºçŸ¥è­˜</p>
                </div>
                <button onclick="showLeaderboard()" class="ghost small" style="width: auto;">
                    <i class="fas fa-trophy"></i> æ’è¡Œæ¦œ
                </button>
            </div>

            <div class="game-selector" id="game-selector">
                <div class="game-selector-card" onclick="startLinkGame()">
                    <i class="fas fa-puzzle-piece"></i>
                    <div>
                        <h3>çŸ¥è­˜é€£é€£çœ‹</h3>
                        <p>é€£æ¥çŸ¥è­˜é»èˆ‡å°æ‡‰ä¾‹å­</p>
                        <div class="game-difficulty">ä¸­ç´š</div>
                    </div>
                </div>
                
                <div class="game-selector-card" onclick="startMemoryGame()">
                    <i class="fas fa-brain"></i>
                    <div>
                        <h3>è¨˜æ†¶å¤§è€ƒé©—</h3>
                        <p>è¨˜æ†¶ä¸¦é…å°çŸ¥è­˜å¡ç‰‡</p>
                        <div class="game-difficulty">åˆç´š</div>
                    </div>
                </div>
                
                <div class="game-selector-card" onclick="startMatchGame()">
                    <i class="fas fa-layer-group"></i>
                    <div>
                        <h3>çŸ¥è­˜é…å°</h3>
                        <p>æ‹–æ”¾é…å°ç›¸é—œçŸ¥è­˜</p>
                        <div class="game-difficulty">åˆç´š</div>
                    </div>
                </div>
                
                <div class="game-selector-card" onclick="startTypingGame()">
                    <i class="fas fa-keyboard"></i>
                    <div>
                        <h3>æ‰“å­—æŒ‘æˆ°</h3>
                        <p>å¿«é€Ÿè¼¸å…¥çŸ¥è­˜è¦é»</p>
                        <div class="game-difficulty">é«˜ç´š</div>
                    </div>
                </div>
                
                <div class="game-selector-card" onclick="startQuizGame()">
                    <i class="fas fa-question-circle"></i>
                    <div>
                        <h3>å¿«é€Ÿå•ç­”</h3>
                        <p>æ¸¬è©¦ä½ çš„çŸ¥è­˜å„²å‚™</p>
                        <div class="game-difficulty">ä¸­ç´š</div>
                    </div>
                </div>
            </div>

            <!-- é€£é€£çœ‹éŠæˆ²ç•Œé¢ -->
            <div id="link-game-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <div class="game-header">
                        <div>
                            <h2 style="margin: 0; color: var(--text);">ğŸ§© çŸ¥è­˜é€£é€£çœ‹</h2>
                            <p style="margin: 5px 0 0 0; color: var(--text-sub); font-size: 14px;">é€£æ¥çŸ¥è­˜é»èˆ‡å°æ‡‰ä¾‹å­</p>
                        </div>
                        <div class="game-info">
                            <div class="game-stat">
                                <div class="game-stat-label">æ™‚é–“</div>
                                <div class="game-stat-value" id="link-time">120</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">åˆ†æ•¸</div>
                                <div class="game-stat-value" id="link-score">0</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">å‰©é¤˜é…å°</div>
                                <div class="game-stat-value" id="link-remaining">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-20">
                        <p style="color: var(--text-sub); margin: 0 0 15px 0; font-size: 14px;">
                            éŠæˆ²è¦å‰‡ï¼šé¸æ“‡ä¸€å€‹çŸ¥è­˜é»ï¼ˆè—è‰²é‚Šæ¡†ï¼‰ï¼Œç„¶å¾Œé¸æ“‡å°æ‡‰çš„ä¾‹å­ï¼ˆæ©™è‰²é‚Šæ¡†ï¼‰ã€‚ç•¶æ‰€æœ‰ä¾‹å­éƒ½èˆ‡çŸ¥è­˜é»é…å°å®Œæˆå¾Œï¼ŒçŸ¥è­˜é»å¡ç‰‡æ‰æœƒæ¶ˆå¤±ã€‚
                        </p>
                        <div class="flex items-center gap-20">
                            <div class="flex items-center gap-10">
                                <div class="link-card knowledge" style="width: 30px; height: 30px; font-size: 16px;">çŸ¥</div>
                                <span style="color: var(--text-sub); font-size: 14px;">çŸ¥è­˜é»</span>
                            </div>
                            <div class="flex items-center gap-10">
                                <div class="link-card example" style="width: 30px; height: 30px; font-size: 16px;">ä¾‹</div>
                                <span style="color: var(--text-sub); font-size: 14px;">ä¾‹å­</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="link-game-board">
                        <!-- é€£é€£çœ‹å¡ç‰‡ç”±JSç”Ÿæˆ -->
                    </div>
                    
                    <div class="flex justify-center gap-15 mt-30">
                        <button onclick="showLinkHint()" class="ghost">
                            <i class="fas fa-lightbulb"></i> æç¤º
                        </button>
                        <button onclick="resetLinkGame()" class="warning">
                            <i class="fas fa-redo"></i> é‡æ–°é–‹å§‹
                        </button>
                        <button onclick="finishLinkGame()" class="danger">
                            <i class="fas fa-flag-checkered"></i> çµæŸéŠæˆ²
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¨˜æ†¶éŠæˆ²ç•Œé¢ -->
            <div id="memory-game-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <div class="game-header">
                        <div>
                            <h2 style="margin: 0; color: var(--text);">ğŸ§  è¨˜æ†¶å¤§è€ƒé©—</h2>
                            <p style="margin: 5px 0 0 0; color: var(--text-sub); font-size: 14px;">è¨˜æ†¶ä¸¦é…å°ç›¸åŒçš„å¡ç‰‡</p>
                        </div>
                        <div class="game-info">
                            <div class="game-stat">
                                <div class="game-stat-label">æ™‚é–“</div>
                                <div class="game-stat-value" id="memory-time">90</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">åˆ†æ•¸</div>
                                <div class="game-stat-value" id="memory-score">0</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">é…å°æ•¸</div>
                                <div class="game-stat-value" id="memory-matched">0/8</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="memory-game-board">
                        <!-- è¨˜æ†¶å¡ç‰‡ç”±JSç”Ÿæˆ -->
                    </div>
                    
                    <div class="flex justify-center gap-15 mt-30">
                        <button onclick="resetMemoryGame()" class="warning">
                            <i class="fas fa-redo"></i> é‡æ–°é–‹å§‹
                        </button>
                        <button onclick="finishMemoryGame()" class="danger">
                            <i class="fas fa-flag-checkered"></i> çµæŸéŠæˆ²
                        </button>
                    </div>
                </div>
            </div>

            <!-- é…å°éŠæˆ²ç•Œé¢ -->
            <div id="match-game-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <div class="game-header">
                        <div>
                            <h2 style="margin: 0; color: var(--text);">ğŸ”— çŸ¥è­˜é…å°</h2>
                            <p style="margin: 5px 0 0 0; color: var(--text-sub); font-size: 14px;">å°‡å·¦å´çŸ¥è­˜èˆ‡å³å´æè¿°é…å°</p>
                        </div>
                        <div class="game-info">
                            <div class="game-stat">
                                <div class="game-stat-label">æ™‚é–“</div>
                                <div class="game-stat-value" id="match-time">60</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">åˆ†æ•¸</div>
                                <div class="game-stat-value" id="match-score">0</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">é€²åº¦</div>
                                <div class="game-stat-value" id="match-progress">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="match-game-area">
                        <!-- é…å°éŠæˆ²å€åŸŸç”±JSç”Ÿæˆ -->
                    </div>
                    
                    <div class="flex justify-center gap-15 mt-30">
                        <button onclick="resetMatchGame()" class="warning">
                            <i class="fas fa-redo"></i> é‡æ–°é–‹å§‹
                        </button>
                        <button onclick="finishMatchGame()" class="danger">
                            <i class="fas fa-flag-checkered"></i> çµæŸéŠæˆ²
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ‰“å­—éŠæˆ²ç•Œé¢ -->
            <div id="typing-game-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <div class="game-header">
                        <div>
                            <h2 style="margin: 0; color: var(--text);">âŒ¨ï¸ æ‰“å­—æŒ‘æˆ°</h2>
                            <p style="margin: 5px 0 0 0; color: var(--text-sub); font-size: 14px;">å¿«é€Ÿæº–ç¢ºè¼¸å…¥é¡¯ç¤ºçš„æ–‡å­—</p>
                        </div>
                        <div class="game-info">
                            <div class="game-stat">
                                <div class="game-stat-label">æ™‚é–“</div>
                                <div class="game-stat-value" id="typing-time">45</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">åˆ†æ•¸</div>
                                <div class="game-stat-value" id="typing-score">0</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">æº–ç¢ºç‡</div>
                                <div class="game-stat-value" id="typing-accuracy">100%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="typing-game-area">
                        <!-- æ‰“å­—éŠæˆ²å€åŸŸç”±JSç”Ÿæˆ -->
                    </div>
                    
                    <div class="flex justify-center gap-15 mt-30">
                        <button onclick="resetTypingGame()" class="warning">
                            <i class="fas fa-redo"></i> é‡æ–°é–‹å§‹
                        </button>
                        <button onclick="finishTypingGame()" class="danger">
                            <i class="fas fa-flag-checkered"></i> çµæŸéŠæˆ²
                        </button>
                    </div>
                </div>
            </div>

            <!-- å•ç­”éŠæˆ²ç•Œé¢ -->
            <div id="quiz-game-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <div class="game-header">
                        <div>
                            <h2 style="margin: 0; color: var(--text);">â“ å¿«é€Ÿå•ç­”</h2>
                            <p style="margin: 5px 0 0 0; color: var(--text-sub); font-size: 14px;">å›ç­”éš¨æ©ŸæŠ½å–çš„çŸ¥è­˜å•é¡Œ</p>
                        </div>
                        <div class="game-info">
                            <div class="game-stat">
                                <div class="game-stat-label">æ™‚é–“</div>
                                <div class="game-stat-value" id="quiz-time">30</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">åˆ†æ•¸</div>
                                <div class="game-stat-value" id="quiz-score">0</div>
                            </div>
                            <div class="game-stat">
                                <div class="game-stat-label">é¡Œç›®</div>
                                <div class="game-stat-value" id="quiz-count">0/10</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="quiz-game-area">
                        <!-- å•ç­”éŠæˆ²å€åŸŸç”±JSç”Ÿæˆ -->
                    </div>
                    
                    <div class="flex justify-center gap-15 mt-30">
                        <button onclick="resetQuizGame()" class="warning">
                            <i class="fas fa-redo"></i> é‡æ–°é–‹å§‹
                        </button>
                        <button onclick="finishQuizGame()" class="danger">
                            <i class="fas fa-flag-checkered"></i> çµæŸéŠæˆ²
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œ -->
            <div id="leaderboard-container" style="display: none; margin-top: 30px;">
                <div class="game-container">
                    <h2 style="margin: 0 0 25px 0; color: var(--text);">ğŸ† éŠæˆ²æ’è¡Œæ¦œ</h2>
                    <div class="flex gap-15 mb-20">
                        <button class="ghost active" onclick="showGameLeaderboard('all')" style="flex: 1;">ç¸½æ’è¡Œæ¦œ</button>
                        <button class="ghost" onclick="showGameLeaderboard('link')" style="flex: 1;">é€£é€£çœ‹</button>
                        <button class="ghost" onclick="showGameLeaderboard('memory')" style="flex: 1;">è¨˜æ†¶éŠæˆ²</button>
                        <button class="ghost" onclick="showGameLeaderboard('typing')" style="flex: 1;">æ‰“å­—æŒ‘æˆ°</button>
                    </div>
                    <div id="leaderboard-list"></div>
                </div>
            </div>
        </div>

        <!-- ç·šä¸Šå°æ±ºé é¢ -->
        <div id="view-duel" class="page">
            <h1 style="margin-bottom: 25px; color: var(--text);">âš¡ï¸ ç·šä¸Šå°æ±º</h1>
            <div class="game-container text-center">
                <div id="duel-lobby">
                    <i class="fas fa-fist-raised" style="font-size: 70px; color: var(--accent); margin-bottom: 25px;"></i>
                    <h2 style="color: var(--text); margin-bottom: 15px;">çŸ¥è­˜å°æ±º</h2>
                    <p style="color: var(--text-sub); margin-bottom: 30px; max-width: 500px; margin-left: auto; margin-right: auto;">
                        èˆ‡å…¶ä»–ç©å®¶å¯¦æ™‚å°æˆ°ï¼Œæ¸¬è©¦ä½ çš„çŸ¥è­˜å„²å‚™ï¼Œè´å–ç©åˆ†å’Œæ¦®è­½ï¼
                    </p>
                    <button onclick="createDuel()" style="max-width: 250px; margin: 0 auto 30px auto; padding: 16px 30px;">
                        <i class="fas fa-plus-circle"></i> å‰µå»ºå°æ±ºæˆ¿é–“
                    </button>
                    
                    <div class="glass" style="padding: 25px; margin-top: 20px;">
                        <h3 style="margin: 0 0 20px 0; color: var(--text);">å°æˆ°æ­·å²</h3>
                        <div id="duel-history" style="max-height: 250px; overflow-y: auto; text-align: left;"></div>
                    </div>
                </div>
                <div id="duel-wait" style="display: none;">
                    <div class="loading" style="margin: 0 auto 25px auto;"></div>
                    <h3 style="color: var(--text); margin-bottom: 15px;">ç­‰å¾…å°æ‰‹åŠ å…¥...</h3>
                    <p style="color: var(--text-sub); margin-bottom: 20px;">æˆ¿é–“ ID: <span id="room-id-disp" style="font-family: monospace; font-weight: bold; color: var(--accent);"></span></p>
                    <div id="room-info" class="glass" style="padding: 20px; margin-bottom: 25px;"></div>
                    <button onclick="cancelDuel()" class="danger" style="max-width: 200px; margin: 0 auto;">
                        <i class="fas fa-times-circle"></i> å–æ¶ˆç­‰å¾…
                    </button>
                </div>
                <div id="duel-game" style="display: none;">
                    <h3 id="dq-text" style="color: var(--text); margin-bottom: 30px;">é¡Œç›®åŠ è¼‰ä¸­...</h3>
                    <div id="dq-opts" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;"></div>
                    <div class="glass" style="padding: 20px; display: inline-block;">
                        <div id="score-display" style="font-size: 18px; font-weight: bold; color: var(--text);">å¾—åˆ†: 0 - 0</div>
                        <div id="timer" style="font-size: 16px; color: var(--text-sub); margin-top: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ•ç¨¿ä¸­å¿ƒé é¢ -->
        <div id="view-submit" class="page">
            <h1 style="margin-bottom: 25px; color: var(--text);">âœï¸ æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="game-container">
                <!-- æŠ•ç¨¿é¡å‹é¸æ“‡ -->
                <div style="display: flex; gap: 12px; margin-bottom: 25px;">
                    <button style="background: var(--accent); color: white; flex: 1; padding: 16px;">
                        <i class="fas fa-book"></i> çŸ¥è­˜é»æŠ•ç¨¿
                    </button>
                </div>
                
                <!-- çŸ¥è­˜é»æŠ•ç¨¿è¡¨å–® -->
                <div id="form-know">
                    <div style="margin-bottom: 20px;">
                        <div style="font-size: 15px; color: var(--text-sub); margin-bottom: 10px; font-weight: 500;">é¸æ“‡ç§‘ç›®ï¼š</div>
                        <div class="capsule-scroll" id="submit-capsules">
                            <!-- ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                    <input id="sub-title" placeholder="çŸ¥è­˜é»æ¨™é¡Œ" style="color: var(--text);">
                    <textarea id="sub-content" rows="6" placeholder="è©³ç´°å…§å®¹æè¿°..." style="color: var(--text);"></textarea>
                    <div style="margin-bottom: 15px;">
                        <div style="font-size: 15px; color: var(--text-sub); margin-bottom: 8px; font-weight: 500;">ä¾‹å­ï¼ˆæ¯è¡Œä¸€å€‹ä¾‹å­ï¼Œç¬¬ä¸€å€‹ä¾‹å­ç‚ºæ­£ç¢ºç­”æ¡ˆï¼‰ï¼š</div>
                        <textarea id="sub-example" rows="4" placeholder="æ­£ç¢ºç­”æ¡ˆ // å¹²æ“¾é …1 // å¹²æ“¾é …2 // å¹²æ“¾é …3" style="color: var(--text);"></textarea>
                    </div>
                    <button onclick="submitKnowledge()" style="margin-top: 10px; padding: 16px;">
                        <i class="fas fa-paper-plane"></i> æäº¤çŸ¥è­˜é»
                    </button>
                </div>
            </div>
        </div>

        <!-- è¨­å®šé é¢ -->
        <div id="view-settings" class="page">
            <h1 style="margin-bottom: 25px; color: var(--text);">âš™ï¸ è¨­å®š</h1>
            <div class="game-container">
                <h3 style="color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-user-circle"></i> å¸³è™Ÿä¿¡æ¯
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="glass" style="padding: 20px; border: none; background: var(--card-bg);">
                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">ç”¨æˆ¶å</div>
                        <div style="font-size: 18px; font-weight: bold; color: var(--text);" id="set-u-nm">è«‹ç™»å…¥</div>
                    </div>
                    <div class="glass" style="padding: 20px; border: none; background: var(--card-bg);">
                        <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">ç©åˆ†</div>
                        <div style="font-size: 18px; font-weight: bold; color: var(--accent);" id="set-u-sc">-</div>
                    </div>
                </div>

                <h3 style="color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-palette"></i> ä¸»é¡Œè¨­å®š
                </h3>
                <div class="theme-colors">
                    <div class="theme-color theme-default active" onclick="changeTheme('default')" title="é»˜èªè—è‰²"></div>
                    <div class="theme-color theme-white" onclick="changeTheme('white')" title="ç´”ç™½ç°¡ç´„"></div>
                    <div class="theme-color theme-dark" onclick="changeTheme('dark')" title="æš—é»‘æ¨¡å¼"></div>
                    <div class="theme-color theme-green" onclick="changeTheme('green')" title="æ¸…æ–°ç¶ è‰²"></div>
                    <div class="theme-color theme-orange" onclick="changeTheme('orange')" title="æ´»åŠ›æ©™è‰²"></div>
                    <div class="theme-color theme-purple" onclick="changeTheme('purple')" title="æµªæ¼«ç´«è‰²"></div>
                    <div class="theme-color theme-pink" onclick="changeTheme('pink')" title="ç”œç¾ç²‰è‰²"></div>
                </div>

                <h3 style="color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 12px; margin-top: 40px;">
                    <i class="fas fa-shield-alt"></i> ç®¡ç†å“¡æ¬Šé™
                </h3>
                <div class="glass" style="padding: 25px; border: none; background: var(--card-bg); margin-top: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--text); margin-bottom: 5px;">ç®¡ç†å“¡æ¨¡å¼</div>
                            <div style="font-size: 14px; color: var(--text-sub);">é–‹å•Ÿå¾Œå¯ä»¥è¨ªå•ç®¡ç†å¾Œå°</div>
                        </div>
                        <button id="btn-adm" class="small" onclick="toggleAdmin()" style="width: auto;">
                            é–‹å•Ÿæ¬Šé™
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç®¡ç†å¾Œå°é é¢ -->
        <div id="view-admin" class="page">
            <h1 style="margin-bottom: 25px; color: var(--accent); display: flex; align-items: center; gap: 15px;">
                <i class="fas fa-shield-alt"></i> ç®¡ç†å¾Œå°
            </h1>
            <div class="game-container">
                <div style="display: flex; gap: 12px; margin-bottom: 30px; flex-wrap: wrap;">
                    <button class="ghost" onclick="showAdminSection('feedbacks')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-comments"></i> ç•™è¨€ç®¡ç†
                    </button>
                    <button class="ghost" onclick="showAdminSection('submissions')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-book"></i> çŸ¥è­˜é»ç®¡ç†
                    </button>
                    <button class="ghost" onclick="showAdminSection('users')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-users"></i> ç”¨æˆ¶ç®¡ç†
                    </button>
                    <button class="ghost" onclick="showAdminSection('games')" style="flex: 1; min-width: 150px;">
                        <i class="fas fa-gamepad"></i> éŠæˆ²è¨˜éŒ„
                    </button>
                </div>
                <div id="admin-content"></div>
            </div>
        </div>

    </div>

    <!-- ç™»å…¥å½ˆçª— -->
    <div class="modal-mask" id="auth-modal" style="display: flex;">
        <div class="modal-box glass">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                    display: inline-flex; align-items: center; justify-content: center; color: white; font-size: 30px; margin-bottom: 15px;">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h2 style="margin: 0; color: var(--text);">DSEå­¸ç¿’ä¸­å¿ƒ</h2>
                <p style="margin: 8px 0 0 0; color: var(--text-sub); font-size: 14px;">é¦™æ¸¯ä¸­å­¸æ–‡æ†‘å­¸ç¿’å¹³å°</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input id="lg-e" placeholder="é›»éƒµåœ°å€" style="color: var(--text);">
                <input id="lg-p" type="password" placeholder="å¯†ç¢¼" style="color: var(--text); margin-bottom: 15px;">
                
                <button onclick="auth('in')" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-sign-in-alt"></i> ç™»å…¥
                </button>
                
                <button class="ghost" style="width: 100%; margin-bottom: 10px;" onclick="auth('up')">
                    <i class="fas fa-user-plus"></i> è¨»å†Šæ–°å¸³è™Ÿ
                </button>
            </div>
            
            <p id="auth-err" style="color: #FF3B30; font-size: 13px; margin-top: 15px; text-align: center;"></p>
            
            <!-- æ·»åŠ é€€å‡ºç™»å½•é“¾æ¥ -->
            <div style="text-align: center; margin-top: 20px; font-size: 13px;">
                <a href="?noautologin=true" style="color: var(--text-light); text-decoration: none;">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡ºå½“å‰è´¦å·
                </a>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å€åŸŸ -->
    <div id="notification-area"></div>

    <script>
        // ================= é…ç½® =================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ================= å…¨å±€å˜é‡ =================
        let user = null;
        let profile = null;
        // ... å…¶ä»–å˜é‡ä¿æŒä¸å˜
        
        // ================= è´¦å·åˆ‡æ¢å™¨ =================
        function showAccountSwitcher() {
            const modal = document.createElement('div');
            modal.className = 'modal-mask';
            modal.innerHTML = `
                <div class="modal-box glass" style="width: 350px;">
                    <h3 style="color: var(--text); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-users"></i> å¸³è™Ÿç®¡ç†
                    </h3>
                    
                    <div style="margin-bottom: 20px;">
                        <div style="background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: var(--text); margin-bottom: 5px;">ç•¶å‰å¸³è™Ÿ</div>
                            <div style="color: var(--text-sub); font-size: 14px;">${profile?.username || 'æœªç™»å…¥'}</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        ${!user ? `
                            <button onclick="switchToLogin()">
                                <i class="fas fa-sign-in-alt"></i> ç™»å…¥å¸³è™Ÿ
                            </button>
                            <button onclick="createNewAccount()" class="ghost">
                                <i class="fas fa-user-plus"></i> è¨»å†Šæ–°å¸³è™Ÿ
                            </button>
                        ` : `
                            <button onclick="logout()" class="danger">
                                <i class="fas fa-sign-out-alt"></i> ç™»å‡ºå¸³è™Ÿ
                            </button>
                        `}
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="small ghost" onclick="this.closest('.modal-mask').remove()">
                            <i class="fas fa-times"></i> å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function switchToLogin() {
            const authModal = document.getElementById('auth-modal');
            if (authModal) {
                document.querySelectorAll('.modal-mask').forEach(m => {
                    if (m !== authModal) m.remove();
                });
                authModal.style.display = 'flex';
            } else {
                // å¦‚æœauth-modalä¸å­˜åœ¨ï¼Œé‡æ–°åŠ è½½é¡µé¢
                location.reload();
            }
        }
        
        // ================= è®¤è¯ç›¸å…³ =================
        async function auth(type) {
            const email = document.getElementById('lg-e').value.trim();
            const password = document.getElementById('lg-p').value.trim();
            const errEl = document.getElementById('auth-err');
            
            if (!email || !password) {
                errEl.innerText = 'è«‹å¡«å¯«é›»éƒµå’Œå¯†ç¢¼';
                return;
            }
        
            try {
                let res;
                if (type === 'up') {
                    res = await sb.auth.signUp({ 
                        email, 
                        password,
                        options: {
                            data: {
                                username: email.split('@')[0]
                            }
                        }
                    });
                } else {
                    res = await sb.auth.signInWithPassword({ email, password });
                }
        
                if (res.error) {
                    errEl.innerText = res.error.message;
                    showNotification('èªè­‰å¤±æ•—: ' + res.error.message, 'error');
                } else {
                    user = res.data.user;
                    if (type === 'up') {
                        showNotification('è¨»å†ŠæˆåŠŸï¼æ­£åœ¨å‰µå»ºç”¨æˆ¶è³‡æ–™...', 'success');
                        // æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•
                        await loadProfile();
                        document.getElementById('auth-modal').style.display = 'none';
                    } else {
                        await loadProfile();
                        document.getElementById('auth-modal').style.display = 'none';
                        showNotification('ç™»å…¥æˆåŠŸï¼', 'success');
                    }
                }
            } catch (error) {
                console.error('èªè­‰éŒ¯èª¤:', error);
                errEl.innerText = 'ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦';
                showNotification('ç¶²çµ¡éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦', 'error');
            }
        }
        
        async function logout() {
            try {
                // 1. å…ˆè°ƒç”¨Supabaseç™»å‡º
                const { error } = await sb.auth.signOut();
                
                // 2. æ¸…é™¤æœ¬åœ°çŠ¶æ€
                user = null;
                profile = null;
                
                // 3. æ›´æ–°UI - ä½¿ç”¨å®‰å…¨çš„DOMæ“ä½œæ–¹æ³•
                const updateElement = (id, text) => {
                    const el = document.getElementById(id);
                    if (el) el.innerText = text;
                };
                
                updateElement('u-nm', 'è«‹ç™»å…¥');
                updateElement('user-avatar', 'è«‹');
                updateElement('u-sc', '- åˆ†');
                updateElement('set-u-nm', 'è«‹ç™»å…¥');
                updateElement('set-u-sc', '-');
                
                // éšè—ç®¡ç†å‘˜å¯¼èˆª
                const navAdmin = document.getElementById('nav-admin');
                if (navAdmin) navAdmin.style.display = 'none';
                
                // 4. æ˜¾ç¤ºé€šçŸ¥
                showNotification('å·²æˆåŠŸç™»å‡º', 'success');
                
                // 5. æ˜¾ç¤ºç™»å½•å¼¹çª—
                const authModal = document.getElementById('auth-modal');
                if (authModal) {
                    authModal.style.display = 'flex';
                }
                
                // 6. å¯¼èˆªåˆ°é¦–é¡µ
                nav('home');
                
            } catch (error) {
                console.error('ç™»å‡ºå¼‚å¸¸:', error);
                // å³ä½¿å‡ºé”™ä¹Ÿæ¸…é™¤æœ¬åœ°çŠ¶æ€
                user = null;
                profile = null;
                
                // å¼ºåˆ¶åˆ·æ–°é¡µé¢
                location.reload();
            }
        }
        
        // ================= ç”¨æˆ·èµ„æ–™ç®¡ç† =================
        async function loadProfile() {
            try {
                console.log('æ­£åœ¨åŠ è½½ç”¨æˆ·èµ„æ–™');
                
                if (!user || !user.id) {
                    throw new Error('ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±');
                }
                
                // å…ˆå°è¯•è·å–ç°æœ‰èµ„æ–™
                const { data, error } = await sb
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .maybeSingle();
                
                if (error) {
                    console.error('æŸ¥è¯¢ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    throw error;
                }
                
                if (data) {
                    profile = data;
                } else {
                    // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„ç”¨æˆ·èµ„æ–™
                    console.log('åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™');
                    const { data: newProfile, error: createError } = await sb
                        .from('profiles')
                        .insert({
                            id: user.id,
                            username: user.email ? user.email.split('@')[0] : 'ç”¨æˆ¶',
                            email: user.email,
                            score: 0,
                            is_admin: false,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        })
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('åˆ›å»ºç”¨æˆ·èµ„æ–™å¤±è´¥:', createError);
                        throw createError;
                    }
                    
                    profile = newProfile;
                }
                
                updateUserUI();
                const authModal = document.getElementById('auth-modal');
                if (authModal) authModal.style.display = 'none';
                
                // å¯¼èˆªåˆ°é¦–é¡µ
                setTimeout(() => nav('home'), 100);
                
                // å»¶è¿ŸåŠ è½½çŸ¥è¯†åº“
                setTimeout(() => fetchHome(), 500);
                
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™é”™è¯¯:', error);
                
                // å‡ºé”™æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const errMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                showNotification('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥: ' + errMessage, 'error');
                
                // å¦‚æœæ˜¯å› ä¸ºRLSç­–ç•¥é—®é¢˜ï¼Œå¼•å¯¼ç”¨æˆ·æ£€æŸ¥è®¾ç½®
                if (error.message && error.message.includes('403')) {
                    showNotification('è¯·æ£€æŸ¥Supabase RLSç­–ç•¥è®¾ç½®', 'warning');
                }
                
                // ä¿æŒç™»å½•å¼¹çª—æ˜¾ç¤º
                const authModal = document.getElementById('auth-modal');
                if (authModal) authModal.style.display = 'flex';
            }
        }
        
        // ================= æ¨¡å—B: ç•™è¨€æ¿ - ä¿®å¤æŸ¥è¯¢ =================
        async function fetchChat() {
            try {
                if (!user) {
                    // æœªç™»å½•ç”¨æˆ·åªæ˜¾ç¤ºå…¬å¼€ç•™è¨€
                    const { data, error } = await sb
                        .from('feedbacks')
                        .select('*')
                        .eq('visibility', 'public')
                        .neq('status', 'deleted')
                        .order('created_at', { ascending: false })
                        .limit(30);
                    
                    if (error) throw error;
                    renderChatList(data || []);
                    return;
                }
                
                // ç™»å½•ç”¨æˆ·å¯ä»¥çœ‹åˆ°å…¬å¼€ç•™è¨€å’Œè‡ªå·±çš„ç§å¯†ç•™è¨€
                // ä½¿ç”¨ä¸¤ä¸ªæŸ¥è¯¢æ¥é¿å…å¤æ‚çš„ORæ¡ä»¶
                const { data: publicData, error: publicError } = await sb
                    .from('feedbacks')
                    .select('*')
                    .eq('visibility', 'public')
                    .neq('status', 'deleted')
                    .order('created_at', { ascending: false })
                    .limit(30);
                
                if (publicError) throw publicError;
                
                // è·å–ç§å¯†ç•™è¨€
                const { data: privateData, error: privateError } = await sb
                    .from('feedbacks')
                    .select('*')
                    .eq('visibility', 'private')
                    .neq('status', 'deleted')
                    .or(`user_id.eq.${user.id},target_user_id.eq.${user.id}`)
                    .order('created_at', { ascending: false })
                    .limit(20);
                
                if (privateError) throw privateError;
                
                // åˆå¹¶ç»“æœå¹¶å»é‡
                const allMessages = [...(privateData || []), ...(publicData || [])];
                
                // å»é‡ï¼šåŸºäºç•™è¨€ID
                const uniqueMessages = [];
                const seenIds = new Set();
                
                allMessages.forEach(msg => {
                    if (!seenIds.has(msg.id)) {
                        seenIds.add(msg.id);
                        uniqueMessages.push(msg);
                    }
                });
                
                // æŒ‰æ—¶é—´æ’åº
                uniqueMessages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                renderChatList(uniqueMessages);
                
            } catch (error) {
                console.error('ç²å–ç•™è¨€å¤±æ•—:', error);
                showNotification('ç²å–ç•™è¨€å¤±æ•—: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const container = document.getElementById('chat-list');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px 20px; color: var(--text-sub);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 50px; margin-bottom: 20px; color: #FF9500;"></i>
                            <h3 style="margin: 0 0 15px 0; color: var(--text);">ç„¡æ³•åŠ è¼‰ç•™è¨€</h3>
                            <p style="margin: 0; color: var(--text-sub);">${error.message || 'è«‹ç¨å¾Œé‡è©¦'}</p>
                            <button onclick="fetchChat()" class="ghost small" style="margin-top: 20px;">
                                <i class="fas fa-sync-alt"></i> é‡æ–°å˜—è©¦
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // ================= åˆå§‹åŒ–ä¿®å¤ =================
        window.onload = async () => {
            console.log('æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...');
            
            try {
                // è®¾ç½®å¯¼èˆªåŠ¨ç”»å»¶è¿Ÿ
                document.querySelectorAll('.nav-item').forEach((item, index) => {
                    const delay = item.dataset.delay || index;
                    item.style.animationDelay = `${delay * 0.05}s`;
                });
                
                initUI();
                
                // æ£€æŸ¥URLå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const noAutoLogin = urlParams.get('noautologin');
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const { data: sessionData, error: sessionError } = await sb.auth.getSession();
                
                if (sessionError) {
                    console.error('è·å–ä¼šè¯å¤±è´¥:', sessionError);
                    showNotification('ä¼šè¯æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                }
                
                if (sessionData.session && !noAutoLogin) {
                    console.log('æ£€æµ‹åˆ°ç°æœ‰ä¼šè¯ï¼Œè‡ªåŠ¨ç™»å½•...');
                    user = sessionData.session.user;
                    await loadProfile();
                } else {
                    console.log('æ— æœ‰æ•ˆä¼šè¯ï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—');
                    // æ˜¾ç¤ºç™»å½•å¼¹çª—
                    const authModal = document.getElementById('auth-modal');
                    if (authModal) {
                        authModal.style.display = 'flex';
                    }
                    
                    // å¦‚æœURLå‚æ•°æŒ‡å®šäº†ä¸è‡ªåŠ¨ç™»å½•ï¼Œæ¸…ç©ºä¼šè¯
                    if (noAutoLogin) {
                        try {
                            await sb.auth.signOut();
                            showNotification('å·²é€€å‡ºç™»å½•çŠ¶æ€', 'info');
                        } catch (error) {
                            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        }
                    }
                }
                
                // è½½å…¥ä¿å­˜çš„ä¸»é¢˜
                try {
                    const savedTheme = localStorage.getItem('dsehub-theme');
                    if (savedTheme) {
                        changeTheme(savedTheme);
                    }
                } catch (error) {
                    console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
                }
                
                // è½½å…¥æ¸¸æˆè®°å½•
                loadGameRecords();
                
                // è®¾ç½®ç•™è¨€å¯è§æ€§åˆ‡æ¢äº‹ä»¶
                setupVisibilityToggle();
                
                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showNotification('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                
                // ç¡®ä¿ç™»å½•å¼¹çª—æ˜¾ç¤º
                const authModal = document.getElementById('auth-modal');
                if (authModal) {
                    authModal.style.display = 'flex';
                }
            }
        };
        
        // ================= ä¿®å¤UIæ›´æ–°å‡½æ•° =================
        function updateUserUI() {
            // å®‰å…¨æ›´æ–°DOMå…ƒç´ 
            const safeUpdate = (id, text) => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerText = text;
                }
            };
            
            if (!profile) {
                safeUpdate('u-nm', 'è«‹ç™»å…¥');
                safeUpdate('user-avatar', 'è«‹');
                safeUpdate('u-sc', '- åˆ†');
                safeUpdate('set-u-nm', 'è«‹ç™»å…¥');
                safeUpdate('set-u-sc', '-');
                
                // éšè—ç®¡ç†å‘˜å¯¼èˆª
                const navAdmin = document.getElementById('nav-admin');
                if (navAdmin) {
                    navAdmin.style.display = 'none';
                }
                
                const btnAdm = document.getElementById('btn-adm');
                if (btnAdm) {
                    btnAdm.innerText = 'è«‹å…ˆç™»å…¥';
                    btnAdm.classList.remove('danger');
                    btnAdm.disabled = true;
                }
                
                return;
            }
            
            const username = profile.username || 'ç”¨æˆ¶';
            const score = profile.score || 0;
            
            safeUpdate('u-nm', username);
            safeUpdate('set-u-nm', username);
            safeUpdate('user-avatar', username.charAt(0));
            safeUpdate('u-sc', score + ' åˆ†');
            safeUpdate('set-u-sc', score.toString());
            
            // ç®¡ç†å‘˜æƒé™æ˜¾ç¤º
            const navAdmin = document.getElementById('nav-admin');
            const btnAdm = document.getElementById('btn-adm');
            
            if (profile.is_admin) {
                if (navAdmin) navAdmin.style.display = 'flex';
                if (btnAdm) {
                    btnAdm.innerText = 'é—œé–‰æ¬Šé™';
                    btnAdm.classList.add('danger');
                    btnAdm.disabled = false;
                }
            } else {
                if (navAdmin) navAdmin.style.display = 'none';
                if (btnAdm) {
                    btnAdm.innerText = 'é–‹å•Ÿæ¬Šé™';
                    btnAdm.classList.remove('danger');
                    btnAdm.disabled = false;
                }
            }
        }
        // ================= æ¨¡å—A: çŸ¥è¯†åº“ =================
        async function fetchHome() {
            const searchKey = document.getElementById('search-k').value.trim();
            
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            document.getElementById('home-loading').style.display = 'block';
            document.getElementById('home-list').innerHTML = '';
            
            try {
                // æ„å»ºæŸ¥è¯¢
                let query = sb
                    .from('submissions')
                    .select('*');
                
                // ç§‘ç›®ç­›é€‰
                if (currentSubject !== 'all') {
                    query = query.eq('category', currentSubject);
                }
                
                // æœç´¢ç­›é€‰
                if (searchKey) {
                    query = query.or(`title.ilike.%${searchKey}%,content.ilike.%${searchKey}%`);
                }
                
                // æ‰§è¡ŒæŸ¥è¯¢
                const { data, error } = await query;
                
                if (error) {
                    console.error('ç²å–çŸ¥è­˜åº«å¤±æ•—:', error);
                    
                    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
                    document.getElementById('home-list').innerHTML = `
                        <div class="glass" style="text-align: center; padding: 60px 20px; color: var(--text-sub);">
                            <i class="fas fa-exclamation-triangle" style="font-size: 50px; margin-bottom: 20px; color: #FF9500;"></i>
                            <h3 style="margin: 0 0 15px 0; color: var(--text);">ç„¡æ³•åŠ è¼‰çŸ¥è­˜åº«</h3>
                            <p style="margin: 0; color: var(--text-sub);">${error.message}</p>
                            <button onclick="fetchHome()" class="ghost small" style="margin-top: 20px;">
                                <i class="fas fa-sync-alt"></i> é‡æ–°å˜—è©¦
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // æ¸²æŸ“ç»“æœ
                renderKnowledgeList(data);
                
            } catch (error) {
                console.error('çŸ¥è­˜åº«æŸ¥è©¢éŒ¯èª¤:', error);
                document.getElementById('home-list').innerHTML = `
                    <div class="glass" style="text-align: center; padding: 60px 20px; color: var(--text-sub);">
                        <i class="fas fa-network-wired" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                        <h3 style="margin: 0 0 15px 0; color: var(--text);">ç¶²çµ¡éŒ¯èª¤</h3>
                        <p style="margin: 0; color: var(--text-sub);">è«‹ç¨å¾Œé‡è©¦</p>
                    </div>
                `;
            } finally {
                // éš±è—åŠ è¼‰å‹•ç•«
                document.getElementById('home-loading').style.display = 'none';
            }
        }
        
        function renderKnowledgeList(items) {
            const container = document.getElementById('home-list');
            
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 60px 20px; color: var(--text-sub);">
                        <i class="fas fa-search" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                        <h3 style="margin: 0 0 15px 0; color: var(--text);">æ²’æœ‰æ‰¾åˆ°ç›¸é—œå…§å®¹</h3>
                        <p style="margin: 0; color: var(--text-sub);">å˜—è©¦æ›´æ›æœç´¢é—œéµè©æˆ–é¸æ“‡å…¶ä»–ç§‘ç›®</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map((item, index) => `
                <div class="k-item glass" onclick="toggleKnowledgeItem(this)" style="animation-delay: ${index * 0.05}s">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <div style="font-weight: bold; color: var(--text); font-size: 17px;">
                            [${getSubjectName(item.category)}] ${item.title}
                        </div>
                        <div style="font-size: 12px; color: var(--text-light);">
                            ${new Date(item.created_at).toLocaleDateString('zh-HK')}
                        </div>
                    </div>
                    <div style="color: var(--text-sub); font-size: 14px; line-height: 1.6;">
                        ${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}
                    </div>
                    <div class="k-body">
                        <div style="margin-bottom: 15px; color: var(--text-sub); line-height: 1.8;">${item.content}</div>
                        ${item.example ? `
                            <div style="background: rgba(var(--accent-rgb), 0.08); padding: 18px; border-radius: 12px; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <i class="fas fa-lightbulb" style="color: var(--accent);"></i>
                                    <div style="color: var(--accent); font-weight: 600; font-size: 15px;">ä¾‹å­</div>
                                </div>
                                <div style="color: var(--text);">${formatExample(item.example)}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function toggleKnowledgeItem(element) {
            element.classList.toggle('open');
        }

        function getSubjectName(key) {
            const subject = SUBJECTS.find(s => s.key === key);
            return subject ? subject.name : key;
        }

        function formatExample(example) {
            const parts = example.split('//').map(p => p.trim()).filter(p => p);
            return parts.map((p, i) => `
                <div style="padding: 10px; margin: 8px 0; background: ${i === 0 ? 'rgba(52,199,89,0.1)' : 'rgba(0,0,0,0.03)'}; 
                    border-radius: 8px; border-left: 4px solid ${i === 0 ? '#34C759' : 'var(--text-light)'};">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="color: ${i === 0 ? '#34C759' : 'var(--text-sub)'}; font-weight: ${i === 0 ? 'bold' : 'normal'};">
                            ${i === 0 ? 'âœ“ æ­£ç¢ºç­”æ¡ˆ' : `â€¢ é¸é … ${i}`}
                        </div>
                    </div>
                    <div style="margin-top: 5px; color: var(--text);">${p}</div>
                </div>
            `).join('');
        }

        // ================= æ¨¡å—B: ç•™è¨€æ¿ =================
        async function fetchChat() {
            try {
                // è·å–æ‰€æœ‰å…¬å¼€ç•™è¨€
                let query = sb
                    .from('feedbacks')
                    .select('*')
                    .eq('visibility', 'public')
                    .neq('status', 'deleted')
                    .order('created_at', { ascending: false })
                    .limit(30);
                
                // å¦‚æœç”¨æˆ·å·²ç™»å½•ï¼ŒåŒæ—¶è·å–ç§å¯†ç•™è¨€
                if (user) {
                    // è·å–å½“å‰ç”¨æˆ·å‘é€æˆ–æ¥æ”¶çš„ç§å¯†ç•™è¨€
                    const privateQuery = sb
                        .from('feedbacks')
                        .select('*')
                        .eq('visibility', 'private')
                        .neq('status', 'deleted')
                        .or(`user_id.eq.${user.id},target_user_id.eq.${user.id}`)
                        .order('created_at', { ascending: false })
                        .limit(20);
                    
                    const [publicData, privateData] = await Promise.all([
                        query,
                        privateQuery
                    ]);
                    
                    const allMessages = [...(privateData.data || []), ...(publicData.data || [])];
                    // æŒ‰æ—¶é—´æ’åº
                    allMessages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    renderChatList(allMessages);
                } else {
                    // æœªç™»å½•ç”¨æˆ·åªçœ‹åˆ°å…¬å¼€ç•™è¨€
                    const { data } = await query;
                    renderChatList(data);
                }
                
            } catch (error) {
                console.error('ç²å–ç•™è¨€å¤±æ•—:', error);
                showNotification('ç²å–ç•™è¨€å¤±æ•—', 'error');
            }
        }

        function renderChatList(messages) {
            const container = document.getElementById('chat-list');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 50px 20px; color: var(--text-sub);">
                        <i class="fas fa-comment-slash" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                        <p style="margin: 0;">æš«ç„¡ç•™è¨€ï¼Œå¿«ä¾†ç™¼è¡¨ç¬¬ä¸€æ¢ç•™è¨€å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map((msg, index) => {
                // æ£€æŸ¥æ˜¯å¦ä¸ºç§å¯†ç•™è¨€
                const isPrivate = msg.visibility === 'private';
                const isRecipient = user && msg.target_user_id === user.id;
                const isSender = user && msg.user_id === user.id;
                const isAdmin = profile && profile.is_admin;
                
                // å†³å®šæ˜¯å¦æ˜¾ç¤ºç§å¯†ç•™è¨€
                let shouldDisplay = true;
                if (isPrivate) {
                    shouldDisplay = isRecipient || isSender || isAdmin;
                }
                
                if (!shouldDisplay) return '';
                
                const isPrivateForRecipient = isPrivate && isRecipient;
                const isPrivateFromSender = isPrivate && isSender;
                
                return `
                    <div class="glass ${isPrivate ? 'private-message' : ''}" 
                         style="padding: 20px; background: ${msg.status === 'reported' ? 'rgba(255,59,48,0.08)' : 'var(--card-bg)'}; 
                         animation: slideIn 0.3s ease-out; animation-delay: ${index * 0.05}s; animation-fill-mode: both;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: ${isPrivate ? '#AF52DE' : 'var(--accent)'}; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-${isPrivate ? 'lock' : 'user-circle'}"></i>
                                ${msg.author_name}
                                ${isPrivateFromSender ? 'â†’ ' + (allUsers.find(u => u.id === msg.target_user_id)?.username || 'ç‰¹å®šç”¨æˆ¶') : ''}
                                ${isPrivateForRecipient ? 'ğŸ”’' : ''}
                            </div>
                            <div style="font-size: 12px; color: var(--text-sub);">
                                ${new Date(msg.created_at).toLocaleString('zh-HK', { 
                                    month: 'short', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                                ${msg.status === 'reported' ? ' âš ï¸' : ''}
                            </div>
                        </div>
                        <div style="color: var(--text); white-space: pre-wrap; line-height: 1.6; font-size: 15px;">
                            ${msg.content}
                            ${isPrivate ? '<div style="font-size: 12px; color: #AF52DE; margin-top: 8px;"><i class="fas fa-info-circle"></i> æ­¤ç•™è¨€åƒ…ç‰¹å®šç”¨æˆ¶å¯è¦‹</div>' : ''}
                        </div>
                        ${profile && profile.is_admin ? `
                            <div class="admin-actions" style="margin-top: 12px;">
                                <button class="small danger" onclick="deleteFeedback('${msg.id}')">
                                    <i class="fas fa-trash"></i> åˆªé™¤
                                </button>
                                ${msg.status === 'reported' ? 
                                    '<button class="small success" onclick="restoreFeedback(\'' + msg.id + '\')"><i class="fas fa-undo"></i> æ¢å¾©</button>' : 
                                    '<button class="small warning" onclick="reportFeedback(\'' + msg.id + '\')"><i class="fas fa-flag"></i> èˆ‰å ±</button>'
                                }
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            container.scrollTop = 0;
        }

        async function sendChat() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç™¼é€ç•™è¨€', 'warning');
                return;
            }
            
            const input = document.getElementById('chat-input');
            const content = input.value.trim();
            const visibility = document.querySelector('input[name="visibility"]:checked').value;
            const targetUsername = document.getElementById('target-user').value.trim();
            
            if (!content) {
                showNotification('è«‹è¼¸å…¥ç•™è¨€å…§å®¹', 'warning');
                return;
            }
            
            if (content.length > 300) {
                showNotification('ç•™è¨€å…§å®¹ä¸èƒ½è¶…é300å­—', 'warning');
                return;
            }
            
            try {
                const messageData = {
                    author_name: profile.username,
                    content: content,
                    status: 'normal',
                    user_id: user.id,
                    visibility: visibility
                };
                
                // å¦‚æœæ˜¯ç§å¯†ç•™è¨€ï¼Œéœ€è¦æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·ID
                if (visibility === 'private' && targetUsername) {
                    // æŸ¥æ‰¾ç›®æ ‡ç”¨æˆ·
                    const { data: targetUser, error: userError } = await sb
                        .from('profiles')
                        .select('id')
                        .eq('username', targetUsername)
                        .single();
                    
                    if (userError || !targetUser) {
                        showNotification('æ‰¾ä¸åˆ°æŒ‡å®šçš„ç”¨æˆ¶ï¼Œè«‹æª¢æŸ¥ç”¨æˆ¶åæ˜¯å¦æ­£ç¢º', 'error');
                        return;
                    }
                    
                    messageData.target_user_id = targetUser.id;
                }
                
                const { error } = await sb
                    .from('feedbacks')
                    .insert(messageData);
                
                if (error) {
                    console.error('å‘é€é”™è¯¯:', error);
                    showNotification('ç™¼é€å¤±æ•—: ' + error.message, 'error');
                    return;
                }
                
                input.value = '';
                document.getElementById('target-user').value = '';
                fetchChat();
                showNotification(visibility === 'private' ? 'ç§å¯†ç•™è¨€ç™¼é€æˆåŠŸï¼' : 'ç•™è¨€ç™¼é€æˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('ç™¼é€ç•™è¨€å¤±æ•—:', error);
                showNotification('ç™¼é€å¤±æ•—', 'error');
            }
        }

        // ================= æ¸¸æˆæ¨¡å— =================
        // 1. è¿è¿çœ‹æ¸¸æˆ
        async function startLinkGame() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç©éŠæˆ²', 'warning');
                return;
            }
            
            try {
                // ä»æ•°æ®åº“è·å–çŸ¥è¯†ç‚¹
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .limit(20);
                
                if (error || !data || data.length < 5) {
                    showNotification('çŸ¥è­˜é»ä¸è¶³ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²', 'warning');
                    return;
                }
                
                // éšè—æ¸¸æˆé€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºè¿è¿çœ‹ç•Œé¢
                document.getElementById('game-selector').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'none';
                document.getElementById('link-game-container').style.display = 'block';
                
                // åˆå§‹åŒ–æ¸¸æˆ
                initLinkGame(data);
            } catch (error) {
                console.error('é–‹å§‹é€£é€£çœ‹éŠæˆ²å¤±æ•—:', error);
                showNotification('éŠæˆ²åŠ è¼‰å¤±æ•—', 'error');
            }
        }

        function initLinkGame(knowledgeData) {
            linkGame.active = true;
            linkGame.score = 0;
            linkGame.timeLeft = 120;
            linkGame.selected = null;
            linkGame.board = [];
            linkGame.knowledgeCards = {};
            linkGame.exampleCards = [];
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('link-score').textContent = '0';
            document.getElementById('link-time').textContent = '120';
            
            // åˆ›å»ºæ¸¸æˆæ¿
            createLinkBoard(knowledgeData);
            
            // å¼€å§‹è®¡æ—¶
            linkGame.timer = setInterval(() => {
                linkGame.timeLeft--;
                document.getElementById('link-time').textContent = linkGame.timeLeft;
                
                if (linkGame.timeLeft <= 0) {
                    finishLinkGame();
                }
            }, 1000);
        }

        function createLinkBoard(knowledgeData) {
            const board = document.getElementById('link-game-board');
            board.innerHTML = '';
            
            // éšæœºé€‰æ‹©6ä¸ªçŸ¥è¯†ç‚¹
            const selectedKnowledge = knowledgeData.sort(() => Math.random() - 0.5).slice(0, 6);
            linkGame.pairs = selectedKnowledge.length;
            document.getElementById('link-remaining').textContent = linkGame.pairs;
            
            let cards = [];
            
            // ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹åˆ›å»ºå¡ç‰‡
            selectedKnowledge.forEach((knowledge, knowledgeIndex) => {
                // çŸ¥è¯†ç‚¹å¡ç‰‡
                const knowledgeCard = {
                    type: 'knowledge',
                    id: `knowledge-${knowledgeIndex}`,
                    knowledgeId: knowledge.id,
                    title: knowledge.title,
                    examples: knowledge.example ? knowledge.example.split('//').map(e => e.trim()).filter(e => e) : [],
                    matchedExamples: []
                };
                
                // åˆ›å»ºçŸ¥è¯†ç‚¹å¡ç‰‡å…ƒç´ 
                const knowledgeElement = document.createElement('div');
                knowledgeElement.className = 'link-card knowledge';
                knowledgeElement.dataset.id = knowledgeCard.id;
                knowledgeElement.dataset.type = 'knowledge';
                knowledgeElement.innerHTML = `
                    <div style="text-align: center; padding: 10px;">
                        <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">çŸ¥</div>
                        <div style="font-size: 12px; color: var(--text-sub);">${knowledge.title.substring(0, 15)}${knowledge.title.length > 15 ? '...' : ''}</div>
                    </div>
                `;
                knowledgeElement.onclick = () => selectLinkCard(knowledgeCard.id);
                
                cards.push({
                    element: knowledgeElement,
                    data: knowledgeCard
                });
                
                linkGame.knowledgeCards[knowledgeCard.id] = knowledgeCard;
                
                // ä¸ºæ¯ä¸ªä¾‹å­åˆ›å»ºå¡ç‰‡
                knowledgeCard.examples.forEach((example, exampleIndex) => {
                    const exampleCard = {
                        type: 'example',
                        id: `example-${knowledgeIndex}-${exampleIndex}`,
                        knowledgeId: knowledge.id,
                        knowledgeCardId: knowledgeCard.id,
                        content: example,
                        index: exampleIndex
                    };
                    
                    // åˆ›å»ºä¾‹å­å¡ç‰‡å…ƒç´ 
                    const exampleElement = document.createElement('div');
                    exampleElement.className = 'link-card example';
                    exampleElement.dataset.id = exampleCard.id;
                    exampleElement.dataset.type = 'example';
                    exampleElement.innerHTML = `
                        <div style="text-align: center; padding: 10px;">
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">ä¾‹</div>
                            <div style="font-size: 12px; color: var(--text-sub);">${example.substring(0, 15)}${example.length > 15 ? '...' : ''}</div>
                        </div>
                    `;
                    exampleElement.onclick = () => selectLinkCard(exampleCard.id);
                    
                    cards.push({
                        element: exampleElement,
                        data: exampleCard
                    });
                    
                    linkGame.exampleCards.push(exampleCard);
                });
            });
            
            // éšæœºæ’åˆ—å¡ç‰‡
            cards = cards.sort(() => Math.random() - 0.5);
            
            // æ·»åŠ å¡ç‰‡åˆ°æ¸¸æˆæ¿
            cards.forEach(card => {
                board.appendChild(card.element);
                linkGame.board.push(card);
            });
        }

        function selectLinkCard(cardId) {
            if (!linkGame.active) return;
            
            const card = linkGame.board.find(c => c.data.id === cardId);
            if (!card || card.element.classList.contains('removed')) return;
            
            // å¦‚æœå·²ç»é€‰ä¸­ï¼Œå–æ¶ˆé€‰æ‹©
            if (linkGame.selected === cardId) {
                card.element.classList.remove('selected');
                linkGame.selected = null;
                return;
            }
            
            // é€‰æ‹©æ–°å¡ç‰‡
            card.element.classList.add('selected');
            
            // å¦‚æœæ²¡æœ‰å·²é€‰ä¸­çš„å¡ç‰‡ï¼Œä¿å­˜å½“å‰é€‰æ‹©
            if (linkGame.selected === null) {
                linkGame.selected = cardId;
                return;
            }
            
            // è·å–ä¹‹å‰é€‰ä¸­çš„å¡ç‰‡
            const prevCard = linkGame.board.find(c => c.data.id === linkGame.selected);
            
            // ç§»é™¤é€‰æ‹©çŠ¶æ€
            card.element.classList.remove('selected');
            prevCard.element.classList.remove('selected');
            
            // æ£€æŸ¥æ˜¯å¦åŒ¹é…
            if (checkLinkMatch(prevCard.data, card.data)) {
                // åŒ¹é…æˆåŠŸ
                handleLinkMatch(prevCard, card);
            } else {
                // åŒ¹é…å¤±è´¥
                card.element.classList.add('shake');
                prevCard.element.classList.add('shake');
                
                setTimeout(() => {
                    card.element.classList.remove('shake');
                    prevCard.element.classList.remove('shake');
                }, 500);
                
                // æ‰£åˆ†
                linkGame.score = Math.max(0, linkGame.score - 5);
                document.getElementById('link-score').textContent = linkGame.score;
            }
            
            linkGame.selected = null;
        }

        function checkLinkMatch(card1, card2) {
            // ä¸€ä¸ªå¿…é¡»æ˜¯çŸ¥è¯†ç‚¹ï¼Œä¸€ä¸ªå¿…é¡»æ˜¯ä¾‹å­
            if ((card1.type === 'knowledge' && card2.type === 'example') ||
                (card1.type === 'example' && card2.type === 'knowledge')) {
                
                const knowledgeCard = card1.type === 'knowledge' ? card1 : card2;
                const exampleCard = card1.type === 'example' ? card1 : card2;
                
                // æ£€æŸ¥ä¾‹å­æ˜¯å¦å±äºè¯¥çŸ¥è¯†ç‚¹
                return knowledgeCard.knowledgeId === exampleCard.knowledgeId;
            }
            return false;
        }

        function handleLinkMatch(knowledgeCard, exampleCard) {
            // ç¡®å®šå“ªä¸ªæ˜¯çŸ¥è¯†ç‚¹å¡ç‰‡
            const isKnowledgeFirst = knowledgeCard.data.type === 'knowledge';
            const knowledgeCardData = isKnowledgeFirst ? knowledgeCard.data : exampleCard.data;
            const exampleCardData = isKnowledgeFirst ? exampleCard.data : knowledgeCard.data;
            const knowledgeCardElement = isKnowledgeFirst ? knowledgeCard.element : exampleCard.element;
            const exampleCardElement = isKnowledgeFirst ? exampleCard.element : knowledgeCard.element;
            
            // æ·»åŠ åˆ°çŸ¥è¯†ç‚¹çš„å·²åŒ¹é…ä¾‹å­åˆ—è¡¨
            const knowledgeData = linkGame.knowledgeCards[knowledgeCardData.id];
            if (knowledgeData && !knowledgeData.matchedExamples.includes(exampleCardData.id)) {
                knowledgeData.matchedExamples.push(exampleCardData.id);
                
                // æ ‡è®°ä¸ºå·²åŒ¹é…
                exampleCardElement.classList.add('matched');
                
                // å»¶è¿Ÿåç§»é™¤ä¾‹å­å¡ç‰‡
                setTimeout(() => {
                    exampleCardElement.classList.add('removed');
                }, 500);
                
                // åŠ åˆ†
                linkGame.score += 20;
                document.getElementById('link-score').textContent = linkGame.score;
                
                // åˆ›å»ºåˆ†æ•°å¼¹å‡ºæ•ˆæœ
                createScorePopup(exampleCardElement, '+20');
                
                // æ£€æŸ¥çŸ¥è¯†ç‚¹çš„æ‰€æœ‰ä¾‹å­æ˜¯å¦éƒ½å·²åŒ¹é…
                if (knowledgeData.matchedExamples.length === knowledgeData.examples.length) {
                    // çŸ¥è¯†ç‚¹æ¶ˆå¤±
                    setTimeout(() => {
                        knowledgeCardElement.classList.add('removed');
                        linkGame.pairs--;
                        document.getElementById('link-remaining').textContent = linkGame.pairs;
                        
                        // é¢å¤–åŠ åˆ†
                        linkGame.score += 50;
                        document.getElementById('link-score').textContent = linkGame.score;
                        createScorePopup(knowledgeCardElement, '+50');
                        
                        // æ£€æŸ¥æ¸¸æˆæ˜¯å¦å®Œæˆ
                        if (linkGame.pairs === 0) {
                            finishLinkGame(true);
                        }
                    }, 500);
                }
            }
        }

        function createScorePopup(element, text) {
            const rect = element.getBoundingClientRect();
            const popup = document.createElement('div');
            popup.className = 'score-popup';
            popup.textContent = text;
            popup.style.left = (rect.left + rect.width / 2) + 'px';
            popup.style.top = (rect.top + rect.height / 2) + 'px';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        function showLinkHint() {
            if (!linkGame.active) return;
            
            // æ‰¾åˆ°ä¸€ä¸ªæœªåŒ¹é…çš„ä¾‹å­å’Œå¯¹åº”çš„çŸ¥è¯†ç‚¹
            for (const exampleCard of linkGame.exampleCards) {
                const exampleElement = linkGame.board.find(c => c.data.id === exampleCard.id).element;
                if (exampleElement.classList.contains('removed')) continue;
                
                const knowledgeCard = linkGame.knowledgeCards[exampleCard.knowledgeCardId];
                const knowledgeElement = linkGame.board.find(c => c.data.id === knowledgeCard.id).element;
                
                // æ˜¾ç¤ºæç¤º
                exampleElement.style.boxShadow = '0 0 20px gold';
                knowledgeElement.style.boxShadow = '0 0 20px gold';
                
                setTimeout(() => {
                    exampleElement.style.boxShadow = '';
                    knowledgeElement.style.boxShadow = '';
                }, 1000);
                
                break;
            }
            
            // æ‰£åˆ†
            linkGame.score = Math.max(0, linkGame.score - 10);
            document.getElementById('link-score').textContent = linkGame.score;
        }

        function resetLinkGame() {
            clearInterval(linkGame.timer);
            showNotification('éŠæˆ²å·²é‡ç½®', 'info');
            startLinkGame();
        }

        function finishLinkGame(win = false) {
            clearInterval(linkGame.timer);
            linkGame.active = false;
            
            let message = 'éŠæˆ²çµæŸï¼\n';
            message += `æœ€çµ‚åˆ†æ•¸: ${linkGame.score}\n`;
            
            if (win) {
                message += 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é…å°ï¼\n';
                // æ™‚é–“çå‹µ
                const timeBonus = Math.floor(linkGame.timeLeft * 1.5);
                linkGame.score += timeBonus;
                message += `æ™‚é–“çå‹µ: +${timeBonus}\n`;
                message += `ç¸½åˆ†æ•¸: ${linkGame.score}`;
                
                // æ›´æ–°éŠæˆ²è¨˜éŒ„
                updateGameRecord('link', linkGame.score);
                
                // æ›´æ–°ç”¨æˆ¶ç©åˆ†
                if (profile) {
                    updateUserScore(Math.floor(linkGame.score / 20));
                }
            } else {
                if (linkGame.timeLeft <= 0) {
                    message += 'â° æ™‚é–“åˆ°äº†ï¼';
                } else {
                    message += 'ä½ æå‰çµæŸäº†éŠæˆ²ã€‚';
                }
                
                // ä»ç„¶ä¿å­˜åˆ†æ•¸
                if (linkGame.score > 0) {
                    updateGameRecord('link', linkGame.score);
                }
            }
            
            showNotification(message, win ? 'success' : 'info', 5000);
            
            // è¿”å›éŠæˆ²é¸æ“‡ç•Œé¢
            setTimeout(() => {
                document.getElementById('link-game-container').style.display = 'none';
                document.getElementById('game-selector').style.display = 'grid';
            }, 3000);
        }

        // 2. è¨˜æ†¶éŠæˆ²
        async function startMemoryGame() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç©éŠæˆ²', 'warning');
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .limit(16);
                
                if (error || !data || data.length < 8) {
                    showNotification('çŸ¥è­˜é»ä¸è¶³ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²', 'warning');
                    return;
                }
                
                // éš±è—éŠæˆ²é¸æ“‡å™¨ï¼Œé¡¯ç¤ºè¨˜æ†¶éŠæˆ²ç•Œé¢
                document.getElementById('game-selector').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'none';
                document.getElementById('memory-game-container').style.display = 'block';
                
                // åˆå§‹åŒ–éŠæˆ²
                initMemoryGame(data);
            } catch (error) {
                console.error('é–‹å§‹è¨˜æ†¶éŠæˆ²å¤±æ•—:', error);
                showNotification('éŠæˆ²åŠ è¼‰å¤±æ•—', 'error');
            }
        }

        function initMemoryGame(knowledgeData) {
            memoryGame.active = true;
            memoryGame.score = 0;
            memoryGame.timeLeft = 90;
            memoryGame.flippedCards = [];
            memoryGame.matchedPairs = 0;
            memoryGame.totalPairs = Math.min(8, knowledgeData.length);
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('memory-score').textContent = '0';
            document.getElementById('memory-time').textContent = '90';
            document.getElementById('memory-matched').textContent = `0/${memoryGame.totalPairs}`;
            
            // å‰µå»ºéŠæˆ²æ¿
            createMemoryBoard(knowledgeData);
            
            // é–‹å§‹è¨ˆæ™‚
            memoryGame.timer = setInterval(() => {
                memoryGame.timeLeft--;
                document.getElementById('memory-time').textContent = memoryGame.timeLeft;
                
                if (memoryGame.timeLeft <= 0) {
                    finishMemoryGame();
                }
            }, 1000);
        }

        function createMemoryBoard(knowledgeData) {
            const board = document.getElementById('memory-game-board');
            board.innerHTML = '';
            
            // é¸æ“‡çŸ¥è­˜é»ä¸¦è¤‡è£½é…å°
            const selectedKnowledge = knowledgeData.sort(() => Math.random() - 0.5).slice(0, memoryGame.totalPairs);
            let cards = [];
            
            selectedKnowledge.forEach((knowledge, index) => {
                // å‰µå»ºä¸€å°ç›¸åŒçš„å¡ç‰‡
                for (let i = 0; i < 2; i++) {
                    const card = {
                        id: `memory-${index}-${i}`,
                        pairId: index,
                        content: knowledge.title.substring(0, 20),
                        symbol: knowledge.category ? knowledge.category.substring(0, 1).toUpperCase() : 'çŸ¥'
                    };
                    
                    const cardElement = document.createElement('div');
                    cardElement.className = 'memory-card';
                    cardElement.dataset.id = card.id;
                    cardElement.dataset.pairId = card.pairId;
                    
                    cardElement.innerHTML = `
                        <div class="front">
                            <div style="text-align: center; padding: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">${card.symbol}</div>
                                <div style="font-size: 12px;">${card.content}${knowledge.title.length > 20 ? '...' : ''}</div>
                            </div>
                        </div>
                        <div class="back">
                            <i class="fas fa-question"></i>
                        </div>
                    `;
                    
                    cardElement.onclick = () => flipMemoryCard(cardElement);
                    board.appendChild(cardElement);
                    
                    cards.push({
                        element: cardElement,
                        data: card
                    });
                }
            });
            
            // éš¨æ©Ÿæ’åˆ—å¡ç‰‡
            cards = cards.sort(() => Math.random() - 0.5);
            
            // é‡æ–°æ·»åŠ å¡ç‰‡åˆ°éŠæˆ²æ¿
            board.innerHTML = '';
            cards.forEach(card => {
                board.appendChild(card.element);
            });
            
            memoryGame.cards = cards;
        }

        function flipMemoryCard(cardElement) {
            if (!memoryGame.active) return;
            if (cardElement.classList.contains('flipped') || cardElement.classList.contains('matched')) return;
            if (memoryGame.flippedCards.length >= 2) return;
            
            // ç¿»è½‰å¡ç‰‡
            cardElement.classList.add('flipped');
            memoryGame.flippedCards.push(cardElement);
            
            // å¦‚æœç¿»è½‰äº†å…©å¼µå¡ç‰‡ï¼Œæª¢æŸ¥æ˜¯å¦åŒ¹é…
            if (memoryGame.flippedCards.length === 2) {
                const card1 = memoryGame.flippedCards[0];
                const card2 = memoryGame.flippedCards[1];
                
                if (card1.dataset.pairId === card2.dataset.pairId) {
                    // åŒ¹é…æˆåŠŸ
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        memoryGame.flippedCards = [];
                        
                        memoryGame.matchedPairs++;
                        memoryGame.score += 25;
                        
                        document.getElementById('memory-score').textContent = memoryGame.score;
                        document.getElementById('memory-matched').textContent = `${memoryGame.matchedPairs}/${memoryGame.totalPairs}`;
                        
                        createScorePopup(card1, '+25');
                        
                        // æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
                        if (memoryGame.matchedPairs === memoryGame.totalPairs) {
                            finishMemoryGame(true);
                        }
                    }, 500);
                } else {
                    // åŒ¹é…å¤±æ•—
                    setTimeout(() => {
                        card1.classList.remove('flipped');
                        card2.classList.remove('flipped');
                        memoryGame.flippedCards = [];
                        
                        // è¼•å¾®æ‰£åˆ†
                        memoryGame.score = Math.max(0, memoryGame.score - 5);
                        document.getElementById('memory-score').textContent = memoryGame.score;
                    }, 1000);
                }
            }
        }

        function resetMemoryGame() {
            clearInterval(memoryGame.timer);
            showNotification('éŠæˆ²å·²é‡ç½®', 'info');
            startMemoryGame();
        }

        function finishMemoryGame(win = false) {
            clearInterval(memoryGame.timer);
            memoryGame.active = false;
            
            let message = 'éŠæˆ²çµæŸï¼\n';
            message += `æœ€çµ‚åˆ†æ•¸: ${memoryGame.score}\n`;
            message += `å®Œæˆé…å°: ${memoryGame.matchedPairs}/${memoryGame.totalPairs}\n`;
            
            if (win) {
                message += 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é…å°ï¼\n';
                // æ™‚é–“çå‹µ
                const timeBonus = Math.floor(memoryGame.timeLeft * 2);
                memoryGame.score += timeBonus;
                message += `æ™‚é–“çå‹µ: +${timeBonus}\n`;
                message += `ç¸½åˆ†æ•¸: ${memoryGame.score}`;
                
                // æ›´æ–°éŠæˆ²è¨˜éŒ„
                updateGameRecord('memory', memoryGame.score);
                
                // æ›´æ–°ç”¨æˆ¶ç©åˆ†
                if (profile) {
                    updateUserScore(Math.floor(memoryGame.score / 25));
                }
            } else {
                if (memoryGame.timeLeft <= 0) {
                    message += 'â° æ™‚é–“åˆ°äº†ï¼';
                } else {
                    message += 'ä½ æå‰çµæŸäº†éŠæˆ²ã€‚';
                }
                
                // ä»ç„¶ä¿å­˜åˆ†æ•¸
                if (memoryGame.score > 0) {
                    updateGameRecord('memory', memoryGame.score);
                }
            }
            
            showNotification(message, win ? 'success' : 'info', 5000);
            
            // è¿”å›éŠæˆ²é¸æ“‡ç•Œé¢
            setTimeout(() => {
                document.getElementById('memory-game-container').style.display = 'none';
                document.getElementById('game-selector').style.display = 'grid';
            }, 3000);
        }

        // 3. é…å°éŠæˆ²
        async function startMatchGame() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç©éŠæˆ²', 'warning');
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .limit(10);
                
                if (error || !data || data.length < 5) {
                    showNotification('çŸ¥è­˜é»ä¸è¶³ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²', 'warning');
                    return;
                }
                
                // éš±è—éŠæˆ²é¸æ“‡å™¨ï¼Œé¡¯ç¤ºé…å°éŠæˆ²ç•Œé¢
                document.getElementById('game-selector').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'none';
                document.getElementById('match-game-container').style.display = 'block';
                
                // åˆå§‹åŒ–éŠæˆ²
                initMatchGame(data);
            } catch (error) {
                console.error('é–‹å§‹é…å°éŠæˆ²å¤±æ•—:', error);
                showNotification('éŠæˆ²åŠ è¼‰å¤±æ•—', 'error');
            }
        }

        function initMatchGame(knowledgeData) {
            matchGame.active = true;
            matchGame.score = 0;
            matchGame.timeLeft = 60;
            matchGame.matches = [];
            matchGame.leftItems = [];
            matchGame.rightItems = [];
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('match-score').textContent = '0';
            document.getElementById('match-time').textContent = '60';
            document.getElementById('match-progress').textContent = '0%';
            
            // å‰µå»ºéŠæˆ²æ¿
            createMatchBoard(knowledgeData);
            
            // é–‹å§‹è¨ˆæ™‚
            matchGame.timer = setInterval(() => {
                matchGame.timeLeft--;
                document.getElementById('match-time').textContent = matchGame.timeLeft;
                
                if (matchGame.timeLeft <= 0) {
                    finishMatchGame();
                }
            }, 1000);
        }

        function createMatchBoard(knowledgeData) {
            const gameArea = document.getElementById('match-game-area');
            gameArea.innerHTML = '';
            
            // å‰µå»ºå·¦å³å…©åˆ—
            const leftColumn = document.createElement('div');
            leftColumn.className = 'match-column';
            leftColumn.id = 'match-left-column';
            
            const rightColumn = document.createElement('div');
            rightColumn.className = 'match-column';
            rightColumn.id = 'match-right-column';
            
            gameArea.appendChild(leftColumn);
            gameArea.appendChild(rightColumn);
            
            // ç‚ºæ¯å€‹çŸ¥è­˜é»å‰µå»ºé…å°é …
            knowledgeData.forEach((knowledge, index) => {
                // å·¦å´ï¼šçŸ¥è­˜é»æ¨™é¡Œ
                const leftItem = {
                    id: `left-${index}`,
                    knowledgeId: knowledge.id,
                    content: knowledge.title,
                    type: 'title'
                };
                
                const leftElement = document.createElement('div');
                leftElement.className = 'match-item';
                leftElement.dataset.id = leftItem.id;
                leftElement.textContent = knowledge.title;
                leftElement.draggable = true;
                
                leftElement.addEventListener('dragstart', (e) => {
                    matchGame.draggingItem = leftItem;
                    leftElement.classList.add('dragging');
                });
                
                leftElement.addEventListener('dragend', () => {
                    leftElement.classList.remove('dragging');
                });
                
                leftColumn.appendChild(leftElement);
                matchGame.leftItems.push(leftItem);
                
                // å³å´ï¼šçŸ¥è­˜é»æè¿°æˆ–ä¾‹å­ï¼ˆç°¡çŸ­ç‰ˆæœ¬ï¼‰
                const examples = knowledge.example ? knowledge.example.split('//') : [];
                const rightContent = examples.length > 0 ? examples[0] : knowledge.content.substring(0, 100);
                
                const rightItem = {
                    id: `right-${index}`,
                    knowledgeId: knowledge.id,
                    content: rightContent,
                    type: 'description'
                };
                
                const rightElement = document.createElement('div');
                rightElement.className = 'match-item';
                rightElement.dataset.id = rightItem.id;
                rightElement.textContent = rightContent;
                
                rightElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                
                rightElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (matchGame.draggingItem && matchGame.draggingItem.knowledgeId === rightItem.knowledgeId) {
                        // åŒ¹é…æˆåŠŸ
                        handleMatchSuccess(leftItem.id, rightItem.id);
                    }
                });
                
                rightColumn.appendChild(rightElement);
                matchGame.rightItems.push(rightItem);
            });
            
            // éš¨æ©Ÿæ’åˆ—å³å´é …ç›®
            const rightElements = Array.from(rightColumn.children);
            rightElements.sort(() => Math.random() - 0.5);
            rightElements.forEach(element => rightColumn.appendChild(element));
        }

        function handleMatchSuccess(leftId, rightId) {
            const leftElement = document.querySelector(`[data-id="${leftId}"]`);
            const rightElement = document.querySelector(`[data-id="${rightId}"]`);
            
            if (!leftElement || !rightElement) return;
            
            // æ¨™è¨˜ç‚ºå·²åŒ¹é…
            leftElement.classList.add('matched');
            rightElement.classList.add('matched');
            
            // æ·»åŠ åˆ°åŒ¹é…åˆ—è¡¨
            matchGame.matches.push({ leftId, rightId });
            
            // è¨ˆç®—åˆ†æ•¸
            matchGame.score += 30;
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('match-score').textContent = matchGame.score;
            
            const progress = Math.floor((matchGame.matches.length / matchGame.leftItems.length) * 100);
            document.getElementById('match-progress').textContent = `${progress}%`;
            
            createScorePopup(rightElement, '+30');
            
            // æª¢æŸ¥éŠæˆ²æ˜¯å¦å®Œæˆ
            if (matchGame.matches.length === matchGame.leftItems.length) {
                finishMatchGame(true);
            }
        }

        function resetMatchGame() {
            clearInterval(matchGame.timer);
            showNotification('éŠæˆ²å·²é‡ç½®', 'info');
            startMatchGame();
        }

        function finishMatchGame(win = false) {
            clearInterval(matchGame.timer);
            matchGame.active = false;
            
            let message = 'éŠæˆ²çµæŸï¼\n';
            message += `æœ€çµ‚åˆ†æ•¸: ${matchGame.score}\n`;
            message += `å®Œæˆé…å°: ${matchGame.matches.length}/${matchGame.leftItems.length}\n`;
            
            if (win) {
                message += 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é…å°ï¼\n';
                // æ™‚é–“çå‹µ
                const timeBonus = Math.floor(matchGame.timeLeft * 3);
                matchGame.score += timeBonus;
                message += `æ™‚é–“çå‹µ: +${timeBonus}\n`;
                message += `ç¸½åˆ†æ•¸: ${matchGame.score}`;
                
                // æ›´æ–°éŠæˆ²è¨˜éŒ„
                updateGameRecord('match', matchGame.score);
                
                // æ›´æ–°ç”¨æˆ¶ç©åˆ†
                if (profile) {
                    updateUserScore(Math.floor(matchGame.score / 30));
                }
            } else {
                if (matchGame.timeLeft <= 0) {
                    message += 'â° æ™‚é–“åˆ°äº†ï¼';
                } else {
                    message += 'ä½ æå‰çµæŸäº†éŠæˆ²ã€‚';
                }
                
                // ä»ç„¶ä¿å­˜åˆ†æ•¸
                if (matchGame.score > 0) {
                    updateGameRecord('match', matchGame.score);
                }
            }
            
            showNotification(message, win ? 'success' : 'info', 5000);
            
            // è¿”å›éŠæˆ²é¸æ“‡ç•Œé¢
            setTimeout(() => {
                document.getElementById('match-game-container').style.display = 'none';
                document.getElementById('game-selector').style.display = 'grid';
            }, 3000);
        }

        // 4. æ‰“å­—éŠæˆ²
        async function startTypingGame() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç©éŠæˆ²', 'warning');
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('title, content')
                    .limit(20);
                
                if (error || !data || data.length < 10) {
                    showNotification('çŸ¥è­˜é»ä¸è¶³ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²', 'warning');
                    return;
                }
                
                // éš±è—éŠæˆ²é¸æ“‡å™¨ï¼Œé¡¯ç¤ºæ‰“å­—éŠæˆ²ç•Œé¢
                document.getElementById('game-selector').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'none';
                document.getElementById('typing-game-container').style.display = 'block';
                
                // åˆå§‹åŒ–éŠæˆ²
                initTypingGame(data);
            } catch (error) {
                console.error('é–‹å§‹æ‰“å­—éŠæˆ²å¤±æ•—:', error);
                showNotification('éŠæˆ²åŠ è¼‰å¤±æ•—', 'error');
            }
        }

        function initTypingGame(knowledgeData) {
            typingGame.active = true;
            typingGame.score = 0;
            typingGame.timeLeft = 45;
            typingGame.accuracy = 100;
            typingGame.totalChars = 0;
            typingGame.correctChars = 0;
            typingGame.texts = knowledgeData.map(k => k.title + ' ' + k.content.substring(0, 100));
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('typing-score').textContent = '0';
            document.getElementById('typing-time').textContent = '45';
            document.getElementById('typing-accuracy').textContent = '100%';
            
            // å‰µå»ºéŠæˆ²å€åŸŸ
            createTypingArea();
            
            // é–‹å§‹è¨ˆæ™‚
            typingGame.timer = setInterval(() => {
                typingGame.timeLeft--;
                document.getElementById('typing-time').textContent = typingGame.timeLeft;
                
                if (typingGame.timeLeft <= 0) {
                    finishTypingGame();
                }
            }, 1000);
        }

        function createTypingArea() {
            const gameArea = document.getElementById('typing-game-area');
            gameArea.innerHTML = '';
            
            // é¸æ“‡ä¸€å€‹éš¨æ©Ÿæ–‡æœ¬
            const randomIndex = Math.floor(Math.random() * typingGame.texts.length);
            typingGame.currentText = typingGame.texts[randomIndex];
            typingGame.typedText = '';
            
            // å‰µå»ºé¡¯ç¤ºå€åŸŸ
            const textDisplay = document.createElement('div');
            textDisplay.id = 'typing-text';
            textDisplay.classList.add('active');
            
            // å‰µå»ºè¼¸å…¥æ¡†
            const input = document.createElement('input');
            input.id = 'typing-input';
            input.type = 'text';
            input.autocomplete = 'off';
            input.autocapitalize = 'off';
            input.spellcheck = false;
            
            // å‰µå»ºçµ±è¨ˆä¿¡æ¯
            const stats = document.createElement('div');
            stats.className = 'typing-stats';
            
            gameArea.appendChild(textDisplay);
            gameArea.appendChild(input);
            gameArea.appendChild(stats);
            
            // åˆå§‹åŒ–æ–‡æœ¬é¡¯ç¤º
            updateTypingDisplay();
            
            // è¨­ç½®è¼¸å…¥äº‹ä»¶
            input.focus();
            input.addEventListener('input', handleTypingInput);
        }

        function updateTypingDisplay() {
            const textDisplay = document.getElementById('typing-text');
            if (!textDisplay) return;
            
            let displayHTML = '';
            const currentText = typingGame.currentText;
            const typedText = typingGame.typedText;
            
            for (let i = 0; i < currentText.length; i++) {
                if (i < typedText.length) {
                    if (typedText[i] === currentText[i]) {
                        displayHTML += `<span style="color: #34C759;">${currentText[i]}</span>`;
                        typingGame.correctChars++;
                    } else {
                        displayHTML += `<span style="color: #FF3B30;">${currentText[i]}</span>`;
                    }
                    typingGame.totalChars++;
                } else if (i === typedText.length) {
                    displayHTML += `<span style="background: rgba(var(--accent-rgb), 0.3); color: var(--text);">${currentText[i]}</span>`;
                } else {
                    displayHTML += `<span style="color: var(--text-sub);">${currentText[i]}</span>`;
                }
            }
            
            textDisplay.innerHTML = displayHTML;
            
            // æ›´æ–°æº–ç¢ºç‡
            if (typingGame.totalChars > 0) {
                typingGame.accuracy = Math.floor((typingGame.correctChars / typingGame.totalChars) * 100);
                document.getElementById('typing-accuracy').textContent = typingGame.accuracy + '%';
            }
        }

        function handleTypingInput(e) {
            const typedText = e.target.value;
            typingGame.typedText = typedText;
            
            updateTypingDisplay();
            
            // å¦‚æœå®Œæˆç•¶å‰æ–‡æœ¬
            if (typedText === typingGame.currentText) {
                // è¨ˆç®—åˆ†æ•¸
                const textLength = typingGame.currentText.length;
                const timeBonus = Math.floor(typingGame.timeLeft * 0.5);
                const accuracyBonus = Math.floor(typingGame.accuracy * 0.5);
                const score = textLength + timeBonus + accuracyBonus;
                
                typingGame.score += score;
                document.getElementById('typing-score').textContent = typingGame.score;
                
                createScorePopup(e.target, `+${score}`);
                
                // é¸æ“‡æ–°æ–‡æœ¬
                setTimeout(() => {
                    if (typingGame.active) {
                        e.target.value = '';
                        const randomIndex = Math.floor(Math.random() * typingGame.texts.length);
                        typingGame.currentText = typingGame.texts[randomIndex];
                        typingGame.typedText = '';
                        updateTypingDisplay();
                    }
                }, 500);
            }
        }

        function resetTypingGame() {
            clearInterval(typingGame.timer);
            showNotification('éŠæˆ²å·²é‡ç½®', 'info');
            startTypingGame();
        }

        function finishTypingGame(win = false) {
            clearInterval(typingGame.timer);
            typingGame.active = false;
            
            let message = 'éŠæˆ²çµæŸï¼\n';
            message += `æœ€çµ‚åˆ†æ•¸: ${typingGame.score}\n`;
            message += `æº–ç¢ºç‡: ${typingGame.accuracy}%\n`;
            
            if (win) {
                message += 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰“å­—æŒ‘æˆ°ï¼\n';
            } else {
                if (typingGame.timeLeft <= 0) {
                    message += 'â° æ™‚é–“åˆ°äº†ï¼';
                } else {
                    message += 'ä½ æå‰çµæŸäº†éŠæˆ²ã€‚';
                }
            }
            
            // æ›´æ–°éŠæˆ²è¨˜éŒ„
            if (typingGame.score > 0) {
                updateGameRecord('typing', typingGame.score);
            }
            
            // æ›´æ–°ç”¨æˆ¶ç©åˆ†
            if (profile && typingGame.score > 0) {
                updateUserScore(Math.floor(typingGame.score / 100));
            }
            
            showNotification(message, win ? 'success' : 'info', 5000);
            
            // è¿”å›éŠæˆ²é¸æ“‡ç•Œé¢
            setTimeout(() => {
                document.getElementById('typing-game-container').style.display = 'none';
                document.getElementById('game-selector').style.display = 'grid';
            }, 3000);
        }

        // 5. å•ç­”éŠæˆ²
        async function startQuizGame() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½ç©éŠæˆ²', 'warning');
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .limit(20);
                
                if (error || !data || data.length < 5) {
                    showNotification('çŸ¥è­˜é»ä¸è¶³ï¼Œç„¡æ³•é–‹å§‹éŠæˆ²', 'warning');
                    return;
                }
                
                // éš±è—éŠæˆ²é¸æ“‡å™¨ï¼Œé¡¯ç¤ºå•ç­”éŠæˆ²ç•Œé¢
                document.getElementById('game-selector').style.display = 'none';
                document.getElementById('leaderboard-container').style.display = 'none';
                document.getElementById('quiz-game-container').style.display = 'block';
                
                // åˆå§‹åŒ–éŠæˆ²
                initQuizGame(data);
            } catch (error) {
                console.error('é–‹å§‹å•ç­”éŠæˆ²å¤±æ•—:', error);
                showNotification('éŠæˆ²åŠ è¼‰å¤±æ•—', 'error');
            }
        }

        function initQuizGame(knowledgeData) {
            quizGame.active = true;
            quizGame.score = 0;
            quizGame.timeLeft = 30;
            quizGame.currentQuestion = 0;
            quizGame.totalQuestions = Math.min(10, knowledgeData.length);
            quizGame.questions = knowledgeData.sort(() => Math.random() - 0.5).slice(0, quizGame.totalQuestions);
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('quiz-score').textContent = '0';
            document.getElementById('quiz-time').textContent = '30';
            document.getElementById('quiz-count').textContent = `0/${quizGame.totalQuestions}`;
            
            // é¡¯ç¤ºç¬¬ä¸€é¡Œ
            showQuizQuestion();
            
            // é–‹å§‹è¨ˆæ™‚
            quizGame.timer = setInterval(() => {
                quizGame.timeLeft--;
                document.getElementById('quiz-time').textContent = quizGame.timeLeft;
                
                if (quizGame.timeLeft <= 0) {
                    finishQuizGame();
                }
            }, 1000);
        }

        function showQuizQuestion() {
            if (!quizGame.active || quizGame.currentQuestion >= quizGame.questions.length) {
                finishQuizGame(true);
                return;
            }
            
            const question = quizGame.questions[quizGame.currentQuestion];
            const gameArea = document.getElementById('quiz-game-area');
            
            gameArea.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 18px; color: var(--text-sub); margin-bottom: 10px;">
                        ç¬¬ ${quizGame.currentQuestion + 1} é¡Œ / ${quizGame.totalQuestions}
                    </div>
                    <h3 style="color: var(--text); margin-bottom: 30px; line-height: 1.6;">
                        ${question.title}
                    </h3>
                    <div id="quiz-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- é¸é …ç”±JSç”Ÿæˆ -->
                    </div>
                </div>
            `;
            
            // ç”Ÿæˆé¸é …
            const optionsContainer = document.getElementById('quiz-options');
            
            if (question.example) {
                const parts = question.example.split('//').map(p => p.trim()).filter(p => p);
                const correctAnswer = parts[0];
                const wrongAnswers = parts.slice(1);
                
                // åˆä½µæ‰€æœ‰é¸é …ä¸¦éš¨æ©Ÿæ’åº
                let allOptions = [correctAnswer];
                for (let i = 0; i < Math.min(3, wrongAnswers.length); i++) {
                    allOptions.push(wrongAnswers[i]);
                }
                
                // å¦‚æœé¸é …ä¸å¤ ï¼Œè£œå……ä¸€äº›
                while (allOptions.length < 4) {
                    allOptions.push('é¸é … ' + (allOptions.length + 1));
                }
                
                allOptions = allOptions.sort(() => Math.random() - 0.5);
                
                // å‰µå»ºé¸é …æŒ‰éˆ•
                allOptions.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'ghost';
                    button.style.padding = '18px';
                    button.textContent = option;
                    button.onclick = () => checkQuizAnswer(option, correctAnswer);
                    optionsContainer.appendChild(button);
                });
            } else {
                // å¦‚æœæ²’æœ‰ä¾‹å­ï¼Œä½¿ç”¨ç°¡å–®çš„é¸é …
                ['A', 'B', 'C', 'D'].forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'ghost';
                    button.style.padding = '18px';
                    button.textContent = `é¸é … ${option}`;
                    button.onclick = () => checkQuizAnswer(option, 'A'); // é»˜èªAç‚ºæ­£ç¢ºç­”æ¡ˆ
                    optionsContainer.appendChild(button);
                });
            }
            
            // æ›´æ–°é¡Œç›®è¨ˆæ•¸
            document.getElementById('quiz-count').textContent = `${quizGame.currentQuestion + 1}/${quizGame.totalQuestions}`;
        }

        function checkQuizAnswer(selected, correct) {
            if (!quizGame.active) return;
            
            const isCorrect = selected === correct;
            
            if (isCorrect) {
                quizGame.score += 10;
                document.getElementById('quiz-score').textContent = quizGame.score;
                createScorePopup(document.getElementById('quiz-options'), '+10');
                showNotification('âœ“ ç­”å°äº†ï¼', 'success', 1000);
            } else {
                showNotification(`âœ— ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${correct}`, 'error', 2000);
            }
            
            quizGame.currentQuestion++;
            setTimeout(() => {
                showQuizQuestion();
            }, 2000);
        }

        function resetQuizGame() {
            clearInterval(quizGame.timer);
            showNotification('éŠæˆ²å·²é‡ç½®', 'info');
            startQuizGame();
        }

        function finishQuizGame(win = false) {
            clearInterval(quizGame.timer);
            quizGame.active = false;
            
            let message = 'éŠæˆ²çµæŸï¼\n';
            message += `æœ€çµ‚åˆ†æ•¸: ${quizGame.score}\n`;
            message += `ç­”å°é¡Œæ•¸: ${Math.floor(quizGame.score / 10)}/${quizGame.totalQuestions}\n`;
            
            if (win && quizGame.currentQuestion >= quizGame.totalQuestions) {
                message += 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é¡Œç›®ï¼\n';
                // æ™‚é–“çå‹µ
                const timeBonus = Math.floor(quizGame.timeLeft * 1);
                quizGame.score += timeBonus;
                message += `æ™‚é–“çå‹µ: +${timeBonus}\n`;
                message += `ç¸½åˆ†æ•¸: ${quizGame.score}`;
                
                // æ›´æ–°éŠæˆ²è¨˜éŒ„
                updateGameRecord('quiz', quizGame.score);
                
                // æ›´æ–°ç”¨æˆ¶ç©åˆ†
                if (profile) {
                    updateUserScore(Math.floor(quizGame.score / 20));
                }
            } else {
                if (quizGame.timeLeft <= 0) {
                    message += 'â° æ™‚é–“åˆ°äº†ï¼';
                } else {
                    message += 'ä½ æå‰çµæŸäº†éŠæˆ²ã€‚';
                }
                
                // ä»ç„¶ä¿å­˜åˆ†æ•¸
                if (quizGame.score > 0) {
                    updateGameRecord('quiz', quizGame.score);
                }
            }
            
            showNotification(message, win ? 'success' : 'info', 5000);
            
            // è¿”å›éŠæˆ²é¸æ“‡ç•Œé¢
            setTimeout(() => {
                document.getElementById('quiz-game-container').style.display = 'none';
                document.getElementById('game-selector').style.display = 'grid';
            }, 3000);
        }

        // æ¸¸æˆè®°å½•ç®¡ç†
        function loadGameRecords() {
            const records = localStorage.getItem('dsehub-game-records');
            if (records) {
                try {
                    gameRecords = JSON.parse(records);
                } catch (error) {
                    console.error('è§£æéŠæˆ²è¨˜éŒ„å¤±æ•—:', error);
                }
            }
        }

        function saveGameRecords() {
            try {
                localStorage.setItem('dsehub-game-records', JSON.stringify(gameRecords));
            } catch (error) {
                console.error('ä¿å­˜éŠæˆ²è¨˜éŒ„å¤±æ•—:', error);
            }
        }

        function updateGameRecord(gameType, score) {
            if (!gameRecords[gameType]) {
                gameRecords[gameType] = { highScore: 0, gamesPlayed: 0 };
            }
            
            gameRecords[gameType].gamesPlayed++;
            if (score > gameRecords[gameType].highScore) {
                gameRecords[gameType].highScore = score;
            }
            
            saveGameRecords();
        }

        // æ’è¡Œæ¦œ
        function showLeaderboard() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½æŸ¥çœ‹æ’è¡Œæ¦œ', 'warning');
                return;
            }
            
            document.getElementById('game-selector').style.display = 'none';
            document.getElementById('leaderboard-container').style.display = 'block';
            document.getElementById('link-game-container').style.display = 'none';
            document.getElementById('memory-game-container').style.display = 'none';
            document.getElementById('match-game-container').style.display = 'none';
            document.getElementById('typing-game-container').style.display = 'none';
            document.getElementById('quiz-game-container').style.display = 'none';
            
            showGameLeaderboard('all');
        }

        function showGameLeaderboard(gameType) {
            const leaderboardList = document.getElementById('leaderboard-list');
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('#leaderboard-container .ghost').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target.classList.add('active');
            
            if (gameType === 'all') {
                // é¡¯ç¤ºç¸½æ’è¡Œæ¦œï¼ˆåŸºæ–¼æœ¬åœ°è¨˜éŒ„ï¼‰
                const allRecords = Object.entries(gameRecords)
                    .map(([type, record]) => ({
                        game: type,
                        highScore: record.highScore,
                        gamesPlayed: record.gamesPlayed
                    }))
                    .filter(record => record.gamesPlayed > 0)
                    .sort((a, b) => b.highScore - a.highScore);
                
                if (allRecords.length === 0) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                            <i class="fas fa-trophy" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                            <p style="margin: 0;">é‚„æ²’æœ‰éŠæˆ²è¨˜éŒ„ï¼Œå¿«å»ç©éŠæˆ²å§ï¼</p>
                        </div>
                    `;
                    return;
                }
                
                leaderboardList.innerHTML = allRecords.map((record, index) => `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank ${index < 3 ? `top-${index + 1}` : ''}">
                            ${index + 1}
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ${getGameName(record.game)}
                            </div>
                            <div class="leaderboard-meta">
                                éŠç©æ¬¡æ•¸: ${record.gamesPlayed} æ¬¡
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            ${record.highScore}
                        </div>
                    </div>
                `).join('');
            } else {
                // é¡¯ç¤ºå–®å€‹éŠæˆ²çš„æ’è¡Œæ¦œ
                const record = gameRecords[gameType];
                
                if (!record || record.gamesPlayed === 0) {
                    leaderboardList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                            <i class="fas fa-gamepad" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                            <p style="margin: 0;">é‚„æ²’æœ‰${getGameName(gameType)}çš„éŠæˆ²è¨˜éŒ„</p>
                        </div>
                    `;
                    return;
                }
                
                leaderboardList.innerHTML = `
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank top-1">
                            1
                        </div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">
                                ä½ çš„æœ€ä½³è¨˜éŒ„
                            </div>
                            <div class="leaderboard-meta">
                                éŠç©æ¬¡æ•¸: ${record.gamesPlayed} æ¬¡
                            </div>
                        </div>
                        <div class="leaderboard-score">
                            ${record.highScore}
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px; color: var(--text-sub); font-size: 14px;">
                        <i class="fas fa-info-circle"></i> æ›´å¤šæ’è¡Œæ¦œåŠŸèƒ½å³å°‡ä¸Šç·š
                    </div>
                `;
            }
        }

        function getGameName(gameType) {
            const names = {
                'link': 'çŸ¥è­˜é€£é€£çœ‹',
                'memory': 'è¨˜æ†¶å¤§è€ƒé©—',
                'match': 'çŸ¥è­˜é…å°',
                'typing': 'æ‰“å­—æŒ‘æˆ°',
                'quiz': 'å¿«é€Ÿå•ç­”'
            };
            return names[gameType] || gameType;
        }

        // ================= æ¨¡å—C: çº¿ä¸Šå¯¹å†³ =================
        async function createDuel() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œå°æˆ°', 'warning');
                return;
            }
            
            try {
                // åˆ›å»ºæˆ¿é—´
                const { data, error } = await sb
                    .from('duel_rooms')
                    .insert({
                        player1_id: user.id,
                        status: 'waiting',
                        p1_score: 0,
                        p2_score: 0,
                        created_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    showNotification('å‰µå»ºæˆ¿é–“å¤±æ•—: ' + error.message, 'error');
                    return;
                }
                
                currentRoom = data;
                
                // æ›´æ–°UI
                document.getElementById('duel-lobby').style.display = 'none';
                document.getElementById('duel-wait').style.display = 'block';
                document.getElementById('room-id-disp').textContent = data.id.substring(0, 8).toUpperCase();
                
                // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
                document.getElementById('room-info').innerHTML = `
                    <div style="text-align: center;">
                        <div style="margin-bottom: 15px;">
                            <i class="fas fa-share-alt" style="color: var(--accent); font-size: 24px; margin-bottom: 10px;"></i>
                            <p style="margin: 10px 0; color: var(--text);">åˆ†äº«æ­¤æˆ¿é–“IDçµ¦æœ‹å‹åŠ å…¥å°æˆ°</p>
                            <div style="font-family: monospace; font-size: 20px; font-weight: bold; color: var(--accent); padding: 10px; background: rgba(var(--accent-rgb), 0.1); border-radius: 10px;">
                                ${data.id.substring(0, 8).toUpperCase()}
                            </div>
                        </div>
                        <p style="margin: 0; color: var(--text-sub); font-size: 14px;">
                            <i class="fas fa-clock"></i> æˆ¿é–“ç‹€æ…‹: ç­‰å¾…ç©å®¶2åŠ å…¥
                        </p>
                    </div>
                `;
                
                // ç›‘å¬æˆ¿é—´çŠ¶æ€å˜åŒ–
                listenToRoom(data.id);
                
                // åŠ è½½å¯¹æˆ˜å†å²
                loadDuelHistory();
                
                showNotification('æˆ¿é–“å‰µå»ºæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('å‰µå»ºå°æ±ºæˆ¿é–“å¤±æ•—:', error);
                showNotification('å‰µå»ºæˆ¿é–“å¤±æ•—', 'error');
            }
        }

        async function loadDuelHistory() {
            if (!user) return;
            
            try {
                const { data, error } = await sb
                    .from('duel_rooms')
                    .select('*')
                    .or(`player1_id.eq.${user.id},player2_id.eq.${user.id}`)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (!error && data) {
                    const historyContainer = document.getElementById('duel-history');
                    historyContainer.innerHTML = data.map(room => `
                        <div style="padding: 15px; margin: 8px 0; background: var(--card-bg); border-radius: 12px; border-left: 4px solid ${getDuelStatusColor(room.status)};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div style="font-size: 14px; color: var(--text);">
                                    ${new Date(room.created_at).toLocaleDateString('zh-HK')}
                                </div>
                                <div style="font-size: 12px; color: ${getDuelStatusColor(room.status)};">
                                    ${getDuelStatusText(room.status)}
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--text-sub);">
                                æ¯”åˆ†: ${room.p1_score || 0} : ${room.p2_score || 0}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('åŠ è¼‰å°æˆ°æ­·å²å¤±æ•—:', error);
            }
        }

        function getDuelStatusColor(status) {
            const colors = {
                'waiting': '#FF9500',
                'playing': '#007AFF',
                'finished': '#34C759',
                'cancelled': '#FF3B30'
            };
            return colors[status] || 'var(--text-sub)';
        }

        function getDuelStatusText(status) {
            const texts = {
                'waiting': 'ç­‰å¾…ä¸­',
                'playing': 'é€²è¡Œä¸­',
                'finished': 'å·²å®Œæˆ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return texts[status] || status;
        }

        function getDuelResult(room) {
            if (room.status === 'waiting') return 'ç­‰å¾…ä¸­';
            if (room.status === 'playing') return 'é€²è¡Œä¸­';
            if (room.status === 'finished') {
                const isPlayer1 = user.id === room.player1_id;
                const isWinner = isPlayer1 ? 
                    (room.p1_score > room.p2_score) : 
                    (room.p2_score > room.p1_score);
                return isWinner ? 'å‹åˆ©' : 'å¤±æ•—';
            }
            return room.status;
        }

        async function cancelDuel() {
            if (currentRoom) {
                try {
                    await sb
                        .from('duel_rooms')
                        .update({ status: 'cancelled' })
                        .eq('id', currentRoom.id);
                } catch (error) {
                    console.error('å–æ¶ˆå°æ±ºå¤±æ•—:', error);
                }
            }
            
            resetDuelUI();
            showNotification('å·²å–æ¶ˆç­‰å¾…', 'info');
        }

        async function listenToRoom(roomId) {
            try {
                // ä½¿ç”¨Supabaseçš„å®æ—¶è®¢é˜…åŠŸèƒ½
                const channel = sb
                    .channel('duel-' + roomId)
                    .on(
                        'postgres_changes',
                        {
                            event: 'UPDATE',
                            schema: 'public',
                            table: 'duel_rooms',
                            filter: `id=eq.${roomId}`
                        },
                        async (payload) => {
                            const room = payload.new;
                            
                            if (room.status === 'playing') {
                                // é–‹å§‹éŠæˆ²
                                await startDuelGame(room);
                            } else if (room.status === 'finished') {
                                // éŠæˆ²çµæŸ
                                endDuelGame(room);
                            }
                        }
                    )
                    .subscribe();
            } catch (error) {
                console.error('ç›£è½æˆ¿é–“å¤±æ•—:', error);
            }
        }

        async function startDuelGame(room) {
            try {
                // ç²å–é¡Œç›®
                const { data: questions } = await sb
                    .from('submissions')
                    .select('*')
                    .limit(10);
                
                if (!questions || questions.length === 0) {
                    showNotification('é¡Œåº«ä¸­æ²’æœ‰é¡Œç›®', 'warning');
                    return;
                }
                
                duelQuestions = questions.sort(() => Math.random() - 0.5).slice(0, 5);
                currentQuestionIndex = 0;
                
                // æ›´æ–°UI
                document.getElementById('duel-wait').style.display = 'none';
                document.getElementById('duel-game').style.display = 'block';
                
                // é¡¯ç¤ºç¬¬ä¸€é¡Œ
                showDuelQuestion();
                
                showNotification('å°æˆ°é–‹å§‹ï¼', 'success');
            } catch (error) {
                console.error('é–‹å§‹å°æ±ºéŠæˆ²å¤±æ•—:', error);
                showNotification('é–‹å§‹å°æˆ°å¤±æ•—', 'error');
            }
        }

        function showDuelQuestion() {
            if (currentQuestionIndex >= duelQuestions.length) {
                endDuelGame();
                return;
            }
            
            const question = duelQuestions[currentQuestionIndex];
            timeLeft = 30;
            
            // æ›´æ–°é¡Œç›®
            document.getElementById('dq-text').textContent = `[${getSubjectName(question.category)}] ${question.title}`;
            const options = generateDuelOptions(question.example);
            document.getElementById('dq-opts').innerHTML = options
                .map((opt, index) => `
                    <button class="ghost" onclick="selectDuelAnswer(${index}, '${opt}')" style="padding: 20px;">
                        ${opt}
                    </button>
                `).join('');
            
            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            if (currentRoom) {
                document.getElementById('score-display').textContent = 
                    `å¾—åˆ†: ${currentRoom.p1_score || 0} - ${currentRoom.p2_score || 0}`;
            }
            
            // é–‹å§‹è¨ˆæ™‚
            startDuelTimer();
        }

        function generateDuelOptions(example) {
            if (!example) {
                return ['é¸é … A', 'é¸é … B', 'é¸é … C', 'é¸é … D'];
            }
            
            const parts = example.split('//').map(p => p.trim()).filter(p => p);
            const correctAnswer = parts[0];
            const wrongAnswers = parts.slice(1);
            
            // å¦‚æœæ²’æœ‰è¶³å¤ çš„éŒ¯èª¤ç­”æ¡ˆï¼Œç”Ÿæˆä¸€äº›
            let allOptions = [correctAnswer];
            for (let i = 0; i < Math.min(3, wrongAnswers.length); i++) {
                allOptions.push(wrongAnswers[i]);
            }
            
            // è£œå……é¸é …
            while (allOptions.length < 4) {
                allOptions.push('é¸é … ' + (allOptions.length + 1));
            }
            
            return allOptions.sort(() => Math.random() - 0.5);
        }

        function startDuelTimer() {
            clearInterval(duelTimer);
            
            document.getElementById('timer').textContent = `å‰©é¤˜æ™‚é–“: ${timeLeft}ç§’`;
            
            duelTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = `å‰©é¤˜æ™‚é–“: ${timeLeft}ç§’`;
                
                if (timeLeft <= 0) {
                    clearInterval(duelTimer);
                    currentQuestionIndex++;
                    setTimeout(() => {
                        showDuelQuestion();
                    }, 1000);
                }
            }, 1000);
        }

        async function selectDuelAnswer(optionIndex, answer) {
            clearInterval(duelTimer);
            
            const question = duelQuestions[currentQuestionIndex];
            const correctAnswer = question.example ? question.example.split('//')[0].trim() : 'é¸é … A';
            const isCorrect = answer === correctAnswer;
            
            // æ›´æ–°åˆ†æ•¸
            if (isCorrect && currentRoom) {
                // å‡è¨­ç•¶å‰ç”¨æˆ¶æ˜¯player1
                const newScore = (currentRoom.p1_score || 0) + 10;
                
                try {
                    await sb
                        .from('duel_rooms')
                        .update({ p1_score: newScore })
                        .eq('id', currentRoom.id);
                    
                    currentRoom.p1_score = newScore;
                } catch (error) {
                    console.error('æ›´æ–°åˆ†æ•¸å¤±æ•—:', error);
                }
            }
            
            // é¡¯ç¤ºçµæœ
            createScorePopup(document.getElementById('dq-text'), isCorrect ? '+10' : '0');
            
            // ä¸‹ä¸€é¡Œ
            setTimeout(() => {
                currentQuestionIndex++;
                showDuelQuestion();
            }, 1000);
        }

        function endDuelGame(room = null) {
            clearInterval(duelTimer);
            
            if (room) {
                const isPlayer1 = user.id === room.player1_id;
                const userScore = isPlayer1 ? room.p1_score : room.p2_score;
                const opponentScore = isPlayer1 ? room.p2_score : room.p1_score;
                const isWinner = userScore > opponentScore;
                
                let message = `éŠæˆ²çµæŸï¼\n`;
                message += `æœ€çµ‚æ¯”åˆ†: ${room.p1_score || 0} - ${room.p2_score || 0}\n`;
                message += `ä½ ${isWinner ? 'è´äº†ï¼ğŸ‰' : 'è¼¸äº†ã€‚ğŸ˜¢'}`;
                
                showNotification(message, isWinner ? 'success' : 'info', 5000);
                
                // æ›´æ–°ç”¨æˆ¶ç©åˆ†
                if (isWinner) {
                    updateUserScore(50);
                }
            }
            
            resetDuelUI();
        }

        function resetDuelUI() {
            currentRoom = null;
            duelQuestions = [];
            currentQuestionIndex = 0;
            clearInterval(duelTimer);
            
            document.getElementById('duel-lobby').style.display = 'block';
            document.getElementById('duel-wait').style.display = 'none';
            document.getElementById('duel-game').style.display = 'none';
            
            // åˆ·æ–°æ­·å²è¨˜éŒ„
            loadDuelHistory();
        }

        // ================= æ¨¡å—D: æŠ•ç¨¿ä¸­å¿ƒ =================
        async function submitKnowledge() {
            if (!user) {
                showNotification('è«‹å…ˆç™»å…¥æ‰èƒ½æŠ•ç¨¿', 'warning');
                return;
            }
            
            // è·å–æ•°æ®...
            const selectedCapsule = document.querySelector('#submit-capsules .capsule.active');
            const subjectKey = SUBJECTS.find(s => s.name === selectedCapsule?.textContent)?.key || 'o';
            const title = document.getElementById('sub-title').value.trim();
            const content = document.getElementById('sub-content').value.trim();
            const example = document.getElementById('sub-example').value.trim();
            
            if (!title || !content) {
                showNotification('è«‹å¡«å¯«æ¨™é¡Œå’Œå…§å®¹', 'warning');
                return;
            }
            
            try {
                const submissionData = {
                    category: subjectKey,
                    title: title,
                    content: content,
                    example: example || '',
                    author_name: profile.username,
                    status: 'pending',
                    user_id: user.id
                };
                
                const { error } = await sb
                    .from('submissions')
                    .insert(submissionData);
                
                if (error) {
                    console.error('æäº¤é”™è¯¯:', error);
                    showNotification('æäº¤å¤±è´¥: ' + error.message, 'error');
                    return;
                }
                
                showNotification('æäº¤æˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('sub-title').value = '';
                document.getElementById('sub-content').value = '';
                document.getElementById('sub-example').value = '';
                
                // æ›´æ–°ç§¯åˆ†
                if (profile) {
                    profile.score += 10;
                    updateUserUI();
                }
                
            } catch (error) {
                console.error('æäº¤å¼‚å¸¸:', error);
                showNotification('æäº¤å¤±è´¥', 'error');
            }
        }

        // ================= æ¨¡å—E: è®¾å®š =================
        function changeTheme(theme) {
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
            document.body.classList.remove('theme-default', 'theme-white', 'theme-dark', 'theme-green', 'theme-orange', 'theme-purple', 'theme-pink');
            
            // æ·»åŠ æ–°ä¸»é¢˜ç±»
            if (theme !== 'default') {
                document.body.classList.add('theme-' + theme);
            }
            
            // æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.theme-color').forEach(btn => {
                btn.classList.remove('active');
                if (btn.classList.contains('theme-' + theme)) {
                    btn.classList.add('active');
                }
            });
            
            // æ ¹æ®ä¸»é¢˜æ›´æ–°CSSå˜é‡
            const accentColors = {
                'default': '#007AFF',
                'white': '#666666',
                'dark': '#0A84FF',
                'green': '#34C759',
                'orange': '#FF9500',
                'purple': '#AF52DE',
                'pink': '#FF2D55'
            };
            
            updateCssVariables(accentColors[theme] || '#007AFF');
            
            // ä¿å­˜ä¸»é¢˜åå¥½
            localStorage.setItem('dsehub-theme', theme);
            
            showNotification(`å·²åˆ‡æ›åˆ°${theme}ä¸»é¡Œ`, 'success');
        }

        async function toggleAdmin() {
            if (!profile || !user) {
                showNotification('è«‹å…ˆç™»å…¥', 'warning');
                return;
            }
            
            // ç®€åŒ–é¡¹ç›®ç‰ˆæœ¬ï¼šç›´æ¥å…è®¸ç”¨æˆ·æˆä¸ºç®¡ç†å‘˜
            if (!profile.is_admin) {
                try {
                    const { error } = await sb
                        .from('profiles')
                        .update({ is_admin: true })
                        .eq('id', user.id);
                    
                    if (!error) {
                        await loadProfile();
                        showNotification('ç®¡ç†å“¡æ¬Šé™å·²é–‹å•Ÿ', 'success');
                    }
                } catch (error) {
                    console.error('é–‹å•Ÿç®¡ç†å“¡æ¬Šé™å¤±æ•—:', error);
                    showNotification('é–‹å•Ÿæ¬Šé™å¤±æ•—', 'error');
                }
            } else {
                try {
                    const { error } = await sb
                        .from('profiles')
                        .update({ is_admin: false })
                        .eq('id', user.id);
                    
                    if (!error) {
                        await loadProfile();
                        showNotification('ç®¡ç†å“¡æ¬Šé™å·²é—œé–‰', 'info');
                    }
                } catch (error) {
                    console.error('é—œé–‰ç®¡ç†å“¡æ¬Šé™å¤±æ•—:', error);
                    showNotification('é—œé–‰æ¬Šé™å¤±æ•—', 'error');
                }
            }
        }

        // ================= æ¨¡å—F: ç®¡ç†åå° =================
        async function showAdminSection(section) {
            if (!profile || !profile.is_admin) {
                showNotification('éœ€è¦ç®¡ç†å“¡æ¬Šé™', 'warning');
                return;
            }
            
            const container = document.getElementById('admin-content');
            
            try {
                if (section === 'feedbacks') {
                    await showFeedbackManagement();
                } else if (section === 'submissions') {
                    await showSubmissionManagement();
                } else if (section === 'users') {
                    await showUserManagement();
                } else if (section === 'games') {
                    await showGameManagement();
                }
            } catch (error) {
                container.innerHTML = '<div class="notification error show"><i class="fas fa-exclamation-circle"></i><div>åŠ è¼‰å¤±æ•—: ' + error.message + '</div></div>';
            }
        }

        async function showFeedbackManagement() {
            try {
                const { data, error } = await sb
                    .from('feedbacks')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const container = document.getElementById('admin-content');
                container.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text); margin-bottom: 15px;">
                            <i class="fas fa-comments"></i> ç•™è¨€ç®¡ç† (${data.length}æ¢)
                        </h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <input type="text" id="feedback-search" placeholder="æœç´¢ç•™è¨€å…§å®¹æˆ–ç”¨æˆ¶å..." 
                                   style="flex: 1; margin: 0;" onkeyup="searchFeedbacks(this.value)">
                            <button class="small ghost" onclick="showFeedbackManagement()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="feedback-list" style="max-height: 500px; overflow-y: auto;">
                        ${data.map(msg => `
                            <div class="admin-item" id="feedback-${msg.id}" style="margin-bottom: 12px; animation: slideIn 0.3s ease-out;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <div style="font-weight: bold; color: var(--text); margin-bottom: 4px;">
                                            <i class="fas fa-user-circle"></i> ${msg.author_name}
                                            ${msg.visibility === 'private' ? '<span style="color: #AF52DE; font-size: 12px;"> (ç§å¯†)</span>' : ''}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-sub);">
                                            ${new Date(msg.created_at).toLocaleString('zh-HK')}
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; padding: 4px 8px; border-radius: 20px; 
                                        background: ${msg.status === 'reported' ? 'rgba(255,59,48,0.1)' : msg.status === 'deleted' ? 'rgba(0,0,0,0.1)' : 'rgba(52,199,89,0.1)'}; 
                                        color: ${msg.status === 'reported' ? '#FF3B30' : msg.status === 'deleted' ? 'var(--text-sub)' : '#34C759'};">
                                        ${msg.status === 'reported' ? 'å·²èˆ‰å ±' : msg.status === 'deleted' ? 'å·²åˆªé™¤' : 'æ­£å¸¸'}
                                    </div>
                                </div>
                                <div style="color: var(--text); white-space: pre-wrap; line-height: 1.5; padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 12px;">
                                    ${msg.content}
                                    ${msg.visibility === 'private' ? '<div style="font-size: 12px; color: #AF52DE; margin-top: 8px;"><i class="fas fa-lock"></i> ç§å¯†ç•™è¨€' + (msg.target_user_id ? 'ï¼Œç›®æ¨™ç”¨æˆ¶ID: ' + msg.target_user_id : '') + '</div>' : ''}
                                </div>
                                <div class="admin-actions">
                                    <button class="small danger" onclick="deleteFeedback('${msg.id}')">
                                        <i class="fas fa-trash"></i> åˆªé™¤
                                    </button>
                                    ${msg.status === 'reported' ? 
                                        '<button class="small success" onclick="restoreFeedback(\'' + msg.id + '\')"><i class="fas fa-undo"></i> æ¢å¾©</button>' : 
                                        '<button class="small warning" onclick="reportFeedback(\'' + msg.id + '\')"><i class="fas fa-flag"></i> èˆ‰å ±</button>'
                                    }
                                </div>
                            </div>
                        `).join('')}
                        ${data.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                                <i class="fas fa-inbox" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                                <p style="margin: 0;">æš«ç„¡ç•™è¨€è¨˜éŒ„</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è¼‰ç•™è¨€ç®¡ç†å¤±æ•—:', error);
                showNotification('åŠ è¼‰ç•™è¨€ç®¡ç†å¤±æ•—', 'error');
            }
        }

        async function showSubmissionManagement() {
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const container = document.getElementById('admin-content');
                container.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text); margin-bottom: 15px;">
                            <i class="fas fa-book"></i> çŸ¥è­˜é»ç®¡ç† (${data.length}æ¢)
                        </h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <input type="text" id="submission-search" placeholder="æœç´¢çŸ¥è­˜é»æ¨™é¡Œæˆ–å…§å®¹..." 
                                   style="flex: 1; margin: 0;" onkeyup="searchSubmissions(this.value)">
                            <button class="small ghost" onclick="showSubmissionManagement()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="submission-list" style="max-height: 500px; overflow-y: auto;">
                        ${data.map(item => `
                            <div class="admin-item" style="margin-bottom: 15px; animation: slideIn 0.3s ease-out;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div>
                                        <div style="font-weight: bold; color: var(--text); font-size: 16px; margin-bottom: 4px;">
                                            [${getSubjectName(item.category)}] ${item.title}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-sub);">
                                            ä½œè€…: ${item.author_name} | 
                                            æ™‚é–“: ${new Date(item.created_at).toLocaleDateString('zh-HK')}
                                        </div>
                                    </div>
                                </div>
                                <div style="color: var(--text-sub); margin: 10px 0; padding: 12px; background: var(--card-bg); border-radius: 8px; font-size: 14px; line-height: 1.6;">
                                    ${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}
                                </div>
                                ${item.example ? `
                                    <div style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">
                                        <i class="fas fa-lightbulb"></i> åŒ…å« ${item.example.split('//').filter(p => p.trim()).length} å€‹ä¾‹å­
                                    </div>
                                ` : ''}
                                <div class="admin-actions">
                                    <button class="small danger" onclick="deleteSubmission('${item.id}')">
                                        <i class="fas fa-trash"></i> åˆªé™¤
                                    </button>
                                    <button class="small ghost" onclick="editSubmission('${item.id}')">
                                        <i class="fas fa-edit"></i> ç·¨è¼¯
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        ${data.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                                <i class="fas fa-book" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                                <p style="margin: 0;">æš«ç„¡çŸ¥è­˜é»è¨˜éŒ„</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è¼‰çŸ¥è­˜é»ç®¡ç†å¤±æ•—:', error);
                showNotification('åŠ è¼‰çŸ¥è­˜é»ç®¡ç†å¤±æ•—', 'error');
            }
        }

        async function showUserManagement() {
            try {
                const { data, error } = await sb
                    .from('profiles')
                    .select('*')
                    .order('score', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                const container = document.getElementById('admin-content');
                container.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: var(--text); margin-bottom: 15px;">
                            <i class="fas fa-users"></i> ç”¨æˆ¶ç®¡ç† (${data.length}äºº)
                        </h3>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                            <input type="text" id="user-search" placeholder="æœç´¢ç”¨æˆ¶å..." 
                                   style="flex: 1; margin: 0;" onkeyup="searchUsers(this.value)">
                            <button class="small ghost" onclick="showUserManagement()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="user-list" style="max-height: 500px; overflow-y: auto;">
                        ${data.map(user => `
                            <div class="admin-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; animation: slideIn 0.3s ease-out;">
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                                            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                                            ${user.username ? user.username.charAt(0).toUpperCase() : 'U'}
                                        </div>
                                        <div>
                                            <div style="font-weight: bold; color: var(--text); margin-bottom: 2px; display: flex; align-items: center; gap: 8px;">
                                                ${user.username}
                                                ${user.is_admin ? '<span style="font-size: 12px; color: #FF9500; background: rgba(255,149,0,0.1); padding: 2px 8px; border-radius: 10px;">ç®¡ç†å“¡</span>' : ''}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-sub);">
                                                ç©åˆ†: ${user.score} | æœ€å¾Œæ›´æ–°: ${user.updated_at ? new Date(user.updated_at).toLocaleDateString('zh-HK') : 'å¾æœª'}
                                            </div>
                                    </div>
                                </div>
                                <div class="admin-actions">
                                    <button class="small ${user.is_admin ? 'danger' : 'success'}" 
                                            onclick="toggleUserAdmin('${user.id}', ${user.is_admin})">
                                        <i class="fas fa-shield-alt"></i> ${user.is_admin ? 'ç§»é™¤ç®¡ç†å“¡' : 'è¨­ç‚ºç®¡ç†å“¡'}
                                    </button>
                                    <button class="small ghost" onclick="adjustUserScore('${user.id}', ${user.score})">
                                        <i class="fas fa-coins"></i> èª¿æ•´ç©åˆ†
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                        ${data.length === 0 ? `
                            <div style="text-align: center; padding: 40px 20px; color: var(--text-sub);">
                                <i class="fas fa-users" style="font-size: 50px; margin-bottom: 20px; color: var(--text-light);"></i>
                                <p style="margin: 0;">æš«ç„¡ç”¨æˆ¶è¨˜éŒ„</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            } catch (error) {
                console.error('åŠ è¼‰ç”¨æˆ¶ç®¡ç†å¤±æ•—:', error);
                showNotification('åŠ è¼‰ç”¨æˆ¶ç®¡ç†å¤±æ•—', 'error');
            }
        }

        async function showGameManagement() {
            const container = document.getElementById('admin-content');
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h3 style="color: var(--text); margin-bottom: 15px;">
                        <i class="fas fa-gamepad"></i> éŠæˆ²è¨˜éŒ„ç®¡ç†
                    </h3>
                    <p style="color: var(--text-sub); margin-bottom: 20px;">
                        æŸ¥çœ‹å’Œç®¡ç†å„é¡éŠæˆ²çš„çµ±è¨ˆæ•¸æ“š
                    </p>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    ${Object.entries(gameRecords).map(([gameType, record]) => `
                        <div class="glass" style="padding: 25px; border: none; background: var(--card-bg);">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                                    display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
                                    <i class="fas fa-${getGameIcon(gameType)}"></i>
                                </div>
                                <div>
                                    <div style="font-weight: bold; color: var(--text); font-size: 18px;">${getGameName(gameType)}</div>
                                    <div style="font-size: 13px; color: var(--text-sub);">éŠæˆ²çµ±è¨ˆ</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">æœ€é«˜åˆ†</div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--accent);">${record.highScore}</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-light); margin-bottom: 5px;">éŠç©æ¬¡æ•¸</div>
                                    <div style="font-size: 24px; font-weight: bold; color: var(--accent-dark);">${record.gamesPlayed}</div>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button class="small w-full" onclick="resetGameRecord('${gameType}')">
                                    <i class="fas fa-undo"></i> é‡ç½®è¨˜éŒ„
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function getGameIcon(gameType) {
            const icons = {
                'link': 'puzzle-piece',
                'memory': 'brain',
                'match': 'layer-group',
                'typing': 'keyboard',
                'quiz': 'question-circle'
            };
            return icons[gameType] || 'gamepad';
        }

        // ç®¡ç†åŠŸèƒ½
        async function deleteFeedback(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™æ¢ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚')) return;
            
            try {
                const { error } = await sb
                    .from('feedbacks')
                    .update({ status: 'deleted' })
                    .eq('id', id);
                
                if (error) {
                    showNotification('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
                } else {
                    showNotification('åˆªé™¤æˆåŠŸ', 'success');
                    // å¾åˆ—è¡¨ä¸­ç§»é™¤
                    const element = document.getElementById('feedback-' + id);
                    if (element) element.remove();
                }
            } catch (error) {
                console.error('åˆªé™¤ç•™è¨€å¤±æ•—:', error);
                showNotification('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        async function restoreFeedback(id) {
            try {
                const { error } = await sb
                    .from('feedbacks')
                    .update({ status: 'normal' })
                    .eq('id', id);
                
                if (error) {
                    showNotification('æ¢å¾©å¤±æ•—: ' + error.message, 'error');
                } else {
                    showNotification('æ¢å¾©æˆåŠŸ', 'success');
                    // åˆ·æ–°åˆ—è¡¨
                    showAdminSection('feedbacks');
                }
            } catch (error) {
                console.error('æ¢å¾©ç•™è¨€å¤±æ•—:', error);
                showNotification('æ¢å¾©å¤±æ•—', 'error');
            }
        }

        async function reportFeedback(id) {
            try {
                const { error } = await sb
                    .from('feedbacks')
                    .update({ status: 'reported' })
                    .eq('id', id);
                
                if (error) {
                    showNotification('èˆ‰å ±å¤±æ•—: ' + error.message, 'error');
                } else {
                    showNotification('å·²èˆ‰å ±', 'success');
                    // åˆ·æ–°åˆ—è¡¨
                    showAdminSection('feedbacks');
                }
            } catch (error) {
                console.error('èˆ‰å ±ç•™è¨€å¤±æ•—:', error);
                showNotification('èˆ‰å ±å¤±æ•—', 'error');
            }
        }

        async function deleteSubmission(id) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™å€‹çŸ¥è­˜é»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚')) return;
            
            try {
                const { error } = await sb
                    .from('submissions')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    showNotification('åˆªé™¤å¤±æ•—: ' + error.message, 'error');
                } else {
                    showNotification('åˆªé™¤æˆåŠŸ', 'success');
                    showAdminSection('submissions');
                    fetchHome();
                }
            } catch (error) {
                console.error('åˆªé™¤çŸ¥è­˜é»å¤±æ•—:', error);
                showNotification('åˆªé™¤å¤±æ•—', 'error');
            }
        }

        async function toggleUserAdmin(userId, isAdmin) {
            try {
                const { error } = await sb
                    .from('profiles')
                    .update({ is_admin: !isAdmin })
                    .eq('id', userId);
                
                if (!error) {
                    showNotification(`${isAdmin ? 'ç§»é™¤' : 'è¨­ç½®'}ç®¡ç†å“¡æˆåŠŸ`, 'success');
                    showAdminSection('users');
                }
            } catch (error) {
                console.error('ä¿®æ”¹ç”¨æˆ¶æ¬Šé™å¤±æ•—:', error);
                showNotification('ä¿®æ”¹æ¬Šé™å¤±æ•—', 'error');
            }
        }

        async function adjustUserScore(userId, currentScore) {
            const newScore = prompt('è¼¸å…¥æ–°çš„ç©åˆ†:', currentScore);
            if (newScore === null || isNaN(newScore)) return;
            
            try {
                const { error } = await sb
                    .from('profiles')
                    .update({ 
                        score: parseInt(newScore),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);
                
                if (!error) {
                    showNotification('ç©åˆ†æ›´æ–°æˆåŠŸ', 'success');
                    showAdminSection('users');
                }
            } catch (error) {
                console.error('èª¿æ•´ç©åˆ†å¤±æ•—:', error);
                showNotification('èª¿æ•´ç©åˆ†å¤±æ•—', 'error');
            }
        }

        function resetGameRecord(gameType) {
            if (!confirm('ç¢ºå®šé‡ç½®é€™å€‹éŠæˆ²çš„è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚')) return;
            
            gameRecords[gameType] = { highScore: 0, gamesPlayed: 0 };
            saveGameRecords();
            showNotification(`${getGameName(gameType)}è¨˜éŒ„å·²é‡ç½®`, 'success');
            showAdminSection('games');
        }

        async function searchFeedbacks(keyword) {
            try {
                const { data, error } = await sb
                    .from('feedbacks')
                    .select('*')
                    .or(`content.ilike.%${keyword}%,author_name.ilike.%${keyword}%`)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (!error) {
                    const list = document.getElementById('feedback-list');
                    list.innerHTML = data.map(msg => `
                        <div class="admin-item" id="feedback-${msg.id}" style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; color: var(--text); margin-bottom: 4px;">
                                        <i class="fas fa-user-circle"></i> ${msg.author_name}
                                        ${msg.visibility === 'private' ? '<span style="color: #AF52DE; font-size: 12px;"> (ç§å¯†)</span>' : ''}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-sub);">
                                        ${new Date(msg.created_at).toLocaleString('zh-HK')}
                                    </div>
                                </div>
                                <div style="font-size: 12px; padding: 4px 8px; border-radius: 20px; 
                                    background: ${msg.status === 'reported' ? 'rgba(255,59,48,0.1)' : msg.status === 'deleted' ? 'rgba(0,0,0,0.1)' : 'rgba(52,199,89,0.1)'}; 
                                    color: ${msg.status === 'reported' ? '#FF3B30' : msg.status === 'deleted' ? 'var(--text-sub)' : '#34C759'};">
                                    ${msg.status === 'reported' ? 'å·²èˆ‰å ±' : msg.status === 'deleted' ? 'å·²åˆªé™¤' : 'æ­£å¸¸'}
                                </div>
                            </div>
                            <div style="color: var(--text); white-space: pre-wrap; line-height: 1.5; padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 12px;">
                                ${msg.content}
                                ${msg.visibility === 'private' ? '<div style="font-size: 12px; color: #AF52DE; margin-top: 8px;"><i class="fas fa-lock"></i> ç§å¯†ç•™è¨€' + (msg.target_user_id ? 'ï¼Œç›®æ¨™ç”¨æˆ¶ID: ' + msg.target_user_id : '') + '</div>' : ''}
                            </div>
                            <div class="admin-actions">
                                <button class="small danger" onclick="deleteFeedback('${msg.id}')">
                                    <i class="fas fa-trash"></i> åˆªé™¤
                                </button>
                                ${msg.status === 'reported' ? 
                                    '<button class="small success" onclick="restoreFeedback(\'' + msg.id + '\')"><i class="fas fa-undo"></i> æ¢å¾©</button>' : 
                                    '<button class="small warning" onclick="reportFeedback(\'' + msg.id + '\')"><i class="fas fa-flag"></i> èˆ‰å ±</button>'
                                }
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('æœç´¢ç•™è¨€å¤±æ•—:', error);
            }
        }

        async function searchSubmissions(keyword) {
            try {
                const { data, error } = await sb
                    .from('submissions')
                    .select('*')
                    .or(`title.ilike.%${keyword}%,content.ilike.%${keyword}%,author_name.ilike.%${keyword}%`)
                    .order('created_at', { ascending: false })
                    .limit(50);
                
                if (!error) {
                    const list = document.getElementById('submission-list');
                    list.innerHTML = data.map(item => `
                        <div class="admin-item" style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; color: var(--text); font-size: 16px; margin-bottom: 4px;">
                                        [${getSubjectName(item.category)}] ${item.title}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-sub);">
                                        ä½œè€…: ${item.author_name} | 
                                        æ™‚é–“: ${new Date(item.created_at).toLocaleDateString('zh-HK')}
                                    </div>
                                </div>
                            </div>
                            <div style="color: var(--text-sub); margin: 10px 0; padding: 12px; background: var(--card-bg); border-radius: 8px; font-size: 14px; line-height: 1.6;">
                                ${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}
                            </div>
                            ${item.example ? `
                                <div style="font-size: 13px; color: var(--text-light); margin-bottom: 12px;">
                                    <i class="fas fa-lightbulb"></i> åŒ…å« ${item.example.split('//').filter(p => p.trim()).length} å€‹ä¾‹å­
                                </div>
                            ` : ''}
                            <div class="admin-actions">
                                <button class="small danger" onclick="deleteSubmission('${item.id}')">
                                    <i class="fas fa-trash"></i> åˆªé™¤
                                </button>
                                <button class="small ghost" onclick="editSubmission('${item.id}')">
                                    <i class="fas fa-edit"></i> ç·¨è¼¯
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('æœç´¢çŸ¥è­˜é»å¤±æ•—:', error);
            }
        }

        async function searchUsers(keyword) {
            try {
                const { data, error } = await sb
                    .from('profiles')
                    .select('*')
                    .ilike('username', `%${keyword}%`)
                    .order('score', { ascending: false })
                    .limit(50);
                
                if (!error) {
                    const list = document.getElementById('user-list');
                    list.innerHTML = data.map(user => `
                        <div class="admin-item" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-dark)); 
                                        display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">
                                        ${user.username ? user.username.charAt(0).toUpperCase() : 'U'}
                                    </div>
                                    <div>
                                        <div style="font-weight: bold; color: var(--text); margin-bottom: 2px; display: flex; align-items: center; gap: 8px;">
                                            ${user.username}
                                            ${user.is_admin ? '<span style="font-size: 12px; color: #FF9500; background: rgba(255,149,0,0.1); padding: 2px 8px; border-radius: 10px;">ç®¡ç†å“¡</span>' : ''}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-sub);">
                                            ç©åˆ†: ${user.score} | æœ€å¾Œæ›´æ–°: ${user.updated_at ? new Date(user.updated_at).toLocaleDateString('zh-HK') : 'å¾æœª'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="admin-actions">
                                <button class="small ${user.is_admin ? 'danger' : 'success'}" 
                                        onclick="toggleUserAdmin('${user.id}', ${user.is_admin})">
                                    <i class="fas fa-shield-alt"></i> ${user.is_admin ? 'ç§»é™¤ç®¡ç†å“¡' : 'è¨­ç‚ºç®¡ç†å“¡'}
                                </button>
                                <button class="small ghost" onclick="adjustUserScore('${user.id}', ${user.score})">
                                    <i class="fas fa-coins"></i> èª¿æ•´ç©åˆ†
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ¶å¤±æ•—:', error);
            }
        }

        // ================= å·¥å…·å‡½æ•¸ =================
        async function updateUserScore(points) {
            if (!profile || !user) return;
            
            const newScore = (profile.score || 0) + points;
            
            try {
                const { error } = await sb
                    .from('profiles')
                    .update({ 
                        score: newScore,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (!error) {
                    profile.score = newScore;
                    updateUserUI();
                    showNotification(`ç²å¾— ${points} ç©åˆ†ï¼`, 'success');
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ¶ç©åˆ†å¤±æ•—:', error);
            }
        }

        // ================= å°èˆªç³»çµ± =================
        function nav(pageId, element = null) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // é¡¯ç¤ºç›®æ¨™é é¢
            document.getElementById('view-' + pageId).classList.add('active');
            
            // æ›´æ–°å°èˆªæ¿€æ´»ç‹€æ…‹
            if (element) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            // é é¢ç‰¹å®šåˆå§‹åŒ–
            switch(pageId) {
                case 'home':
                    fetchHome();
                    break;
                case 'chat':
                    fetchChat();
                    break;
                case 'games':
                    // éš±è—æ‰€æœ‰éŠæˆ²ç•Œé¢ï¼Œé¡¯ç¤ºéŠæˆ²é¸æ“‡å™¨
                    document.getElementById('game-selector').style.display = 'grid';
                    document.getElementById('leaderboard-container').style.display = 'none';
                    document.getElementById('link-game-container').style.display = 'none';
                    document.getElementById('memory-game-container').style.display = 'none';
                    document.getElementById('match-game-container').style.display = 'none';
                    document.getElementById('typing-game-container').style.display = 'none';
                    document.getElementById('quiz-game-container').style.display = 'none';
                    break;
                case 'submit':
                    // ä¸éœ€è¦é¢å¤–æ“ä½œ
                    break;
                case 'admin':
                    if (profile && profile.is_admin) {
                        showAdminSection('feedbacks');
                    }
                    break;
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

    </script>
</body>
</html>

