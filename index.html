<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v65 (Stable)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= æ ·å¼é‡ç½®ä¸åŸºç¡€å˜é‡ ================= */
        :root {
            --accent: #007AFF; 
            --bg-grad: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --glass: rgba(255, 255, 255, 0.95);
            --border: rgba(0,0,0,0.1);
            --radius: 16px;
        }

        /* ğŸŸ¢ ç»¿è‰²ä¸»é¢˜ */
        [data-theme="green"] { --accent: #34C759; --bg-grad: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
        /* ğŸŸ  æ©™è‰²ä¸»é¢˜ */
        [data-theme="orange"] { --accent: #FF9500; --bg-grad: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        /* âš«ï¸ æ·±è‰²æ¨¡å¼ */
        [data-theme="dark"] { 
            --accent: #0A84FF; --text-main: #ffffff; --text-sub: #bbbbbb;
            --bg-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass: rgba(30, 30, 40, 0.95); --border: rgba(255,255,255,0.2);
        }

        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif; 
            background-image: var(--bg-grad); background-attachment: fixed; background-size: cover;
            color: var(--text-main); height: 100vh; display: flex; overflow: hidden; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        /* é€šç”¨ç»„ä»¶ */
        .glass { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        .sidebar { width: 260px; padding: 25px 20px; display: flex; flex-direction: column; background: var(--glass); border-right: 1px solid var(--border); transition: 0.3s; z-index: 100; }
        .main { flex: 1; overflow-y: auto; padding: 20px 5%; position: relative; }
        
        .page { display: none; animation: fadeIn 0.3s; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 12px; font-weight: 600; transition:0.2s; }
        .nav-item.active { background: var(--accent); color: #fff; }
        .nav-item:hover:not(.active) { background: rgba(0,0,0,0.05); }

        /* è¾“å…¥æ¡† - å¼ºåˆ¶é«˜å¯¹æ¯”åº¦ */
        input, textarea, select { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.9); color: #000; font-size: 15px; margin-bottom: 10px;
        }
        [data-theme="dark"] input { background: rgba(0,0,0,0.4); color: #fff; }

        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        button.ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        button.small { width: auto; padding: 6px 14px; font-size: 13px; }

        /* èƒ¶å›Šé€‰æ‹©å™¨ */
        .capsule-row { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .capsule-row::-webkit-scrollbar { display: none; }
        .capsule { 
            padding: 8px 16px; border-radius: 20px; background: rgba(125,125,125,0.15); 
            white-space: nowrap; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-sub);
            transition: 0.2s; border: 1px solid transparent;
        }
        .capsule.active { background: var(--accent); color: white; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        .mobile-bar { display: none; padding: 10px 15px; align-items: center; justify-content: space-between; position: fixed; top:0; width:100%; z-index: 200; background: var(--glass); border-bottom: 1px solid var(--border); backdrop-filter: blur(20px); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; width: 85%; box-shadow: 20px 0 50px rgba(0,0,0,0.2); }
            .sidebar.open { left: 0; }
            .mobile-bar { display: flex; }
            .main { padding-top: 70px; }
        }

        /* ç™»å½•å¼¹çª— */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 320px; padding: 30px; background: #fff; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); color:#000; }
    </style>
</head>
<body data-theme="blue">

    <div class="mobile-bar">
        <button class="ghost" style="border:none; width:auto;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b>DSE Hub</b>
        <div style="width:30px"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0 0 30px 10px; color:var(--accent); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-cube"></i> DSE HUB
        </h2>
        
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('duel', this)"><i class="fas fa-bolt"></i> çº¿ä¸Šå¯¹å†³</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>

        <div style="flex:1"></div>
        
        <div class="glass" style="padding:15px; border:none; background:rgba(125,125,125,0.1);">
            <div style="font-weight:bold;" id="u-nm">Guest</div>
            <div style="font-size:12px; opacity:0.7;" id="u-sc">0 pts</div>
            <button class="small ghost" onclick="logout()" style="width:100%; margin-top:8px;">ç™»å‡º</button>
        </div>
    </div>

    <div class="main" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">

        <div id="view-home" class="page active">
            <h1>ğŸ“š çŸ¥è¯†åº“</h1>
            
            <div class="capsule-row" id="sub-capsules"></div>
            
            <div class="glass" style="padding:10px; margin-bottom:20px;">
                <input id="search-k" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹..." style="margin:0; border:none; background:transparent;" onkeyup="fetchHome()">
            </div>
            
            <div id="home-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="glass" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column-reverse; padding:15px; margin-bottom:15px;" id="chat-list"></div>
            <div class="glass" style="padding:15px; display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¾“å…¥ç•™è¨€..." style="margin:0;">
                <button style="width:auto" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="view-duel" class="page">
            <h1>âš¡ï¸ çº¿ä¸Šå¯¹å†³</h1>
            <div class="glass" style="text-align:center; padding:50px 20px;">
                <div id="duel-lobby">
                    <i class="fas fa-trophy" style="font-size:60px; color:var(--accent); margin-bottom:20px;"></i>
                    <p>åˆ›å»ºæˆ¿é—´ï¼Œé‚€è¯·å¥½å‹PK</p>
                    <button onclick="createDuel()" style="max-width:200px">åˆ›å»ºæˆ¿é—´</button>
                </div>
                <div id="duel-wait" style="display:none;">
                    <h3>âŒ›ï¸ ç­‰å¾…ä¸­...</h3>
                    <p>æˆ¿é—´ ID: <b id="room-id-disp"></b></p>
                    <small>ç­‰å¾…ç©å®¶åŠ å…¥...</small>
                </div>
                <div id="duel-game" style="display:none;">
                    <h3 id="dq-text">é¢˜ç›®åŠ è½½ä¸­...</h3>
                    <div id="dq-opts" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="glass" style="padding:20px;">
                <div style="margin-bottom:15px; display:flex; gap:10px;">
                   <button class="small" onclick="subMode='know'; toggleSub()" id="btn-sub-know">ğŸ“š çŸ¥è¯†ç‚¹</button>
                   <button class="small ghost" onclick="subMode='chat'; toggleSub()" id="btn-sub-chat">ğŸ’¬ ç•™è¨€</button>
                </div>

                <div id="form-know">
                    <div class="capsule-row" id="sub-capsules-form"></div>
                    <input id="sub-t" placeholder="æ ‡é¢˜ (Title)">
                    <textarea id="sub-d" rows="5" placeholder="æ­£æ–‡å†…å®¹ (Content)..."></textarea>
                    <input id="sub-ex" placeholder="ä¾‹å­/ç­”æ¡ˆ (Example)">
                </div>
                
                <div id="form-chat" style="display:none;">
                    <textarea id="sub-msg" rows="3" placeholder="ç•™è¨€å†…å®¹..."></textarea>
                </div>

                <button onclick="submitItem()" style="margin-top:15px;">æäº¤</button>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>âš™ï¸ è®¾ç½®</h1>
            
            <div class="glass" style="padding:20px; margin-bottom:20px;">
                <h3>ğŸ¨ ä¸»é¢˜é£æ ¼</h3>
                <div style="display:flex; gap:15px;">
                    <div style="width:30px; height:30px; background:#007AFF; border-radius:50%; cursor:pointer;" onclick="setTheme('blue')"></div>
                    <div style="width:30px; height:30px; background:#34C759; border-radius:50%; cursor:pointer;" onclick="setTheme('green')"></div>
                    <div style="width:30px; height:30px; background:#FF9500; border-radius:50%; cursor:pointer;" onclick="setTheme('orange')"></div>
                    <div style="width:30px; height:30px; background:#222; border-radius:50%; border:1px solid #fff; cursor:pointer;" onclick="setTheme('dark')"></div>
                </div>
            </div>

            <div class="glass" style="padding:20px;">
                <h3>ğŸ‘¤ è´¦å·ä¿¡æ¯</h3>
                <p>User: <b id="set-u-nm">Guest</b></p>
                <p>Email: <span id="set-u-em">-</span></p>
                <p>Status: <span id="set-u-adm">Student</span></p>
            </div>
        </div>

    </div>

    <div class="modal-mask" id="auth-modal">
        <div class="modal-box">
            <h2 style="margin-top:0;">æ¬¢è¿æ¥åˆ° DSE Hub</h2>
            <input id="lg-e" placeholder="ç”µé‚® (Email)">
            <input id="lg-p" type="password" placeholder="å¯†ç  (Password)">
            <button onclick="auth('in')">ç™»å½•</button>
            <button class="ghost" style="margin-top:10px" onclick="auth('up')">æ³¨å†Œ</button>
            <p id="auth-err" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // ================= âš ï¸ å¡«å…¥ä½ çš„ Supabase é…ç½® âš ï¸ =================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co'; // æ›¿æ¢æˆä½ çš„Supabase URL
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr'; // æ›¿æ¢æˆä½ çš„Supabase anon key
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // å…¨å±€å˜é‡
        let user = null;    // Auth user
        let profile = null; // Public profile
        
        let currentCat = 'all'; // å¯¹åº”æ–°è¡¨çš„ category
        let subMode = 'know';
        let formCat = 'chi';
        
        const CATS = [
            {k:'chi', n:'ä¸­æ–‡'}, {k:'eng', n:'è‹±æ–‡'}, {k:'math', n:'æ•°å­¦'}, 
            {k:'cs', n:'å…¬ç¤¾ç§‘'}, {k:'phy', n:'ç‰©ç†'}, {k:'chem', n:'åŒ–å­¦'}, 
            {k:'bio', n:'ç”Ÿç‰©'}, {k:'hist', n:'å†å²'}, {k:'geog', n:'åœ°ç†'}
        ];

        // ================= åˆå§‹åŒ– =================
        window.onload = async () => {
            renderCapsules();
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const { data } = await sb.auth.getSession();
            if (data.session) {
                user = data.session.user;
                await loadProfile();
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        };

        function renderCapsules() {
            // é¦–é¡µç­›é€‰
            let html = `<div class="capsule active" onclick="filterCat('all', this)">å…¨éƒ¨</div>` + 
                CATS.map(s => `<div class="capsule" onclick="filterCat('${s.k}', this)">${s.n}</div>`).join('');
            document.getElementById('sub-capsules').innerHTML = html;

            // æŠ•ç¨¿é€‰æ‹©
            let formHtml = CATS.map(s => `<div class="capsule ${s.k==='chi'?'active':''}" onclick="setFormCat('${s.k}', this)">${s.n}</div>`).join('');
            document.getElementById('sub-capsules-form').innerHTML = formHtml;
        }

        // ================= æ ¸å¿ƒï¼šåŠ è½½ç”¨æˆ·èµ„æ–™ (é€‚é…æ–°è¡¨ç»“æ„) =================
        async function loadProfile() {
            // æ³¨æ„ï¼šç°åœ¨æˆ‘ä»¬ç”¨ auth_id æ¥æŸ¥æ‰¾ï¼Œè€Œä¸æ˜¯ id
            // å› ä¸ºä½ çš„æ–° SQL é‡Œï¼Œprofiles.id æ˜¯ç‹¬ç«‹ UUIDï¼Œprofiles.auth_id æ‰æ˜¯ Auth UUID
            let { data, error } = await sb.from('profiles').select('*').eq('auth_id', user.id).single();

            // å¦‚æœè§¦å‘å™¨å·¥ä½œæ­£å¸¸ï¼Œè¿™é‡Œè‚¯å®šæœ‰æ•°æ®ã€‚å¦‚æœå¤ªå¿«æ²¡æŸ¥åˆ°ï¼Œå¯ä»¥é‡è¯•ä¸€æ¬¡ï¼ˆç•¥ï¼‰ã€‚
            if (data) {
                profile = data;
                updateUserUI();
                document.getElementById('auth-modal').style.display = 'none';
                nav('home');
            } else {
                // æç½•è§æƒ…å†µï¼šè§¦å‘å™¨æ²¡è·‘å®Œï¼Œæˆ–è¡¨è¢«æ¸…ç©ºäº†
                console.error("Profile not found, trigger might have failed.", error);
                alert("åŠ è½½èµ„æ–™å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•");
            }
        }

        function updateUserUI() {
            document.getElementById('u-nm').innerText = profile.username;
            document.getElementById('u-sc').innerText = profile.score + ' pts';
            document.getElementById('set-u-nm').innerText = profile.username;
            document.getElementById('set-u-em').innerText = profile.email;
            document.getElementById('set-u-adm').innerText = profile.is_admin ? "ç®¡ç†å‘˜ (Admin)" : "å­¦ç”Ÿ (Student)";
        }

        // ================= è®¤è¯ =================
        async function auth(type) {
            const email = document.getElementById('lg-e').value;
            const password = document.getElementById('lg-p').value;
            const errEl = document.getElementById('auth-err');
            
            let res;
            if(type==='up') res = await sb.auth.signUp({ email, password });
            else res = await sb.auth.signInWithPassword({ email, password });

            if(res.error) errEl.innerText = res.error.message;
            else {
                if(type==='up') alert("æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±æˆ–ç›´æ¥ç™»å½•ã€‚");
                else location.reload(); 
            }
        }
        async function logout() { await sb.auth.signOut(); location.reload(); }

        // ================= 1. çŸ¥è¯†åº“ (Submissions) =================
        // æ–°è¡¨ç»“æ„ï¼šcategory, title, content, example, author_id, author_name, status
        function filterCat(k, el) {
            currentCat = k;
            document.querySelectorAll('#sub-capsules .capsule').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            fetchHome();
        }

        async function fetchHome() {
            const key = document.getElementById('search-k').value;
            let q = sb.from('submissions').select('*').eq('status', 'approved'); // åªçœ‹ approved
            
            if(currentCat !== 'all') q = q.eq('category', currentCat); // æ³¨æ„ï¼šè¿™é‡Œæ”¹æˆ category
            if(key) q = q.ilike('title', `%${key}%`);

            const { data } = await q;
            
            document.getElementById('home-list').innerHTML = (data && data.length) ? data.map(i => `
                <div class="glass" style="padding:15px; margin-bottom:10px;">
                    <div style="font-weight:bold; color:var(--text-main);">[${i.category.toUpperCase()}] ${i.title}</div>
                    <div style="color:var(--text-sub); margin-top:5px; white-space:pre-wrap;">${i.content}</div>
                    ${i.example ? `<div style="font-size:12px; margin-top:10px; color:var(--accent); background:rgba(0,0,0,0.03); padding:5px; border-radius:5px;">ğŸ’¡ ä¾‹: ${i.example}</div>` : ''}
                    <div style="font-size:10px; color:#aaa; margin-top:8px; text-align:right;">By ${i.author_name}</div>
                </div>
            `).join('') : '<div style="text-align:center; padding:20px; color:#888;">æš‚æ— å†…å®¹</div>';
        }

        // ================= 2. ç•™è¨€æ¿ (Feedbacks) =================
        // æ–°è¡¨ç»“æ„ï¼šauthor_id, author_name, content, status
        async function fetchChat() {
            const { data } = await sb.from('feedbacks').select('*')
                .neq('status', 'deleted')
                .order('created_at', { ascending: false }) 
                .limit(30);

            document.getElementById('chat-list').innerHTML = data ? data.map(i => `
                <div style="padding:10px; margin-bottom:10px; background:rgba(255,255,255,0.4); border-radius:10px;">
                    <div style="font-size:12px; font-weight:bold; color:var(--accent)">${i.author_name}</div>
                    <div style="color:var(--text-main); margin-top:2px;">${i.content}</div>
                </div>
            `).join('') : '';
        }

        async function sendChat() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            
            await sb.from('feedbacks').insert({
                author_id: profile.id,       // ä½¿ç”¨ profile.id (æ–°è¡¨å¤–é”®)
                author_name: profile.username,
                content: txt,
                status: 'normal'
            });
            document.getElementById('chat-input').value = '';
            fetchChat();
        }

        // ================= 3. å¯¹å†³ (Duel Rooms) =================
        // æ–°è¡¨ç»“æ„ï¼šplayer1_id (å…³è” profiles.id), status, p1_score...
        async function createDuel() {
            const { data, error } = await sb.from('duel_rooms').insert({
                player1_id: profile.id, // è¿™é‡Œå¡« profile.idï¼Œä¸æ˜¯ user.id
                status: 'waiting',
                p1_score: 0, 
                p2_score: 0,
                settings: {}
            }).select().single();

            if(error) return alert("åˆ›å»ºå¤±è´¥: " + error.message);

            document.getElementById('duel-lobby').style.display = 'none';
            document.getElementById('duel-wait').style.display = 'block';
            document.getElementById('room-id-disp').innerText = data.id.slice(0,8); // åªæ˜¾ç¤ºå‰8ä½ç¾è§‚ä¸€ç‚¹
            
            // æ¨¡æ‹Ÿå¼€å§‹
            setTimeout(startLocalGame, 2000);
        }

        async function startLocalGame() {
            // ä» submissions éšæœºæŠ½é¢˜
            const { data } = await sb.from('submissions').select('*').eq('status', 'approved').limit(20);
            
            if(!data || data.length === 0) return alert("é¢˜åº“é‡Œè¿˜æ²¡é¢˜å‘¢ï¼Œå¿«å»æŠ•ç¨¿ï¼");

            const q = data[Math.floor(Math.random() * data.length)];
            const ans = q.example ? q.example.split('//')[0] : "A"; // ç®€å•å‡è®¾ example ç¬¬ä¸€æ®µæ˜¯ç­”æ¡ˆ
            
            document.getElementById('duel-wait').style.display = 'none';
            document.getElementById('duel-game').style.display = 'block';
            document.getElementById('dq-text').innerText = q.title;
            
            const opts = [ans, "å¹²æ‰°é¡¹ A", "å¹²æ‰°é¡¹ B", "å¹²æ‰°é¡¹ C"].sort(()=>Math.random()-0.5);
            
            document.getElementById('dq-opts').innerHTML = opts.map(o => 
                `<button class="ghost" onclick="alert('${o===ans?'Bingo! +10åˆ†':'Wrong!'}'); nav('home')">${o}</button>`
            ).join('');
        }

        // ================= 4. æŠ•ç¨¿ (Submissions) =================
        function setFormCat(k, el) {
            formCat = k;
            document.querySelectorAll('#sub-capsules-form .capsule').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function toggleSub() {
            document.getElementById('form-know').style.display = subMode==='know'?'block':'none';
            document.getElementById('form-chat').style.display = subMode==='chat'?'block':'none';
            document.getElementById('btn-sub-know').className = subMode==='know'?'small':'small ghost';
            document.getElementById('btn-sub-chat').className = subMode==='chat'?'small':'small ghost';
        }

        async function submitItem() {
            if(subMode === 'know') {
                const { error } = await sb.from('submissions').insert({
                    category: formCat, // æ–°å­—æ®µå
                    title: document.getElementById('sub-t').value,
                    content: document.getElementById('sub-d').value,
                    example: document.getElementById('sub-ex').value,
                    status: 'pending', 
                    author_id: profile.id, // å¤–é”®
                    author_name: profile.username 
                });
                if(error) alert("å¤±è´¥: " + error.message);
                else alert("æŠ•ç¨¿æˆåŠŸï¼ç­‰å¾…å®¡æ ¸ã€‚");
            } else {
                // å¤ç”¨ç•™è¨€é€»è¾‘ï¼Œä½†æ˜¯å†…å®¹æ¥è‡ª sub-msg
                const txt = document.getElementById('sub-msg').value;
                if(!txt) return;
                await sb.from('feedbacks').insert({
                    author_id: profile.id,
                    author_name: profile.username,
                    content: txt,
                    status: 'normal'
                });
                nav('chat');
            }
        }
        
        // ================= å¯¼èˆªä¸æ‚é¡¹ =================
        function setTheme(t) { document.body.setAttribute('data-theme', t); }
        
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if(id==='home') fetchHome();
            if(id==='chat') fetchChat();
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>
