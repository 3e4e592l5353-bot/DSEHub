<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub (Live Tables)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= æ ·å¼éƒ¨åˆ† (ä¿æŒ v59 æå…‰ç»ç’ƒé£æ ¼) ================= */
        :root {
            --accent: #007AFF; --bg-grad: linear-gradient(135deg, #E0C3FC 0%, #8EC5FC 100%);
            --glass-bg: rgba(255, 255, 255, 0.75); --glass-border: rgba(255, 255, 255, 0.5);
            --text: #1d1d1f; --text-sub: #6e6e73; --radius: 20px;
        }
        body { margin: 0; font-family: -apple-system, sans-serif; background-image: var(--bg-grad); background-attachment: fixed; background-size: cover; color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        
        /* å¸ƒå±€ */
        .sidebar { width: 260px; padding: 25px 20px; display: flex; flex-direction: column; z-index: 100; transition: 0.3s; }
        .main { flex: 1; overflow-y: auto; padding: 30px 5%; position: relative; scroll-behavior: smooth; }
        .page { display: none; animation: fadeIn 0.3s; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* ç»„ä»¶ */
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 14px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .nav-item.active { background: var(--accent); color: white; }
        .admin-tag { background: #FF9500; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight:bold; display:none; margin-left:auto; }
        
        h1 { margin: 0 0 20px 0; font-size: 26px; font-weight: 800; }
        .card { padding: 20px; margin-bottom: 20px; }
        input, textarea, select { width: 100%; padding: 12px; border-radius: 12px; border: none; background: rgba(125,125,125,0.1); margin-bottom: 10px; font-size: 15px; }
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        button.danger { background: #FF3B30; }
        button.ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--glass-border); }
        button.small { width: auto; padding: 6px 12px; font-size: 12px; }

        /* çŸ¥è¯†ç‚¹æ‰‹é£ç´ */
        .k-item { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; }
        .k-body { max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s; margin-top: 0; }
        .k-item.open .k-body { max-height: 1000px; opacity: 1; margin-top: 15px; }

        /* ç§»åŠ¨ç«¯ */
        .mobile-bar { display: none; padding: 10px 15px; align-items: center; justify-content: space-between; position: fixed; top:0; width:100%; z-index: 200; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; background: var(--glass-bg); box-shadow: 20px 0 50px rgba(0,0,0,0.2); }
            .sidebar.open { left: 0; }
            .mobile-bar { display: flex; }
            .main { padding-top: 70px; }
        }

        /* ç™»å½•æ¡† */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .modal-box { width: 320px; padding: 30px; }
    </style>
</head>
<body>

    <div class="mobile-bar glass">
        <button class="ghost" style="width:auto; border:none;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b>DSE Hub</b>
        <div style="width:30px"></div>
    </div>

    <div class="sidebar glass" id="sidebar">
        <h2 style="margin:0 0 30px 10px; color:var(--accent); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-cube"></i> DSE HUB
            <span id="badge-admin" class="admin-tag">ADMIN</span>
        </h2>
        
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('duel', this)"><i class="fas fa-bolt"></i> çº¿ä¸Šå¯¹å†³</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>
        
        <div class="nav-item" id="nav-admin" onclick="nav('admin', this)" style="display:none; color:#FF9500; background:rgba(255,149,0,0.1); margin-top:20px;">
            <i class="fas fa-shield-alt"></i> ç®¡ç†åå°
        </div>

        <div style="flex:1"></div>
        
        <div class="glass" style="padding:15px; border:none; background:rgba(125,125,125,0.05);">
            <div style="font-weight:bold; margin-bottom:5px;" id="u-nm">User</div>
            <div style="font-size:12px; opacity:0.6; margin-bottom:10px;" id="u-sc">0 pts</div>
            <button class="small ghost" onclick="logout()" style="width:100%">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="main">

        <div id="view-home" class="page active">
            <h1>ğŸ“š å…¨ç§‘çŸ¥è¯†åº“</h1>
            <div class="card glass" style="display:flex; gap:10px;">
                <select id="filter-sub" style="width:auto;" onchange="fetchHome()"></select>
                <input id="search-k" placeholder="ğŸ” æœç´¢..." onkeyup="fetchHome()">
            </div>
            <div id="home-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="card glass" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column-reverse;" id="chat-list"></div>
            <div class="card glass" style="display:flex; gap:10px;">
                <input id="chat-input" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                <button style="width:auto" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="view-duel" class="page">
            <h1>âš¡ï¸ çº¿ä¸Šå¯¹å†³</h1>
            <div class="card glass" style="text-align:center; padding:50px 20px;">
                <div id="duel-lobby">
                    <i class="fas fa-fist-raised" style="font-size:60px; color:var(--accent); margin-bottom:20px;"></i>
                    <p>ä»é¢˜åº“éšæœºæŠ½é¢˜PK</p>
                    <button onclick="startDuel()" style="max-width:200px">å¼€å§‹åŒ¹é…</button>
                </div>
                <div id="duel-game" style="display:none;">
                    <h3 id="dq-text">é¢˜ç›®...</h3>
                    <div id="dq-opts" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿</h1>
            <div class="card glass">
                <select id="sub-type" onchange="toggleSubUI()">
                    <option value="know">ğŸ“š çŸ¥è¯†ç‚¹ (éœ€å®¡æ ¸)</option>
                    <option value="chat">ğŸ’¬ ç•™è¨€ (å³æ—¶)</option>
                </select>

                <div id="form-know">
                    <select id="sub-sub"></select>
                    <input id="sub-t" placeholder="æ ‡é¢˜">
                    <textarea id="sub-d" rows="5" placeholder="å†…å®¹..."></textarea>
                    <input id="sub-ex" placeholder="ä¾‹å­ (æ­£ç¡®ç­”æ¡ˆ // å¹²æ‰°é¡¹)">
                </div>
                
                <div id="form-chat" style="display:none;">
                    <textarea id="sub-msg" rows="3" placeholder="ç•™è¨€å†…å®¹..."></textarea>
                </div>

                <button onclick="submitItem()">æäº¤</button>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>âš™ï¸ è®¾ç½®</h1>
            <div class="card glass">
                <h3>ğŸ‘¤ è´¦å·ä¿¡æ¯</h3>
                <p>ID: <span id="set-uid"></span></p>
                <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:15px; margin-top:15px;">
                    <span>ğŸ›¡ ç®¡ç†å‘˜æ¨¡å¼</span>
                    <button id="btn-adm" class="small" style="width:auto" onclick="toggleAdmin()">å¼€å¯</button>
                </div>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1 style="color:#FF9500">ğŸ›¡ ç®¡ç†æ§åˆ¶å°</h1>
            <div class="card glass">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="small ghost" onclick="fetchAdmin('audit')">å¾…å®¡çŸ¥è¯†</button>
                    <button class="small ghost" onclick="fetchAdmin('reported')">ä¸¾æŠ¥ç•™è¨€</button>
                </div>
                <div id="admin-content"></div>
            </div>
        </div>

    </div>

    <div class="modal-mask" id="auth-modal">
        <div class="modal-box glass">
            <h2 style="margin-top:0">ç™»å½• DSE Hub</h2>
            <input id="lg-e" placeholder="é‚®ç®±">
            <input id="lg-p" type="password" placeholder="å¯†ç ">
            <button onclick="auth('in')">ç™»å½•</button>
            <button class="ghost" style="margin-top:10px" onclick="auth('up')">æ³¨å†Œ</button>
        </div>
    </div>

    <script>
        // ================= âš ï¸ è¿™é‡Œå¡«å…¥ä½ çš„ Supabase URL å’Œ Key âš ï¸ =================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // å…¨å±€å˜é‡
        let user = null;
        let profile = null;
        const SUBJECTS = ["chi","eng","math","cs","phy","chem","bio","econ","bafs","ict","hist","geog"];

        // ================= åˆå§‹åŠ è½½ =================
        window.onload = async () => {
            // ç”Ÿæˆä¸‹æ‹‰æ¡†
            const opts = SUBJECTS.map(s => `<option value="${s}">${s.toUpperCase()}</option>`).join('');
            document.getElementById('filter-sub').innerHTML = `<option value="all">ALL</option>` + opts;
            document.getElementById('sub-sub').innerHTML = opts;

            // æ£€æŸ¥ç™»å½•
            const { data } = await sb.auth.getSession();
            if (data.session) {
                user = data.session.user;
                await loadProfile();
            }
        };

        // ================= è®¤è¯æ¨¡å— =================
        async function auth(type) {
            const email = document.getElementById('lg-e').value;
            const password = document.getElementById('lg-p').value;
            let res;
            
            if(type === 'up') res = await sb.auth.signUp({ email, password });
            else res = await sb.auth.signInWithPassword({ email, password });

            if(res.error) alert(res.error.message);
            else {
                user = res.data.user;
                if(type==='up') alert("æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•"); // é˜²æ­¢æœªéªŒè¯é‚®ç®±é—®é¢˜
                else {
                    await loadProfile();
                    document.getElementById('auth-modal').style.display = 'none';
                }
            }
        }
        
        async function logout() {
            await sb.auth.signOut();
            location.reload();
        }

        async function loadProfile() {
            // è¯»å– profiles è¡¨
            let { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
            
            // å¦‚æœæ²¡profileï¼ˆæ—§æ•°æ®ï¼‰ï¼Œè‡ªåŠ¨åˆ›å»º
            if(!data) {
                const newP = { id: user.id, username: user.email.split('@')[0], score: 0, is_admin: false };
                await sb.from('profiles').insert(newP);
                data = newP;
            }
            profile = data;
            updateUI();
            nav('home');
        }

        function updateUI() {
            document.getElementById('u-nm').innerText = profile.username;
            document.getElementById('u-sc').innerText = profile.score + ' pts';
            document.getElementById('set-uid').innerText = user.id;
            
            // ç®¡ç†å‘˜ Tag
            const isAdmin = profile.is_admin;
            document.getElementById('nav-admin').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('badge-admin').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('btn-adm').innerText = isAdmin ? "å…³é—­æƒé™" : "å¼€å¯";
            document.getElementById('btn-adm').className = isAdmin ? "small danger" : "small";
        }

        // ================= ç®¡ç†å‘˜ææƒ (æ ¸å¿ƒ) =================
        async function toggleAdmin() {
            if (profile.is_admin) {
                await sb.from('profiles').update({ is_admin: false }).eq('id', user.id);
                profile.is_admin = false;
            } else {
                const p = prompt("è¾“å…¥ç®¡ç†å‘˜å¯†ç  (admin):");
                if (p === 'admin') {
                    await sb.from('profiles').update({ is_admin: true }).eq('id', user.id);
                    profile.is_admin = true;
                } else {
                    alert("å¯†ç é”™è¯¯");
                }
            }
            updateUI();
        }

        // ================= 1. çŸ¥è¯†åº“ (è¯»å– submissions) =================
        async function fetchHome() {
            const sub = document.getElementById('filter-sub').value;
            const key = document.getElementById('search-k').value;
            
            let q = sb.from('submissions').select('*').eq('status', 'approved');
            if(sub !== 'all') q = q.eq('subject', sub);
            if(key) q = q.ilike('title', `%${key}%`);
            
            const { data } = await q;
            document.getElementById('home-list').innerHTML = data ? data.map(i => `
                <div class="k-item glass" onclick="this.classList.toggle('open')">
                    <b>[${i.subject}] ${i.title}</b>
                    <div class="k-body">${i.content}</div>
                </div>
            `).join('') : 'æ— å†…å®¹';
        }

        // ================= 2. ç•™è¨€æ¿ (è¯»å– feedbacks) =================
        async function fetchChat() {
            const { data } = await sb.from('feedbacks').select('*')
                .neq('status', 'deleted')
                .order('created_at', { ascending: false }).limit(20);
                
            document.getElementById('chat-list').innerHTML = data ? data.map(i => `
                <div style="padding:10px; margin-bottom:5px; border-bottom:1px solid rgba(0,0,0,0.05)">
                    <div style="font-size:12px; color:var(--accent)">${i.author_name}</div>
                    <div>${i.content}</div>
                    ${i.status==='reported'?'<span style="color:red;font-size:10px">âš ï¸ å·²ä¸¾æŠ¥</span>':
                    `<span style="font-size:10px;cursor:pointer;opacity:0.5" onclick="report(${i.id})">ä¸¾æŠ¥</span>`}
                </div>
            `).join('') : '';
        }

        async function sendChat() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;
            await sb.from('feedbacks').insert({
                author_name: profile.username, content: txt, status: 'normal'
            }); // æ³¨æ„: ä¸éœ€è¦ user_id å¦‚æœä½ è¿˜æ²¡å»ºå¤–é”®ï¼Œå¦‚æœ‰éœ€è¦è¯·åŠ ä¸Š user_id: user.id
            document.getElementById('chat-input').value = '';
            fetchChat();
        }
        
        async function report(id) {
            if(confirm('ä¸¾æŠ¥æ­¤ç•™è¨€ï¼Ÿ')) {
                await sb.from('feedbacks').update({ status: 'reported' }).eq('id', id);
                fetchChat();
            }
        }

        // ================= 4. æŠ•ç¨¿ (Insert submissions/feedbacks) =================
        function toggleSubUI() {
            const t = document.getElementById('sub-type').value;
            document.getElementById('form-know').style.display = t==='know'?'block':'none';
            document.getElementById('form-chat').style.display = t==='chat'?'block':'none';
        }

        async function submitItem() {
            const t = document.getElementById('sub-type').value;
            if(t === 'know') {
                await sb.from('submissions').insert({
                    author_name: profile.username,
                    subject: document.getElementById('sub-sub').value,
                    title: document.getElementById('sub-t').value,
                    content: document.getElementById('sub-d').value,
                    example: document.getElementById('sub-ex').value,
                    status: 'pending'
                });
                alert("å·²æŠ•ç¨¿çŸ¥è¯†ç‚¹ï¼Œå¾…å®¡æ ¸");
            } else {
                await sb.from('feedbacks').insert({
                    author_name: profile.username,
                    content: document.getElementById('sub-msg').value,
                    status: 'normal'
                });
                nav('chat');
            }
        }

        // ================= 6. ç®¡ç†åå° (å®¡æ ¸) =================
        async function fetchAdmin(tab) {
            const box = document.getElementById('admin-content');
            box.innerHTML = 'åŠ è½½ä¸­...';
            
            if(tab === 'audit') {
                // è¯» submissions
                const { data } = await sb.from('submissions').select('*').eq('status', 'pending');
                box.innerHTML = data.map(i => `
                    <div class="glass" style="padding:10px; margin-bottom:10px;">
                        <b>${i.title}</b>
                        <p>${i.content}</p>
                        <button class="small" onclick="admAct('submissions',${i.id},'approved')">é€šè¿‡</button>
                        <button class="small danger" onclick="admAct('submissions',${i.id},'deleted')">åˆ é™¤</button>
                    </div>
                `).join('');
            } else {
                // è¯» feedbacks
                const { data } = await sb.from('feedbacks').select('*').eq('status', 'reported');
                box.innerHTML = data.map(i => `
                    <div class="glass" style="padding:10px; margin-bottom:10px;">
                        <p>${i.content}</p>
                        <button class="small danger" onclick="admAct('feedbacks',${i.id},'deleted')">åˆ é™¤</button>
                        <button class="small" onclick="admAct('feedbacks',${i.id},'normal')">æ¢å¤</button>
                    </div>
                `).join('');
            }
        }

        async function admAct(table, id, status) {
            await sb.from(table).update({ status: status }).eq('id', id);
            fetchAdmin(table==='submissions'?'audit':'reported');
        }

        // ================= å¯¼èˆª =================
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if(id==='home') fetchHome();
            if(id==='chat') fetchChat();
            if(id==='admin') fetchAdmin('audit');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        
        // ================= å¯¹å†³ (ç®€åŒ–ç‰ˆ: è¯» submissions) =================
        async function startDuel() {
             const { data } = await sb.from('submissions').select('*').eq('status', 'approved').limit(50);
             if(!data || data.length < 2) return alert("é¢˜åº“ä¸è¶³");
             
             const q = data[Math.floor(Math.random()*data.length)];
             const ans = q.example ? q.example.split('//')[0] : "ç­”æ¡ˆ";
             
             document.getElementById('duel-lobby').style.display='none';
             document.getElementById('duel-game').style.display='block';
             document.getElementById('dq-text').innerText = q.title;
             document.getElementById('dq-opts').innerHTML = [ans, "A","B","C"].sort(()=>Math.random()-0.5).map(o=>
                 `<button onclick="alert('${o===ans?'WIN':'LOSE'}');nav('home')">${o}</button>`
             ).join('');
        }
    </script>
</body>
</html>
