<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v69 (Ultimate)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= å…¨å±€æ ·å¼ç³»ç»Ÿ ================= */
        :root {
            --accent: #007AFF; 
            --bg-grad: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-main: #333;
            --text-sub: #666;
            --glass: rgba(255, 255, 255, 0.9);
            --border: rgba(0,0,0,0.1);
            --radius: 16px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* åŠ¨æ€ä¸»é¢˜ */
        [data-theme="dark"] {
            --accent: #0A84FF; --bg-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --text-main: #fff; --text-sub: #ccc; --glass: rgba(30, 35, 45, 0.95); --border: rgba(255,255,255,0.1);
        }
        [data-theme="green"] { --accent: #34C759; }
        [data-theme="purple"] { --accent: #AF52DE; }

        body { margin:0; font-family:-apple-system, system-ui, sans-serif; background:var(--bg-grad); color:var(--text-main); height:100vh; display:flex; overflow:hidden; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; user-select:none; }

        /* ç»„ä»¶æ ·å¼ */
        .glass { background:var(--glass); backdrop-filter:blur(10px); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); transition:0.3s; }
        button { background:var(--accent); color:#fff; border:none; padding:12px; border-radius:12px; font-weight:600; cursor:pointer; width:100%; transition:0.2s; }
        button:active { transform:scale(0.98); opacity:0.9; }
        button.ghost { background:transparent; color:var(--text-sub); border:1px solid var(--border); }
        button.small { width:auto; padding:6px 12px; font-size:13px; }
        
        input, textarea { width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.5); color:var(--text-main); margin-bottom:10px; font-size:15px; }
        [data-theme="dark"] input { background:rgba(0,0,0,0.3); }

        /* å¸ƒå±€ */
        .sidebar { width:260px; padding:25px 20px; display:flex; flex-direction:column; background:var(--glass); border-right:1px solid var(--border); z-index:100; }
        .main { flex:1; overflow-y:auto; padding:20px 5%; position:relative; scroll-behavior:smooth; }
        .page { display:none; max-width:800px; margin:0 auto; padding-bottom:100px; animation:fadeIn 0.3s; }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* å¯¼èˆª */
        .nav-item { padding:12px 15px; margin-bottom:8px; border-radius:12px; cursor:pointer; color:var(--text-sub); display:flex; align-items:center; gap:12px; font-weight:600; }
        .nav-item.active { background:var(--accent); color:#fff; box-shadow:0 4px 15px var(--accent); }
        .nav-item:hover:not(.active) { background:rgba(125,125,125,0.1); }

        /* èƒ¶å›Šè¿‡æ»¤å™¨ */
        .capsule-row { display:flex; overflow-x:auto; gap:8px; padding-bottom:5px; margin-bottom:15px; }
        .capsule { padding:6px 16px; border-radius:20px; background:rgba(125,125,125,0.1); white-space:nowrap; cursor:pointer; font-size:13px; font-weight:600; color:var(--text-sub); }
        .capsule.active { background:var(--accent); color:#fff; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        .mobile-bar { display:none; padding:10px 15px; align-items:center; justify-content:space-between; position:fixed; top:0; width:100%; z-index:200; background:var(--glass); border-bottom:1px solid var(--border); }
        @media (max-width: 768px) {
            .sidebar { position:fixed; left:-100%; height:100%; width:80%; transition:0.3s; box-shadow:50px 0 100px rgba(0,0,0,0.5); }
            .sidebar.open { left:0; }
            .mobile-bar { display:flex; }
            .main { padding-top:70px; }
        }

        /* å¼¹çª— */
        .modal-mask { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { width:320px; padding:30px; background:#fff; border-radius:24px; box-shadow:0 20px 60px rgba(0,0,0,0.4); text-align:center; color:#333; }

        /* æ¸¸æˆç½‘æ ¼ */
        .game-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
        .card { aspect-ratio:1; background:var(--glass); display:flex; align-items:center; justify-content:center; border-radius:8px; font-weight:bold; cursor:pointer; font-size:12px; border:2px solid transparent; text-align:center; padding:4px; }
        .card.selected { border-color:var(--accent); background:rgba(0,122,255,0.1); }
        .card.matched { opacity:0; pointer-events:none; }
    </style>
</head>
<body data-theme="blue">

    <div class="mobile-bar">
        <button class="ghost" style="border:none; width:auto;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b>DSE Hub v69</b>
        <div style="width:30px"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0 0 30px 10px; color:var(--accent); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-cube"></i> DSE HUB
        </h2>
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('games', this)"><i class="fas fa-gamepad"></i> æ¸¸æˆå¤§å…</div>
        <div class="nav-item" onclick="nav('duel', this)"><i class="fas fa-bolt"></i> çº¿ä¸Šå¯¹å†³ (Real)</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>
        <div style="flex:1"></div>
        <div class="glass" style="padding:15px; border:none; background:rgba(125,125,125,0.1);">
            <div style="font-weight:bold;" id="u-nm">Guest</div>
            <div style="font-size:12px; opacity:0.7;" id="u-sc">0 pts</div>
            <button class="small ghost" onclick="logout()" style="width:100%; margin-top:8px;">ç™»å‡º</button>
        </div>
    </div>

    <div class="main" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">

        <div id="view-home" class="page active">
            <h1>ğŸ“š çŸ¥è¯†åº“</h1>
            <div class="capsule-row" id="filter-capsules"></div>
            <input id="search-input" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹..." onkeyup="fetchHome()">
            <div id="home-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="glass" style="height:55vh; overflow-y:auto; display:flex; flex-direction:column-reverse; padding:15px; margin-bottom:15px;" id="chat-list"></div>
            <div class="glass" style="padding:15px;">
                <textarea id="chat-txt" rows="2" placeholder="è¾“å…¥ç•™è¨€..." style="margin-bottom:5px;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <label style="font-size:12px; display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="chat-priv"> ç§å¯†ç•™è¨€ (Private)
                    </label>
                    <button style="width:auto; padding:8px 20px;" onclick="postChat()"><i class="fas fa-paper-plane"></i> å‘é€</button>
                </div>
            </div>
        </div>

        <div id="view-games" class="page">
            <h1>ğŸ® æ¸¸æˆå¤§å…</h1>
            <div style="display:grid; gap:15px;">
                <div class="glass" style="padding:20px; cursor:pointer; display:flex; align-items:center; gap:15px;" onclick="startGame('pair')">
                    <div style="font-size:24px; color:var(--accent);"><i class="fas fa-link"></i></div>
                    <div>
                        <h3 style="margin:0">è¿è¿çœ‹ (Pair Match)</h3>
                        <div style="font-size:12px; opacity:0.7;">å•äºº â€¢ åŒ¹é…çŸ¥è¯†ç‚¹</div>
                    </div>
                </div>
                <div class="glass" style="padding:20px; cursor:pointer; display:flex; align-items:center; gap:15px;" onclick="startGame('quiz')">
                    <div style="font-size:24px; color:var(--accent);"><i class="fas fa-check-square"></i></div>
                    <div>
                        <h3 style="margin:0">å¤šé€‰ç‰¹è®­ (Quiz)</h3>
                        <div style="font-size:12px; opacity:0.7;">å•äºº â€¢ å¿«é€Ÿåˆ·é¢˜</div>
                    </div>
                </div>
                <div class="glass" style="padding:20px; cursor:pointer; display:flex; align-items:center; gap:15px;" onclick="nav('duel')">
                    <div style="font-size:24px; color:var(--accent);"><i class="fas fa-users"></i></div>
                    <div>
                        <h3 style="margin:0">çº¿ä¸Šå¯¹å†³å¤§å… (PVP Lobby)</h3>
                        <div style="font-size:12px; opacity:0.7;">å¤šäºº â€¢ å®æ—¶æ•°æ®åº“åŒ¹é…</div>
                    </div>
                </div>
            </div>

            <div id="game-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--glass); z-index:500; padding:20px; backdrop-filter:blur(15px);">
                <div style="max-width:600px; margin:0 auto; padding-top:40px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <b id="game-name">Game</b>
                        <button class="small ghost" onclick="document.getElementById('game-overlay').style.display='none'">é€€å‡º</button>
                    </div>
                    <div id="g-pair" style="display:none;">
                        <div class="game-grid" id="pair-board"></div>
                    </div>
                    <div id="g-quiz" style="display:none; text-align:center;">
                        <h2 id="qz-q" style="margin-bottom:30px;">Q</h2>
                        <div id="qz-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-duel" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>âš¡ï¸ çº¿ä¸Šå¯¹å†³</h1>
                <button class="small" style="width:auto;" onclick="createRoom()">â• åˆ›å»ºæˆ¿é—´</button>
            </div>
            
            <div class="glass" style="padding:15px; margin-bottom:20px;">
                <p style="margin:0; font-size:13px; color:var(--text-sub);">
                    <i class="fas fa-database"></i> æ•°æ®å®æ—¶åŒæ­¥è‡³ Supabase æ•°æ®åº“
                </p>
            </div>
            
            <button class="ghost small" onclick="loadRooms()" style="margin-bottom:10px; width:100%;">ğŸ”„ åˆ·æ–°æˆ¿é—´åˆ—è¡¨</button>
            <div id="room-list">åŠ è½½ä¸­...</div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="glass" style="padding:20px;">
                <div class="capsule-row" id="sub-capsules"></div>
                <input id="sub-title" placeholder="æ ‡é¢˜ / é¢˜ç›® (Title)">
                <textarea id="sub-content" rows="4" placeholder="æ­£æ–‡å†…å®¹ / è§£é‡Š..."></textarea>
                <input id="sub-ex" placeholder="ä¾‹å­ / ç­”æ¡ˆ (Answer)">
                <button onclick="submitData()" style="margin-top:10px;">æäº¤è‡³æ•°æ®åº“</button>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>âš™ï¸ è®¾ç½®</h1>
            <div class="glass" style="padding:20px; margin-bottom:20px;">
                <h3>ä¸»é¢˜é¢œè‰²</h3>
                <div style="display:flex; gap:10px;">
                    <div style="width:30px; height:30px; border-radius:50%; background:#007AFF; cursor:pointer;" onclick="setTheme('blue')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#34C759; cursor:pointer;" onclick="setTheme('green')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#AF52DE; cursor:pointer;" onclick="setTheme('purple')"></div>
                    <div style="width:30px; height:30px; border-radius:50%; background:#222; border:1px solid #fff; cursor:pointer;" onclick="setTheme('dark')"></div>
                </div>
            </div>
            <div class="glass" style="padding:20px;">
                <h3>å½“å‰è´¦å·</h3>
                <p>Email: <span id="set-email">...</span></p>
                <p>ID: <span id="set-id" style="font-size:12px; color:#999;">...</span></p>
            </div>
        </div>

    </div>

    <div class="modal-mask" id="login-modal">
        <div class="modal-box">
            <h2>DSE Hub</h2>
            <input id="lg-email" placeholder="Email">
            <input id="lg-pwd" type="password" placeholder="Password">
            <button onclick="doAuth('in')" style="margin-bottom:10px;">ç™»å½•</button>
            <button class="ghost" onclick="doAuth('up')">æ³¨å†Œ</button>
            <p id="lg-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // =========================================================
        // âš ï¸ é…ç½®åŒºåŸŸï¼šè¯·å¡«å…¥ä½ çš„ Project URL å’Œ Anon Key
        // =========================================================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co'; // æ›¿æ¢æˆä½ çš„Supabase URL
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr'; // æ›¿æ¢æˆä½ çš„Supabase anon key
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // å…¨å±€å˜é‡
        let user = null;
        let profile = null;
        let curCat = 'all';
        let formCat = 'chi';
        const cats = [
            {k:'chi',n:'ä¸­æ–‡'}, {k:'eng',n:'è‹±æ–‡'}, {k:'math',n:'æ•°å­¦'}, 
            {k:'cs',n:'å…¬ç¤¾ç§‘'}, {k:'phy',n:'ç‰©ç†'}, {k:'chem',n:'åŒ–å­¦'}
        ];

        // åˆå§‹åŒ–
        window.onload = async () => {
            initCapsules();
            const { data } = await sb.auth.getSession();
            if(data.session) {
                user = data.session.user;
                await loadProfile();
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
        };

        function initCapsules() {
            // çŸ¥è¯†åº“ç­›é€‰
            document.getElementById('filter-capsules').innerHTML = 
                `<div class="capsule active" onclick="setCat('all',this)">å…¨éƒ¨</div>` +
                cats.map(c => `<div class="capsule" onclick="setCat('${c.k}',this)">${c.n}</div>`).join('');
            
            // æŠ•ç¨¿åˆ†ç±»
            document.getElementById('sub-capsules').innerHTML = 
                cats.map(c => `<div class="capsule ${c.k==='chi'?'active':''}" onclick="setFormCat('${c.k}',this)">${c.n}</div>`).join('');
        }

        async function loadProfile() {
            // å°è¯•è¯»å– Profileï¼Œå¦‚æœå¤±è´¥(æ¯”å¦‚æ–°ç”¨æˆ·)åˆ™ç”¨ä¸´æ—¶æ•°æ®ï¼Œé˜²æ­¢ç™½å±
            let { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
            profile = data || { id: user.id, username: user.email.split('@')[0], score: 0 };
            
            // æ›´æ–° UI
            document.getElementById('u-nm').innerText = profile.username;
            document.getElementById('u-sc').innerText = profile.score + ' pts';
            document.getElementById('set-email').innerText = user.email;
            document.getElementById('set-id').innerText = user.id;
            document.getElementById('login-modal').style.display = 'none';
            nav('home');
        }

        // ================= æ ¸å¿ƒåŠŸèƒ½ï¼šçº¿ä¸Šå¯¹å†³ (Real PVP) =================
        async function loadRooms() {
            // è¯»å–æ•°æ®åº“çœŸå®æˆ¿é—´
            const { data, error } = await sb.from('duel_rooms')
                .select('*')
                .neq('status', 'finished') // åªæ˜¾ç¤ºæ²¡ç»“æŸçš„
                .order('created_at', { ascending: false });

            if(error) return alert("è¯»å–å¤±è´¥: " + error.message);

            const listEl = document.getElementById('room-list');
            if(!data || data.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6;">æš‚æ— æˆ¿é—´ï¼Œè¯·åˆ›å»ºä¸€ä¸ª</div>';
                return;
            }

            listEl.innerHTML = data.map(r => {
                const isFull = r.player2_id != null;
                const isMine = r.player1_id === user.id;
                let statusBadge = isFull ? `<span style="color:red">â— æ¿€æˆ˜ä¸­</span>` : `<span style="color:#34C759">â— ç­‰å¾…ä¸­</span>`;
                
                let actionBtn = '';
                if(isMine) actionBtn = `<button class="small ghost" disabled>æˆ‘çš„æˆ¿é—´</button>`;
                else if(isFull) actionBtn = `<button class="small ghost" disabled>å·²æ»¡</button>`;
                else actionBtn = `<button class="small" onclick="joinRoom(${r.id})">åŠ å…¥</button>`;

                return `
                <div class="glass" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold;">Room #${r.id} ${statusBadge}</div>
                        <div style="font-size:12px; color:#777;">Host: ${r.player1_name || 'Player'}</div>
                    </div>
                    ${actionBtn}
                </div>`;
            }).join('');
        }

        async function createRoom() {
            const { error } = await sb.from('duel_rooms').insert({
                player1_id: user.id,
                player1_name: profile.username,
                status: 'waiting'
            });
            if(error) alert(error.message);
            else { alert("âœ… æˆ¿é—´å·²åˆ›å»ºï¼"); loadRooms(); }
        }

        async function joinRoom(rid) {
            // çœŸå®å†™å…¥æ•°æ®åº“ï¼šæŠŠæˆ‘çš„IDå¡«å…¥ player2_id
            const { error } = await sb.from('duel_rooms').update({
                player2_id: user.id,
                player2_name: profile.username,
                status: 'playing'
            }).eq('id', rid);

            if(error) alert(error.message);
            else { 
                alert("âš”ï¸ åŠ å…¥æˆåŠŸï¼æ¸¸æˆå¼€å§‹ï¼"); 
                // è¿›å…¥æ¸¸æˆé€»è¾‘ (å¤ç”¨ Quiz ç•Œé¢)
                startGame('quiz'); 
            }
        }

        // ================= å¸¸è§„åŠŸèƒ½ (DBäº¤äº’) =================
        async function fetchHome() {
            const k = document.getElementById('search-input').value;
            let q = sb.from('submissions').select('*');
            if(curCat !== 'all') q = q.eq('category', curCat);
            if(k) q = q.ilike('title', `%${k}%`);
            
            const { data } = await q;
            document.getElementById('home-list').innerHTML = (data||[]).map(i => `
                <div class="glass" style="padding:15px; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:12px; background:var(--accent); color:#fff; padding:2px 8px; border-radius:4px;">${i.category}</span>
                    </div>
                    <h3 style="margin:5px 0;">${i.title}</h3>
                    <div style="color:var(--text-sub);">${i.content}</div>
                </div>
            `).join('');
        }

        async function fetchChat() {
            // è¯»å–æœ€æ–°çš„30æ¡ç•™è¨€
            const { data } = await sb.from('feedbacks').select('*').order('created_at', {ascending:false}).limit(30);
            const el = document.getElementById('chat-list');
            if(!data) return;

            el.innerHTML = data.map(m => {
                const isPriv = m.target_id != null;
                // æƒé™è¿‡æ»¤ï¼šå¦‚æœæ˜¯ç§ä¿¡ï¼Œåªæœ‰ä½œè€…å’Œç›®æ ‡(è¿™é‡Œç®€åŒ–ä¸ºåªæœ‰ä½œè€…)èƒ½çœ‹
                // å®é™…ä¸Š admin åŠŸèƒ½éœ€è¦åå°ï¼Œè¿™é‡Œä»…åšå±•ç¤ºé€»è¾‘
                if(isPriv && m.author_id !== user.id && m.target_id !== user.id) return '';
                
                return `
                <div style="margin-bottom:10px; padding:10px; background:${isPriv?'rgba(255,0,0,0.05)':'rgba(255,255,255,0.5)'}; border-radius:10px;">
                    <div style="font-size:12px; font-weight:bold; color:var(--accent);">
                        ${m.author_name || 'User'} ${isPriv ? '<i class="fas fa-lock"></i>' : ''}
                    </div>
                    <div>${m.content}</div>
                </div>`;
            }).join('');
        }

        async function postChat() {
            const txt = document.getElementById('chat-txt').value;
            const isPriv = document.getElementById('chat-priv').checked;
            if(!txt) return;
            
            await sb.from('feedbacks').insert({
                author_id: user.id,
                author_name: profile.username,
                content: txt,
                target_id: isPriv ? user.id : null // æ¼”ç¤ºï¼šç§ä¿¡å‘ç»™è‡ªå·±
            });
            document.getElementById('chat-txt').value = '';
            fetchChat();
        }

        async function submitData() {
            const { error } = await sb.from('submissions').insert({
                category: formCat,
                title: document.getElementById('sub-title').value,
                content: document.getElementById('sub-content').value,
                example: document.getElementById('sub-ex').value,
                author_id: user.id,
                author_name: profile.username
            });
            if(error) alert("å¤±è´¥: "+error.message);
            else { alert("æŠ•ç¨¿æˆåŠŸï¼"); nav('home'); }
        }

        // ================= æ¸¸æˆé€»è¾‘ (å¤ç”¨) =================
        let gameData = [];
        let firstPick = null;

        async function startGame(type) {
            // ä»æ•°æ®åº“æ‹¿é¢˜ç›®
            const { data } = await sb.from('submissions').select('*').limit(20);
            if(!data || data.length < 4) return alert("é¢˜åº“é¢˜ç›®ä¸è¶³ï¼Œè¯·å…ˆå»æŠ•ç¨¿ï¼");

            document.getElementById('game-overlay').style.display = 'block';
            document.getElementById('g-pair').style.display = 'none';
            document.getElementById('g-quiz').style.display = 'none';

            if(type === 'pair') {
                document.getElementById('g-pair').style.display = 'block';
                document.getElementById('game-name').innerText = 'è¿è¿çœ‹';
                setupPair(data);
            } else {
                document.getElementById('g-quiz').style.display = 'block';
                document.getElementById('game-name').innerText = 'å¤šé€‰ç‰¹è®­';
                setupQuiz(data);
            }
        }

        function setupPair(data) {
            let cards = [];
            data.slice(0, 6).forEach((d, i) => {
                cards.push({ id: i, txt: d.title, type: 'q' });
                cards.push({ id: i, txt: d.example || 'Answer', type: 'a' });
            });
            cards.sort(()=>Math.random()-0.5);
            document.getElementById('pair-board').innerHTML = cards.map((c, idx) => 
                `<div class="card" id="c-${idx}" onclick="clkCard(${idx}, ${c.id})">${c.txt.slice(0,12)}</div>`
            ).join('');
            firstPick = null;
        }

        function clkCard(idx, matchId) {
            const el = document.getElementById(`c-${idx}`);
            if(el.classList.contains('matched') || el.classList.contains('selected')) return;
            el.classList.add('selected');

            if(!firstPick) firstPick = { idx, matchId };
            else {
                if(firstPick.matchId === matchId && firstPick.idx !== idx) {
                    setTimeout(() => {
                        document.getElementById(`c-${firstPick.idx}`).classList.add('matched');
                        el.classList.add('matched');
                        firstPick = null;
                    }, 300);
                } else {
                    setTimeout(() => {
                        document.getElementById(`c-${firstPick.idx}`).classList.remove('selected');
                        el.classList.remove('selected');
                        firstPick = null;
                    }, 500);
                }
            }
        }

        function setupQuiz(data) {
            gameData = data;
            nextQ();
        }

        function nextQ() {
            const q = gameData[Math.floor(Math.random()*gameData.length)];
            document.getElementById('qz-q').innerText = q.title;
            const ans = q.example || "A";
            const opts = [ans, "Option 1", "Option 2", "Option 3"].sort(()=>Math.random()-0.5);
            
            document.getElementById('qz-opts').innerHTML = opts.map(o => 
                `<button class="ghost" onclick="alert('${o===ans?'Bingo!':'Wrong!'}'); nextQ()">${o}</button>`
            ).join('');
        }

        // ================= åŸºç¡€é€»è¾‘ =================
        function auth(act) {
            const e = document.getElementById('lg-email').value;
            const p = document.getElementById('lg-pwd').value;
            if(act === 'up') sb.auth.signUp({email:e, password:p}).then(r => r.error ? alert(r.error.message) : alert('è¯·æŸ¥æ”¶é‚®ä»¶ç¡®è®¤'));
            else sb.auth.signInWithPassword({email:e, password:p}).then(r => r.error ? alert(r.error.message) : location.reload());
        }
        window.doAuth = auth; // æš´éœ²ç»™ HTML

        function logout() { sb.auth.signOut().then(() => location.reload()); }

        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+page).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                el.classList.add('active');
            }
            // åˆ‡æ¢é¡µé¢æ—¶è‡ªåŠ¨åˆ·æ–°æ•°æ®
            if(page === 'home') fetchHome();
            if(page === 'chat') fetchChat();
            if(page === 'duel') loadRooms();
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }

        function setCat(c, el) { curCat=c; initCapsules(); el.classList.add('active'); fetchHome(); }
        function setFormCat(c, el) { formCat=c; initCapsules(); el.classList.add('active'); } // ä¿®æ­£èƒ¶å›Šæ ·å¼
        function setTheme(t) { document.body.setAttribute('data-theme', t); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>
