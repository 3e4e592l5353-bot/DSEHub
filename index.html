<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DSE Hub v53 - Pro Clean</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ================= ğŸ¨ Apple Design System (Web) ================= */
        :root {
            --bg-color: #F5F5F7;
            --card-bg: rgba(255, 255, 255, 0.85);
            --sidebar-bg: rgba(255, 255, 255, 0.7);
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --accent: #007AFF;
            --accent-hover: #005ECB;
            --danger: #FF3B30;
            --success: #34C759;
            --radius: 18px;
            --shadow: 0 8px 40px rgba(0,0,0,0.08);
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        }

        [data-theme="dark"] {
            --bg-color: #000000;
            --card-bg: rgba(28, 28, 30, 0.85);
            --sidebar-bg: rgba(30, 30, 30, 0.7);
            --text-primary: #F5F5F7;
            --text-secondary: #98989D;
            --shadow: 0 8px 40px rgba(0,0,0,0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: var(--font-stack);
            background: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
            /* æå…‰èƒŒæ™¯åŠ¨ç”» */
            background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.3) 0px, transparent 50%),
                              radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.3) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.3) 0px, transparent 50%);
            background-size: 100% 100%;
        }

        /* ================= ğŸ“± ä¾§è¾¹æ  (iPadOS Style) ================= */
        .sidebar {
            width: 260px;
            height: 100%;
            background: var(--sidebar-bg);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid rgba(0,0,0,0.05);
            padding: 30px 16px;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .brand {
            font-size: 20px; font-weight: 800; letter-spacing: -0.5px;
            margin-bottom: 30px; padding-left: 12px;
            background: linear-gradient(135deg, #007AFF, #5856D6);
            -webkit-background-clip: text; color: transparent;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px; font-weight: 500;
            color: var(--text-secondary);
            transition: 0.2s;
            display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover { background: rgba(0,0,0,0.05); color: var(--text-primary); }
        .nav-item.active { background: var(--accent); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(0,122,255,0.25); }
        .nav-item i { width: 20px; text-align: center; }

        /* ================= ğŸ“„ ä¸»å†…å®¹åŒº ================= */
        .main {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            position: relative;
            padding: 40px 8%; /* å®½å±ç•™ç™½ */
            scroll-behavior: smooth;
        }

        .page { 
            display: none; 
            max-width: 900px; 
            margin: 0 auto; 
            animation: fadeScale 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        .page.active { display: block; }

        @keyframes fadeScale { from{opacity:0;transform:scale(0.98) translateY(10px);} to{opacity:1;transform:scale(1) translateY(0);} }

        /* æ ‡é¢˜å¤§å­— */
        h1 { font-size: 34px; font-weight: 800; margin: 0 0 24px 0; letter-spacing: -1px; }

        /* å¡ç‰‡å®¹å™¨ */
        .card {
            background: var(--card-bg);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.3);
            margin-bottom: 24px;
        }

        /* ğŸ›  æ§ä»¶ (Inputs & Buttons) */
        input, select, textarea {
            width: 100%; padding: 14px; margin-bottom: 12px;
            background: rgba(0,0,0,0.05); border: none; border-radius: 12px;
            font-size: 16px; color: var(--text-primary); font-family: inherit;
            transition: 0.2s;
        }
        input:focus, textarea:focus { background: rgba(0,0,0,0.08); transform: scale(1.005); }

        button {
            background: var(--accent); color: white;
            border: none; padding: 14px 24px; border-radius: 12px;
            font-size: 15px; font-weight: 600; cursor: pointer;
            width: 100%; transition: 0.2s; box-shadow: 0 2px 10px rgba(0,122,255,0.2);
        }
        button:active { transform: scale(0.96); }
        button.text-btn { background: transparent; color: var(--accent); box-shadow: none; padding: 8px; width: auto; }
        button.text-btn:hover { background: rgba(0,122,255,0.1); }

        /* ğŸ“š åˆ—è¡¨é¡¹ */
        .item-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer; transition: 0.2s;
        }
        .item-row:last-child { border-bottom: none; }
        .item-row:hover { background: rgba(0,0,0,0.03); }
        
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; background: rgba(0,122,255,0.1); color: var(--accent); font-weight: 700; margin-right: 8px; }

        .detail-content { display: none; padding: 16px; font-size: 15px; line-height: 1.6; color: var(--text-primary); white-space: pre-wrap; background: rgba(0,0,0,0.02); }
        
        /* ğŸ® æ¸¸æˆç½‘æ ¼ */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .g-card {
            aspect-ratio: 1; background: #fff; border-radius: 16px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            font-weight: 700; font-size: 14px; padding: 8px; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s;
            border: 2px solid transparent; user-select: none;
        }
        .g-card.active { border-color: var(--accent); transform: scale(0.95); background: #F0F9FF; color: var(--accent); }
        .g-card.matched { opacity: 0; transform: scale(0); pointer-events: none; }
        .g-card.topic { color: var(--accent); background: #EEF2FF; }

        /* ğŸ“± ç§»åŠ¨ç«¯é€‚é… */
        .mobile-header { display: none; padding: 15px 20px; align-items: center; justify-content: space-between; z-index: 200; position: fixed; top: 0; width: 100%; background: var(--sidebar-bg); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .menu-btn { font-size: 24px; cursor: pointer; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); width: 280px; box-shadow: 5px 0 30px rgba(0,0,0,0.1); }
            .sidebar.show { transform: translateX(0); }
            .mobile-header { display: flex; }
            .main { padding: 80px 20px 40px 20px; } /* é¡¶éƒ¨ç•™å‡º header é«˜åº¦ */
            h1 { font-size: 28px; }
            .card { padding: 20px; border-radius: 20px; }
        }

        /* Toast */
        #toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 50px;
            font-size: 14px; font-weight: 600; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px);
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="mobile-header">
        <div class="menu-btn" onclick="toggleSidebar()">â‰¡</div>
        <div style="font-weight:700;">DSE HUB v53</div>
        <div onclick="toggleTheme()" style="font-size:20px;">â—‘</div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand">ğŸš€ DSE HUB v53</div>
        
        <div class="nav-item active" onclick="nav('home', this)"><i>ğŸ“š</i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('game', this)"><i>ğŸ®</i> è¿è¿çœ‹</div>
        <div class="nav-item" onclick="nav('chat', this)"><i>ğŸ’¬</i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('submit', this)"><i>ğŸ“</i> æŠ•ç¨¿</div>
        
        <div style="flex:1"></div> <div class="nav-item" onclick="checkAdmin()"><i>ğŸ›¡</i> ç®¡ç†åå°</div>
        <div class="nav-item" onclick="toggleTheme()" style="display:none;" id="pc-theme-btn"><i>â—‘</i> åˆ‡æ¢ä¸»é¢˜</div>
    </div>

    <div class="main" onclick="closeSidebarMobile()">
        
        <div id="view-home" class="page active">
            <h1>çŸ¥è¯†å®åº“</h1>
            <div class="card" style="padding:10px; display:flex; gap:10px; align-items:center; background:rgba(255,255,255,0.5);">
                <span style="padding-left:10px; opacity:0.5;">ğŸ”</span>
                <input id="search" placeholder="æœç´¢å…³é”®è¯..." style="margin:0; background:transparent;" onkeyup="renderHome()">
                <select id="filter" onchange="renderHome()" style="width:auto; margin:0; padding-right:30px;">
                    <option value="all">å…¨ç§‘</option>
                    <option value="chi">ä¸­æ–‡</option>
                    <option value="eng">English</option>
                    <option value="math">Math</option>
                    <option value="ls">å…¬ç¤¾ç§‘</option>
                </select>
            </div>
            <div class="card" style="padding:0; overflow:hidden;" id="home-list">
                </div>
        </div>

        <div id="view-game" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>è¿è¿çœ‹</h1>
                <button class="text-btn" onclick="initGame()">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="card">
                <p style="color:var(--text-secondary); margin-top:0;">è§„åˆ™ï¼šæ¶ˆé™¤æ‰€æœ‰ Example (ç™½è‰²)ï¼ŒTopic (è“è‰²) æ‰ä¼šæ¶ˆå¤±ã€‚</p>
                <div id="game-board" class="game-grid"></div>
            </div>
        </div>

        <div id="view-chat" class="page">
            <h1>ç•™è¨€æ¿</h1>
            <div class="card">
                <div id="chat-box" style="height:400px; overflow-y:auto; margin-bottom:15px;"></div>
                <div style="display:flex; gap:10px;">
                    <input id="u-name" placeholder="æ˜µç§°" style="width:30%;">
                    <input id="u-msg" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                    <button onclick="sendMsg()" style="width:auto;">ğŸš€</button>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>æŠ•ç¨¿</h1>
            <div class="card">
                <select id="sub-cat">
                    <option value="chi">ä¸­æ–‡</option><option value="eng">English</option>
                    <option value="math">Math</option><option value="ls">å…¬ç¤¾ç§‘</option>
                </select>
                <input id="sub-t" placeholder="æ ‡é¢˜ (e.g. å¤¸å¼ æ‰‹æ³•)">
                <textarea id="sub-d" rows="5" placeholder="è§£é‡Š..."></textarea>
                <textarea id="sub-ex" rows="3" placeholder="ä¾‹å­ (ç”¨äºè¿è¿çœ‹): ç”¨ // åˆ†éš”&#10;e.g. ä¾‹å­A // ä¾‹å­B" style="background:rgba(255,250,230,0.5); border:1px solid rgba(255,200,0,0.3);"></textarea>
                <button onclick="submitData()">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1>åå°ç®¡ç†</h1>
            <div class="card" style="padding:0;">
                <div style="padding:15px; border-bottom:1px solid #eee; display:flex; gap:10px;">
                    <button class="text-btn" onclick="renderAdmin('pending')">å¾…å®¡</button>
                    <button class="text-btn" onclick="renderAdmin('approved')">å·²å‘</button>
                </div>
                <div id="admin-list"></div>
            </div>
        </div>

    </div>

    <div id="toast"></div>

    <script>
        // é…ç½® & æ¨¡æ‹Ÿæ•°æ®
        const CONFIG = { URL: 'https://alsalyskulozwakhmzoa.supabase.co', KEY: 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr' };
        let appData = [
            {id:1, cat:'chi', t:'æ˜å–»', d:'æœ¬ä½“ã€å–»ä½“éƒ½å‡ºç°ï¼Œç”¨â€œåƒâ€è¿æ¥ã€‚', ex:'è„¸åƒçº¢è‹¹æœ//é›¨åƒæ–­äº†çº¿çš„ç å­', status:'approved', created_at: new Date().toISOString()},
            {id:2, cat:'eng', t:'Passive Voice', d:'Subject receives the action.', ex:'The cake was eaten//Homework was done', status:'approved', created_at: new Date().toISOString()},
            {id:3, cat:'math', t:'Pythagoras', d:'aÂ² + bÂ² = cÂ² (Right angle only)', ex:'3,4,5//5,12,13', status:'approved', created_at: new Date().toISOString()},
            {id:99, cat:'GB_MSG', t:'System', d:'Welcome to v53 Pro Clean!', status:'approved', created_at: new Date().toISOString()}
        ];
        let db = null;
        let isAdmin = false;

        // åˆå§‹åŒ–
        window.onload = async () => {
            if(window.innerWidth > 768) document.getElementById('pc-theme-btn').style.display = 'flex';
            
            if(!CONFIG.URL.includes('YOUR_') && typeof supabase !== 'undefined') {
                db = supabase.createClient(CONFIG.URL, CONFIG.KEY);
                await loadData();
            } else {
                toast('âš ï¸ æ— æ•°æ®åº“ Keyï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼');
            }
            renderHome();
            renderChat();
        };

        async function loadData() {
            const {data} = await db.from('submissions').select('*').order('created_at',{ascending:false});
            if(data) appData = data;
        }

        // äº¤äº’é€»è¾‘
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) el.classList.add('active');
            closeSidebarMobile();
            if(id==='game') initGame();
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
        function closeSidebarMobile() { if(window.innerWidth<768) document.getElementById('sidebar').classList.remove('show'); }
        
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 3000);
        }

        function toggleTheme() {
            const doc = document.documentElement;
            doc.setAttribute('data-theme', doc.getAttribute('data-theme')==='dark'?'light':'dark');
        }

        // 1. çŸ¥è¯†åº“
        function renderHome() {
            const kw = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('filter').value;
            const list = appData.filter(i=> i.status==='approved' && i.cat!=='GB_MSG' && (cat==='all'||i.cat===cat) && (i.t.toLowerCase().includes(kw)||i.d.includes(kw)));
            
            document.getElementById('home-list').innerHTML = list.map(i=>`
                <div class="item-row" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">
                    <div><span class="badge">${i.cat.toUpperCase()}</span><b>${i.t}</b></div>
                    <span style="color:#ccc">â€º</span>
                </div>
                <div class="detail-content">${i.d}<br><br>${i.ex?`<span style="opacity:0.6;font-size:13px;">ğŸ’¡ ${i.ex}</span>`:''}</div>
            `).join('') || '<div style="padding:20px;text-align:center;color:#999">ç©ºç©ºå¦‚ä¹Ÿ</div>';
        }

        // 2. æ¸¸æˆ (é€»è¾‘ä¼˜åŒ–ç‰ˆ)
        let gState = { sel: null, lock: false };
        function initGame() {
            const pool = appData.filter(i=>i.status==='approved' && i.cat!=='GB_MSG' && i.ex).sort(()=>Math.random()-0.5).slice(0,4);
            if(pool.length<2) return document.getElementById('game-board').innerHTML='<div style="text-align:center;width:100%">é¢˜ç›®ä¸è¶³</div>';
            
            let cards = [];
            pool.forEach(p => {
                cards.push({ id: p.id, txt: p.t, type: 'topic' }); // æ¯é¢˜
                p.ex.split(/(\/\/|\n)+/).filter(s=>s.length>1).slice(0,3).forEach(e => {
                    cards.push({ id: p.id, txt: e, type: 'ex' }); // ä¾‹å­
                });
            });
            
            document.getElementById('game-board').innerHTML = cards.sort(()=>Math.random()-0.5).map((c,i)=>`
                <div id="c-${i}" class="g-card ${c.type}" onclick="tapCard(${i}, '${c.id}', '${c.type}')">${c.txt}</div>
            `).join('');
            gState = { sel: null, lock: false };
        }

        function tapCard(idx, pid, type) {
            if(gState.lock) return;
            const el = document.getElementById(`c-${idx}`);
            if(el.classList.contains('matched')) return;

            // å–æ¶ˆé€‰ä¸­
            if(gState.sel && gState.sel.idx === idx) {
                el.classList.remove('active'); gState.sel = null; return;
            }

            el.classList.add('active');

            if(!gState.sel) {
                gState.sel = { idx, pid, type };
            } else {
                const prev = gState.sel;
                const prevEl = document.getElementById(`c-${prev.idx}`);
                
                // é…å¯¹é€»è¾‘: åŒä¸€ID (PID) ä¸” ç±»å‹ä¸åŒ (ä¸€æ¯ä¸€å­)
                if(prev.pid === pid && prev.type !== type) {
                    // æˆåŠŸ
                    const exEl = type==='ex'?el:prevEl;
                    const topEl = type==='topic'?el:prevEl;

                    exEl.classList.remove('active'); exEl.classList.add('matched'); // ä¾‹å­æ¶ˆå¤±
                    topEl.classList.remove('active'); // æ¯é¢˜å–æ¶ˆé«˜äº®

                    // æ£€æŸ¥è¯¥æ¯é¢˜æ˜¯å¦è¿˜æœ‰å‰©ä½™ä¾‹å­
                    const rem = Array.from(document.querySelectorAll(`.g-card:not(.matched)`)).some(d => d.innerText !== topEl.innerText && d.onclick.toString().includes(`'${pid}'`));
                    
                    if(!rem) topEl.classList.add('matched'); // æ²¡ä¾‹å­äº†ï¼Œæ¯é¢˜ä¹Ÿæ¶ˆå¤±
                    
                    toast('âœ¨ Bingo!');
                    gState.sel = null;
                } else {
                    // å¤±è´¥
                    gState.lock = true;
                    setTimeout(()=>{
                        el.classList.remove('active');
                        prevEl.classList.remove('active');
                        gState.sel = null;
                        gState.lock = false;
                    }, 500);
                }
            }
        }

        // 3. ç•™è¨€
        async function sendMsg() {
            const p = {
                cat: 'GB_MSG',
                t: document.getElementById('u-name').value || 'User',
                d: document.getElementById('u-msg').value,
                status: 'approved', created_at: new Date().toISOString()
            };
            if(!p.d) return;
            appData.unshift(p); renderChat();
            document.getElementById('u-msg').value = '';
            if(db) await db.from('submissions').insert([p]);
        }
        function renderChat() {
            document.getElementById('chat-box').innerHTML = appData.filter(i=>i.cat==='GB_MSG').map(i=>`
                <div style="margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.03); border-radius:12px;">
                    <div style="font-weight:bold; font-size:13px; color:var(--accent)">${i.t}</div>
                    <div style="font-size:15px;">${i.d}</div>
                </div>
            `).join('');
        }

        // 4. æŠ•ç¨¿
        async function submitData() {
            const p = {
                cat: document.getElementById('sub-cat').value,
                t: document.getElementById('sub-t').value,
                d: document.getElementById('sub-d').value,
                ex: document.getElementById('sub-ex').value,
                status: 'pending', created_at: new Date()
            };
            if(!p.t) return toast('âŒ å†™ç‚¹ä¸œè¥¿');
            if(db) await db.from('submissions').insert([p]);
            else appData.unshift(p);
            toast('âœ… å·²æäº¤');
            document.getElementById('sub-t').value = '';
            document.getElementById('sub-d').value = '';
        }

        // 5. Admin
        function checkAdmin() {
            if(!isAdmin && prompt('Pass')!=='admin') return toast('âŒ é”™è¯¯');
            isAdmin = true; nav('admin'); renderAdmin('pending');
        }
        function renderAdmin(st) {
            document.getElementById('admin-list').innerHTML = appData.filter(i=>i.status===st && i.cat!=='GB_MSG').map(i=>`
                <div class="item-row">
                    <div><b>${i.t}</b> <span style="font-size:12px;color:#999">${i.d.substr(0,10)}</span></div>
                    <div>
                        ${st==='pending' ? `<button class="text-btn" onclick="audit('${i.id}','approved')">é€šè¿‡</button>`:''}
                        <button class="text-btn" style="color:red" onclick="audit('${i.id}','deleted')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        async function audit(id, s) {
            const it = appData.find(x=>x.id==id); if(it) it.status = s;
            if(db) await db.from('submissions').update({status:s}).eq('id',id);
            renderAdmin(s==='approved'?'pending':'approved');
        }
    </script>
</body>
</html>
