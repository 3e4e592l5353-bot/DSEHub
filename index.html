<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v63 - Auto Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ================= ğŸ Mac é£æ ¼ (æ·±ç°ç‰ˆ) ================= */
        :root {
            --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            
            /* æ·±ç©ºç°ä¸»é¢˜ (Dark Space Grey) */
            --bg: #1e1e1e;            /* è¿™ç§ç°æ¯”çº¯é»‘æ›´æœ‰è´¨æ„Ÿ */
            --sidebar: #252526;       /* ä¾§è¾¹æ ç¨æµ… */
            --card: #2d2d2d;          /* å¡ç‰‡æ‚¬æµ®æ„Ÿ */
            --text-main: #e0e0e0;     /* æŸ”å’Œç™½ */
            --text-sub: #858585;      /* æ¬¡è¦æ–‡å­— */
            --primary: #0a84ff;       /* macOS è“è‰² */
            --border: #3e3e3e;        /* è¾¹æ¡† */
            --input-bg: #333333;      /* è¾“å…¥æ¡†èƒŒæ™¯ */
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { 
            width: 250px; background: var(--sidebar); border-right: 1px solid var(--border);
            padding: 20px; display: flex; flex-direction: column; z-index: 100;
        }
        
        /* ğŸš¥ ç»å…¸çš„çº¢ç»¿ç¯ */
        .traffic-lights { display: flex; gap: 8px; margin-bottom: 25px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .r { background: #ff5f57; } .y { background: #febc2e; } .g { background: #28c840; }

        .nav-item { 
            padding: 10px 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; 
            color: var(--text-sub); display: flex; align-items: center; font-size: 14px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }
        .nav-item.active { background: rgba(10, 132, 255, 0.15); color: var(--primary); font-weight: 500; }

        .main { flex: 1; overflow-y: auto; padding: 40px; position: relative; }
        .page { display: none; max-width: 700px; margin: 0 auto; animation: fadeUp 0.3s ease-out; }
        .page.active { display: block; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* å¡ç‰‡ä¸æ§ä»¶ */
        .card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 20px; }
        
        input, textarea, select { 
            width: 100%; padding: 10px 12px; margin-bottom: 12px; background: var(--input-bg); 
            border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; font-size: 14px; outline: none;
        }
        input:focus { border-color: var(--primary); }
        
        button { 
            background: var(--primary); color: white; border: none; padding: 10px 16px; 
            border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; width: 100%; 
        }
        button:hover { filter: brightness(1.1); }
        button.ghost { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        button.small { width: auto; padding: 4px 10px; font-size: 12px; }

        /* è¯„è®ºåŒº */
        .fb-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
        .fb-item:last-child { border-bottom: none; }
        .chip { background: var(--input-bg); padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; color: var(--text-sub); }

        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .menu-toggle { display: none; position: fixed; top: 15px; left: 15px; z-index: 200; background: var(--card); border: 1px solid var(--border); padding: 5px 10px; border-radius: 6px; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height: 100%; }
            .sidebar.show { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            .menu-toggle { display: block; }
            .main { padding: 60px 20px; }
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleMenu()">â˜°</button>

    <div class="sidebar" id="sidebar">
        <div class="traffic-lights"><div class="dot r"></div><div class="dot y"></div><div class="dot g"></div></div>
        <div style="font-weight:700; font-size:18px; margin-bottom:20px; color:var(--text-main);">DSE Hub</div>
        
        <div id="user-zone" style="background:var(--input-bg); padding:12px; border-radius:8px; margin-bottom:20px; text-align:center;">
            <div id="u-name" style="margin-bottom:8px; font-size:13px; font-weight:500;">æœªç™»å½•</div>
            <button class="small ghost" onclick="nav('auth')">ç™»å½• / æ³¨å†Œ</button>
        </div>

        <div class="nav-item active" onclick="nav('home')">ğŸ“š çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('duel')">âš”ï¸ åœ¨çº¿å¯¹æˆ˜</div>
        <div class="nav-item" onclick="nav('submit')">ğŸ“ æŠ•ç¨¿</div>
        <div class="nav-item" onclick="tryAdmin()">âš™ï¸ ç®¡ç†å‘˜</div>
    </div>

    <div class="main">
        
        <div id="view-auth" class="page">
            <div class="card" style="max-width:350px; margin:50px auto; text-align:center;">
                <h3 style="margin-top:0;">è´¦å·é€šè¡Œè¯</h3>
                <div id="auth-status" style="margin-bottom:15px; font-size:12px; color:var(--text-sub);">
                    è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç 
                </div>
                
                <input id="email" type="email" placeholder="Email">
                <input id="pass" type="password" placeholder="Password (6ä½+)">
                <input id="username" placeholder="æ˜µç§° (ä»…æ³¨å†Œéœ€å¡«)" style="display:none;">

                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="btn-login" onclick="handleLogin()">ç™»å½•</button>
                    <button id="btn-reg-mode" class="ghost" onclick="toggleMode()">æ²¡æœ‰è´¦å·?</button>
                </div>
                <button id="btn-reg-action" onclick="handleRegister()" style="display:none; background:#34c759; margin-top:10px;">æ³¨å†Œå¹¶å‘é€é‚®ä»¶</button>
                <button id="btn-logout" class="ghost" onclick="logout()" style="display:none; margin-top:20px; color:#ff453a; border-color:#ff453a;">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div id="view-home" class="page active">
            <div class="card" style="display:flex; gap:10px;">
                <input id="search" placeholder="ğŸ” æœç´¢..." onkeyup="renderList()" style="margin:0;">
                <select id="cat-filter" onchange="renderList()" style="width:100px; margin:0;"><option value="all">å…¨éƒ¨</option><option value="math">Math</option><option value="chi">Chi</option><option value="eng">Eng</option></select>
            </div>
            <div id="list-container"></div>
        </div>

        <div id="view-duel" class="page">
            <div class="card" id="duel-lobby" style="text-align:center; padding:50px;">
                <h2>âš¡ æé€Ÿå¯¹å†³</h2>
                <p style="color:var(--text-sub)">å®æ—¶åŒ¹é…ï¼Œæ‹¼é€Ÿåº¦ã€‚</p>
                <button onclick="findMatch()" style="width:150px; margin-top:20px;">å¼€å§‹åŒ¹é…</button>
                <div id="match-msg" style="margin-top:20px; color:var(--primary);"></div>
            </div>
            <div class="card" id="duel-game" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:20px; font-weight:bold;">
                    <span style="color:var(--primary)">æˆ‘: <span id="my-s">0</span></span>
                    <span style="color:#ff453a">æ•Œ: <span id="op-s">0</span></span>
                </div>
                <div id="duel-board" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <div class="card">
                <h3>æŠ•ç¨¿æ–°é¢˜</h3>
                <input id="sub-t" placeholder="æ ‡é¢˜">
                <select id="sub-cat"><option value="math">Math</option><option value="chi">Chi</option><option value="eng">Eng</option></select>
                <textarea id="sub-d" rows="5" placeholder="è¯¦ç»†è§£ç­”..."></textarea>
                <button onclick="submitItem()" style="background:#34c759;">æäº¤</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <div class="card">
                <h3 style="color:#ff453a">å®¡æ ¸åå°</h3>
                <button class="ghost small" onclick="loadPending()" style="width:auto; margin-bottom:10px;">åˆ·æ–°</button>
                <div id="admin-list"></div>
            </div>
        </div>

    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è¿™é‡Œå¡«å…¥ä½ çš„ KEY âš ï¸âš ï¸âš ï¸
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';

        let supabase, auth;
        let currentUser = null;
        let appData = [];
        let isRegMode = false;
        let activeRoom = null;

        window.onload = async () => {
            if(SUPABASE_URL.includes('YOUR_')) return alert('è¯·å¡«å†™ API KEY');
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            auth = supabase.auth;

            // 1. åˆå§‹åŒ–æ£€æŸ¥ Session
            const { data } = await auth.getSession();
            if(data.session) handleUser(data.session.user);

            // 2. æ ¸å¿ƒä¿®å¤ï¼šç›‘å¬èº«ä»½å˜åŒ– (è‡ªåŠ¨åŒæ­¥å¤šæ ‡ç­¾é¡µ)
            auth.onAuthStateChange(async (event, session) => {
                console.log("Auth Event:", event);
                if (session?.user) {
                    // å¦‚æœåœ¨å…¶ä»–æ ‡ç­¾é¡µç™»å½•äº†ï¼Œè¿™é‡Œä¼šè‡ªåŠ¨è§¦å‘
                    await handleUser(session.user);
                    if(document.getElementById('view-auth').classList.contains('active')){
                         nav('home'); // å¦‚æœå½“å‰åœç•™åœ¨ç™»å½•é¡µï¼Œè‡ªåŠ¨åˆ‡èµ°
                    }
                } else {
                    currentUser = null;
                    updateUserUI();
                }
            });

            // 3. åŒä¿é™©ï¼šå½“çª—å£é‡æ–°è·å¾—ç„¦ç‚¹æ—¶ï¼Œå†æ¬¡æ£€æŸ¥ (é˜²æ­¢ onAuthStateChange æ¼å‘)
            window.addEventListener('focus', async () => {
                const { data } = await auth.getSession();
                if (data.session && !currentUser) {
                    await handleUser(data.session.user);
                    nav('home');
                }
            });

            loadData();
        };

        // ç”¨æˆ·é€»è¾‘
        async function handleUser(user) {
            currentUser = user;
            // è·å– usernameï¼Œæ‹¿ä¸åˆ°å°±ç”¨ email å‰ç¼€
            const { data } = await supabase.from('profiles').select('username, is_admin').eq('id', user.id).single();
            currentUser.username = data ? data.username : user.email.split('@')[0];
            currentUser.is_admin = data ? data.is_admin : false;
            updateUserUI();
        }

        function updateUserUI() {
            const el = document.getElementById('u-name');
            const btn = document.querySelector('#user-zone button');
            const logBtn = document.getElementById('btn-logout');
            
            if(currentUser) {
                el.innerHTML = `ğŸ‘‹ ${currentUser.username}` + (currentUser.is_admin ? ' <span style="color:#ff453a; font-size:10px;">ADMIN</span>' : '');
                btn.style.display = 'none'; // éšè—ç™»å½•æŒ‰é’®
                logBtn.style.display = 'block';
            } else {
                el.innerHTML = 'æœªç™»å½•';
                btn.style.display = 'inline-block';
                btn.innerText = 'ç™»å½• / æ³¨å†Œ';
                logBtn.style.display = 'none';
            }
        }

        // ç™»å½•/æ³¨å†Œé€»è¾‘
        function toggleMode() {
            isRegMode = !isRegMode;
            document.getElementById('username').style.display = isRegMode ? 'block' : 'none';
            document.getElementById('btn-reg-action').style.display = isRegMode ? 'block' : 'none';
            document.getElementById('btn-login').style.display = isRegMode ? 'none' : 'block';
            document.getElementById('btn-reg-mode').innerText = isRegMode ? 'è¿”å›ç™»å½•' : 'æ²¡æœ‰è´¦å·?';
            document.getElementById('auth-status').innerText = isRegMode ? 'æ–°ç”¨æˆ·æ³¨å†Œ' : 'è€ç”¨æˆ·ç™»å½•';
        }

        async function handleLogin() {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value;
            const { error } = await auth.signInWithPassword({ email: e, password: p });
            if(error) {
                if(error.message.includes('Email not confirmed')) alert("âŒ ä½ çš„é‚®ç®±è¿˜æ²¡éªŒè¯ï¼è¯·å»é‚®ç®±ç‚¹é“¾æ¥ã€‚");
                else alert(error.message);
            } else {
                nav('home');
            }
        }

        async function handleRegister() {
            const e = document.getElementById('email').value, p = document.getElementById('pass').value, u = document.getElementById('username').value;
            if(!u) return alert("è¯·å¡«å†™æ˜µç§°");
            
            // æ³¨å†Œæ—¶ï¼Œé‡å®šå‘ URL è®¾ä¸ºå½“å‰é¡µé¢
            const { data, error } = await auth.signUp({ 
                email: e, password: p, 
                options: { data: { username: u }, emailRedirectTo: window.location.href }
            });

            if(error) return alert(error.message);
            
            // æç¤ºç”¨æˆ·å»é‚®ç®±
            document.getElementById('auth-status').innerHTML = `<span style="color:#34c759">âœ… é‚®ä»¶å·²å‘é€ï¼<br>è¯·å»é‚®ç®±ç¡®è®¤ï¼Œç¡®è®¤å<b>å›åˆ°æœ¬é¡µé¢</b>å³å¯è‡ªåŠ¨ç™»å½•ã€‚</span>`;
            document.getElementById('email').value = '';
            document.getElementById('pass').value = '';
        }

        async function logout() { await auth.signOut(); location.reload(); }

        // æ•°æ®ä¸è¯„è®º
        async function loadData() {
            const { data } = await supabase.from('submissions').select('*').eq('status','approved').order('created_at',{ascending:false});
            appData = data || []; renderList();
        }

        function renderList() {
            const k = document.getElementById('search').value.toLowerCase();
            const c = document.getElementById('cat-filter').value;
            const filtered = appData.filter(i => (c==='all'||i.cat===c) && i.t.toLowerCase().includes(k));
            
            document.getElementById('list-container').innerHTML = filtered.map(i => `
                <div class="card" onclick="toggleDetail(this)">
                    <div style="display:flex; justify-content:space-between; font-weight:600;">
                        ${i.t} <span class="chip">${i.cat.toUpperCase()}</span>
                    </div>
                    <div class="detail" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                        <p style="color:var(--text-sub)">${i.d}</p>
                        <button class="ghost small" onclick="loadComments('${i.id}', event)">ğŸ’¬ è¯„è®ºåŒº</button>
                        <div id="cmt-${i.id}" style="margin-top:10px;"></div>
                    </div>
                </div>
            `).join('');
        }
        window.toggleDetail = (e) => { const d = e.querySelector('.detail'); d.style.display = d.style.display==='none'?'block':'none'; };

        // è¯„è®º
        window.loadComments = async (kid, e) => {
            e.stopPropagation();
            const box = document.getElementById(`cmt-${kid}`);
            // è®¢é˜…å®æ—¶è¯„è®º
            supabase.channel(`c-${kid}`).on('postgres_changes', {event:'*', schema:'public', table:'feedbacks', filter:`knowledge_id=eq.${kid}`}, ()=>renderCmts(kid)).subscribe();
            renderCmts(kid);
        }
        async function renderCmts(kid) {
            const { data } = await supabase.from('feedbacks').select('*').eq('knowledge_id', kid).order('created_at');
            let h = (data||[]).map(c => `
                <div class="fb-item">
                    <div style="display:flex; justify-content:space-between;">
                        <b style="color:var(--primary)">${c.user_name}</b>
                        ${(currentUser?.is_admin || currentUser?.username === c.user_name) ? `<span onclick="delCmt('${c.id}')" style="cursor:pointer; color:#ff453a;">ğŸ—‘ï¸</span>` : ''}
                    </div>
                    <div>${c.custom_text}</div>
                </div>`).join('');
            
            h += `<div style="display:flex; gap:5px; margin-top:10px;">
                <input id="in-${kid}" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="margin:0;">
                <button class="small" style="width:50px;" onclick="postCmt('${kid}')">å‘</button>
            </div>`;
            document.getElementById(`cmt-${kid}`).innerHTML = h;
        }
        window.postCmt = async (kid) => {
            if(!currentUser) return alert('è¯·å…ˆç™»å½•');
            const txt = document.getElementById(`in-${kid}`).value;
            if(!txt) return;
            await supabase.from('feedbacks').insert([{knowledge_id:kid, user_name:currentUser.username, custom_text:txt, is_admin:currentUser.is_admin}]);
            document.getElementById(`in-${kid}`).value = '';
        }
        window.delCmt = async (id) => { if(confirm('åˆ ?')) await supabase.from('feedbacks').delete().eq('id', id); }

        // æŠ•ç¨¿
        async function submitItem() {
            if(!currentUser) return alert('è¯·ç™»å½•');
            const t=document.getElementById('sub-t').value, d=document.getElementById('sub-d').value, c=document.getElementById('sub-cat').value;
            await supabase.from('submissions').insert([{t,d,cat:c, status:'pending', user_id:currentUser.id}]);
            alert('å·²æŠ•ç¨¿ï¼Œå¾…å®¡æ ¸'); nav('home');
        }

        // ç®¡ç†å‘˜
        async function tryAdmin() {
            if(!currentUser) return alert('è¯·ç™»å½•');
            if(currentUser.is_admin) return nav('admin');
            if(prompt('Admin Key?') === '888888') {
                await supabase.from('profiles').update({is_admin:true}).eq('id', currentUser.id);
                currentUser.is_admin = true; nav('admin'); updateUserUI();
            }
        }
        async function loadPending() {
            const {data} = await supabase.from('submissions').select('*').eq('status','pending');
            document.getElementById('admin-list').innerHTML = data.map(i=>`
                <div class="card">
                    <b>${i.t}</b><br>${i.d}<br>
                    <button class="small" style="background:#34c759; margin-top:5px;" onclick="audit('${i.id}','approved')">é€šè¿‡</button>
                    <button class="small" style="background:#ff453a; margin-top:5px;" onclick="audit('${i.id}','rejected')">æ‹’ç»</button>
                </div>
            `).join('') || 'æ— å¾…åŠ';
        }
        async function audit(id,s){ await supabase.from('submissions').update({status:s}).eq('id',id); loadPending(); loadData(); }

        // åŸºç¡€è·¯ç”±
        function nav(id) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('show');
            if(id === 'admin') loadPending();
        }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('show'); }
    </script>
</body>
</html>
