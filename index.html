<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v49 - å…¬æ­£ä¸¥æ˜ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... (ä¿ç•™ä¹‹å‰çš„ CSS æ ·å¼ï¼Œæ­¤å¤„çœç•¥ä»¥èŠ‚çœç©ºé—´ï¼Œç›´æ¥ç”¨ v48 çš„ CSS å³å¯) ... */
        /* ä¸‹é¢æ˜¯ v48 çš„ CSSï¼Œä¸ºäº†å®Œæ•´æ€§æˆ‘è¿˜æ˜¯æ”¾è¿™é‡Œï¼Œä½ ä¸ç”¨å˜ */
        :root { --primary: #4F46E5; --bg-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); --glass: rgba(255, 255, 255, 0.95); --text-main: #1F2937; --sidebar-bg: rgba(255,255,255,0.95); }
        [data-theme="dark"] { --primary: #818cf8; --bg-gradient: linear-gradient(135deg, #1f2937 0%, #111827 100%); --glass: rgba(31, 41, 55, 0.95); --text-main: #F3F4F6; --sidebar-bg: rgba(31, 41, 55, 0.95); }
        [data-theme="pink"] { --primary: #EC4899; --bg-gradient: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); }
        body { margin: 0; font-family: 'Noto Sans SC', sans-serif; background: var(--bg-gradient); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background 0.5s; }
        .sidebar { width: 260px; background: var(--sidebar-bg); backdrop-filter: blur(10px); display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.2); flex-shrink: 0; z-index: 50; transition: transform 0.3s ease, background 0.3s; height: 100%; }
        .sidebar-scroll { flex: 1; overflow-y: auto; padding: 30px 20px; }
        .sidebar-foot { padding: 20px; border-top: 1px solid rgba(0,0,0,0.05); background: rgba(0,0,0,0.02); }
        .nav-item { padding: 12px 16px; margin-bottom: 8px; cursor: pointer; border-radius: 10px; font-weight: 600; color: #888; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .main { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .page { display: none; padding: 40px 60px; max-width: 900px; margin: 0 auto; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        .card { background: var(--glass); padding: 30px; border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.05); margin-bottom: 20px; transition: background 0.3s; }
        h1 { margin-top:0; color: var(--text-main); }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); border-radius: 10px; box-sizing: border-box; font-family: inherit; color: #333; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; }
        button.small { width: auto; padding: 6px 12px; font-size: 12px; }
        button.danger { background: #EF4444; }
        button.restore { background: #10B981; } /* æ–°å¢æ¢å¤æŒ‰é’®é¢œè‰² */
        .item { padding: 15px; background: rgba(255,255,255,0.5); border-radius: 12px; margin-bottom: 10px; border: 1px solid transparent; position: relative;}
        .item:hover { background: rgba(255,255,255,0.8); border-color: var(--primary); }
        .tag { font-size: 10px; padding: 3px 6px; background: var(--primary); color: #fff; border-radius: 4px; margin-right: 8px; }
        /* çŠ¶æ€æ ‡ç­¾æ ·å¼ */
        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold;}
        .st-approved { background: #D1FAE5; color: #065F46; }
        .st-pending { background: #FEF3C7; color: #92400E; }
        .st-deleted { background: #FEE2E2; color: #991B1B; text-decoration: line-through;}
        
        .g-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
        .g-card { aspect-ratio: 1; background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: #333; text-align: center; padding: 5px; }
        .g-card.sel { background: var(--primary); color: #fff; }
        .menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 100; background: #fff; border-radius: 8px; padding: 5px 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        @media (max-width: 768px) { .sidebar { position: fixed; transform: translateX(-100%); width: 240px; } .sidebar.active { transform: translateX(0); } .menu-btn { display: block; } .page { padding: 80px 15px 20px 15px; } .card { padding: 20px; } }
    </style>
</head>
<body>
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-scroll">
            <div style="font-size:20px; font-weight:900; color:var(--primary); margin-bottom:30px; display:flex; justify-content:space-between;">
                <span>ğŸš€ DSE HUB v49</span>
                <span onclick="toggleSidebar()" style="cursor:pointer; opacity:0.5; font-size:16px;">âœ•</span>
            </div>
            <div class="nav-item active" onclick="nav('home')">ğŸ“š çŸ¥è¯†åº“</div>
            <div class="nav-item" onclick="nav('game')">ğŸ® è¿è¿çœ‹</div>
            <div class="nav-item" onclick="nav('chat')">ğŸ’¬ ç•™è¨€æ¿</div>
            <div class="nav-item" onclick="nav('submit')">ğŸ“ æŠ•ç¨¿</div>
        </div>
        <div class="sidebar-foot">
            <div style="display:flex; gap:5px; margin-bottom:15px;">
                <div onclick="setTheme('light')" style="width:20px; height:20px; background:#e0c3fc; border-radius:50%; cursor:pointer; border:1px solid #999;"></div>
                <div onclick="setTheme('dark')" style="width:20px; height:20px; background:#374151; border-radius:50%; cursor:pointer; border:1px solid #999;"></div>
                <div onclick="setTheme('pink')" style="width:20px; height:20px; background:#fce7f3; border-radius:50%; cursor:pointer; border:1px solid #999;"></div>
            </div>
            <div class="nav-item" onclick="checkAdmin()" style="margin:0; justify-content:center;">ğŸ›¡ï¸ ç®¡ç†åå°</div>
        </div>
    </div>

    <div class="main">
        <div id="view-home" class="page active">
            <h1>çŸ¥è¯†å®åº“</h1>
            <div class="card">
                <input id="search" placeholder="ğŸ” æœç´¢..." onkeyup="renderKnowledge()">
                <div id="list"></div>
            </div>
        </div>

        <div id="view-game" class="page">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h1>è¿è¿çœ‹</h1>
                    <button class="small" onclick="initGame()">ğŸ”„ é‡ç½®</button>
                </div>
                <div id="game-board" class="g-grid"></div>
            </div>
        </div>

        <div id="view-chat" class="page">
            <h1>ç•™è¨€æ¿ (å³æ—¶)</h1>
            <div class="card">
                <div id="chat-box" style="height:400px; overflow-y:auto; margin-bottom:15px; padding-right:5px;"></div>
                <div style="display:flex; gap:10px;">
                    <input id="chat-u" placeholder="æ˜µç§°" style="width:30%">
                    <input id="chat-m" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                    <button onclick="sendChat()" style="width:auto">ğŸš€</button>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>æŠ•ç¨¿çŸ¥è¯†</h1>
            <div class="card">
                <select id="sub-sub">
                    <option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option><option value="math">æ•°å­¦</option>
                    <option value="ls">å…¬ç¤¾ç§‘</option><option value="phy">ç‰©ç†</option><option value="chem">åŒ–å­¦</option>
                    <option value="bio">ç”Ÿç‰©</option><option value="hist">å†å²</option><option value="other">å…¶ä»–</option>
                </select>
                <input id="sub-t" placeholder="æ ‡é¢˜">
                <textarea id="sub-d" rows="5" placeholder="è¯¦ç»†å†…å®¹..."></textarea>
                <textarea id="sub-ex" rows="3" placeholder="ä¾‹å­ (è¿è¿çœ‹ç”¨)"></textarea>
                <button onclick="submitKnowledge()">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1>ç®¡ç†åå°</h1>
            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button id="tab-know" onclick="renderAdmin('know')" style="background:#ddd; color:#333;">çŸ¥è¯†å®¡æ ¸</button>
                    <button id="tab-chat" onclick="renderAdmin('chat')" style="background:#ddd; color:#333;">ç•™è¨€æ²»ç†</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="font-size:14px; font-weight:bold;">å½“å‰è§†å›¾ï¼š</span>
                    <select id="admin-filter" onchange="renderAdmin(adminTab)" style="width:auto; margin:0; padding:6px;">
                        <option value="pending">âš ï¸ å¾…å¤„ç† (é»˜è®¤)</option>
                        <option value="approved">âœ… å·²å‘å¸ƒ</option>
                        <option value="deleted">ğŸ—‘ï¸ å·²åˆ é™¤</option>
                        <option value="all">ğŸ‘ï¸ ä¸Šå¸è§†è§’ (å…¨éƒ¨)</option>
                    </select>
                </div>

                <div id="admin-list"></div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è®°å¾—å¡«å›ä½ çš„ KEY âš ï¸âš ï¸âš ï¸
        const CONFIG = { URL: 'https://alsalyskulozwakhmzoa.supabase.co', KEY: 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr' };
        
        let appData = [];
        let db = null;
        let isAdmin = false;
        let adminTab = 'know';

        window.onload = async () => {
            if(CONFIG.URL.includes('YOUR_')) return alert('è¯·å…ˆé…ç½® API Key');
            // @ts-ignore
            db = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
            await loadData();
        };

        async function loadData() {
            // å…³é”®ï¼šç°åœ¨æˆ‘ä»¬æ‹‰å– *æ‰€æœ‰* æ•°æ®ï¼Œä¸å†æ’é™¤ deleted
            // å› ä¸ºç®¡ç†å‘˜éœ€è¦çœ‹åˆ° deleted çš„æ•°æ®æ¥â€œåŒ…åº‡â€æ£€æŸ¥
            const { data } = await db.from('submissions').select('*').order('created_at',{ascending:false});
            if(data) appData = data;
            
            renderKnowledge();
            renderChat();
            if(isAdmin) renderAdmin(adminTab);
        }

        function nav(id) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            toggleSidebar();
            if(id === 'game') initGame();
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
        function setTheme(t) { document.documentElement.setAttribute('data-theme', t); }

        // çŸ¥è¯†æŠ•ç¨¿
        async function submitKnowledge() {
            const p = {
                cat: document.getElementById('sub-sub').value,
                t: document.getElementById('sub-t').value,
                d: document.getElementById('sub-d').value,
                ex: document.getElementById('sub-ex').value,
                status: 'pending',
                created_at: new Date()
            };
            if(!p.t || !p.d) return alert("å†…å®¹ä¸ºç©º");
            await db.from('submissions').insert([p]);
            alert("å·²æäº¤ï¼Œè¯·ç­‰å¾…å®¡æ ¸");
            document.getElementById('sub-t').value = '';
            document.getElementById('sub-d').value = '';
        }

        function renderKnowledge() {
            const kw = document.getElementById('search').value.toLowerCase();
            const list = appData.filter(i => 
                i.status === 'approved' && i.cat !== 'GB_MSG' && 
                (i.t.toLowerCase().includes(kw) || i.d.toLowerCase().includes(kw))
            );
            document.getElementById('list').innerHTML = list.map(i => `
                <div class="item">
                    <div><span class="tag">${i.cat}</span> <b>${i.t}</b></div>
                    <div style="margin-top:5px; color:var(--text-main);">${i.d}</div>
                </div>`).join('') || '<div style="text-align:center;color:#999">æš‚æ— å†…å®¹</div>';
        }

        // èŠå¤© & ä¸¾æŠ¥
        async function sendChat() {
            const u = document.getElementById('chat-u').value || 'åŒ¿å';
            const m = document.getElementById('chat-m').value;
            if(!m) return;
            const p = { cat: 'GB_MSG', t: u, d: m, status: 'approved', created_at: new Date().toISOString() };
            appData.unshift({...p, id: 'temp_'+Date.now()}); 
            renderChat();
            document.getElementById('chat-m').value = '';
            await db.from('submissions').insert([p]);
            loadData();
        }

        function renderChat() {
            // å‰å°åªæ˜¾ç¤º approved
            const list = appData.filter(i => i.cat === 'GB_MSG' && i.status === 'approved');
            document.getElementById('chat-box').innerHTML = list.map(i => `
                <div style="background:rgba(255,255,255,0.6); padding:10px; border-radius:8px; margin-bottom:8px;">
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666;">
                        <b>${i.t}</b>
                        <span onclick="report('${i.id}')" style="cursor:pointer; color:#EF4444;">ğŸš¨ ä¸¾æŠ¥</span>
                    </div>
                    <div style="margin-top:4px;">${i.d}</div>
                </div>`).join('');
        }

        async function report(id) {
            if(!confirm("ç¡®å®šä¸¾æŠ¥ï¼Ÿ")) return;
            await db.from('submissions').update({ status: 'pending' }).eq('id', id);
            const item = appData.find(i => i.id == id);
            if(item) item.status = 'pending';
            renderChat();
            alert("å·²ä¸¾æŠ¥");
        }

        // ================= ğŸ›¡ï¸ å‡çº§ç‰ˆåå°é€»è¾‘ =================
        function checkAdmin() {
            if(isAdmin) { nav('admin'); return; }
            if(prompt("å¯†ç ") === 'admin') { isAdmin = true; nav('admin'); renderAdmin('know'); }
        }

        function renderAdmin(tab) {
            adminTab = tab;
            const filter = document.getElementById('admin-filter').value;

            // æŒ‰é’®æ ·å¼åˆ‡æ¢
            document.getElementById('tab-know').style.background = tab==='know'?'var(--primary)':'#ddd';
            document.getElementById('tab-know').style.color = tab==='know'?'#fff':'#333';
            document.getElementById('tab-chat').style.background = tab==='chat'?'var(--primary)':'#ddd';
            document.getElementById('tab-chat').style.color = tab==='chat'?'#fff':'#333';

            // 1. å…ˆæŒ‰ç±»å‹åˆ† (çŸ¥è¯† vs èŠå¤©)
            let list = appData.filter(i => tab==='know' ? i.cat !== 'GB_MSG' : i.cat === 'GB_MSG');

            // 2. å†æŒ‰è¿‡æ»¤å™¨åˆ†
            if (filter !== 'all') {
                list = list.filter(i => i.status === filter);
            }

            // æ¸²æŸ“åˆ—è¡¨
            document.getElementById('admin-list').innerHTML = list.length ? list.map(i => {
                // æ ¹æ®çŠ¶æ€ç”Ÿæˆæ ‡ç­¾
                let badge = '';
                if(i.status === 'approved') badge = '<span class="status-badge st-approved">å·²å‘å¸ƒ</span>';
                else if(i.status === 'pending') badge = '<span class="status-badge st-pending">å¾…å¤„ç†</span>';
                else badge = '<span class="status-badge st-deleted">å·²åˆ é™¤</span>';

                // æ ¹æ®çŠ¶æ€ç”Ÿæˆæ“ä½œæŒ‰é’®
                let btns = '';
                if (i.status === 'deleted') {
                    // å¦‚æœæ˜¯å·²åˆ é™¤ï¼Œæ˜¾ç¤ºâ€œæ¢å¤â€æŒ‰é’®
                    btns = `<button class="small restore" onclick="audit('${i.id}', 'approved')">â™»ï¸ æ¢å¤</button>`;
                } else if (i.status === 'approved') {
                    // å¦‚æœæ˜¯å·²å‘å¸ƒï¼Œæ˜¾ç¤ºâ€œä¸‹æ¶â€æŒ‰é’®
                    btns = `<button class="small danger" onclick="audit('${i.id}', 'deleted')">ğŸ—‘ï¸ ä¸‹æ¶</button>`;
                } else {
                    // å¦‚æœæ˜¯å¾…å¤„ç†ï¼Œæ˜¾ç¤ºâ€œé€šè¿‡â€å’Œâ€œåˆ é™¤â€
                    btns = `
                        <button class="small" onclick="audit('${i.id}', 'approved')">âœ… é€šè¿‡</button>
                        <button class="small danger" onclick="audit('${i.id}', 'deleted')">ğŸ—‘ï¸ åˆ é™¤</button>
                    `;
                }

                return `
                <div class="item">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <b>${i.t}</b> ${badge}
                        </div>
                        <div style="display:flex; gap:5px; margin-left:10px;">
                            ${btns}
                        </div>
                    </div>
                    <div style="font-size:12px; margin-top:5px; color:#555;">${i.d}</div>
                    <div style="font-size:10px; color:#999; margin-top:5px;">ID: ${i.id} | ${new Date(i.created_at).toLocaleString()}</div>
                </div>`;
            }).join('') : '<p style="text-align:center; padding:20px;">å½“å‰åˆ—è¡¨ä¸ºç©º</p>';
        }

        async function audit(id, newStatus) {
            await db.from('submissions').update({ status: newStatus }).eq('id', id);
            // æ‰¾åˆ°æœ¬åœ°æ•°æ®å¹¶æ›´æ–°
            const item = appData.find(i => i.id == id);
            if(item) item.status = newStatus;
            
            // åˆ·æ–°åå°ç•Œé¢
            renderAdmin(adminTab);
            // åˆ·æ–°å‰å°ç•Œé¢ (ä¸‡ä¸€ç®¡ç†å‘˜è‡ªå·±åœ¨å‰å°çœ‹)
            renderKnowledge();
            renderChat();
        }

        // æ¸¸æˆé€»è¾‘
        function initGame() {
            const box = document.getElementById('game-board');
            const data = appData.filter(i => i.status==='approved' && i.cat!=='GB_MSG' && i.ex).slice(0,6);
            if(data.length < 2) return box.innerHTML = 'é¢˜ç›®ä¸å¤Ÿå•¦';
            let cards = [];
            data.forEach(d => {
                cards.push({ id: d.id, txt: d.t, type: 'q' });
                cards.push({ id: d.id, txt: d.ex.split('//')[0] || 'Ex', type: 'a' });
            });
            cards.sort(()=>Math.random()-0.5);
            box.innerHTML = cards.map((c,i) => `<div id="c-${i}" class="g-card" onclick="cardClick(${i}, '${c.id}')">${c.txt}</div>`).join('');
            window.gState = { sel: null };
        }
        function cardClick(idx, id) {
            const el = document.getElementById(`c-${idx}`);
            if(el.style.visibility === 'hidden') return;
            const s = window.gState;
            if(s.sel === null) { s.sel = { idx, id }; el.classList.add('sel'); }
            else {
                const prev = document.getElementById(`c-${s.sel.idx}`);
                if(s.sel.idx !== idx && s.sel.id === id) { el.style.visibility = 'hidden'; prev.style.visibility = 'hidden'; }
                else { prev.classList.remove('sel'); }
                s.sel = null;
            }
        }
    </script>
</body>
</html>
