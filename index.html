<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= è§†è§‰ä¿®å¤åŒº ================= */
        :root {
            --accent: #007AFF; 
            --bg-grad: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            /* å…³é”®ä¿®æ”¹ï¼šæ–‡å­—é¢œè‰²æ”¹æˆæ·±ç°ï¼Œä¸å†æ˜¯ç™½è‰²ï¼Œä¿è¯å¯è§æ€§ */
            --text: #1d1d1f; 
            --text-sub: #555555;
            --glass-bg: rgba(255, 255, 255, 0.85); /* å¢åŠ ä¸é€æ˜åº¦ */
            --glass-border: rgba(255, 255, 255, 0.6);
            --radius: 20px;
        }

        body { 
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-image: var(--bg-grad); background-attachment: fixed; background-size: cover; 
            color: var(--text); height: 100vh; display: flex; overflow: hidden; 
        }
        
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        /* ç»ç’ƒå¡ç‰‡ - å¢å¼ºå¯¹æ¯”åº¦ */
        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); 
            border-radius: var(--radius); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.05); 
        }

        /* å¸ƒå±€ */
        .sidebar { width: 260px; padding: 25px 20px; display: flex; flex-direction: column; z-index: 100; background: rgba(255,255,255,0.5); backdrop-filter: blur(30px); border-right: 1px solid rgba(255,255,255,0.5); }
        .main { flex: 1; overflow-y: auto; padding: 30px 5%; position: relative; scroll-behavior: smooth; }
        .page { display: none; animation: fadeIn 0.3s; max-width: 800px; margin: 0 auto; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* å¯¼èˆªæŒ‰é’® */
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 12px; font-weight: 600; transition:0.2s; }
        .nav-item:hover { background: rgba(0,0,0,0.05); color: #000; }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }

        /* ä¿®å¤è¾“å…¥æ¡†çœ‹ä¸æ¸…çš„é—®é¢˜ */
        input, textarea, select { 
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); 
            background: #ffffff; /* å¼ºåˆ¶ç™½åº• */
            margin-bottom: 10px; font-size: 15px; color: #000; /* å¼ºåˆ¶é»‘å­— */
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }

        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; transition:0.2s; }
        button:active { transform: scale(0.98); }
        button.danger { background: #FF3B30; }
        button.ghost { background: transparent; color: var(--text-sub); border: 1px solid rgba(0,0,0,0.1); }
        button.small { width: auto; padding: 6px 14px; font-size: 13px; }

        /* ğŸ”¥ æ–°ç‰ˆèƒ¶å›Šé€‰æ‹©å™¨ (æ›¿ä»£ä¸‘é™‹ä¸‹æ‹‰æ¡†) ğŸ”¥ */
        .capsule-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .capsule-scroll::-webkit-scrollbar { display: none; }
        .capsule { 
            padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.6); 
            border: 1px solid rgba(0,0,0,0.05); white-space: nowrap; cursor: pointer; font-size: 14px; font-weight: 600; color: #555;
            transition: 0.2s;
        }
        .capsule.active { background: var(--accent); color: white; border-color: transparent; box-shadow: 0 4px 10px rgba(0,122,255,0.25); }

        /* çŸ¥è¯†å¡ç‰‡ */
        .k-item { padding: 18px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; background: rgba(255,255,255,0.4); margin-bottom: 10px; border-radius: 12px; }
        .k-item:hover { background: rgba(255,255,255,0.7); }
        .k-body { max-height: 0; overflow: hidden; opacity: 0; transition: 0.3s; margin-top: 0; color: #444; line-height: 1.6; }
        .k-item.open .k-body { max-height: 1000px; opacity: 1; margin-top: 15px; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        .mobile-bar { display: none; padding: 10px 15px; align-items: center; justify-content: space-between; position: fixed; top:0; width:100%; z-index: 200; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.1); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; width: 80%; box-shadow: 20px 0 50px rgba(0,0,0,0.2); }
            .sidebar.open { left: 0; }
            .mobile-bar { display: flex; }
            .main { padding-top: 70px; }
        }

        /* ç™»å½•å¼¹çª— */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); z-index: 999; display: flex; align-items: center; justify-content: center; }
        .modal-box { width: 320px; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="mobile-bar">
        <button class="ghost" style="width:auto; border:none;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b style="color:#000">DSE Hub</b>
        <div style="width:30px"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0 0 30px 10px; color:var(--accent); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-cube"></i> DSE HUB
        </h2>
        
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('duel', this)"><i class="fas fa-bolt"></i> çº¿ä¸Šå¯¹å†³</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>
        <div class="nav-item" id="nav-admin" onclick="nav('admin', this)" style="display:none; color:#FF9500;"><i class="fas fa-shield-alt"></i> ç®¡ç†åå°</div>

        <div style="flex:1"></div>
        <div class="glass" style="padding:15px; border:none; margin-top:20px;">
            <div style="font-weight:bold; color:#000" id="u-nm">Guest</div>
            <div style="font-size:12px; color:#666;" id="u-sc">0 pts</div>
            <button class="small ghost" onclick="logout()" style="width:100%; margin-top:10px;">é€€å‡º</button>
        </div>
    </div>

    <div class="main" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">

        <div id="view-home" class="page active">
            <h1>ğŸ“š çŸ¥è¯†åº“</h1>
            
            <div class="capsule-scroll" id="sub-capsules">
                </div>

            <div class="glass" style="padding:15px; margin-bottom:20px; display:flex; gap:10px;">
                <input id="search-k" placeholder="ğŸ” æœç´¢æ ‡é¢˜..." style="margin:0; border:none; background:transparent;" onkeyup="fetchHome()">
            </div>
            
            <div id="home-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="card glass" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column-reverse; padding:15px;" id="chat-list"></div>
            <div class="glass" style="padding:15px; display:flex; gap:10px; margin-top:10px;">
                <input id="chat-input" placeholder="è¾“å…¥ç•™è¨€..." style="margin:0;">
                <button style="width:auto" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="view-duel" class="page">
            <h1>âš¡ï¸ çº¿ä¸Šå¯¹å†³</h1>
            <div class="glass card" style="text-align:center; padding:50px 20px;">
                <div id="duel-lobby">
                    <i class="fas fa-fist-raised" style="font-size:60px; color:var(--accent); margin-bottom:20px;"></i>
                    <p style="color:#555">åŒ¹é…åœ¨çº¿ç©å®¶ï¼Œç­”é¢˜èµ¢å–ç§¯åˆ†</p>
                    <button onclick="createDuel()" style="max-width:200px">åˆ›å»ºæˆ¿é—´</button>
                </div>
                <div id="duel-wait" style="display:none;">
                    <h3>âŒ›ï¸ ç­‰å¾…å¯¹æ‰‹...</h3>
                    <p>æˆ¿é—´ ID: <span id="room-id-disp"></span></p>
                </div>
                <div id="duel-game" style="display:none;">
                    <h3 id="dq-text">é¢˜ç›®åŠ è½½ä¸­...</h3>
                    <div id="dq-opts" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;"></div>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿</h1>
            <div class="glass card">
                <select id="sub-type" onchange="toggleSubUI()" style="background:#fff;">
                    <option value="know">ğŸ“š çŸ¥è¯†ç‚¹</option>
                    <option value="chat">ğŸ’¬ ç•™è¨€</option>
                </select>

                <div id="form-know">
                    <select id="sub-sub" style="background:#fff;"></select>
                    <input id="sub-t" placeholder="æ ‡é¢˜">
                    <textarea id="sub-d" rows="5" placeholder="æ­£æ–‡å†…å®¹..."></textarea>
                    <input id="sub-ex" placeholder="ä¾‹å­ (æ­£ç¡®ç­”æ¡ˆ // å¹²æ‰°é¡¹1 // å¹²æ‰°é¡¹2)">
                </div>
                
                <div id="form-chat" style="display:none;">
                    <textarea id="sub-msg" rows="3" placeholder="ç•™è¨€å†…å®¹..."></textarea>
                </div>

                <button onclick="submitItem()" style="margin-top:10px;">æäº¤</button>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>âš™ï¸ è®¾ç½®</h1>
            <div class="glass card">
                <h3>ğŸ‘¤ è´¦å·</h3>
                <p>Username: <b id="set-u-nm"></b></p>
                <div style="border-top:1px solid #eee; padding-top:15px; margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <span>ç®¡ç†æƒé™</span>
                    <button id="btn-adm" class="small" onclick="toggleAdmin()" style="width:auto">å¼€å¯</button>
                </div>
            </div>
        </div>
        
        <div id="view-admin" class="page">
            <h1 style="color:#FF9500">ç®¡ç†åå°</h1>
            <div class="glass card" id="admin-content"></div>
        </div>

    </div>

    <div class="modal-mask" id="auth-modal">
        <div class="modal-box">
            <h2 style="margin-top:0; color:#000;">DSE Hub</h2>
            <input id="lg-e" placeholder="é‚®ç®±">
            <input id="lg-p" type="password" placeholder="å¯†ç ">
            <button onclick="auth('in')">ç™»å½•</button>
            <button class="ghost" style="margin-top:10px" onclick="auth('up')">æ³¨å†Œ</button>
            <p id="auth-err" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // ================= âš ï¸ å¡«å…¥ä½ çš„ Supabase URL å’Œ Key âš ï¸ =================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // å…¨å±€
        let user = null;
        let profile = null;
        let currentSub = 'all';
        
        const SUBJECTS = [
            {k:'chi', n:'ä¸­æ–‡'}, {k:'eng', n:'è‹±æ–‡'}, {k:'math', n:'æ•°å­¦'}, 
            {k:'cs', n:'å…¬ç¤¾ç§‘'}, {k:'phy', n:'ç‰©ç†'}, {k:'chem', n:'åŒ–å­¦'}, 
            {k:'bio', n:'ç”Ÿç‰©'}, {k:'hist', n:'å†å²'}, {k:'geog', n:'åœ°ç†'}
        ];

        // ================= åˆå§‹åŠ è½½ =================
        window.onload = async () => {
            renderCapsules();
            renderSelects();

            const { data } = await sb.auth.getSession();
            if (data.session) {
                user = data.session.user;
                await loadProfile();
            }
        };

        // æ¸²æŸ“èƒ¶å›ŠUI
        function renderCapsules() {
            const html = `<div class="capsule active" onclick="filterSub('all', this)">å…¨éƒ¨</div>` + 
                SUBJECTS.map(s => `<div class="capsule" onclick="filterSub('${s.k}', this)">${s.n}</div>`).join('');
            document.getElementById('sub-capsules').innerHTML = html;
        }

        function renderSelects() {
            const html = SUBJECTS.map(s => `<option value="${s.k}">${s.n}</option>`).join('');
            document.getElementById('sub-sub').innerHTML = html;
        }

        // ================= è®¤è¯ =================
        async function auth(type) {
            const email = document.getElementById('lg-e').value;
            const password = document.getElementById('lg-p').value;
            const errEl = document.getElementById('auth-err');
            
            let res;
            if(type==='up') res = await sb.auth.signUp({ email, password });
            else res = await sb.auth.signInWithPassword({ email, password });

            if(res.error) errEl.innerText = res.error.message;
            else {
                user = res.data.user;
                if(type==='up') alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•ï¼");
                else {
                    await loadProfile();
                    document.getElementById('auth-modal').style.display = 'none';
                }
            }
        }
        
        async function logout() { await sb.auth.signOut(); location.reload(); }

        // æ ¸å¿ƒï¼šè¯»å– Profiles (id, username, score, is_admin)
        async function loadProfile() {
            let { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
            if(!data) {
                // å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºé»˜è®¤
                const newP = { id: user.id, username: user.email.split('@')[0], score: 0, is_admin: false };
                await sb.from('profiles').insert(newP);
                data = newP;
            }
            profile = data;
            
            document.getElementById('u-nm').innerText = profile.username;
            document.getElementById('u-sc').innerText = profile.score + ' pts';
            document.getElementById('set-u-nm').innerText = profile.username;
            
            // ç®¡ç†å‘˜åˆ¤å®š
            if(profile.is_admin) {
                document.getElementById('nav-admin').style.display = 'flex';
                document.getElementById('btn-adm').innerText = "å…³é—­æƒé™";
                document.getElementById('btn-adm').classList.add('danger');
            }
            nav('home');
        }

        // ================= 1. çŸ¥è¯†åº“ (Submissions: id, subject, title, content, example) =================
        function filterSub(k, el) {
            currentSub = k;
            document.querySelectorAll('.capsule').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            fetchHome();
        }

        async function fetchHome() {
            const key = document.getElementById('search-k').value;
            let q = sb.from('submissions').select('*');
            
            // æ³¨æ„ï¼šå› ä¸ºä½ çš„è¡¨æœ¬æ¥æ²¡æœ‰ statusï¼Œä½†æˆ‘åŠ ä¸Šäº†ã€‚å¦‚æœæŠ¥é”™ï¼Œè¯·è¿è¡Œ SQLã€‚
            // è¿™é‡Œä¸ºäº†é˜²å´©ï¼Œæˆ‘ä¸åŠ  status è¿‡æ»¤ï¼Œé™¤éä½  SQL è·‘æˆåŠŸäº†ã€‚
            // å‡è®¾ä½ è·‘äº† SQLï¼Œæœ‰ status='approved'
            try { q = q.eq('status', 'approved'); } catch(e){}

            if(currentSub !== 'all') q = q.eq('subject', currentSub);
            if(key) q = q.ilike('title', `%${key}%`);

            const { data, error } = await q;
            if(error) return console.error(error); // å¯èƒ½æ˜¯æ²¡ status åˆ—

            document.getElementById('home-list').innerHTML = data.map(i => `
                <div class="k-item" onclick="this.classList.toggle('open')">
                    <div style="font-weight:bold; color:#000;">[${i.subject}] ${i.title}</div>
                    <div class="k-body">
                        ${i.content}
                        ${i.example ? `<br><br><small style="color:#666">ğŸ’¡ ä¾‹å­: ${i.example}</small>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ================= 2. ç•™è¨€æ¿ (Feedbacks: id, author_name, content, status, depth) =================
        async function fetchChat() {
            const { data } = await sb.from('feedbacks').select('*')
                .neq('status', 'deleted')
                .order('id', { ascending: false }) // ç”¨ ID å€’åºï¼Œå› ä¸ºæ²¡æœ‰ created_at
                .limit(30);

            document.getElementById('chat-list').innerHTML = data.map(i => `
                <div style="padding:10px; margin-bottom:8px; background:rgba(255,255,255,0.5); border-radius:10px;">
                    <div style="font-size:12px; font-weight:bold; color:var(--accent)">${i.author_name}</div>
                    <div style="color:#333; margin-top:2px;">${i.content}</div>
                </div>
            `).join('');
        }

        async function sendChat() {
            const txt = document.getElementById('chat-input').value;
            if(!txt) return;

            // ä¸¥æ ¼åŒ¹é…ä½ çš„å­—æ®µ
            const { error } = await sb.from('feedbacks').insert({
                author_name: profile.username,
                content: txt,
                status: 'normal',
                depth: 0
            });

            if(error) alert("å‘é€å¤±è´¥: " + error.message);
            else {
                document.getElementById('chat-input').value = '';
                fetchChat();
            }
        }

        // ================= 3. å¯¹å†³ (Duel Rooms: player1_id, status) =================
        async function createDuel() {
            // åˆ›å»ºæˆ¿é—´
            const { data, error } = await sb.from('duel_rooms').insert({
                player1_id: user.id,
                status: 'waiting',
                p1_score: 0,
                p2_score: 0
            }).select().single();

            if(error) return alert("åˆ›å»ºå¤±è´¥");

            document.getElementById('duel-lobby').style.display = 'none';
            document.getElementById('duel-wait').style.display = 'block';
            document.getElementById('room-id-disp').innerText = data.id;

            // ç®€å•æ¨¡æ‹ŸåŒ¹é…æˆåŠŸï¼ˆå®é™…éœ€è¦ Realtime è®¢é˜…ï¼‰
            setTimeout(() => {
                alert("æ¨¡æ‹Ÿï¼šåŒ¹é…æˆåŠŸï¼(çœŸå®åŒ¹é…éœ€å¼€å¯ Realtime)");
                startLocalGame();
            }, 3000);
        }

        async function startLocalGame() {
            // ä» submissions æŠ½é¢˜
            const { data } = await sb.from('submissions').select('*').limit(50);
            if(!data || data.length === 0) return alert("é¢˜åº“æ²¡é¢˜ï¼");

            const q = data[Math.floor(Math.random() * data.length)];
            const ans = q.example ? q.example.split('//')[0] : "Answer";
            
            document.getElementById('duel-wait').style.display = 'none';
            document.getElementById('duel-game').style.display = 'block';
            document.getElementById('dq-text').innerText = q.title;
            
            document.getElementById('dq-opts').innerHTML = [ans, "A", "B", "C"].sort(()=>Math.random()-0.5).map(o => 
                `<button class="ghost" onclick="alert('${o===ans?'WIN +50':'LOSE'}'); nav('home')">${o}</button>`
            ).join('');
        }

        // ================= 4. æŠ•ç¨¿ & ç®¡ç† =================
        function toggleSubUI() {
            const t = document.getElementById('sub-type').value;
            document.getElementById('form-know').style.display = t==='know'?'block':'none';
            document.getElementById('form-chat').style.display = t==='chat'?'block':'none';
        }

        async function submitItem() {
            const t = document.getElementById('sub-type').value;
            if(t === 'know') {
                await sb.from('submissions').insert({
                    subject: document.getElementById('sub-sub').value,
                    title: document.getElementById('sub-t').value,
                    content: document.getElementById('sub-d').value,
                    example: document.getElementById('sub-ex').value,
                    status: 'pending', // ä¾èµ– SQL è¡¥å……çš„åˆ—
                    author_name: profile.username // ä¾èµ– SQL è¡¥å……çš„åˆ—
                });
                alert("å·²æŠ•ç¨¿ï¼");
            } else {
                await sb.from('feedbacks').insert({
                    author_name: profile.username,
                    content: document.getElementById('sub-msg').value,
                    status: 'normal',
                    depth: 0
                });
                nav('chat');
            }
        }
        
        async function toggleAdmin() {
            if(profile.is_admin) {
                await sb.from('profiles').update({ is_admin: false }).eq('id', user.id);
            } else {
                if(prompt("PWD?") === 'admin') await sb.from('profiles').update({ is_admin: true }).eq('id', user.id);
            }
            loadProfile();
        }

        // ================= å¯¼èˆª =================
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if(id==='home') fetchHome();
            if(id==='chat') fetchChat();
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>

