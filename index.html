<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v66 (Gaming Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= æ ·å¼ç³»ç»Ÿ ================= */
        :root {
            --accent: #007AFF; 
            --bg-grad: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            --text-main: #1d1d1f;
            --text-sub: #555;
            --glass: rgba(255, 255, 255, 0.90);
            --border: rgba(0,0,0,0.1);
            --radius: 16px;
        }

        /* ä¸»é¢˜è‰²ç³» */
        [data-theme="green"] { --accent: #34C759; --bg-grad: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%); }
        [data-theme="orange"] { --accent: #FF9500; --bg-grad: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        [data-theme="purple"] { --accent: #AF52DE; --bg-grad: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%); }
        [data-theme="red"] { --accent: #FF3B30; --bg-grad: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); }
        [data-theme="cyan"] { --accent: #32ADE6; --bg-grad: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); }
        
        /* æš—é»‘æ¨¡å¼ */
        [data-theme="dark"] { 
            --accent: #0A84FF; --text-main: #ffffff; --text-sub: #bbbbbb;
            --bg-grad: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass: rgba(30, 30, 40, 0.95); --border: rgba(255,255,255,0.2);
        }

        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif; 
            background-image: var(--bg-grad); background-attachment: fixed; background-size: cover;
            color: var(--text-main); height: 100vh; display: flex; overflow: hidden; 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

        /* å¸ƒå±€ç»„ä»¶ */
        .glass { background: var(--glass); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: 0.3s; }
        
        .sidebar { width: 260px; padding: 25px 20px; display: flex; flex-direction: column; background: var(--glass); border-right: 1px solid var(--border); z-index: 100; }
        .main { flex: 1; overflow-y: auto; padding: 20px 5%; position: relative; }
        
        .page { display: none; animation: fadeIn 0.3s; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; color: var(--text-sub); display: flex; align-items: center; gap: 12px; font-weight: 600; transition:0.2s; }
        .nav-item.active { background: var(--accent); color: #fff; }
        
        input, textarea { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
            background: rgba(255,255,255,0.8); color: #000; font-size: 15px; margin-bottom: 10px;
        }
        [data-theme="dark"] input, [data-theme="dark"] textarea { background: rgba(0,0,0,0.4); color: #fff; }

        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        button.ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
        button.small { width: auto; padding: 6px 14px; font-size: 13px; }

        /* èƒ¶å›Šé€‰æ‹©å™¨ */
        .capsule-row { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 5px; margin-bottom: 15px; }
        .capsule-row::-webkit-scrollbar { display: none; }
        .capsule { 
            padding: 8px 16px; border-radius: 20px; background: rgba(125,125,125,0.15); 
            white-space: nowrap; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-sub);
            border: 1px solid transparent;
        }
        .capsule.active { background: var(--accent); color: white; }

        /* æ¸¸æˆç½‘æ ¼ - è¿è¿çœ‹ */
        .game-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
        .game-card { 
            aspect-ratio: 1; background: var(--glass); display: flex; align-items: center; justify-content: center; 
            border-radius: 12px; cursor: pointer; font-size: 14px; text-align: center; padding: 5px;
            border: 2px solid transparent; font-weight: bold; word-break: break-all;
        }
        .game-card.selected { border-color: var(--accent); background: rgba(0,122,255,0.1); }
        .game-card.matched { visibility: hidden; pointer-events: none; }

        /* ç§»åŠ¨ç«¯é€‚é… */
        .mobile-bar { display: none; padding: 10px 15px; align-items: center; justify-content: space-between; position: fixed; top:0; width:100%; z-index: 200; background: var(--glass); border-bottom: 1px solid var(--border); backdrop-filter: blur(20px); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; height: 100%; width: 85%; box-shadow: 20px 0 50px rgba(0,0,0,0.2); transition: 0.3s; }
            .sidebar.open { left: 0; }
            .mobile-bar { display: flex; }
            .main { padding-top: 70px; }
        }

        /* ç™»å½•å¼¹çª— */
        .modal-mask { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 320px; padding: 30px; background: #fff; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); color:#000; }
    </style>
</head>
<body data-theme="blue">

    <div class="mobile-bar">
        <button class="ghost" style="border:none; width:auto;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b>DSE Hub</b>
        <div style="width:30px"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0 0 30px 10px; color:var(--accent); display:flex; align-items:center; gap:10px;">
            <i class="fas fa-cube"></i> DSE HUB
        </h2>
        
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('games', this)"><i class="fas fa-gamepad"></i> æ¸¸æˆå¤§å…</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>

        <div style="flex:1"></div>
        
        <div class="glass" style="padding:15px; border:none; background:rgba(125,125,125,0.1);">
            <div style="font-weight:bold;" id="u-nm">Guest</div>
            <div style="font-size:12px; opacity:0.7;" id="u-sc">0 pts</div>
            <button class="small ghost" onclick="logout()" style="width:100%; margin-top:8px;">ç™»å‡º</button>
        </div>
    </div>

    <div class="main" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">

        <div id="view-home" class="page active">
            <h1>ğŸ“š çŸ¥è¯†åº“</h1>
            <div class="capsule-row" id="sub-capsules"></div>
            <input id="search-k" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹..." onkeyup="fetchHome()">
            <div id="home-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ ç•™è¨€æ¿</h1>
            <div class="glass" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column-reverse; padding:15px; margin-bottom:15px;" id="chat-list"></div>
            
            <div class="glass" style="padding:15px;">
                <textarea id="chat-input" rows="2" placeholder="è¾“å…¥ç•™è¨€..." style="margin-bottom:5px;"></textarea>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <label style="font-size:12px; display:flex; align-items:center; gap:5px; cursor:pointer;">
                        <input type="checkbox" id="chat-private"> ä»…ç®¡ç†å‘˜å¯è§ (Private)
                    </label>
                    <button style="width:auto; padding:8px 20px;" onclick="sendChat()"><i class="fas fa-paper-plane"></i> å‘é€</button>
                </div>
            </div>
        </div>

        <div id="view-games" class="page">
            <h1>ğŸ® æ¸¸æˆå¤§å…</h1>
            
            <div class="glass" style="padding:20px; margin-bottom:15px; cursor:pointer;" onclick="startGame('pair')">
                <h3 style="margin:0"><i class="fas fa-link" style="color:var(--accent)"></i> è¿è¿çœ‹ (Pair Match)</h3>
                <p style="font-size:13px; opacity:0.7; margin:5px 0 0;">å°†é¢˜ç›®ä¸ç­”æ¡ˆé…å¯¹ï¼Œæ¶ˆé™¤æ‰€æœ‰æ–¹å—ï¼</p>
            </div>

            <div class="glass" style="padding:20px; margin-bottom:15px; cursor:pointer;" onclick="startGame('quiz')">
                <h3 style="margin:0"><i class="fas fa-check-square" style="color:var(--accent)"></i> æé€Ÿå¤šé€‰ (Quiz)</h3>
                <p style="font-size:13px; opacity:0.7; margin:5px 0 0;">30ç§’å†…æŒ‘æˆ˜å¤šå°‘é“é¢˜ï¼Ÿ</p>
            </div>

            <div class="glass" style="padding:20px; cursor:pointer;" onclick="startGame('duel')">
                <h3 style="margin:0"><i class="fas fa-bolt" style="color:var(--accent)"></i> çº¿ä¸Šå¯¹å†³ (Duel)</h3>
                <p style="font-size:13px; opacity:0.7; margin:5px 0 0;">åˆ›å»ºæˆ¿é—´ï¼Œä¸æœ‹å‹å®æ—¶PKã€‚</p>
            </div>

            <div id="game-stage" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--glass); z-index:500; padding:20px; backdrop-filter:blur(10px);">
                <div style="max-width:600px; margin:0 auto; padding-top:50px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                        <b id="game-title">Game</b>
                        <button class="small ghost" onclick="document.getElementById('game-stage').style.display='none'">é€€å‡º</button>
                    </div>
                    
                    <div id="stage-pair" style="display:none;">
                        <p style="text-align:center;">è¯·ç‚¹å‡»åŒ¹é…çš„ **æ ‡é¢˜** å’Œ **ç­”æ¡ˆ**</p>
                        <div class="game-grid" id="pair-grid"></div>
                    </div>

                    <div id="stage-quiz" style="display:none;">
                        <h2 id="qz-q" style="text-align:center; margin-bottom:30px;">Q</h2>
                        <div id="qz-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿çŸ¥è¯†ç‚¹</h1>
            <div class="glass" style="padding:20px;">
                <div class="capsule-row" id="sub-capsules-form"></div>
                <input id="sub-t" placeholder="æ ‡é¢˜ (Title)">
                <textarea id="sub-d" rows="5" placeholder="æ­£æ–‡å†…å®¹ (Content)..."></textarea>
                <input id="sub-ex" placeholder="ä¾‹å­/ç­”æ¡ˆ (Example) - ç”¨äºå‡ºé¢˜">
                <button onclick="submitItem()" style="margin-top:15px;">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>âš™ï¸ è®¾ç½®</h1>
            
            <div class="glass" style="padding:20px; margin-bottom:20px;">
                <h3>ğŸ¨ ä¸»é¢˜é£æ ¼</h3>
                <div style="display:flex; flex-wrap:wrap; gap:15px;">
                    <div style="width:30px; height:30px; background:#007AFF; border-radius:50%; cursor:pointer;" onclick="setTheme('blue')"></div>
                    <div style="width:30px; height:30px; background:#34C759; border-radius:50%; cursor:pointer;" onclick="setTheme('green')"></div>
                    <div style="width:30px; height:30px; background:#FF9500; border-radius:50%; cursor:pointer;" onclick="setTheme('orange')"></div>
                    <div style="width:30px; height:30px; background:#AF52DE; border-radius:50%; cursor:pointer;" onclick="setTheme('purple')"></div>
                    <div style="width:30px; height:30px; background:#FF3B30; border-radius:50%; cursor:pointer;" onclick="setTheme('red')"></div>
                    <div style="width:30px; height:30px; background:#32ADE6; border-radius:50%; cursor:pointer;" onclick="setTheme('cyan')"></div>
                    <div style="width:30px; height:30px; background:#222; border-radius:50%; border:1px solid #fff; cursor:pointer;" onclick="setTheme('dark')"></div>
                </div>
            </div>

            <div class="glass" style="padding:20px;">
                <h3>ğŸ‘¤ è´¦å·ä¿¡æ¯</h3>
                <p>User: <b id="set-u-nm">Guest</b></p>
                <button class="small ghost" onclick="updateProfileAttempt()">ğŸ”„ åˆ·æ–°èµ„æ–™</button>
            </div>
        </div>
    </div>

    <div class="modal-mask" id="auth-modal">
        <div class="modal-box">
            <h2 style="margin-top:0;">DSE Hub Login</h2>
            <input id="lg-e" placeholder="Email">
            <input id="lg-p" type="password" placeholder="Password">
            <button onclick="auth('in')">ç™»å½•</button>
            <button class="ghost" style="margin-top:10px" onclick="auth('up')">æ³¨å†Œ</button>
            <p id="auth-err" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // ================= âš ï¸ å¡«å…¥ä½ çš„ Supabase é…ç½® âš ï¸ =================
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co'; // æ›¿æ¢æˆä½ çš„Supabase URL
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr'; // æ›¿æ¢æˆä½ çš„Supabase anon key
        
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let user = null;
        let profile = null;
        let currentCat = 'all';
        let formCat = 'chi';
        
        const CATS = [
            {k:'chi', n:'ä¸­æ–‡'}, {k:'eng', n:'è‹±æ–‡'}, {k:'math', n:'æ•°å­¦'}, 
            {k:'cs', n:'å…¬ç¤¾ç§‘'}, {k:'phy', n:'ç‰©ç†'}, {k:'chem', n:'åŒ–å­¦'}, 
            {k:'bio', n:'ç”Ÿç‰©'}, {k:'hist', n:'å†å²'}, {k:'geog', n:'åœ°ç†'}
        ];

        window.onload = async () => {
            renderCapsules();
            const { data } = await sb.auth.getSession();
            if (data.session) {
                user = data.session.user;
                await loadProfile();
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        };

        function renderCapsules() {
            let html = `<div class="capsule active" onclick="filterCat('all', this)">å…¨éƒ¨</div>` + 
                CATS.map(s => `<div class="capsule" onclick="filterCat('${s.k}', this)">${s.n}</div>`).join('');
            document.getElementById('sub-capsules').innerHTML = html;
            
            let fHtml = CATS.map(s => `<div class="capsule ${s.k==='chi'?'active':''}" onclick="setFormCat('${s.k}', this)">${s.n}</div>`).join('');
            document.getElementById('sub-capsules-form').innerHTML = fHtml;
        }

        // ================= æ ¸å¿ƒï¼šå®¹é”™ç‰ˆèµ„æ–™åŠ è½½ =================
        async function loadProfile() {
            try {
                // å°è¯•1: æ ‡å‡†è¯»å–
                let { data, error } = await sb.from('profiles').select('*').eq('auth_id', user.id).single();
                
                // å°è¯•2: å¦‚æœ auth_id æ²¡æ‰¾åˆ°ï¼Œå°è¯•ç”¨ id æ‰¾ (å…¼å®¹æ—§æ•°æ®)
                if (!data) {
                    let res = await sb.from('profiles').select('*').eq('id', user.id).single();
                    data = res.data;
                }

                if (data) {
                    profile = data;
                    updateUI();
                } else {
                    // æ²¡èµ„æ–™ï¼Ÿä½¿ç”¨ä¸´æ—¶èµ„æ–™ï¼Œä¸æŠ¥é”™
                    console.warn("No profile found in DB, using temp.");
                    profile = { id: user.id, username: user.email.split('@')[0], score: 0, is_admin: false };
                    updateUI();
                }
                document.getElementById('auth-modal').style.display = 'none';
                nav('home');
            } catch (e) {
                console.error("Critical Profile Error:", e);
                // å…œåº•ï¼šä¾ç„¶è¿›å…¥ç³»ç»Ÿï¼Œåªæ˜¯åŠŸèƒ½å—é™
                profile = { id: 'temp', username: 'Guest', score: 0 };
                document.getElementById('auth-modal').style.display = 'none';
                nav('home');
            }
        }
        
        async function updateProfileAttempt() { await loadProfile(); alert("åˆ·æ–°å®Œæˆ"); }

        function updateUI() {
            document.getElementById('u-nm').innerText = profile.username;
            document.getElementById('u-sc').innerText = profile.score + ' pts';
            document.getElementById('set-u-nm').innerText = profile.username;
        }

        // ================= æ¸¸æˆé€»è¾‘ (è¿è¿çœ‹ & å¤šé€‰) =================
        let gameData = [];
        let firstCard = null;

        async function startGame(type) {
            // è·å–é¢˜åº“
            const { data } = await sb.from('submissions').select('*').limit(20);
            if(!data || data.length < 4) return alert("é¢˜åº“é¢˜ç›®å¤ªå°‘ï¼Œå…ˆå»æŠ•ç¨¿ï¼");
            
            document.getElementById('game-stage').style.display = 'block';
            document.getElementById('stage-pair').style.display = 'none';
            document.getElementById('stage-quiz').style.display = 'none';
            document.getElementById('duel-lobby').style.display = 'none'; // éšè— duel é»˜è®¤ç•Œé¢

            if(type === 'pair') startPairGame(data);
            if(type === 'quiz') startQuizGame(data);
            if(type === 'duel') {
                 // ç®€å•çš„è·³è½¬åˆ° Duel ç•Œé¢
                 document.getElementById('game-stage').style.display = 'none';
                 nav('games'); // è¿™é‡Œå¯ä»¥å¤ç”¨ä¹‹å‰çš„ duel é€»è¾‘
                 alert("çº¿ä¸Šå¯¹å†³åŠŸèƒ½æ­£åœ¨å‡çº§ï¼Œè¯·ç­‰å¾…..."); 
            }
        }

        function startPairGame(data) {
            document.getElementById('stage-pair').style.display = 'block';
            document.getElementById('game-title').innerText = "è¿è¿çœ‹ (Pair Match)";
            
            // å‡†å¤‡æ•°æ®ï¼šå–å‰6é¢˜ï¼Œæ‹†åˆ†ä¸º æ ‡é¢˜å¡ å’Œ ç­”æ¡ˆå¡
            let cards = [];
            data.slice(0, 6).forEach((item, idx) => {
                cards.push({ id: idx, text: item.title, type: 'q' });
                cards.push({ id: idx, text: item.example || 'Answer', type: 'a' });
            });
            
            // æ‰“ä¹±
            cards.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('pair-grid');
            grid.innerHTML = cards.map((c, i) => 
                `<div class="game-card" id="c-${i}" onclick="clickCard(${i}, ${c.id})">${c.text.slice(0,15)}</div>`
            ).join('');
            
            gameData = cards;
            firstCard = null;
        }

        function clickCard(idx, matchId) {
            const el = document.getElementById(`c-${idx}`);
            if(el.classList.contains('matched') || el.classList.contains('selected')) return;

            el.classList.add('selected');

            if(!firstCard) {
                firstCard = { idx, matchId };
            } else {
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…
                if(firstCard.matchId === matchId && firstCard.idx !== idx) {
                    // åŒ¹é…æˆåŠŸ
                    setTimeout(() => {
                        document.getElementById(`c-${firstCard.idx}`).classList.add('matched');
                        el.classList.add('matched');
                        firstCard = null;
                    }, 300);
                } else {
                    // åŒ¹é…å¤±è´¥
                    setTimeout(() => {
                        document.getElementById(`c-${firstCard.idx}`).classList.remove('selected');
                        el.classList.remove('selected');
                        firstCard = null;
                    }, 500);
                }
            }
        }

        function startQuizGame(data) {
            document.getElementById('stage-quiz').style.display = 'block';
            document.getElementById('game-title').innerText = "å¤šé€‰ç‰¹è®­";
            nextQuiz(data);
        }

        function nextQuiz(data) {
            const q = data[Math.floor(Math.random() * data.length)];
            document.getElementById('qz-q').innerText = q.title;
            
            let ans = q.example || "A";
            let opts = [ans, "Option X", "Option Y", "Option Z"].sort(() => Math.random() - 0.5);
            
            document.getElementById('qz-opts').innerHTML = opts.map(o => 
                `<button class="ghost" onclick="alert('${o===ans?'Bingo!':'Wrong!'}'); nextQuiz(gameData)">${o}</button>`
            ).join('');
            gameData = data; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿é€’å½’
        }

        // ================= åŠŸèƒ½æ¨¡å— =================
        async function fetchHome() {
            const k = document.getElementById('search-k').value;
            let q = sb.from('submissions').select('*').eq('status', 'approved'); // åªæ˜¾ç¤ºå®¡æ ¸è¿‡çš„
            if(currentCat !== 'all') q = q.eq('category', currentCat);
            if(k) q = q.ilike('title', `%${k}%`);
            
            const { data } = await q;
            document.getElementById('home-list').innerHTML = (data||[]).map(i => `
                <div class="glass" style="padding:15px; margin-bottom:10px;">
                    <b>[${i.category}] ${i.title}</b>
                    <div style="color:#555; margin-top:5px;">${i.content}</div>
                </div>
            `).join('');
        }

        async function fetchChat() {
            // ç•™è¨€æ¿ï¼šæ˜¾ç¤ºæ‰€æœ‰ status='normal' çš„ï¼Œä¸” (target_id ä¸ºç©º OR target_id æ˜¯æˆ‘ OR author_id æ˜¯æˆ‘)
            const { data } = await sb.from('feedbacks').select('*')
                .neq('status', 'deleted')
                .order('created_at', {ascending:false})
                .limit(30);

            if(!data) return;

            // å‰ç«¯è¿‡æ»¤éšç§æ¶ˆæ¯ (è™½ç„¶ä¸å®‰å…¨ï¼Œä½†åœ¨åŸå‹é˜¶æ®µå¤Ÿç”¨)
            const myId = profile.id; 
            const html = data.map(i => {
                const isPrivate = i.target_id; // å¦‚æœæœ‰ target_id è§†ä¸ºç§å¯†
                const canSee = !isPrivate || i.target_id === myId || i.author_id === myId;
                
                if(!canSee) return ''; // çœ‹ä¸è§

                return `
                <div style="padding:10px; margin-bottom:10px; background:${isPrivate?'rgba(255,200,200,0.3)':'rgba(255,255,255,0.4)'}; border-radius:10px;">
                    <div style="font-size:12px; font-weight:bold; color:var(--accent)">
                        ${i.author_name} ${isPrivate ? '<i class="fas fa-lock"></i>' : ''}
                    </div>
                    <div style="margin-top:2px;">${i.content}</div>
                </div>`;
            }).join('');
            
            document.getElementById('chat-list').innerHTML = html;
        }

        async function sendChat() {
            const txt = document.getElementById('chat-input').value;
            const isPriv = document.getElementById('chat-private').checked;
            if(!txt) return;

            // å¦‚æœå‹¾é€‰ç§å¯†ï¼Œtarget_id è®¾ä¸ºç®¡ç†å‘˜ID (è¿™é‡Œæš‚ç”¨ profile.id æ¼”ç¤ºï¼Œå®é™…åº”å¡«ç®¡ç†å‘˜ID)
            // ä½ å¯ä»¥åœ¨è¿™é‡Œç¡¬ç¼–ç ä½ çš„ç®¡ç†å‘˜UUID
            const target = isPriv ? profile.id : null; 

            await sb.from('feedbacks').insert({
                author_id: profile.id, author_name: profile.username,
                content: txt, status: 'normal', target_id: target
            });
            document.getElementById('chat-input').value = '';
            fetchChat();
        }

        async function submitItem() {
            const { error } = await sb.from('submissions').insert({
                category: formCat,
                title: document.getElementById('sub-t').value,
                content: document.getElementById('sub-d').value,
                example: document.getElementById('sub-ex').value,
                status: 'pending',
                author_id: profile.id, author_name: profile.username
            });
            if(error) alert(error.message);
            else { alert("æŠ•ç¨¿æˆåŠŸï¼"); nav('home'); }
        }

        // ================= åŸºç¡€é€»è¾‘ =================
        function auth(type) {
            const email = document.getElementById('lg-e').value;
            const password = document.getElementById('lg-p').value;
            if(type==='up') sb.auth.signUp({email, password}).then(r=>{ if(!r.error) alert("è¯·ç¡®è®¤é‚®ä»¶"); else alert(r.error.message)});
            else sb.auth.signInWithPassword({email, password}).then(r=>{ if(!r.error) location.reload(); else alert(r.error.message)});
        }
        function logout() { sb.auth.signOut().then(()=>location.reload()); }
        function filterCat(k,e) { currentCat=k; document.querySelectorAll('#sub-capsules .capsule').forEach(c=>c.classList.remove('active')); e.classList.add('active'); fetchHome();}
        function setFormCat(k,e) { formCat=k; document.querySelectorAll('#sub-capsules-form .capsule').forEach(c=>c.classList.remove('active')); e.classList.add('active'); }
        function setTheme(t) { document.body.setAttribute('data-theme', t); }
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); }
            if(id==='home') fetchHome();
            if(id==='chat') fetchChat();
            if(window.innerWidth<768) document.getElementById('sidebar').classList.remove('open');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>
