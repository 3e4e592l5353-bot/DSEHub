<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v73 (æå…‰ç»ç’ƒUI + å°æ¸¸æˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= æå…‰ç»ç’ƒä¸»é¢˜ç³»ç»Ÿ ================= */
        :root {
            --accent: #6366F1;
            --accent-light: #8B5CF6;
            --accent-dark: #4F46E5;
            --bg-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass: rgba(255, 255, 255, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            --radius-xl: 24px;
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --transition-smooth: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* 10è‰²ä¸»é¢˜ç³»ç»Ÿ */
        [data-theme="indigo"] { 
            --accent: #6366F1; --accent-light: #8B5CF6; --accent-dark: #4F46E5;
            --bg-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        [data-theme="emerald"] { 
            --accent: #10B981; --accent-light: #34D399; --accent-dark: #059669;
            --bg-grad: linear-gradient(135deg, #10b981 0%, #047857 100%);
        }
        [data-theme="amber"] { 
            --accent: #F59E0B; --accent-light: #FBBF24; --accent-dark: #D97706;
            --bg-grad: linear-gradient(135deg, #F59E0B 0%, #DC2626 100%);
        }
        [data-theme="rose"] { 
            --accent: #F43F5E; --accent-light: #FB7185; --accent-dark: #E11D48;
            --bg-grad: linear-gradient(135deg, #F43F5E 0%, #BE185D 100%);
        }
        [data-theme="cyan"] { 
            --accent: #06B6D4; --accent-light: #22D3EE; --accent-dark: #0891B2;
            --bg-grad: linear-gradient(135deg, #06B6D4 0%, #3B82F6 100%);
        }
        [data-theme="violet"] { 
            --accent: #8B5CF6; --accent-light: #A78BFA; --accent-dark: #7C3AED;
            --bg-grad: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
        }
        [data-theme="teal"] { 
            --accent: #14B8A6; --accent-light: #2DD4BF; --accent-dark: #0D9488;
            --bg-grad: linear-gradient(135deg, #14B8A6 0%, #0EA5E9 100%);
        }
        [data-theme="fuchsia"] { 
            --accent: #D946EF; --accent-light: #E879F9; --accent-dark: #C026D3;
            --bg-grad: linear-gradient(135deg, #D946EF 0%, #8B5CF6 100%);
        }
        [data-theme="slate"] { 
            --accent: #64748B; --accent-light: #94A3B8; --accent-dark: #475569;
            --bg-grad: linear-gradient(135deg, #64748B 0%, #475569 100%);
        }
        [data-theme="dark"] { 
            --accent: #60A5FA; --accent-light: #93C5FD; --accent-dark: #3B82F6;
            --bg-grad: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
            --glass: rgba(30, 41, 59, 0.9);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --text-main: #F1F5F9;
            --text-sub: #CBD5E1;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg-grad);
            background-attachment: fixed;
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition-smooth);
        }

        /* ================= ç»ç’ƒæ‹Ÿæ€ç»„ä»¶ ================= */
        .glass {
            background: var(--glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 20px;
            transition: var(--transition-smooth);
            animation: floatIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .glass:hover {
            transform: translateY(-4px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        /* ================= åŠ¨ç”»ç³»ç»Ÿ ================= */
        @keyframes floatIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .animate-float { animation: floatIn 0.6s ease-out; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-slide { animation: slideInRight 0.5s ease-out; }

        /* ================= å¸ƒå±€ç³»ç»Ÿ ================= */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            padding: 30px 20px;
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-right: var(--glass-border);
            z-index: 100;
            position: relative;
            animation: slideInRight 0.4s ease-out;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px 5%;
            position: relative;
        }

        .page {
            display: none;
            max-width: 900px;
            margin: 0 auto;
            animation: floatIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .page.active {
            display: block;
        }

        /* ================= å¯¼èˆªç»„ä»¶ ================= */
        .nav-item {
            padding: 14px 18px;
            margin-bottom: 8px;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-sub);
            display: flex;
            align-items: center;
            gap: 14px;
            font-weight: 600;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: var(--accent);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        .nav-item i {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* ================= æŒ‰é’®ç³»ç»Ÿ ================= */
        .btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .btn:hover::after {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-ghost {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .btn-danger {
            background: linear-gradient(135deg, #EF4444, #DC2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10B981, #059669);
        }

        /* ================= èƒ¶å›Šæ ‡ç­¾ç³»ç»Ÿ ================= */
        .capsule-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
        }

        .capsule {
            padding: 10px 20px;
            border-radius: 50px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .capsule::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s;
        }

        .capsule:hover::before {
            left: 100%;
        }

        .capsule:hover {
            background: rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }

        .capsule.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        /* ================= è¾“å…¥æ¡†ç³»ç»Ÿ ================= */
        .input-field, .textarea-field, .select-field {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius-md);
            border: 2px solid rgba(99, 102, 241, 0.2);
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-main);
            font-size: 15px;
            margin-bottom: 16px;
            transition: var(--transition-smooth);
            font-family: 'Inter', sans-serif;
        }

        .input-field:focus, .textarea-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            background: white;
        }

        /* ================= æ¸¸æˆå¡ç‰‡ ================= */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .game-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition-smooth);
            border: var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
        }

        .game-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
        }

        .game-card i {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ================= çŸ¥è¯†åº“å¡ç‰‡ ================= */
        .kb-card {
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .kb-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, var(--accent), var(--accent-light));
        }

        .category-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            color: white;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* ================= æ¨¡æ€æ¡†ç³»ç»Ÿ ================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(30px);
            border-radius: var(--radius-xl);
            padding: 40px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: floatIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            border: var(--glass-border);
        }

        /* ================= ç§»åŠ¨ç«¯é€‚é… ================= */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 20px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                border-right: none;
                border-top: var(--glass-border);
                z-index: 200;
                display: flex;
                overflow-x: auto;
                gap: 10px;
            }
            
            .sidebar-nav {
                display: flex;
                width: 100%;
                gap: 10px;
            }
            
            .nav-item {
                flex: 1;
                min-width: 60px;
                justify-content: center;
                padding: 12px;
                margin-bottom: 0;
            }
            
            .nav-item span {
                display: none;
            }
            
            .main-content {
                padding: 20px;
                padding-bottom: 100px;
            }
            
            .game-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        /* ================= ä¸»é¢˜åˆ‡æ¢å™¨ ================= */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .theme-color {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-smooth);
            border: 3px solid transparent;
            position: relative;
        }

        .theme-color:hover {
            transform: scale(1.1);
        }

        .theme-color.active {
            border-color: white;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .theme-color::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .theme-color.active::after {
            opacity: 1;
        }

        /* ================= ç‰¹æ•ˆå…ƒç´  ================= */
        .bg-blob {
            position: fixed;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--accent-light), transparent 70%);
            opacity: 0.1;
            z-index: -1;
            animation: floatBlob 20s infinite alternate ease-in-out;
        }

        @keyframes floatBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(100px, 100px) scale(1.1); }
        }

        .sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: sparkleAnim 2s infinite;
        }

        @keyframes sparkleAnim {
            0% { opacity: 0; transform: scale(0); }
            50% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* ================= æ¸¸æˆç•Œé¢æ ·å¼ ================= */
        .game-container {
            text-align: center;
            padding: 40px;
        }

        .question-card {
            background: var(--glass);
            border-radius: var(--radius-xl);
            padding: 40px;
            margin: 30px 0;
            position: relative;
            overflow: hidden;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        .option-btn {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition-smooth);
            font-size: 16px;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(5px);
        }

        .option-btn.correct {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1));
            border-color: #10B981;
            color: #10B981;
        }

        .option-btn.wrong {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-color: #EF4444;
            color: #EF4444;
        }

        .timer-bar {
            height: 6px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            border-radius: 3px;
            margin: 20px 0;
            transition: width 0.1s linear;
        }

        .score-display {
            font-size: 48px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 20px 0;
        }
    </style>
</head>
<body data-theme="indigo">

    <!-- èƒŒæ™¯ç‰¹æ•ˆ -->
    <div class="bg-blob" style="top: -200px; left: -200px;"></div>
    <div class="bg-blob" style="bottom: -200px; right: -200px; animation-delay: -10s;"></div>

    <!-- è®¤è¯å±‚ -->
    <div class="modal-overlay" id="auth-layer">
        <div class="modal-content" style="text-align: center;">
            <div class="animate-float">
                <i class="fas fa-graduation-cap" style="font-size: 48px; background: linear-gradient(135deg, #6366F1, #8B5CF6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px;"></i>
                <h2 style="margin: 0 0 10px 0;">DSE HUB v73</h2>
                <p style="color: var(--text-sub); margin-bottom: 30px;">æå…‰ç»ç’ƒUI Â· æ™ºèƒ½å­¦ä¹ å¹³å°</p>
                
                <input type="email" class="input-field" id="lg-e" placeholder="ğŸ“§ ç”µå­é‚®ç®±">
                <input type="password" class="input-field" id="lg-p" placeholder="ğŸ”’ å¯†ç ">
                
                <button class="btn" onclick="auth('in')" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•
                </button>
                
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-ghost btn-small" onclick="auth('up')" style="flex: 1;">
                        æ³¨å†Œ
                    </button>
                    <button class="btn btn-ghost btn-small" id="resume-btn" onclick="resume()" style="flex: 1; display: none;">
                        æ¢å¤ç™»å½•
                    </button>
                </div>
                
                <p id="lg-msg" style="color: #EF4444; font-size: 13px; margin-top: 15px;"></p>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div class="app-container" style="display: none;">
        <!-- ä¾§è¾¹æ å¯¼èˆª -->
        <div class="sidebar">
            <div style="text-align: center; margin-bottom: 40px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                    <i class="fas fa-brain" style="font-size: 32px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                    <h2 style="margin: 0; font-weight: 700;">DSE HUB</h2>
                </div>
                <p style="font-size: 13px; color: var(--text-sub); margin: 0;">é¦™æ¸¯ä¸­å­¦æ–‡å‡­è€ƒè¯•æ™ºèƒ½å­¦ä¹ å¹³å°</p>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="nav('home', this)">
                    <i class="fas fa-book-open"></i>
                    <span>çŸ¥è¯†åº“</span>
                </div>
                <div class="nav-item" onclick="nav('chat', this)">
                    <i class="fas fa-comments"></i>
                    <span>ç•™è¨€æ¿</span>
                </div>
                <div class="nav-item" onclick="nav('duel', this)">
                    <i class="fas fa-gamepad"></i>
                    <span>æ¸¸æˆä¸­å¿ƒ</span>
                </div>
                <div class="nav-item" onclick="nav('rank', this)">
                    <i class="fas fa-trophy"></i>
                    <span>æ’è¡Œæ¦œ</span>
                </div>
                <div class="nav-item" onclick="nav('submit', this)">
                    <i class="fas fa-pen-nib"></i>
                    <span>æŠ•ç¨¿ä¸­å¿ƒ</span>
                </div>
                <div class="nav-item" onclick="nav('settings', this)">
                    <i class="fas fa-sliders-h"></i>
                    <span>è®¾ç½®</span>
                </div>
            </div>
            
            <div id="admin-link" class="nav-item" onclick="nav('admin', this)" style="display: none; margin-top: auto; background: linear-gradient(135deg, #F59E0B, #D97706); color: white;">
                <i class="fas fa-shield-alt"></i>
                <span>ç®¡ç†åå°</span>
            </div>
            
            <div style="margin-top: auto; padding-top: 20px;">
                <div class="glass" style="padding: 20px; text-align: center; background: rgba(99, 102, 241, 0.05);">
                    <div style="font-weight: 700; font-size: 16px;" id="u-name">è®¿å®¢</div>
                    <div style="font-size: 14px; color: var(--text-sub); margin: 8px 0;">ç§¯åˆ†: <span id="u-score">0</span></div>
                    <button class="btn btn-danger btn-small" onclick="logout()" style="width: 100%;">
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </button>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- çŸ¥è¯†åº“é¡µé¢ -->
            <div id="view-home" class="page active">
                <div class="animate-float">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h1 style="margin: 0; font-size: 32px; font-weight: 700;">ğŸ“š æ™ºèƒ½çŸ¥è¯†åº“</h1>
                            <p style="color: var(--text-sub); margin: 10px 0 0 0;">ä»æµ·é‡çŸ¥è¯†ç‚¹ä¸­é«˜æ•ˆå­¦ä¹ </p>
                        </div>
                        <div class="category-badge" id="current-category">ä¸­åœ‹èªæ–‡</div>
                    </div>
                    
                    <div class="capsule-row" id="kb-cats"></div>
                    
                    <div class="glass" style="padding: 5px 20px;">
                        <input type="text" class="input-field" id="kb-search" placeholder="ğŸ” æœç´¢çŸ¥è¯†ç‚¹ã€é¢˜ç›®ã€æ¦‚å¿µ..." style="border: none; background: transparent; padding: 20px 0;" onkeyup="fetchHome()">
                    </div>
                    
                    <div id="kb-list" class="animate-slide"></div>
                </div>
            </div>

            <!-- ç•™è¨€æ¿é¡µé¢ -->
            <div id="view-chat" class="page">
                <div class="animate-float">
                    <h1 style="margin: 0 0 30px 0; font-size: 32px; font-weight: 700;">ğŸ’¬ å­¦ä¹ äº¤æµåŒº</h1>
                    
                    <div class="glass" style="height: 50vh; overflow-y: auto; display: flex; flex-direction: column-reverse; padding: 20px;" id="chat-list"></div>
                    
                    <div class="capsule-row">
                        <div class="capsule" onclick="addTag('è°¢è°¢åˆ†äº«ï¼')"><i class="fas fa-thumbs-up"></i> ç‚¹èµ</div>
                        <div class="capsule" onclick="addTag('æ±‚è§£ç­”ï¼')"><i class="fas fa-question-circle"></i> æé—®</div>
                        <div class="capsule" onclick="addTag('è¿™ä¸ªçŸ¥è¯†ç‚¹å¾ˆé‡è¦ï¼')"><i class="fas fa-star"></i> é‡ç‚¹</div>
                        <div class="capsule" onclick="addTag('å¯ä»¥ä¸€èµ·è®¨è®ºå—ï¼Ÿ')"><i class="fas fa-users"></i> è®¨è®º</div>
                    </div>
                    
                    <div id="reply-bar" style="display: none; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); padding: 12px 20px; border-radius: var(--radius-md); margin-bottom: 20px; align-items: center; justify-content: space-between;">
                        <span style="font-weight: 600;">â†ªï¸ å›å¤: <span id="reply-user" style="color: var(--accent);">ç”¨æˆ·</span></span>
                        <i class="fas fa-times" style="cursor: pointer; color: var(--text-sub);" onclick="cancelReply()"></i>
                    </div>
                    
                    <div class="glass">
                        <textarea class="textarea-field" id="chat-in" rows="3" placeholder="è¾“å…¥ä½ çš„ç•™è¨€..."></textarea>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <select class="select-field" id="chat-target" style="flex: 1;">
                                <option value="public">ğŸŒ å…¬å¼€ç•™è¨€</option>
                            </select>
                            <button class="btn btn-small" onclick="sendChat()">
                                <i class="fas fa-paper-plane"></i> å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆä¸­å¿ƒé¡µé¢ -->
            <div id="view-duel" class="page">
                <div class="animate-float">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h1 style="margin: 0; font-size: 32px; font-weight: 700;">ğŸ® æ™ºèƒ½æ¸¸æˆä¸­å¿ƒ</h1>
                            <p style="color: var(--text-sub); margin: 10px 0 0 0;">ä»çŸ¥è¯†ç‚¹ç”Ÿæˆé¢˜ç›®ï¼Œè¾¹ç©è¾¹å­¦</p>
                        </div>
                        <button class="btn" onclick="showGameSelect()" style="width: auto;">
                            <i class="fas fa-plus-circle"></i> åˆ›å»ºæˆ¿é—´
                        </button>
                    </div>
                    
                    <!-- å•äººç»ƒä¹ æ¨¡å¼ -->
                    <div class="glass">
                        <h3 style="margin-top: 0;">ğŸ’ª å•äººç»ƒä¹ æ¨¡å¼</h3>
                        <p style="color: var(--text-sub); margin-bottom: 20px;">éšæ—¶å¼€å§‹æŒ‘æˆ˜ï¼Œç»ƒä¹ ç­”é¢˜æŠ€å·§</p>
                        <div class="game-grid" id="solo-games"></div>
                    </div>
                    
                    <!-- å¤šäººå¯¹æˆ˜ -->
                    <div class="glass">
                        <h3 style="margin-top: 0;">âš”ï¸ å¤šäººå¯¹æˆ˜å¤§å…</h3>
                        <button class="btn btn-ghost btn-small" onclick="fetchDuels()" style="margin-bottom: 20px;">
                            <i class="fas fa-sync-alt"></i> åˆ·æ–°æˆ¿é—´åˆ—è¡¨
                        </button>
                        <div id="duel-list"></div>
                    </div>
                </div>
            </div>

            <!-- æ’è¡Œæ¦œé¡µé¢ -->
            <div id="view-rank" class="page">
                <div class="animate-float">
                    <h1 style="margin: 0 0 30px 0; font-size: 32px; font-weight: 700;">ğŸ† è£èª‰æ’è¡Œæ¦œ</h1>
                    <p style="color: var(--text-sub); margin-bottom: 30px;">å±•ç¤ºå­¦ä¹ æˆæœï¼Œæ¿€åŠ±è¿›æ­¥</p>
                    <div id="rank-list"></div>
                </div>
            </div>

            <!-- æŠ•ç¨¿ä¸­å¿ƒé¡µé¢ -->
            <div id="view-submit" class="page">
                <div class="animate-float">
                    <h1 style="margin: 0 0 30px 0; font-size: 32px; font-weight: 700;">âœï¸ çŸ¥è¯†æŠ•ç¨¿ä¸­å¿ƒ</h1>
                    
                    <div class="glass">
                        <h3 style="margin-top: 0;">é€‰æ‹©ç§‘ç›®åˆ†ç±»</h3>
                        <div class="capsule-row" id="sub-cats"></div>
                        
                        <input type="text" class="input-field" id="sub-t" placeholder="çŸ¥è¯†ç‚¹æ ‡é¢˜ï¼ˆä¾‹å¦‚ï¼šäºŒæ¬¡æ–¹ç¨‹æ±‚æ ¹å…¬å¼ï¼‰">
                        <textarea class="textarea-field" id="sub-c" rows="5" placeholder="è¯¦ç»†å†…å®¹æè¿°..."></textarea>
                        
                        <div class="glass" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); border-left: 4px solid var(--accent);">
                            <h4 style="margin-top: 0;"><i class="fas fa-lightbulb"></i> å¦‚ä½•åˆ›å»ºæ¸¸æˆé¢˜ç›®æ ¼å¼</h4>
                            <p style="margin-bottom: 10px;">ä½¿ç”¨ <code style="background: rgba(99, 102, 241, 0.1); padding: 2px 6px; border-radius: 4px;">//</code> ä½œä¸ºåˆ†éš”ç¬¦æ¥åˆ›å»ºå¯è‡ªåŠ¨è½¬æ¢ä¸ºæ¸¸æˆé¢˜ç›®çš„å†…å®¹ï¼š</p>
                            <pre style="background: rgba(0, 0, 0, 0.05); padding: 15px; border-radius: var(--radius-sm); font-size: 13px; margin: 0;">
æ ¼å¼ï¼šé—®é¢˜//é€‰é¡¹A//é€‰é¡¹B//é€‰é¡¹C//é€‰é¡¹D//æ­£ç¡®ç­”æ¡ˆ

ç¤ºä¾‹1ï¼š
é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒºçš„é¦–åºœæ˜¯ï¼Ÿ//é¦™æ¸¯å²›//ä¹é¾™//æ–°ç•Œ//æ¾³é—¨//é¦™æ¸¯å²›

ç¤ºä¾‹2ï¼š
æ°´çš„åŒ–å­¦å¼æ˜¯ä»€ä¹ˆï¼Ÿ//H2O//CO2//O2//NaCl//H2O

ç¤ºä¾‹3ï¼š
å…‰é€Ÿçº¦ä¸ºæ¯ç§’å¤šå°‘å…¬é‡Œï¼Ÿ//30ä¸‡//10ä¸‡//50ä¸‡//100ä¸‡//30ä¸‡</pre>
                        </div>
                        
                        <textarea class="textarea-field" id="sub-example" rows="3" placeholder="é¢˜ç›®ç¤ºä¾‹ï¼ˆä½¿ç”¨ä¸Šè¿°æ ¼å¼ï¼Œå¯é€‰ï¼‰"></textarea>
                        
                        <p style="font-size: 14px; color: var(--text-sub); margin: 20px 0;">* æäº¤åéœ€ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡æ‰ä¼šæ˜¾ç¤ºåœ¨çŸ¥è¯†åº“å’Œæ¸¸æˆä¸­</p>
                        
                        <button class="btn btn-success" onclick="submitPost()">
                            <i class="fas fa-paper-plane"></i> æäº¤å®¡æ ¸
                        </button>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®é¡µé¢ -->
            <div id="view-settings" class="page">
                <div class="animate-float">
                    <h1 style="margin: 0 0 30px 0; font-size: 32px; font-weight: 700;">âš™ï¸ ä¸ªæ€§åŒ–è®¾ç½®</h1>
                    
                    <div class="glass">
                        <h3 style="margin-top: 0;"><i class="fas fa-palette"></i> ä¸»é¢˜é¢œè‰²</h3>
                        <p style="color: var(--text-sub); margin-bottom: 20px;">é€‰æ‹©ä½ å–œæ¬¢çš„ç•Œé¢ä¸»é¢˜è‰²</p>
                        
                        <div class="theme-grid">
                            <div class="theme-color active" style="background: linear-gradient(135deg, #6366F1, #8B5CF6);" onclick="setTheme('indigo', this)" title="é›è“"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #10B981, #34D399);" onclick="setTheme('emerald', this)" title="ç¿¡ç¿ ç»¿"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #F59E0B, #FBBF24);" onclick="setTheme('amber', this)" title="ç¥ç€é»„"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #F43F5E, #FB7185);" onclick="setTheme('rose', this)" title="ç«ç‘°çº¢"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #06B6D4, #22D3EE);" onclick="setTheme('cyan', this)" title="é’è“è‰²"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);" onclick="setTheme('violet', this)" title="ç´«ç½—å…°"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #14B8A6, #2DD4BF);" onclick="setTheme('teal', this)" title="å‡«ç»¿è‰²"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #D946EF, #E879F9);" onclick="setTheme('fuchsia', this)" title="ç´«çº¢è‰²"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #64748B, #94A3B8);" onclick="setTheme('slate', this)" title="çŸ³æ¿ç°"></div>
                            <div class="theme-color" style="background: linear-gradient(135deg, #1E293B, #475569);" onclick="setTheme('dark', this)" title="æ·±è‰²æ¨¡å¼"></div>
                        </div>
                    </div>
                    
                    <div class="glass">
                        <h3 style="margin-top: 0;"><i class="fas fa-user-circle"></i> è´¦æˆ·ä¿¡æ¯</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">ç”¨æˆ·å</p>
                                <p style="color: var(--text-sub); margin: 0;" id="set-username">...</p>
                            </div>
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">ç”µå­é‚®ç®±</p>
                                <p style="color: var(--text-sub); margin: 0;" id="set-email">...</p>
                            </div>
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">å½“å‰ç§¯åˆ†</p>
                                <p style="color: var(--text-sub); margin: 0;" id="set-score">0</p>
                            </div>
                            <div>
                                <p style="font-weight: 600; margin: 0 0 5px 0;">å¯¹æˆ˜è®°å½•</p>
                                <p style="color: var(--text-sub); margin: 0;" id="set-record">0èƒœ 0è´Ÿ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†åå°é¡µé¢ -->
            <div id="view-admin" class="page">
                <div class="animate-float">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 30px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #F59E0B, #D97706); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-shield-alt" style="color: white; font-size: 24px;"></i>
                        </div>
                        <div>
                            <h1 style="margin: 0; font-size: 32px; font-weight: 700; color: #F59E0B;">ğŸ›¡ ç®¡ç†åå°</h1>
                            <p style="color: var(--text-sub); margin: 10px 0 0 0;">å®¡æ ¸å†…å®¹ï¼Œç»´æŠ¤ç¤¾åŒºç§©åº</p>
                        </div>
                    </div>
                    
                    <div class="capsule-row">
                        <div class="capsule active" onclick="loadAdmin('kb', this)">çŸ¥è¯†å®¡æ ¸</div>
                        <div class="capsule" onclick="loadAdmin('chat', this)">ç•™è¨€ä¸¾æŠ¥</div>
                        <div class="capsule" onclick="loadAdmin('users', this)">ç”¨æˆ·ç®¡ç†</div>
                        <div class="capsule" onclick="loadAdmin('stats', this)">æ•°æ®ç»Ÿè®¡</div>
                    </div>
                    
                    <div id="admin-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆé€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="game-select-modal" style="display: none;">
        <div class="modal-content">
            <h2 style="margin-top: 0;">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
            <p style="color: var(--text-sub); margin-bottom: 30px;">æ‰€æœ‰é¢˜ç›®éƒ½ä»çŸ¥è¯†åº“ä¸­æ™ºèƒ½ç”Ÿæˆ</p>
            
            <div class="game-grid">
                <div class="game-card" onclick="createRoom('quick_quiz')">
                    <i class="fas fa-bolt"></i>
                    <h4>å¿«é€Ÿé—®ç­”</h4>
                    <small>60ç§’æŒ‘æˆ˜</small>
                </div>
                <div class="game-card" onclick="createRoom('memory_match')">
                    <i class="fas fa-brain"></i>
                    <h4>è®°å¿†é…å¯¹</h4>
                    <small>è®°å¿†è®­ç»ƒ</small>
                </div>
                <div class="game-card" onclick="createRoom('typing_race')">
                    <i class="fas fa-keyboard"></i>
                    <h4>æ‰“å­—ç«èµ›</h4>
                    <small>é€Ÿåº¦æ¯”æ‹¼</small>
                </div>
                <div class="game-card" onclick="createRoom('survival_mode')">
                    <i class="fas fa-fire"></i>
                    <h4>ç”Ÿå­˜æ¨¡å¼</h4>
                    <small>æ— å°½æŒ‘æˆ˜</small>
                </div>
            </div>
            
            <button class="btn btn-ghost" onclick="hideModal('game-select-modal')" style="width: 100%; margin-top: 20px;">
                å–æ¶ˆ
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆè¿›è¡Œä¸­æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="game-modal" style="display: none;">
        <div class="modal-content">
            <div id="game-container"></div>
        </div>
    </div>

    <script>
        // ================= é…ç½®ä¸åˆå§‹åŒ– =================
        const SB_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SB_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // å…¨å±€å˜é‡
        let user = null;
        let profile = null;
        let replyingTo = null;
        let currentCategory = 'chi';
        
        // å®Œæ•´çš„é¦™æ¸¯ä¸­å­¦ç§‘ç›®åˆ†ç±»ï¼ˆå«"å…¶ä»–"ï¼‰
        const categories = [
            // æ ¸å¿ƒç§‘ç›®
            {k:'chi', n:'ä¸­åœ‹èªæ–‡'},
            {k:'eng', n:'è‹±åœ‹èªæ–‡'},
            {k:'math', n:'æ•¸å­¸'},
            {k:'ls', n:'é€šè­˜æ•™è‚²'},
            // ç†ç§‘
            {k:'phy', n:'ç‰©ç†'},
            {k:'chem', n:'åŒ–å­¸'},
            {k:'bio', n:'ç”Ÿç‰©'},
            {k:'ict', n:'è³‡è¨ŠåŠé€šè¨Šç§‘æŠ€'},
            // æ–‡ç§‘
            {k:'hist', n:'æ­·å²'},
            {k:'geo', n:'åœ°ç†'},
            {k:'econ', n:'ç¶“æ¿Ÿ'},
            {k:'bafs', n:'ä¼æ¥­ã€æœƒè¨ˆèˆ‡è²¡å‹™æ¦‚è«–'},
            // å…¶ä»–
            {k:'other', n:'å…¶ä»–ç§‘ç›®'}
        ];

        // æ¸¸æˆé…ç½®
        const games = [
            {id: 'quick_quiz', name: 'å¿«é€Ÿé—®ç­”', icon: 'bolt', color: '#F59E0B', desc: '60ç§’å†…å›ç­”å°½å¯èƒ½å¤šçš„é—®é¢˜'},
            {id: 'memory_match', name: 'è®°å¿†é…å¯¹', icon: 'brain', color: '#8B5CF6', desc: 'åŒ¹é…ç›¸å…³çš„æ¦‚å¿µå’Œå®šä¹‰'},
            {id: 'typing_race', name: 'æ‰“å­—ç«èµ›', icon: 'keyboard', color: '#10B981', desc: 'å¿«é€Ÿè¾“å…¥æ­£ç¡®ç­”æ¡ˆ'},
            {id: 'survival_mode', name: 'ç”Ÿå­˜æ¨¡å¼', icon: 'fire', color: '#EF4444', desc: 'ç­”é”™å³ç»“æŸçš„æ— å°½æŒ‘æˆ˜'}
        ];

        // ================= åˆå§‹åŒ–å‡½æ•° =================
        window.onload = async () => {
            // åˆå§‹åŒ–ç§‘ç›®é€‰æ‹©å™¨
            initCategories();
            initSoloGames();
            
            // æ£€æŸ¥ä¼šè¯ä½†ä¸è‡ªåŠ¨ç™»å½•
            const { data } = await sb.auth.getSession();
            if(data.session) {
                document.getElementById('resume-btn').style.display = 'inline-flex';
            }
            
            // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem('dse-theme') || 'indigo';
            setTheme(savedTheme, document.querySelector(`.theme-color[onclick*="${savedTheme}"]`));
            
            // æ·»åŠ ä¸€äº›è§†è§‰ç‰¹æ•ˆ
            createSparkles();
        };

        function initCategories() {
            // çŸ¥è¯†åº“ç§‘ç›®é€‰æ‹©
            const kbCatsHtml = categories.map(cat => 
                `<div class="capsule ${cat.k === 'chi' ? 'active' : ''}" onclick="setCategory('${cat.k}', this)">
                    ${cat.n}
                </div>`
            ).join('');
            
            document.getElementById('kb-cats').innerHTML = kbCatsHtml;
            document.getElementById('sub-cats').innerHTML = kbCatsHtml;
        }

        function initSoloGames() {
            const soloGamesHtml = games.map(game => `
                <div class="game-card" onclick="startSoloGame('${game.id}')" style="border-top: 4px solid ${game.color};">
                    <i class="fas fa-${game.icon}" style="color: ${game.color};"></i>
                    <h4 style="margin: 10px 0 5px 0;">${game.name}</h4>
                    <small style="color: var(--text-sub);">${game.desc}</small>
                </div>
            `).join('');
            
            document.getElementById('solo-games').innerHTML = soloGamesHtml;
        }

        function createSparkles() {
            const container = document.querySelector('.app-container');
            for(let i = 0; i < 20; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = Math.random() * 100 + 'vw';
                sparkle.style.top = Math.random() * 100 + 'vh';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                container?.appendChild(sparkle);
            }
        }

        // ================= è®¤è¯ç³»ç»Ÿ =================
        async function auth(type) {
            const email = document.getElementById('lg-e').value;
            const password = document.getElementById('lg-p').value;
            
            if(!email || !password) {
                showMessage('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            let result;
            if(type === 'up') {
                result = await sb.auth.signUp({email, password});
            } else {
                result = await sb.auth.signInWithPassword({email, password});
            }

            if(result.error) {
                showMessage(result.error.message, 'error');
            } else {
                await enter(result.data.user);
            }
        }

        async function resume() {
            const { data } = await sb.auth.getSession();
            if(data.session) {
                await enter(data.session.user);
            }
        }

        async function enter(u) {
            user = u;
            
            // è·å–æˆ–åˆ›å»ºç”¨æˆ·èµ„æ–™
            let { data } = await sb.from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();
            
            if(!data) {
                // åˆ›å»ºæ–°ç”¨æˆ·èµ„æ–™
                data = {
                    id: user.id,
                    username: user.email.split('@')[0],
                    email: user.email,
                    score: 0,
                    is_admin: false,
                    games_played: 0,
                    high_score: 0,
                    duel_wins: 0,
                    duel_losses: 0,
                    auth_id: user.id
                };
                
                await sb.from('profiles').insert(data);
            }
            
            profile = data;
            
            // æ›´æ–°UI
            updateUserUI();
            
            // éšè—è®¤è¯å±‚ï¼Œæ˜¾ç¤ºä¸»åº”ç”¨
            document.getElementById('auth-layer').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';
            
            // åŠ è½½åˆå§‹æ•°æ®
            nav('home');
        }

        function updateUserUI() {
            document.getElementById('u-name').textContent = profile.username + (profile.is_admin ? ' ğŸ‘‘' : '');
            document.getElementById('u-score').textContent = profile.score;
            document.getElementById('set-username').textContent = profile.username;
            document.getElementById('set-email').textContent = profile.email;
            document.getElementById('set-score').textContent = profile.score;
            document.getElementById('set-record').textContent = `${profile.duel_wins || 0}èƒœ ${profile.duel_losses || 0}è´Ÿ`;
            
            if(profile.is_admin) {
                document.getElementById('admin-link').style.display = 'flex';
            }
        }

        function logout() {
            if(confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                sb.auth.signOut().then(() => {
                    localStorage.removeItem('supabase.auth.token');
                    location.reload();
                });
            }
        }

        function showMessage(message, type = 'info') {
            const msgEl = document.getElementById('lg-msg');
            msgEl.textContent = message;
            msgEl.style.color = type === 'error' ? '#EF4444' : '#10B981';
            
            setTimeout(() => {
                msgEl.textContent = '';
            }, 5000);
        }

        // ================= çŸ¥è¯†åº“ç³»ç»Ÿ =================
        async function fetchHome() {
            const searchTerm = document.getElementById('kb-search').value;
            
            let query = sb.from('submissions')
                .select('*')
                .eq('status', 'approved')
                .eq('category', currentCategory);
            
            if(searchTerm) {
                query = query.or(`title.ilike.%${searchTerm}%,content.ilike.%${searchTerm}%`);
            }
            
            const { data, error } = await query.order('created_at', {ascending: false});
            
            if(error) {
                console.error('è·å–çŸ¥è¯†åº“å¤±è´¥:', error);
                return;
            }
            
            const categoryName = categories.find(c => c.k === currentCategory)?.n || currentCategory;
            document.getElementById('current-category').textContent = categoryName;
            
            const kbList = document.getElementById('kb-list');
            
            if(!data || data.length === 0) {
                kbList.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <i class="fas fa-book" style="font-size: 48px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <h3>æš‚æ— å†…å®¹</h3>
                        <p style="color: var(--text-sub);">å½“å‰åˆ†ç±»ä¸‹è¿˜æ²¡æœ‰é€šè¿‡å®¡æ ¸çš„çŸ¥è¯†ç‚¹</p>
                        <button class="btn btn-ghost" onclick="nav('submit')">å»æŠ•ç¨¿</button>
                    </div>
                `;
                return;
            }
            
            kbList.innerHTML = data.map(item => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ¸¸æˆé¢˜ç›®æ ¼å¼
                const hasGameFormat = item.content.includes('//') || (item.example && item.example.includes('//'));
                const gameBadge = hasGameFormat ? '<span class="category-badge" style="background: #10B981; margin-left: 10px;">ğŸ® å¯æ¸¸æˆåŒ–</span>' : '';
                
                // è§£æå¯èƒ½çš„é¢˜ç›®æ ¼å¼
                let exampleHtml = '';
                if(item.example && item.example.includes('//')) {
                    const parts = item.example.split('//');
                    if(parts.length >= 6) {
                        exampleHtml = `
                            <div class="glass" style="margin-top: 15px; background: rgba(16, 185, 129, 0.05);">
                                <h4 style="margin-top: 0; color: #10B981;">ğŸ¯ é¢˜ç›®ç¤ºä¾‹</h4>
                                <p><strong>é—®é¢˜ï¼š</strong>${parts[0]}</p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0;">
                                    <div class="option-btn">A. ${parts[1]}</div>
                                    <div class="option-btn">B. ${parts[2]}</div>
                                    <div class="option-btn">C. ${parts[3]}</div>
                                    <div class="option-btn">D. ${parts[4]}</div>
                                </div>
                                <p><strong>æ­£ç¡®ç­”æ¡ˆï¼š</strong> ${parts[5]}</p>
                            </div>
                        `;
                    }
                }
                
                return `
                    <div class="glass kb-card animate-float">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <h3 style="margin: 0 0 10px 0;">${item.title}</h3>
                            ${gameBadge}
                        </div>
                        <p style="color: var(--text-sub); margin-bottom: 15px; line-height: 1.6;">${item.content}</p>
                        ${exampleHtml}
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; font-size: 13px;">
                            <span style="color: var(--accent);">
                                <i class="fas fa-user"></i> ${item.author_name}
                            </span>
                            <span style="color: var(--text-sub);">
                                <i class="fas fa-calendar"></i> ${new Date(item.created_at).toLocaleDateString('zh-HK')}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setCategory(category, element) {
            currentCategory = category;
            
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.capsule').forEach(capsule => {
                capsule.classList.remove('active');
            });
            
            if(element) {
                element.classList.add('active');
            }
            
            // è·å–æ•°æ®
            fetchHome();
        }

        // ================= æ¸¸æˆç³»ç»Ÿ =================
        function showGameSelect() {
            showModal('game-select-modal');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        async function createRoom(gameType) {
            // ä»çŸ¥è¯†åº“è·å–é¢˜ç›®
            const questions = await fetchQuestionsForGame(currentCategory, gameType);
            
            if(questions.length === 0) {
                alert('å½“å‰åˆ†ç±»ä¸‹æ²¡æœ‰å¯ç”¨çš„é¢˜ç›®ï¼Œè¯·å…ˆæŠ•ç¨¿æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»');
                return;
            }
            
            // æ„å»ºæˆ¿é—´æ•°æ®ï¼ˆåŒ¹é…æ•°æ®åº“ç»“æ„ï¼‰
            const roomData = {
                player1_id: user.id,
                player1_name: profile.username,
                game_type: gameType,
                status: 'waiting',
                p1_score: 0,
                p2_score: 0,
                settings: {
                    category: currentCategory,
                    question_count: questions.length,
                    questions: questions.slice(0, 10) // åªå­˜å‚¨å‰10é¢˜
                },
                winner_id: null,
                created_at: new Date().toISOString()
            };
            
            const { data, error } = await sb.from('duel_rooms').insert(roomData);
            
            if(error) {
                console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error);
                alert(`åˆ›å»ºå¤±è´¥: ${error.message}`);
                return;
            }
            
            hideModal('game-select-modal');
            alert(`ğŸ® ${games.find(g => g.id === gameType)?.name || gameType} æˆ¿é—´åˆ›å»ºæˆåŠŸï¼`);
            fetchDuels();
        }

        async function fetchQuestionsForGame(category, gameType) {
            // ä»çŸ¥è¯†åº“è·å–å·²å®¡æ ¸çš„å†…å®¹
            const { data, error } = await sb.from('submissions')
                .select('title, content, example')
                .eq('status', 'approved')
                .eq('category', category)
                .limit(20);
            
            if(error || !data) return [];
            
            const questions = [];
            
            data.forEach(item => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ¸¸æˆæ ¼å¼çš„å†…å®¹
                if(item.example && item.example.includes('//')) {
                    const parts = item.example.split('//');
                    if(parts.length >= 6) {
                        questions.push({
                            question: parts[0],
                            options: parts.slice(1, 5),
                            answer: parts[5],
                            source: item.title
                        });
                    }
                }
                
                // ä¹Ÿå¯ä»¥ä»å†…å®¹ä¸­è§£æ
                if(item.content.includes('ï¼Ÿ') && item.content.includes('//')) {
                    const lines = item.content.split('\n');
                    lines.forEach(line => {
                        if(line.includes('ï¼Ÿ') && line.includes('//')) {
                            const parts = line.split('//');
                            if(parts.length >= 6) {
                                questions.push({
                                    question: parts[0],
                                    options: parts.slice(1, 5),
                                    answer: parts[5],
                                    source: item.title
                                });
                            }
                        }
                    });
                }
            });
            
            return questions;
        }

        async function startSoloGame(gameType) {
            // è·å–é¢˜ç›®
            const questions = await fetchQuestionsForGame(currentCategory, gameType);
            
            if(questions.length === 0) {
                alert('å½“å‰åˆ†ç±»ä¸‹æ²¡æœ‰å¯ç”¨çš„é¢˜ç›®ï¼Œè¯·å…ˆæŠ•ç¨¿æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»');
                return;
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            showGameInterface(gameType, questions, true);
        }

        function showGameInterface(gameType, questions, isSolo = true) {
            const gameContainer = document.getElementById('game-container');
            const gameInfo = games.find(g => g.id === gameType) || games[0];
            
            let gameHtml = `
                <div class="game-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h2 style="margin: 0; color: ${gameInfo.color};">${gameInfo.name}</h2>
                            <p style="color: var(--text-sub); margin: 5px 0 0 0;">${isSolo ? 'å•äººç»ƒä¹ ' : 'å¤šäººå¯¹æˆ˜'} â€¢ ${categories.find(c => c.k === currentCategory)?.n || 'éšæœº'}</p>
                        </div>
                        <div style="text-align: right;">
                            <div class="score-display" id="game-score">0</div>
                            <p style="color: var(--text-sub); margin: 0;">ç§¯åˆ†</p>
                        </div>
                    </div>
                    
                    <div id="game-timer" class="timer-bar" style="width: 100%;"></div>
                    
                    <div id="question-area" style="min-height: 300px;"></div>
                </div>
            `;
            
            gameContainer.innerHTML = gameHtml;
            showModal('game-modal');
            
            // å¼€å§‹æ¸¸æˆé€»è¾‘
            startGameSession(gameType, questions, isSolo);
        }

        function startGameSession(gameType, questions, isSolo) {
            let currentQuestion = 0;
            let score = 0;
            let timeLeft = 60;
            let timerInterval;
            
            function updateQuestion() {
                if(currentQuestion >= questions.length) {
                    endGame();
                    return;
                }
                
                const q = questions[currentQuestion];
                const questionArea = document.getElementById('question-area');
                
                questionArea.innerHTML = `
                    <div class="question-card animate-float">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <span class="category-badge">${categories.find(c => c.k === currentCategory)?.n || 'é¢˜ç›®'}</span>
                            <span style="color: var(--text-sub); font-size: 14px;">${currentQuestion + 1}/${questions.length}</span>
                        </div>
                        
                        <h3 style="margin: 0 0 30px 0; font-size: 20px; line-height: 1.5;">${q.question}</h3>
                        
                        <div class="options-grid">
                            ${q.options.map((option, index) => `
                                <button class="option-btn" onclick="checkAnswer(${index}, '${q.answer}')">
                                    ${String.fromCharCode(65 + index)}. ${option}
                                </button>
                            `).join('')}
                        </div>
                        
                        <p style="color: var(--text-sub); margin-top: 20px; font-size: 13px;">
                            <i class="fas fa-book"></i> æ¥æº: ${q.source}
                        </p>
                    </div>
                `;
            }
            
            function checkAnswer(selectedIndex, correctAnswer) {
                const options = document.querySelectorAll('.option-btn');
                const selectedOption = q.options[selectedIndex];
                
                options.forEach((btn, idx) => {
                    if(q.options[idx] === correctAnswer) {
                        btn.classList.add('correct');
                    }
                    if(idx === selectedIndex && q.options[idx] !== correctAnswer) {
                        btn.classList.add('wrong');
                    }
                    btn.disabled = true;
                });
                
                if(selectedOption === correctAnswer) {
                    score += 10;
                    document.getElementById('game-score').textContent = score;
                    
                    // æ·»åŠ å¾—åˆ†åŠ¨ç”»
                    const scoreEl = document.getElementById('game-score');
                    scoreEl.style.animation = 'none';
                    setTimeout(() => {
                        scoreEl.style.animation = 'pulse 0.5s ease';
                    }, 10);
                }
                
                setTimeout(() => {
                    currentQuestion++;
                    updateQuestion();
                }, 1500);
            }
            
            function updateTimer() {
                const timerBar = document.getElementById('game-timer');
                const percentage = (timeLeft / 60) * 100;
                timerBar.style.width = percentage + '%';
                
                if(timeLeft <= 0) {
                    endGame();
                }
                timeLeft--;
            }
            
            function endGame() {
                clearInterval(timerInterval);
                
                document.getElementById('question-area').innerHTML = `
                    <div class="question-card" style="text-align: center;">
                        <i class="fas fa-trophy" style="font-size: 60px; color: var(--accent); margin-bottom: 20px;"></i>
                        <h2>æ¸¸æˆç»“æŸï¼</h2>
                        <div class="score-display">${score}</div>
                        <p style="color: var(--text-sub); margin-bottom: 30px;">æœ€ç»ˆå¾—åˆ†</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0;">
                            <div class="glass" style="padding: 15px;">
                                <div style="font-size: 12px; color: var(--text-sub);">ç­”å¯¹é¢˜æ•°</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--accent);">${Math.floor(score / 10)}</div>
                            </div>
                            <div class="glass" style="padding: 15px;">
                                <div style="font-size: 12px; color: var(--text-sub);">å‡†ç¡®ç‡</div>
                                <div style="font-size: 24px; font-weight: bold; color: var(--accent);">${questions.length > 0 ? Math.floor((score / 10) / questions.length * 100) : 0}%</div>
                            </div>
                        </div>
                        
                        <button class="btn" onclick="hideModal('game-modal'); nav('duel');" style="width: 100%; margin-top: 10px;">
                            è¿”å›æ¸¸æˆä¸­å¿ƒ
                        </button>
                    </div>
                `;
                
                // å¦‚æœæ˜¯å•äººæ¸¸æˆï¼Œæ›´æ–°ç”¨æˆ·ç§¯åˆ†
                if(isSolo && score > 0) {
                    updateUserScore(score);
                }
            }
            
            function updateUserScore(points) {
                const newScore = (profile.score || 0) + points;
                profile.score = newScore;
                
                // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
                document.getElementById('u-score').textContent = newScore;
                document.getElementById('set-score').textContent = newScore;
                
                // æ›´æ–°æ•°æ®åº“
                sb.from('profiles')
                    .update({ score: newScore })
                    .eq('id', user.id)
                    .then(() => {
                        console.log('ç§¯åˆ†æ›´æ–°æˆåŠŸ');
                    });
            }
            
            // å¯åŠ¨è®¡æ—¶å™¨
            timerInterval = setInterval(updateTimer, 1000);
            
            // æ˜¾ç¤ºç¬¬ä¸€é¢˜
            updateQuestion();
        }

        async function fetchDuels() {
            const { data, error } = await sb.from('duel_rooms')
                .select('*')
                .is('winner_id', null)
                .order('created_at', {ascending: false})
                .limit(20);
            
            if(error) {
                console.error('è·å–æˆ¿é—´å¤±è´¥:', error);
                return;
            }
            
            const duelList = document.getElementById('duel-list');
            
            if(!data || data.length === 0) {
                duelList.innerHTML = `
                    <div class="glass" style="text-align: center; padding: 40px;">
                        <i class="fas fa-door-open" style="font-size: 48px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <h3>æš‚æ— æˆ¿é—´</h3>
                        <p style="color: var(--text-sub); margin-bottom: 20px;">è¿˜æ²¡æœ‰äººåˆ›å»ºæˆ¿é—´ï¼Œå¿«æ¥åˆ›å»ºç¬¬ä¸€ä¸ªå§ï¼</p>
                        <button class="btn" onclick="showGameSelect()">åˆ›å»ºæˆ¿é—´</button>
                    </div>
                `;
                return;
            }
            
            duelList.innerHTML = data.map(room => {
                const isPlayer = room.player1_id === user.id || room.player2_id === user.id;
                const isFull = room.player2_id != null;
                const gameInfo = games.find(g => g.id === room.game_type) || games[0];
                
                let buttonHtml = '';
                if(isPlayer) {
                    buttonHtml = `<button class="btn btn-success btn-small" onclick="enterRoom('${room.id}')">è¿›å…¥æˆ¿é—´</button>`;
                } else if(!isFull) {
                    buttonHtml = `<button class="btn btn-small" onclick="joinRoom('${room.id}')">åŠ å…¥å¯¹æˆ˜</button>`;
                } else {
                    buttonHtml = `<button class="btn btn-ghost btn-small" disabled>è¿›è¡Œä¸­</button>`;
                }
                
                return `
                    <div class="glass animate-float" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="width: 10px; height: 10px; border-radius: 50%; background: ${gameInfo.color};"></div>
                                <h4 style="margin: 0;">${gameInfo.name}</h4>
                            </div>
                            <div style="font-size: 13px; color: var(--text-sub);">
                                <div><i class="fas fa-user"></i> ${room.player1_name}</div>
                                <div><i class="fas fa-users"></i> ${room.player2_id ? '2/2 ç©å®¶' : '1/2 ç©å®¶'}</div>
                            </div>
                        </div>
                        <div>
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function joinRoom(roomId) {
            const { data, error } = await sb.from('duel_rooms')
                .update({
                    player2_id: user.id,
                    player2_name: profile.username,
                    status: 'playing'
                })
                .eq('id', roomId)
                .select()
                .single();
            
            if(error) {
                alert('åŠ å…¥æˆ¿é—´å¤±è´¥: ' + error.message);
                return;
            }
            
            // è·å–æˆ¿é—´çš„é¢˜ç›®å¹¶å¼€å§‹æ¸¸æˆ
            const questions = data.settings?.questions || [];
            if(questions.length > 0) {
                showGameInterface(data.game_type, questions, false);
            }
            
            fetchDuels();
        }

        async function enterRoom(roomId) {
            const { data, error } = await sb.from('duel_rooms')
                .select('*')
                .eq('id', roomId)
                .single();
            
            if(error) return;
            
            const questions = data.settings?.questions || await fetchQuestionsForGame(data.settings?.category || currentCategory, data.game_type);
            showGameInterface(data.game_type, questions, false);
        }

        // ================= ç•™è¨€æ¿ç³»ç»Ÿ =================
        async function loadChat() {
            // ... (ç•™è¨€æ¿ä»£ç ä¿æŒåŸæ ·ï¼Œä¸ºèŠ‚çœç¯‡å¹…çœç•¥)
        }

        // ================= æ’è¡Œæ¦œç³»ç»Ÿ =================
        async function fetchRank() {
            const { data, error } = await sb.from('profiles')
                .select('username, score, duel_wins, duel_losses, games_played')
                .order('score', {ascending: false})
                .limit(20);
            
            if(error) return;
            
            const rankList = document.getElementById('rank-list');
            
            rankList.innerHTML = data.map((player, index) => {
                const rankClass = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : `#${index + 1}`;
                const isCurrentUser = player.username === profile?.username;
                
                return `
                    <div class="glass animate-float" style="${isCurrentUser ? 'border: 2px solid var(--accent);' : ''}">
                        <div style="display: flex; align-items: center; gap: 20px;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: white;">
                                ${rankClass}
                            </div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h4 style="margin: 0;">${player.username} ${isCurrentUser ? 'ğŸ‘¤' : ''}</h4>
                                    <div class="score-display" style="font-size: 24px;">${player.score}</div>
                                </div>
                                <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 12px; color: var(--text-sub);">
                                    <span><i class="fas fa-gamepad"></i> ${player.games_played || 0} åœº</span>
                                    <span><i class="fas fa-trophy"></i> ${player.duel_wins || 0} èƒœ</span>
                                    <span><i class="fas fa-times"></i> ${player.duel_losses || 0} è´Ÿ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ================= æŠ•ç¨¿ç³»ç»Ÿ =================
        function submitPost() {
            const title = document.getElementById('sub-t').value.trim();
            const content = document.getElementById('sub-c').value.trim();
            const example = document.getElementById('sub-example').value.trim();
            
            if(!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            const submission = {
                category: currentCategory,
                title: title,
                content: content,
                example: example,
                user_id: user.id,
                author_name: profile.username,
                status: 'pending',
                like_count: 0,
                view_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            sb.from('submissions').insert(submission)
                .then(() => {
                    alert('âœ… æŠ•ç¨¿æäº¤æˆåŠŸï¼ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸ã€‚');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('sub-t').value = '';
                    document.getElementById('sub-c').value = '';
                    document.getElementById('sub-example').value = '';
                    nav('home');
                })
                .catch(error => {
                    alert('æäº¤å¤±è´¥: ' + error.message);
                });
        }

        // ================= åå°ç®¡ç†ç³»ç»Ÿ =================
        async function loadAdmin(tab, element) {
            if(!profile?.is_admin) return;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.capsule').forEach(capsule => {
                capsule.classList.remove('active');
            });
            
            if(element) {
                element.classList.add('active');
            }
            
            const adminList = document.getElementById('admin-list');
            
            if(tab === 'kb') {
                // çŸ¥è¯†å®¡æ ¸
                const { data } = await sb.from('submissions')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', {ascending: false});
                
                adminList.innerHTML = (data || []).map(item => `
                    <div class="glass animate-float">
                        <h4 style="margin: 0 0 10px 0;">${item.title}</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <span class="category-badge">${categories.find(c => c.k === item.category)?.n || item.category}</span>
                            <span style="color: var(--text-sub); font-size: 13px;">æŠ•ç¨¿äºº: ${item.author_name}</span>
                        </div>
                        <p style="margin-bottom: 20px;">${item.content}</p>
                        
                        ${item.example ? `
                            <div class="glass" style="margin-bottom: 20px; background: rgba(99, 102, 241, 0.05);">
                                <h5 style="margin-top: 0; color: var(--accent);">é¢˜ç›®ç¤ºä¾‹</h5>
                                <pre style="background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; font-size: 13px; margin: 0; white-space: pre-wrap;">${item.example}</pre>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success btn-small" onclick="adminAction('submissions', '${item.id}', 'approved')">
                                <i class="fas fa-check"></i> é€šè¿‡
                            </button>
                            <button class="btn btn-danger btn-small" onclick="adminAction('submissions', '${item.id}', 'rejected')">
                                <i class="fas fa-times"></i> æ‹’ç»
                            </button>
                        </div>
                    </div>
                `).join('');
            } else if(tab === 'chat') {
                // ç•™è¨€ä¸¾æŠ¥å¤„ç†ï¼ˆä»£ç ç±»ä¼¼ï¼Œä¸ºèŠ‚çœç¯‡å¹…çœç•¥ï¼‰
            }
        }

        async function adminAction(table, id, action) {
            if(!confirm(`ç¡®å®šè¦${action === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»'}æ­¤å†…å®¹å—ï¼Ÿ`)) return;
            
            await sb.from(table).update({status: action}).eq('id', id);
            alert('æ“ä½œæˆåŠŸï¼');
            loadAdmin(document.querySelector('.capsule.active').innerText.includes('çŸ¥è¯†') ? 'kb' : 'chat');
        }

        // ================= UI äº¤äº’å‡½æ•° =================
        function nav(pageId, element) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(`view-${pageId}`).classList.add('active');
            
            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            if(element) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                element.classList.add('active');
            }
            
            // ç§»åŠ¨ç«¯å…³é—­ä¾§è¾¹æ 
            if(window.innerWidth < 768) {
                document.querySelector('.sidebar').style.display = 'none';
            }
            
            // åŠ è½½é¡µé¢æ•°æ®
            switch(pageId) {
                case 'home':
                    fetchHome();
                    break;
                case 'duel':
                    fetchDuels();
                    break;
                case 'rank':
                    fetchRank();
                    break;
                case 'admin':
                    if(profile?.is_admin) loadAdmin('kb');
                    break;
            }
        }

        function setTheme(theme, element) {
            // æ›´æ–°ä¸»é¢˜
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('dse-theme', theme);
            
            // æ›´æ–°ä¸»é¢˜é€‰æ‹©å™¨çŠ¶æ€
            document.querySelectorAll('.theme-color').forEach(color => {
                color.classList.remove('active');
            });
            
            if(element) {
                element.classList.add('active');
            }
        }

        function addTag(tag) {
            const chatInput = document.getElementById('chat-in');
            chatInput.value += tag + ' ';
            chatInput.focus();
        }

        function setReply(id, name) {
            replyingTo = id;
            document.getElementById('reply-bar').style.display = 'flex';
            document.getElementById('reply-user').textContent = name;
        }

        function cancelReply() {
            replyingTo = null;
            document.getElementById('reply-bar').style.display = 'none';
        }

        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            if(window.innerWidth < 768) {
                sidebar.style.display = sidebar.style.display === 'flex' ? 'none' : 'flex';
            }
        }

        // å…¨å±€é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // ESC å…³é—­æ¨¡æ€æ¡†
            if(e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.style.display = 'none';
                });
            }
            
            // Ctrl+K æœç´¢
            if(e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('kb-search').focus();
            }
        });

        // é¡µé¢åŠ è½½åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ åˆå§‹åŠ è½½åŠ¨ç”»
            setTimeout(() => {
                document.body.style.opacity = 1;
            }, 100);
        });
    </script>
</body>
</html>
