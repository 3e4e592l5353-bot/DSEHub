<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v61 - ç®¡ç†å‘˜å®Œå…¨ä½“</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ================= ğŸ¨ äº”è‰²ä¸»é¢˜å®šä¹‰ ================= */
        :root {
            /* é»˜è®¤: æ·±è“ (Blue) */
            --bg: #0f172a; --sidebar-bg: #1e293b; --card-bg: #1e293b;
            --text-main: #f1f5f9; --text-sub: #94a3b8;
            --primary: #6366f1; --border: #334155; --input-bg: #0f172a;
            --shadow: rgba(0,0,0,0.3);
        }
        [data-theme="black"] { /* çº¯é»‘ */
            --bg: #000000; --sidebar-bg: #111111; --card-bg: #111111;
            --text-main: #e5e5e5; --text-sub: #a3a3a3;
            --primary: #2563eb; --border: #333333; --input-bg: #000000;
            --shadow: rgba(255,255,255,0.15);
        }
        [data-theme="white"] { /* çº¯ç™½ */
            --bg: #f3f4f6; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --text-main: #1f2937; --text-sub: #6b7280;
            --primary: #3b82f6; --border: #e5e7eb; --input-bg: #f9fafb;
            --shadow: rgba(0,0,0,0.08);
        }
        [data-theme="orange"] { /* æ´»åŠ›æ©™ */
            --bg: #fff7ed; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --text-main: #7c2d12; --text-sub: #d97706;
            --primary: #f97316; --border: #fed7aa; --input-bg: #ffedd5;
            --shadow: rgba(249, 115, 22, 0.15);
        }
        [data-theme="pink"] { /* æ¨±èŠ±ç²‰ */
            --bg: #fff0f5; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --text-main: #831843; --text-sub: #db2777;
            --primary: #ec4899; --border: #fbcfe8; --input-bg: #fdf2f8;
            --shadow: rgba(236, 72, 153, 0.15);
        }

        /* ================= âœ¨ åŠ¨ç”» & å¸ƒå±€ ================= */
        body, .sidebar, .card, input, textarea, select, .nav-item, button, .chip, .fb-item, .theme-btn {
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body { margin: 0; font-family: 'Noto Sans SC', sans-serif; background: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        .sidebar { width: 260px; background: var(--sidebar-bg); display: flex; flex-direction: column; padding: 20px; border-right: 1px solid var(--border); z-index: 50; }
        .nav-item { padding: 12px; margin-bottom: 8px; cursor: pointer; border-radius: 10px; font-weight: 500; color: var(--text-sub); display: flex; align-items: center; gap: 8px; }
        .nav-item:hover { background: rgba(125,125,125,0.1); }
        .nav-item.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px var(--shadow); }

        .main { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page { display: none; max-width: 800px; margin: 0 auto; animation: fadeIn 0.4s; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }

        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; margin-bottom: 20px; border: 1px solid var(--border); box-shadow: 0 4px 20px var(--shadow); }
        
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 10px; background: var(--input-bg); border: 1px solid var(--border); color: var(--text-main); border-radius: 10px; box-sizing: border-box; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        button.small { width: auto; padding: 6px 14px; font-size: 12px; }
        .btn-green { background: #10b981; } .btn-red { background: #ef4444; }

        .theme-switch { display: flex; gap: 8px; margin-top: auto; justify-content: center; padding-top: 20px; border-top: 1px solid var(--border); }
        .theme-btn { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .theme-btn:hover { transform: scale(1.3); }
        .t-blue { background: #0f172a; border-color: #6366f1; }
        .t-black { background: #000000; border-color: #555; }
        .t-white { background: #ffffff; border-color: #ccc; }
        .t-orange { background: #f97316; border-color: #fed7aa; }
        .t-pink { background: #ec4899; border-color: #fbcfe8; }

        /* è¯„è®ºä¸ç®¡ç† */
        .fb-item { padding: 10px; margin-bottom: 8px; background: rgba(125,125,125,0.05); border-radius: 8px; font-size: 13px; border-left: 3px solid transparent; position: relative; }
        .fb-item:hover .del-btn { display: block; } /* é¼ æ ‡æ‚¬åœæ˜¾ç¤ºåˆ é™¤æŒ‰é’® */
        .fb-item.active-target { background: rgba(99, 102, 241, 0.1); border-left-color: var(--primary); }
        .admin-badge { background: #fee2e2; color: #b91c1c; font-size: 10px; padding: 2px 5px; border-radius: 4px; border:1px solid #fecaca; font-weight:bold;}
        
        .del-btn { display: none; position: absolute; right: 10px; top: 10px; color: #ef4444; font-weight: bold; cursor: pointer; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 4px; }
        .del-btn:hover { background: #ef4444; color: white; }

        .chip { background: rgba(125,125,125,0.1); padding: 5px 12px; border-radius: 20px; font-size: 11px; cursor: pointer; color: var(--text-sub); }
        .chip.selected { background: var(--primary); color: #fff; }

        .menu-btn { display: none; position: fixed; top: 10px; left: 10px; z-index: 100; background: var(--card-bg); border: 1px solid var(--border); color:var(--text-main); padding: 5px 10px; border-radius:6px;}
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height:100%; box-shadow: 10px 0 30px rgba(0,0,0,0.3); }
            .sidebar.active { transform: translateX(0); }
            .menu-btn { display: block; }
            .main { padding: 60px 15px 20px 15px; }
            .del-btn { display: block; } /* æ‰‹æœºç«¯å¸¸æ˜¾åˆ é™¤æŒ‰é’® */
        }
    </style>
</head>
<body data-theme="blue">
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    
    <div class="sidebar" id="sidebar">
        <div style="font-size:22px; font-weight:900; color:var(--primary); margin-bottom:30px; letter-spacing:-1px;">DSE HUB</div>
        
        <div id="user-panel" style="background:rgba(125,125,125,0.08); padding:15px; border-radius:12px; margin-bottom:20px; text-align:center;">
            <div id="u-name" style="font-weight:bold; font-size:14px; margin-bottom:10px; color:var(--text-main);">æœªç™»å½•</div>
            <button class="small" onclick="nav('auth')">ğŸ‘¤ ç™»å½•/æ³¨å†Œ</button>
        </div>

        <div class="nav-item active" onclick="nav('home')">ğŸ“š çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('duel')">âš”ï¸ åœ¨çº¿å¯¹æˆ˜</div>
        <div class="nav-item" onclick="nav('submit')">ğŸ“ æŠ•ç¨¿</div>
        <div class="nav-item" onclick="tryEnterAdmin()" style="color:#ef4444;">âš–ï¸ å®¡é˜…åå°</div>

        <div class="theme-switch">
            <div class="theme-btn t-blue" onclick="setTheme('blue')"></div>
            <div class="theme-btn t-black" onclick="setTheme('black')"></div>
            <div class="theme-btn t-white" onclick="setTheme('white')"></div>
            <div class="theme-btn t-orange" onclick="setTheme('orange')"></div>
            <div class="theme-btn t-pink" onclick="setTheme('pink')"></div>
        </div>
    </div>

    <div class="main">
        <div id="view-auth" class="page">
            <div class="card" style="text-align:center; max-width:400px; margin:50px auto;">
                <h2 style="color:var(--primary)">é€šè¡Œè¯</h2>
                <div id="auth-msg" style="background:rgba(16, 185, 129, 0.1); color:#10b981; padding:10px; border-radius:8px; font-size:12px; margin-bottom:15px; display:none;"></div>
                <input id="auth-email" placeholder="é‚®ç®±" type="email">
                <input id="auth-pass" placeholder="å¯†ç  (6ä½+)" type="password">
                <input id="auth-user" placeholder="æ˜µç§° (ä»…æ³¨å†Œéœ€è¦)">
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button onclick="doLogin()">ç™»å½•</button>
                    <button onclick="doRegister()" class="btn-green">æ³¨å†Œ</button>
                </div>
                <button onclick="doLogout()" id="btn-logout" class="btn-red" style="margin-top:15px; display:none;">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div id="view-home" class="page active">
            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input id="search" placeholder="ğŸ” æœç´¢..." onkeyup="renderKnowledge()" style="margin-bottom:0;">
                    <select id="filter-cat" onchange="renderKnowledge()" style="width:120px; margin-bottom:0;">
                        <option value="all">å…¨éƒ¨</option><option value="math">æ•°å­¦</option><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option>
                    </select>
                </div>
                <div id="list"></div>
            </div>
        </div>

        <div id="view-duel" class="page">
            <div class="card" id="duel-lobby" style="text-align:center; padding:50px;">
                <h2 style="color:var(--primary)">âš¡ æé€Ÿå¯¹å†³</h2>
                <button onclick="findMatch()" style="padding:15px 40px; font-size:18px; margin-top:20px;">ğŸ” åŒ¹é…å¯¹æ‰‹</button>
                <div id="match-status" style="margin-top:20px; color:var(--text-sub);"></div>
            </div>
            <div class="card" id="duel-arena" style="display:none;">
                <div style="display:flex; justify-content:space-around; font-size:24px; font-weight:bold; margin-bottom:20px; color:var(--primary);">
                    <span id="my-score">0</span> VS <span id="op-score">0</span>
                </div>
                <div id="duel-board" style="display:grid; grid-template-columns:repeat(2,1fr); gap:15px;"></div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <div class="card">
                <h2>æŠ•ç¨¿æ–°é¢˜</h2>
                <input id="sub-t" placeholder="æ ‡é¢˜">
                <select id="sub-cat"><option value="math">æ•°å­¦</option><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option></select>
                <textarea id="sub-d" rows="5" placeholder="å†…å®¹..."></textarea>
                <button onclick="submitKnowledge()" class="btn-green">æäº¤</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <div class="card" style="border:1px solid #ef4444;">
                <h2 style="color:#ef4444">ğŸ‘‘ ç®¡ç†å‘˜åå°</h2>
                <button class="small" onclick="loadPending()" style="width:auto; margin-bottom:10px;">ğŸ”„ åˆ·æ–°å¾…å®¡æ ¸</button>
                <div id="admin-list"></div>
                <p style="font-size:12px; color:var(--text-sub); margin-top:10px;">* ç®¡ç†è¯„è®ºè¯·ç›´æ¥å»çŸ¥è¯†åº“æ–‡ç« ä¸‹çš„è¯„è®ºåŒºï¼Œå·²ä¸ºæ‚¨è§£é”åˆ é™¤æŒ‰é’®ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸âš ï¸âš ï¸ å¡«å…¥ KEY âš ï¸âš ï¸âš ï¸
        const CONFIG = { URL: 'https://alsalyskulozwakhmzoa.supabase.co', KEY: 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr' };
        const ADMIN_SECRET = '888888'; 

        // ä¸»é¢˜é€»è¾‘
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('dse_theme', theme);
        }
        setTheme(localStorage.getItem('dse_theme') || 'blue');

        const CODE_MAP = { '/1': 'ğŸ™ æ„Ÿè°¢å¤§ç¥ï¼', '/2': 'ğŸ‘ æ¸…æ™°æ˜“æ‡‚ã€‚', '/3': 'ğŸ’¡ é‡ç‚¹Markã€‚', '/4': 'ğŸ¤¯ æ±‚ä¾‹å­ã€‚' };
        let db, auth, currentUser = null, appData = [], activeRoomId = null;

        window.onload = async () => {
            if(CONFIG.URL.includes('YOUR_')) return alert('è¯·é…ç½® API Key');
            const sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
            db = sb; auth = sb.auth;
            
            // å¤„ç†ä»é‚®ä»¶é“¾æ¥è·³å›æ¥çš„æƒ…å†µ
            const { data: { session } } = await auth.getSession();
            if(session) handleUser(session.user);
            
            auth.onAuthStateChange((event, s) => { 
                if(s) handleUser(s.user); 
                else { currentUser = null; updateProfileUI(); }
                if(event === 'SIGNED_IN') nav('home');
            });
            await loadData();
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.fb-input-box') && !e.target.closest('.fb-item')) {
                    document.querySelectorAll('.fb-input-box').forEach(box => resetInputState(box.id.replace('box-', '')));
                }
            });
        };

        // ç”¨æˆ·å¤„ç†
        async function handleUser(u) {
            currentUser = u;
            const {data} = await db.from('profiles').select('username, is_admin').eq('id',u.id).single();
            if(data) { currentUser.username = data.username; currentUser.is_admin = data.is_admin; }
            updateProfileUI();
        }

        // æ³¨å†Œ (å…¼é¡¾éªŒè¯å¼€å¯/å…³é—­)
        async function doRegister() {
            const e=document.getElementById('auth-email').value, p=document.getElementById('auth-pass').value, u=document.getElementById('auth-user').value;
            if(!u) return alert("è¯·å¡«å†™æ˜µç§°");
            
            // é»˜è®¤é‡å®šå‘åˆ°å½“å‰é¡µé¢ URL (Supabaseä¼šè‡ªåŠ¨å¤„ç†)
            const { data, error } = await auth.signUp({ 
                email: e, password: p, 
                options: { data: { username: u }, emailRedirectTo: window.location.href } 
            });

            if(error) return alert(error.message);
            if(data.session) {
                alert("ğŸ‰ æ³¨å†ŒæˆåŠŸå¹¶è‡ªåŠ¨ç™»å½•ï¼"); handleUser(data.session.user); nav('home');
            } else {
                document.getElementById('auth-msg').innerHTML = `ğŸ“§ <b>é‚®ä»¶å·²å‘é€</b><br>è¯·å»é‚®ç®±ç‚¹å‡»é“¾æ¥ï¼Œé€šè¿‡åå°†è·³è½¬å›æœ¬é¡µè‡ªåŠ¨ç™»å½•ã€‚`;
                document.getElementById('auth-msg').style.display='block';
            }
        }
        async function doLogin() {
            const {error}=await auth.signInWithPassword({email:document.getElementById('auth-email').value,password:document.getElementById('auth-pass').value});
            if(!error) nav('home'); else alert(error.message);
        }

        // æ ¸å¿ƒï¼šè¯„è®ºåŠ è½½ä¸ç®¡ç† (åŒ…å«åˆ é™¤åŠŸèƒ½)
        async function loadComments(kId) {
            db.channel(`fb-${kId}`).on('postgres_changes', { event: '*', schema: 'public', table: 'feedbacks', filter: `knowledge_id=eq.${kId}` }, () => refreshComments(kId)).subscribe();
            refreshComments(kId);
        }
        async function refreshComments(kId) {
            const { data } = await db.from('feedbacks').select('*').eq('knowledge_id', kId).order('created_at');
            const container = document.getElementById(`fb-container-${kId}`);
            
            // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
            let html = `<div class="fb-list" id="list-${kId}">`;
            html += (data||[]).map(f => `
                <div class="fb-item d-${Math.min(f.depth||0,3)}" id="item-${f.id}" onclick="selectReplyTarget('${kId}','${f.id}','${f.user_name}')">
                    ${currentUser?.is_admin ? `<span class="del-btn" onclick="deleteComment('${f.id}', '${kId}', event)">ğŸ—‘ï¸ åˆ é™¤</span>` : ''}
                    
                    <div style="color:var(--text-sub); font-size:11px;">
                        <b>${f.user_name}</b> ${f.is_admin?'<span class="admin-badge">ç®¡ç†å‘˜</span>':''}
                    </div>
                    <div style="margin-top:2px;">${CODE_MAP[f.custom_text]||f.custom_text}</div>
                </div>`).join('') + `</div>`;
            
            // è¾“å…¥æ¡†
            html += `<div class="fb-input-box" id="box-${kId}" onclick="event.stopPropagation()">
                <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-sub); margin-bottom:5px;">
                    <span id="st-${kId}">ğŸ“ è¯„è®º</span><span id="reset-${kId}" style="display:none; cursor:pointer; color:#ef4444;" onclick="resetInputState('${kId}')">Ã— å–æ¶ˆ</span>
                </div>
                <div class="preset-chips">${Object.keys(CODE_MAP).map(k => `<span class="chip" id="chip-${kId}-${k.replace('/','_')}" onclick="togglePreset('${kId}', '${k}')">${CODE_MAP[k]}</span>`).join('')}</div>
                <div style="display:flex; gap:5px;"><input id="in-${kId}" placeholder="..." oninput="handleUserTyping('${kId}')" onclick="unlockInput('${kId}')"><button class="small" style="width:60px;" onclick="send('${kId}')">å‘é€</button></div>
                <input type="hidden" id="pid-${kId}"><input type="hidden" id="pcode-${kId}"></div>`;
            container.innerHTML = html;
        }
        
        // âš ï¸ æ–°å¢ï¼šç®¡ç†å‘˜åˆ é™¤è¯„è®ºåŠŸèƒ½
        async function deleteComment(cId, kId, event) {
            event.stopPropagation(); // é˜²æ­¢è§¦å‘å›å¤
            if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ")) return;
            const { error } = await db.from('feedbacks').delete().eq('id', cId);
            if(error) alert("åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½æ²¡æœ‰æƒé™: " + error.message);
            // å®æ—¶ç›‘å¬ä¼šè‡ªåŠ¨åˆ·æ–° UI
        }

        // å‘é€é€»è¾‘
        window.send = async function(kId) {
            if(!currentUser) return alert("è¯·å…ˆç™»å½•");
            const txt=document.getElementById(`in-${kId}`).value, code=document.getElementById(`pcode-${kId}`).value, pid=document.getElementById(`pid-${kId}`).value;
            if(!code && !txt) return;
            await db.from('feedbacks').insert([{ knowledge_id:kId, user_name:currentUser.username, parent_id:pid||null, custom_text:code||txt, is_admin:currentUser.is_admin }]);
            resetInputState(kId);
        }

        // æŠ•ç¨¿ä¸ç®¡ç†
        async function tryEnterAdmin() {
            if(!currentUser) return alert("è¯·å…ˆç™»å½•");
            if(currentUser.is_admin) { nav('admin'); return; }
            const input = prompt("ğŸ” ç®¡ç†å‘˜å¯†é’¥ï¼š");
            if(input === ADMIN_SECRET) {
                await db.from('profiles').update({ is_admin: true }).eq('id', currentUser.id);
                currentUser.is_admin = true; alert("ğŸ‰ æƒé™å·²å‡çº§ï¼ç°åœ¨æ‚¨å¯ä»¥å®¡æ ¸é¢˜ç›®å¹¶åˆ é™¤è¯„è®ºã€‚"); nav('admin'); updateProfileUI();
            }
        }
        async function loadData() {
            const { data } = await db.from('submissions').select('*').eq('status', 'approved').order('created_at',{ascending:false});
            appData = data || []; renderKnowledge();
        }
        function renderKnowledge() {
            const kw = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('filter-cat').value;
            const list = appData.filter(i => (cat==='all'||i.cat===cat) && i.t.toLowerCase().includes(kw));
            document.getElementById('list').innerHTML = list.map(i => `
                <div class="item card" style="padding:15px; margin-bottom:10px;">
                    <div onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer; display:flex; justify-content:space-between;"><b>${i.t}</b> <span>â–¼</span></div>
                    <div style="margin-top:10px; display:none;" class="detail-box">
                        <div style="color:var(--text-sub); margin-bottom:15px;">${i.d}</div>
                        <div id="fb-container-${i.id}"><button class="small" onclick="loadComments('${i.id}')" style="background:var(--input-bg); color:var(--text-sub); width:100%;">ğŸ’¬ å±•å¼€è¯„è®º</button></div>
                    </div>
                </div>
                <style>.open .detail-box { display:block; }</style>`).join('');
        }
        // å®¡æ ¸
        async function loadPending() { if(!currentUser?.is_admin) return; const {data} = await db.from('submissions').select('*').eq('status','pending'); document.getElementById('admin-list').innerHTML = (data||[]).map(i=>`<div class="card" style="padding:10px;"><b>${i.t}</b><br><span style="font-size:12px">${i.d}</span><div style="margin-top:5px;"><button class="small btn-green" onclick="audit('${i.id}','approved')">é€šè¿‡</button> <button class="small btn-red" onclick="audit('${i.id}','rejected')">æ‹’ç»</button></div></div>`).join('') || 'æ— å¾…å®¡æ ¸'; }
        async function audit(id,s){ await db.from('submissions').update({status:s}).eq('id',id); loadPending(); if(s==='approved') loadData(); }
        async function submitKnowledge() { if(!currentUser) return alert("è¯·ç™»å½•"); const t=document.getElementById('sub-t').value, d=document.getElementById('sub-d').value, cat=document.getElementById('sub-cat').value; if(!t||!d) return; const {error} = await db.from('submissions').insert([{t,d,cat,status:'pending',user_id:currentUser.id}]); if(!error){ alert("å·²æŠ•ç¨¿ï¼Œç­‰å¾…å®¡æ ¸"); nav('home'); } }

        // å¯¹æˆ˜
        async function findMatch() { if(!currentUser) return alert("è¯·ç™»å½•"); document.getElementById('match-status').innerText = "ğŸ“¡ ..."; const {data:rooms} = await db.from('duel_rooms').select('*').eq('status','waiting').neq('player1_id',currentUser.id).limit(1); if(rooms?.length){ activeRoomId=rooms[0].id; await db.from('duel_rooms').update({player2_id:currentUser.id, status:'playing'}).eq('id',activeRoomId); startGame('p2'); } else { const {data}=await db.from('duel_rooms').insert([{player1_id:currentUser.id,status:'waiting'}]).select().single(); activeRoomId=data.id; document.getElementById('match-status').innerText="ğŸ  ç­‰å¾…..."; db.channel(`r-${activeRoomId}`).on('postgres_changes',{event:'UPDATE',schema:'public',table:'duel_rooms',filter:`id=eq.${activeRoomId}`}, p=>{if(p.new.status==='playing') startGame('p1')}).subscribe(); } }
        function startGame(role){ document.getElementById('duel-lobby').style.display='none'; document.getElementById('duel-arena').style.display='block'; document.getElementById('duel-board').innerHTML = appData.slice(0,4).map(i=>`<div class="card" style="margin:0; text-align:center; cursor:pointer; display:flex; align-items:center; justify-content:center; height:100px; font-weight:bold;" onclick="hit(this)">${i.t}</div>`).join(''); db.channel(`play-${activeRoomId}`).on('postgres_changes',{event:'UPDATE',schema:'public',table:'duel_rooms',filter:`id=eq.${activeRoomId}`}, p=>{ document.getElementById('my-score').innerText=role==='p1'?p.new.p1_score:p.new.p2_score; document.getElementById('op-score').innerText=role==='p1'?p.new.p2_score:p.new.p1_score; }).subscribe(); window.role=role; window.score=0; }
        async function hit(e){ if(e.style.opacity==='0')return; e.style.opacity='0'; window.score++; await db.from('duel_rooms').update(window.role==='p1'?{p1_score:window.score}:{p2_score:window.score}).eq('id',activeRoomId); }

        // UI & Utils
        window.selectReplyTarget=(k,i,u)=>{ event.stopPropagation(); document.querySelectorAll(`#list-${k} .fb-item`).forEach(e=>e.classList.remove('active-target')); document.getElementById(`item-${i}`).classList.add('active-target'); document.getElementById(`pid-${k}`).value=i; document.getElementById(`st-${k}`).innerHTML=`å›å¤ <b>${u}</b>`; document.getElementById(`reset-${k}`).style.display='block'; document.getElementById(`in-${k}`).focus(); }
        window.togglePreset=(k,c)=>{ document.getElementById(`pcode-${k}`).value=c; document.querySelectorAll(`#box-${k} .chip`).forEach(e=>e.classList.remove('selected')); document.getElementById(`chip-${k}-${c.replace('/','_')}`).classList.add('selected'); const i=document.getElementById(`in-${k}`); i.value=""; i.placeholder="[å·²é€‰]"; i.disabled=true; document.getElementById(`reset-${k}`).style.display='block'; }
        window.handleUserTyping=(k)=>{ document.getElementById(`pcode-${k}`).value=""; document.querySelectorAll(`#box-${k} .chip`).forEach(e=>e.classList.remove('selected')); }
        window.unlockInput=(k)=>{ const i=document.getElementById(`in-${k}`); if(i.disabled){ i.disabled=false; i.placeholder="..."; i.focus(); handleUserTyping(k); }}
        window.resetInputState=(k)=>{ document.getElementById(`pid-${k}`).value=""; document.getElementById(`pcode-${k}`).value=""; const i=document.getElementById(`in-${k}`); i.value=""; i.disabled=false; i.placeholder="..."; document.querySelectorAll(`#list-${k} .fb-item`).forEach(e=>e.classList.remove('active-target')); document.querySelectorAll(`#box-${k} .chip`).forEach(e=>e.classList.remove('selected')); document.getElementById(`st-${k}`).innerHTML="ğŸ“ è¯„è®º"; document.getElementById(`reset-${k}`).style.display='none'; }
        function updateProfileUI() { document.getElementById('u-name').innerHTML = currentUser ? `ğŸ‘‹ ${currentUser.username}` + (currentUser.is_admin?' <span style="color:#ef4444">(Admin)</span>':'') : 'æœªç™»å½•'; document.getElementById('btn-logout').style.display = currentUser ? 'block' : 'none'; }
        async function doLogout() { await auth.signOut(); location.reload(); }
        function nav(id) { document.querySelectorAll('.page').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); if(id==='admin') loadPending(); toggleSidebar(); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }
    </script>
</body>
</html>
