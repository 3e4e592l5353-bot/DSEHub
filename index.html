<!DOCTYPE html>
<html lang="zh-HK" data-theme="light" data-aurora="active">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSEhub · 香港DSE科目知识库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== 极光风CSS变量 ===== */
        :root {
            /* 香港DSE科目专属色系 */
            --chi-red: #EF4444;      /* 中文 */
            --eng-blue: #3B82F6;     /* 英文 */
            --math-green: #10B981;   /* 数学 */
            --ls-purple: #8B5CF6;    /* 通识 */
            --phy-pink: #EC4899;     /* 物理 */
            --chem-orange: #F59E0B;  /* 化学 */
            --bio-lime: #84CC16;     /* 生物 */
            --hist-amber: #D97706;   /* 历史 */
            --geog-emerald: #059669; /* 地理 */
            --econ-violet: #7C3AED;  /* 经济 */
            
            /* Mac风格功能分区 */
            --mac-bg-primary: #f8fafc;
            --mac-bg-secondary: #ffffff;
            --mac-bg-sidebar: #1e293b;
            --mac-bg-card: #ffffff;
            --mac-bg-hover: #f1f5f9;
            --mac-bg-toolbar: rgba(255, 255, 255, 0.8);
            
            /* 文字色彩 */
            --mac-text-primary: #1e293b;
            --mac-text-secondary: #475569;
            --mac-text-muted: #64748b;
            --mac-text-light: #f8fafc;
            
            /* 极光渐变 */
            --aurora-gradient: linear-gradient(135deg, 
                #FF6B8B 0%, #FFD166 25%, #06D6A0 50%, #118AB2 75%, #7209B7 100%);
            --aurora-subtle: linear-gradient(135deg, 
                rgba(255, 107, 139, 0.1) 0%, 
                rgba(255, 209, 102, 0.1) 25%, 
                rgba(6, 214, 160, 0.1) 50%, 
                rgba(17, 138, 178, 0.1) 75%, 
                rgba(114, 9, 183, 0.1) 100%);
            
            /* Mac布局 */
            --mac-sidebar-width: 280px;
            --mac-header-height: 60px;
            --mac-radius: 12px;
            --mac-radius-lg: 16px;
            --mac-radius-xl: 20px;
            
            /* 过渡效果 */
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --mac-bg-primary: #0f172a;
            --mac-bg-secondary: #1e293b;
            --mac-bg-sidebar: #0f172a;
            --mac-bg-card: #1e293b;
            --mac-bg-hover: #334155;
            --mac-bg-toolbar: rgba(30, 41, 59, 0.8);
            
            --mac-text-primary: #f1f5f9;
            --mac-text-secondary: #cbd5e1;
            --mac-text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'PingFang SC', sans-serif;
            background: var(--mac-bg-primary);
            color: var(--mac-text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* ===== Mac风格布局 ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* 侧边栏 - 科目导航 */
        .sidebar {
            width: var(--mac-sidebar-width);
            background: var(--mac-bg-sidebar);
            border-right: 1px solid var(--mac-border);
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            overflow-y: auto;
            z-index: 40;
            transition: var(--transition-smooth);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(255, 107, 139, 0.2), rgba(58, 134, 255, 0.2));
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--aurora-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FF6B8B, #3A86FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* 科目分类 */
        .subject-category {
            padding: 20px 24px;
        }

        .category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--mac-text-muted);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }

        .subject-list {
            list-style: none;
        }

        .subject-item {
            margin-bottom: 8px;
        }

        .subject-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--mac-text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .subject-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .subject-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
        }

        .subject-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--aurora-gradient);
        }

        .subject-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .subject-name {
            flex: 1;
            font-size: 0.95rem;
        }

        .subject-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            margin-left: var(--mac-sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }

        /* 顶部工具栏 - Mac风格 */
        .toolbar {
            background: var(--mac-bg-toolbar);
            backdrop-filter: blur(20px);
            border-radius: var(--mac-radius-lg);
            padding: 16px 24px;
            margin-bottom: 24px;
            border: 1px solid var(--mac-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .toolbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 知识库网格 */
        .knowledge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        /* 知识点卡片 - 可展开设计 */
        .knowledge-card {
            background: var(--mac-bg-card);
            border-radius: var(--mac-radius-lg);
            border: 1px solid var(--mac-border);
            overflow: hidden;
            transition: var(--transition-smooth);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .knowledge-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
            border-color: transparent;
        }

        .knowledge-card.expanded {
            grid-column: 1 / -1;
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--mac-border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--mac-bg-hover);
        }

        .subject-badge-large {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin: 12px 0 8px;
            color: var(--mac-text-primary);
        }

        .card-meta {
            display: flex;
            gap: 16px;
            color: var(--mac-text-muted);
            font-size: 0.875rem;
        }

        .expand-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--mac-bg-primary);
            color: var(--mac-text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .expand-btn:hover {
            background: var(--mac-bg-hover);
            transform: rotate(180deg);
        }

        /* 卡片内容区域 */
        .card-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .knowledge-card.expanded .card-content {
            max-height: 2000px;
            padding: 24px;
        }

        /* 章节导航 */
        .chapter-nav {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .chapter-tag {
            padding: 6px 16px;
            background: var(--mac-bg-hover);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--mac-text-secondary);
            text-decoration: none;
            transition: var(--transition-smooth);
        }

        .chapter-tag:hover {
            background: var(--mac-bg-primary);
            color: var(--mac-text-primary);
        }

        /* 知识点详情 */
        .knowledge-detail {
            margin-top: 20px;
        }

        .detail-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mac-text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mac-border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key-points {
            display: grid;
            gap: 12px;
        }

        .key-point {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--mac-bg-hover);
            border-radius: 8px;
            border-left: 4px solid;
        }

        .key-point-number {
            width: 28px;
            height: 28px;
            background: var(--aurora-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
        }

        /* 示例题目 */
        .examples-grid {
            display: grid;
            gap: 16px;
        }

        .example-card {
            padding: 20px;
            background: var(--mac-bg-hover);
            border-radius: 12px;
            border: 1px solid var(--mac-border);
        }

        .example-question {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--mac-text-primary);
        }

        .example-answer {
            padding: 12px;
            background: var(--mac-bg-primary);
            border-radius: 8px;
            color: var(--mac-text-secondary);
            border-left: 4px solid;
        }

        /* 相关资源 */
        .resources {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .resource-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--mac-bg-hover);
            border-radius: 20px;
            color: var(--mac-text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            transition: var(--transition-smooth);
        }

        .resource-link:hover {
            background: var(--mac-bg-primary);
            color: var(--mac-text-primary);
            transform: translateY(-2px);
        }

        /* 底部操作栏 */
        .card-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid var(--mac-border);
            background: var(--mac-bg-hover);
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--mac-bg-primary);
            border: 1px solid var(--mac-border);
            border-radius: 8px;
            color: var(--mac-text-primary);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition-smooth);
        }

        .action-btn:hover {
            background: var(--mac-bg-secondary);
            transform: translateY(-2px);
        }

        .action-btn.primary {
            background: var(--aurora-gradient);
            color: white;
            border: none;
        }

        /* 科目颜色映射 */
        .subject-CHI { background-color: var(--chi-red); }
        .subject-ENG { background-color: var(--eng-blue); }
        .subject-MATH { background-color: var(--math-green); }
        .subject-LS { background-color: var(--ls-purple); }
        .subject-PHY { background-color: var(--phy-pink); }
        .subject-CHEM { background-color: var(--chem-orange); }
        .subject-BIO { background-color: var(--bio-lime); }
        .subject-HIST { background-color: var(--hist-amber); }
        .subject-GEOG { background-color: var(--geog-emerald); }
        .subject-ECON { background-color: var(--econ-violet); }

        /* 主题切换 */
        .theme-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--aurora-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: var(--transition-smooth);
            border: none;
        }

        .theme-toggle:hover {
            transform: rotate(15deg) scale(1.1);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .knowledge-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        /* 动画效果 */
        @keyframes auroraGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .aurora-glow {
            animation: auroraGlow 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- 应用容器 -->
    <div class="app-container">
        <!-- 侧边栏 - 科目导航 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <a href="#" class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">DSEhub</div>
                </a>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.875rem; margin-top: 8px;">
                    香港文凭考试知识库
                </div>
            </div>

            <!-- 必修科目 -->
            <div class="subject-category">
                <div class="category-title">
                    <i class="fas fa-star"></i>
                    <span>必修科目</span>
                </div>
                <ul class="subject-list">
                    <li class="subject-item">
                        <a href="#" class="subject-link active" data-subject="CHI">
                            <div class="subject-icon subject-CHI">
                                <i class="fas fa-language"></i>
                            </div>
                            <div class="subject-name">中国语文</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="ENG">
                            <div class="subject-icon subject-ENG">
                                <i class="fas fa-font"></i>
                            </div>
                            <div class="subject-name">英国语文</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="MATH">
                            <div class="subject-icon subject-MATH">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="subject-name">数学</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="LS">
                            <div class="subject-icon subject-LS">
                                <i class="fas fa-globe-asia"></i>
                            </div>
                            <div class="subject-name">通识教育</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 理科科目 -->
            <div class="subject-category">
                <div class="category-title">
                    <i class="fas fa-atom"></i>
                    <span>理科科目</span>
                </div>
                <ul class="subject-list">
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="PHY">
                            <div class="subject-icon subject-PHY">
                                <i class="fas fa-atom"></i>
                            </div>
                            <div class="subject-name">物理</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="CHEM">
                            <div class="subject-icon subject-CHEM">
                                <i class="fas fa-flask"></i>
                            </div>
                            <div class="subject-name">化学</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="BIO">
                            <div class="subject-icon subject-BIO">
                                <i class="fas fa-dna"></i>
                            </div>
                            <div class="subject-name">生物</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 文科科目 -->
            <div class="subject-category">
                <div class="category-title">
                    <i class="fas fa-landmark"></i>
                    <span>文科科目</span>
                </div>
                <ul class="subject-list">
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="CHIST">
                            <div class="subject-icon subject-HIST">
                                <i class="fas fa-scroll"></i>
                            </div>
                            <div class="subject-name">中国历史</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="HIST">
                            <div class="subject-icon subject-HIST">
                                <i class="fas fa-landmark"></i>
                            </div>
                            <div class="subject-name">历史</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="GEOG">
                            <div class="subject-icon subject-GEOG">
                                <i class="fas fa-mountain"></i>
                            </div>
                            <div class="subject-name">地理</div>
                            <div class="subject-badge">DSE</div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 初中科目 -->
            <div class="subject-category">
                <div class="category-title">
                    <i class="fas fa-school"></i>
                    <span>初中科目</span>
                </div>
                <ul class="subject-list">
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="CHI_J">
                            <div class="subject-icon subject-CHI">
                                <i class="fas fa-language"></i>
                            </div>
                            <div class="subject-name">中文（初中）</div>
                            <div class="subject-badge">中一至三</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="ENG_J">
                            <div class="subject-icon subject-ENG">
                                <i class="fas fa-font"></i>
                            </div>
                            <div class="subject-name">英文（初中）</div>
                            <div class="subject-badge">中一至三</div>
                        </a>
                    </li>
                    <li class="subject-item">
                        <a href="#" class="subject-link" data-subject="MATH_J">
                            <div class="subject-icon subject-MATH">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="subject-name">数学（初中）</div>
                            <div class="subject-badge">中一至三</div>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <!-- 工具栏 -->
            <div class="toolbar">
                <div class="toolbar-title">
                    <i class="fas fa-book-open aurora-glow" style="color: #FF6B8B;"></i>
                    <span>中国语文 · 知识点库</span>
                </div>
                <div class="toolbar-actions">
                    <button class="action-btn">
                        <i class="fas fa-search"></i> 搜索知识点
                    </button>
                    <button class="action-btn">
                        <i class="fas fa-filter"></i> 筛选
                    </button>
                    <button class="action-btn primary">
                        <i class="fas fa-plus"></i> 添加笔记
                    </button>
                </div>
            </div>

            <!-- 知识点网格 -->
            <div class="knowledge-grid" id="knowledgeGrid">
                <!-- 知识点卡片将通过JavaScript动态加载 -->
            </div>

            <!-- 空状态提示 -->
            <div id="emptyState" style="display: none;" class="empty-state">
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 4rem; color: var(--mac-text-muted); margin-bottom: 20px;">
                        <i class="fas fa-book"></i>
                    </div>
                    <h3 style="margin-bottom: 12px; color: var(--mac-text-primary);">暂无知识点</h3>
                    <p style="color: var(--mac-text-muted); margin-bottom: 24px;">
                        当前科目还没有知识点内容，点击"添加笔记"开始创建
                    </p>
                    <button class="action-btn primary">
                        <i class="fas fa-plus"></i> 创建第一个知识点
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 主题切换按钮 -->
    <button class="theme-toggle" onclick="toggleDarkMode()">
        <i class="fas fa-moon" id="themeIcon"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== 配置 =====
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        // ===== 全局状态 =====
        let currentUser = null;
        let currentSubject = 'CHI';
        let supabaseClient = null;
        let expandedCardId = null;
        
        // ===== 科目配置 =====
        const subjects = {
            'CHI': { name: '中国语文', color: '#EF4444', icon: 'fa-language' },
            'ENG': { name: '英国语文', color: '#3B82F6', icon: 'fa-font' },
            'MATH': { name: '数学', color: '#10B981', icon: 'fa-calculator' },
            'LS': { name: '通识教育', color: '#8B5CF6', icon: 'fa-globe-asia' },
            'PHY': { name: '物理', color: '#EC4899', icon: 'fa-atom' },
            'CHEM': { name: '化学', color: '#F59E0B', icon: 'fa-flask' },
            'BIO': { name: '生物', color: '#84CC16', icon: 'fa-dna' },
            'CHIST': { name: '中国历史', color: '#DC2626', icon: 'fa-scroll' },
            'HIST': { name: '历史', color: '#D97706', icon: 'fa-landmark' },
            'GEOG': { name: '地理', color: '#059669', icon: 'fa-mountain' },
            'ECON': { name: '经济', color: '#7C3AED', icon: 'fa-chart-pie' },
            'CHI_J': { name: '中文（初中）', color: '#EF4444', icon: 'fa-language' },
            'ENG_J': { name: '英文（初中）', color: '#3B82F6', icon: 'fa-font' },
            'MATH_J': { name: '数学（初中）', color: '#10B981', icon: 'fa-calculator' }
        };

        // ===== 初始化 =====
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 初始化Supabase
                if (window.supabase && window.supabase.createClient) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase初始化成功');
                } else {
                    console.error('Supabase库加载失败');
                    return;
                }
                
                // 检查用户会话
                await checkUserSession();
                
                // 初始化事件监听器
                initEventListeners();
                
                // 加载当前科目的知识点
                loadKnowledgePoints();
                
                // 设置自动刷新
                setInterval(() => {
                    if (document.querySelector('.knowledge-card.expanded')) {
                        loadKnowledgePoints();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('系统初始化失败', 'error');
            }
        });

        // ===== 用户会话管理 =====
        async function checkUserSession() {
            const sessionToken = getCookie('cross_site_session');
            
            if (sessionToken && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('cross_site_sessions')
                        .select('*, profiles(*)')
                        .eq('session_token', sessionToken)
                        .gt('expires_at', new Date().toISOString())
                        .single();
                    
                    if (data && !error && data.profiles) {
                        currentUser = {
                            id: data.user_id,
                            ...data.profiles
                        };
                        console.log('用户已登录:', currentUser.username);
                    } else {
                        deleteCookie('cross_site_session');
                    }
                } catch (error) {
                    console.error('会话检查失败:', error);
                }
            }
        }

        // ===== 知识点管理 =====
        async function loadKnowledgePoints() {
            if (!supabaseClient) {
                console.error('Supabase客户端未初始化');
                showTestData();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('knowledge_points')
                    .select('*, dse_subjects(subject_name_zh, subject_name_en)')
                    .eq('subject_code', currentSubject)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) {
                    console.error('加载知识点失败:', error);
                    showTestData();
                    return;
                }
                
                if (data && data.length > 0) {
                    renderKnowledgePoints(data);
                } else {
                    showEmptyState();
                }
                
            } catch (error) {
                console.error('加载知识点异常:', error);
                showTestData();
            }
        }

        function renderKnowledgePoints(knowledgePoints) {
            const container = document.getElementById('knowledgeGrid');
            const emptyState = document.getElementById('emptyState');
            
            if (!knowledgePoints || knowledgePoints.length === 0) {
                showEmptyState();
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            knowledgePoints.forEach((point, index) => {
                const subject = subjects[point.subject_code] || subjects.CHI;
                const isExpanded = expandedCardId === point.id;
                
                const card = document.createElement('div');
                card.className = `knowledge-card ${isExpanded ? 'expanded' : ''}`;
                card.id = `knowledge-${point.id}`;
                
                // 解析关键点和示例
                const keyPoints = point.key_points || ['暂无关键点'];
                const examples = point.examples || [{ question: '暂无示例题目', answer: '暂无答案' }];
                
                card.innerHTML = `
                    <div class="card-header" onclick="toggleCardExpand(${point.id})">
                        <div>
                            <div class="subject-badge-large" style="background: ${subject.color}">
                                <i class="fas ${subject.icon}"></i>
                                <span>${subject.name}</span>
                            </div>
                            <h3 class="card-title">${point.title || '未命名知识点'}</h3>
                            <div class="card-meta">
                                <span><i class="fas fa-layer-group"></i> ${point.chapter || '未分类'}</span>
                                <span><i class="fas fa-tag"></i> ${point.topic || '未标记'}</span>
                                <span><i class="fas fa-signal"></i> 难度: ${'★'.repeat(point.difficulty || 1)}</span>
                            </div>
                        </div>
                        <button class="expand-btn">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    
                    <div class="card-content">
                        <!-- 章节导航 -->
                        ${point.related_topics ? `
                        <div class="chapter-nav">
                            ${JSON.parse(point.related_topics || '[]').map(topic => 
                                `<a href="#" class="chapter-tag">${topic}</a>`
                            ).join('')}
                        </div>` : ''}
                        
                        <!-- 主要内容 -->
                        <div class="knowledge-detail">
                            <div class="detail-section">
                                <div class="section-title">
                                    <i class="fas fa-align-left"></i>
                                    <span>内容概要</span>
                                </div>
                                <p>${point.content || '暂无详细内容'}</p>
                            </div>
                            
                            <!-- 关键点 -->
                            <div class="detail-section">
                                <div class="section-title">
                                    <i class="fas fa-key"></i>
                                    <span>关键知识点</span>
                                </div>
                                <div class="key-points">
                                    ${keyPoints.map((kp, i) => `
                                        <div class="key-point" style="border-left-color: ${subject.color}">
                                            <div class="key-point-number">${i + 1}</div>
                                            <div>${kp}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- 示例 -->
                            <div class="detail-section">
                                <div class="section-title">
                                    <i class="fas fa-question-circle"></i>
                                    <span>示例题目</span>
                                </div>
                                <div class="examples-grid">
                                    ${examples.map((example, i) => `
                                        <div class="example-card">
                                            <div class="example-question">
                                                <strong>示例 ${i + 1}:</strong> ${example.question || '题目'}
                                            </div>
                                            <div class="example-answer" style="border-left-color: ${subject.color}">
                                                <strong>解答:</strong> ${example.answer || '答案'}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- 相关资源 -->
                            <div class="detail-section">
                                <div class="section-title">
                                    <i class="fas fa-link"></i>
                                    <span>相关资源</span>
                                </div>
                                <div class="resources">
                                    <a href="#" class="resource-link">
                                        <i class="fas fa-video"></i> 教学视频
                                    </a>
                                    <a href="#" class="resource-link">
                                        <i class="fas fa-file-pdf"></i> PDF讲义
                                    </a>
                                    <a href="#" class="resource-link">
                                        <i class="fas fa-clipboard-check"></i> 练习题目
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <div>
                            <button class="action-btn" onclick="markAsLearned(${point.id})">
                                <i class="fas fa-check"></i> 标记为已学
                            </button>
                            <button class="action-btn" onclick="addToFavorites(${point.id})">
                                <i class="fas fa-star"></i> 收藏
                            </button>
                        </div>
                        <div>
                            <button class="action-btn" onclick="shareKnowledge(${point.id})">
                                <i class="fas fa-share-alt"></i> 分享
                            </button>
                            <button class="action-btn primary" onclick="editKnowledge(${point.id})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function showTestData() {
            const testData = [
                {
                    id: 1,
                    title: 'DSE中文：阅读理解技巧',
                    content: '掌握记叙文、描写文、说明文、议论文四种文体的阅读策略，包括快速浏览、精读分析、主旨归纳等方法...',
                    subject_code: 'CHI',
                    chapter: '卷一：阅读能力',
                    topic: '文体分析',
                    difficulty: 3,
                    key_points: ['记叙文六要素', '描写手法分析', '论证方法识别', '主旨归纳技巧'],
                    examples: [
                        { question: '文中第三段运用了什么描写手法？有什么作用？', answer: '运用了比喻和拟人手法，生动形象地表现了人物的内心世界。' },
                        { question: '作者在文中表达了怎样的中心思想？', answer: '通过……表达了……的思想感情。' }
                    ]
                },
                {
                    id: 2,
                    title: '数学：二次函数图像与性质',
                    content: '理解二次函数y=ax²+bx+c的图像特征，包括顶点坐标、对称轴方程、开口方向、最值问题等...',
                    subject_code: 'MATH',
                    chapter: '代数',
                    topic: '二次函数',
                    difficulty: 4,
                    key_points: ['顶点公式(-b/2a, f(-b/2a))', '判别式Δ=b²-4ac', '图像变换规律', '最值求解方法'],
                    examples: [
                        { question: '求函数y=2x²-4x+1的顶点坐标和对称轴', answer: '顶点(1, -1)，对称轴x=1' },
                        { question: '已知二次函数图像经过(1,0)、(3,0)和(0,3)，求函数表达式', answer: 'y=x²-4x+3' }
                    ]
                }
            ];
            
            renderKnowledgePoints(testData);
        }

        function showEmptyState() {
            document.getElementById('knowledgeGrid').innerHTML = '';
            document.getElementById('emptyState').style.display = 'block';
        }

        // ===== 交互功能 =====
        function toggleCardExpand(cardId) {
            const card = document.getElementById(`knowledge-${cardId}`);
            const isExpanded = card.classList.contains('expanded');
            
            // 关闭当前展开的卡片
            if (expandedCardId && expandedCardId !== cardId) {
                const prevCard = document.getElementById(`knowledge-${expandedCardId}`);
                if (prevCard) {
                    prevCard.classList.remove('expanded');
                    const prevBtn = prevCard.querySelector('.expand-btn i');
                    prevBtn.className = 'fas fa-chevron-down';
                }
            }
            
            // 切换当前卡片状态
            card.classList.toggle('expanded');
            const expandBtn = card.querySelector('.expand-btn i');
            
            if (isExpanded) {
                expandBtn.className = 'fas fa-chevron-down';
                expandedCardId = null;
            } else {
                expandBtn.className = 'fas fa-chevron-up';
                expandedCardId = cardId;
            }
        }

        function switchSubject(subjectCode) {
            currentSubject = subjectCode;
            const subject = subjects[subjectCode];
            
            // 更新工具栏标题
            const toolbarTitle = document.querySelector('.toolbar-title span');
            toolbarTitle.textContent = `${subject.name} · 知识点库`;
            
            // 更新侧边栏激活状态
            document.querySelectorAll('.subject-link').forEach(link => {
                link.classList.toggle('active', link.dataset.subject === subjectCode);
            });
            
            // 加载新科目的知识点
            loadKnowledgePoints();
            
            // 收起所有卡片
            if (expandedCardId) {
                const card = document.getElementById(`knowledge-${expandedCardId}`);
                if (card) {
                    card.classList.remove('expanded');
                    const expandBtn = card.querySelector('.expand-btn i');
                    expandBtn.className = 'fas fa-chevron-down';
                    expandedCardId = null;
                }
            }
            
            showNotification(`切换到${subject.name}`, 'info');
        }

        // ===== 工具函数 =====
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
        }

        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // 样式
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                border-radius: 8px;
                background: ${type === 'error' ? '#EF4444' : type === 'success' ? '#10B981' : '#3B82F6'};
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ===== 主题切换 =====
        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const themeIcon = document.getElementById('themeIcon');
            
            document.documentElement.setAttribute('data-theme', newTheme);
            themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            localStorage.setItem('dsehub_theme', newTheme);
        }

        // ===== 事件监听器初始化 =====
        function initEventListeners() {
            // 科目切换
            document.querySelectorAll('.subject-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const subjectCode = link.dataset.subject;
                    switchSubject(subjectCode);
                });
            });
            
            // 回车发送消息
            document.addEventListener('keypress', (e) => {
                if (e.target.classList.contains('message-input') && e.key === 'Enter') {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // 加载保存的主题
            const savedTheme = localStorage.getItem('dsehub_theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
                document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            // 添加键盘快捷键
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    document.querySelector('.action-btn i.fa-search').closest('.action-btn').click();
                }
                if (e.key === 'Escape' && expandedCardId) {
                    toggleCardExpand(expandedCardId);
                }
            });
        }

        // ===== 占位功能函数 =====
        function markAsLearned(knowledgeId) {
            if (!currentUser) {
                showNotification('请先登录', 'warning');
                return;
            }
            showNotification('已标记为已学', 'success');
        }

        function addToFavorites(knowledgeId) {
            if (!currentUser) {
                showNotification('请先登录', 'warning');
                return;
            }
            showNotification('已添加到收藏', 'success');
        }

        function shareKnowledge(knowledgeId) {
            const card = document.getElementById(`knowledge-${knowledgeId}`);
            const title = card.querySelector('.card-title').textContent;
            
            if (navigator.share) {
                navigator.share({
                    title: `DSEhub知识点: ${title}`,
                    text: `分享一个DSE学习知识点：${title}`,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(`${title} - ${window.location.href}`);
                showNotification('链接已复制到剪贴板', 'success');
            }
        }

        function editKnowledge(knowledgeId) {
            if (!currentUser) {
                showNotification('请先登录', 'warning');
                return;
            }
            showNotification('进入编辑模式', 'info');
        }

        // ===== 添加动画样式 =====
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

