<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v56 - è‡ªåŠ¨é‰´æƒç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... æ ·å¼ä¿æŒä¸å˜ï¼Œæ–°å¢ç®¡ç†å‘˜æ ‡ç­¾æ ·å¼ ... */
        :root { --primary: #6366f1; --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        body { margin: 0; font-family: 'Noto Sans SC', sans-serif; background: var(--bg-gradient); height: 100vh; display: flex; overflow: hidden; color:#333; }
        .sidebar { width: 260px; background: #fff; display: flex; flex-direction: column; padding: 20px; border-right:1px solid #ddd; z-index:50; transition:0.3s; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 8px; font-weight: 600; color: #666; display:flex; align-items:center; gap:8px;}
        .nav-item.active { background: var(--primary); color: #fff; }
        .main { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .page { display: none; max-width: 800px; margin: 0 auto; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
        .card { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; }
        button.small { width: auto; padding: 5px 12px; font-size: 12px; }
        .btn-green { background: #10B981; } .btn-red { background: #EF4444; }

        /* è¯„è®ºåŒºæ ·å¼ */
        .fb-area { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .fb-list { max-height: 400px; overflow-y: auto; padding: 5px; }
        .fb-item { padding: 8px 12px; margin-bottom: 6px; background: #f9fafb; border-radius: 8px; font-size: 13px; border-left: 3px solid transparent; cursor: pointer; }
        .fb-item.active-target { background: #eef2ff; border-left-color: var(--primary); }
        
        /* ç®¡ç†å‘˜æ ‡ç­¾æ ·å¼ */
        .admin-badge { background: #fee2e2; color: #b91c1c; font-size: 10px; padding: 1px 4px; border-radius: 4px; border: 1px solid #fecaca; margin-left: 5px; font-weight: bold; }
        .user-badge { background: #e0e7ff; color: #4f46e5; padding: 1px 4px; border-radius: 4px; margin-left: 5px; font-size: 10px; }
        
        /* å…¶ä»–æ ·å¼çœç•¥ï¼Œä¿æŒåŸæ · */
        .fb-input-box { background: #fff; padding: 10px; border-radius: 12px; border: 1px solid #e5e7eb; margin-top: 10px; }
        .preset-chips { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 5px; }
        .chip { font-size: 11px; padding: 4px 10px; background: #f3f4f6; border-radius: 20px; white-space: nowrap; cursor: pointer; color: #555; }
        .chip.selected { background: var(--primary); color: #fff; }
        .menu-btn { display: none; position: fixed; top: 10px; left: 10px; z-index: 100; background: #fff; padding: 5px 10px; }
        @media (max-width: 768px) { .sidebar { position: fixed; transform: translateX(-100%); height:100%; } .sidebar.active { transform: translateX(0); } .menu-btn { display: block; } .main { padding: 60px 15px 20px 15px; } }
    </style>
</head>
<body>
    <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
    
    <div class="sidebar" id="sidebar">
        <div style="font-size:20px; font-weight:900; color:var(--primary); margin-bottom:30px;">DSE HUB v56</div>
        
        <div id="user-panel" style="background:#f3f4f6; padding:10px; border-radius:10px; margin-bottom:20px; text-align:center;">
            <div id="u-name" style="font-weight:bold; font-size:14px; margin-bottom:5px;">æœªç™»å½•</div>
            <button class="small" onclick="nav('auth')">ğŸ‘¤ ç™»å½•/æ³¨å†Œ</button>
        </div>

        <div class="nav-item active" onclick="nav('home')">ğŸ“š çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('duel')">âš”ï¸ åœ¨çº¿å¯¹æˆ˜</div>
        <div class="nav-item" onclick="nav('submit')">ğŸ“ æŠ•ç¨¿</div>
        <div class="nav-item" onclick="tryEnterAdmin()" style="color:#EF4444;">âš–ï¸ å®¡é˜…åå°</div>
    </div>

    <div class="main">
        <div id="view-auth" class="page">
            <div class="card" style="text-align:center;">
                <h2>é€šè¡Œè¯</h2>
                <input id="auth-email" placeholder="é‚®ç®±" type="email">
                <input id="auth-pass" placeholder="å¯†ç  (6ä½+)" type="password">
                <input id="auth-user" placeholder="æ˜µç§° (ä»…æ³¨å†Œéœ€è¦)">
                <div style="display:flex; gap:10px;">
                    <button onclick="doLogin()">ç™»å½•</button>
                    <button onclick="doRegister()" class="btn-green">æ³¨å†Œ</button>
                </div>
                <button onclick="doLogout()" id="btn-logout" class="btn-red" style="margin-top:10px; display:none;">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div id="view-home" class="page active">
            <div class="card">
                <input id="search" placeholder="ğŸ” æœç´¢..." onkeyup="renderKnowledge()">
                <div id="list"></div>
            </div>
        </div>

        <div id="view-duel" class="page">
            <div class="card" id="duel-lobby">
                <h2>åœ¨çº¿å¯¹å†³</h2>
                <button onclick="findMatch()" style="padding:20px;">ğŸ” å¼€å§‹åŒ¹é…</button>
                <div id="match-status" style="margin-top:15px; text-align:center;"></div>
            </div>
            <div class="card" id="duel-arena" style="display:none;">
                <div class="duel-stat"><span id="my-score">0</span> VS <span id="op-score">0</span></div>
                <div id="duel-board" style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px;"></div>
            </div>
        </div>

        <div id="view-submit" class="page">
            <div class="card">
                <h2>æŠ•ç¨¿æ–°é¢˜</h2>
                <input id="sub-t" placeholder="æ ‡é¢˜">
                <select id="sub-cat"><option value="math">æ•°å­¦</option><option value="chi">ä¸­æ–‡</option><option value="eng">è‹±æ–‡</option></select>
                <textarea id="sub-d" rows="5" placeholder="å†…å®¹..."></textarea>
                <button onclick="submitKnowledge()">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <div class="card">
                <h2>ğŸ‘‘ ç®¡ç†å‘˜æ§åˆ¶å°</h2>
                <p>è¿™é‡Œåªæ˜¾ç¤ºã€å¾…å®¡æ ¸ã€‘çš„å†…å®¹ã€‚</p>
                <button class="small" onclick="loadPending()" style="margin-bottom:10px; width:auto;">ğŸ”„ åˆ·æ–°</button>
                <div id="admin-list"></div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ é…ç½®åŒº
        const CONFIG = { URL: 'https://alsalyskulozwakhmzoa.supabase.co', KEY: 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr' };
        const ADMIN_SECRET = '260117'; // ğŸ‘ˆ è¿™é‡Œè®¾ç½®ä½ çš„ç®¡ç†å‘˜å¯†ç 

        const CODE_MAP = {
            '/1': 'ğŸ™ æ„Ÿè°¢åˆ†äº«ï¼Œå¾ˆæœ‰å¸®åŠ©ï¼',
            '/2': 'ğŸ‘ è§£é‡Šå¾—éå¸¸æ¸…æ™°ï¼Œæ‡‚äº†ã€‚',
            '/3': 'ğŸ’¡ è¿™æ˜¯ä¸€ä¸ªå¸¸è€ƒé‡ç‚¹ï¼ŒMarkã€‚',
            '/4': 'ğŸ¤¯ å¤ªéš¾ï¼Œæ±‚æ›´è¯¦ç»†è§£é‡Šã€‚'
        };

        let db, auth, currentUser = null;
        let appData = [];
        let activeRoomId = null;

        window.onload = async () => {
            if(CONFIG.URL.includes('YOUR_')) return alert('è¯·é…ç½® API Key');
            const sb = window.supabase.createClient(CONFIG.URL, CONFIG.KEY);
            db = sb; auth = sb.auth;

            const { data: { session } } = await auth.getSession();
            if(session) handleUser(session.user);

            auth.onAuthStateChange((_, s) => { 
                if(s) handleUser(s.user); 
                else { currentUser = null; updateProfileUI(); }
            });

            await loadData();
            
            // ç‚¹å‡»ç©ºç™½å…³é—­è¾“å…¥æ¡†
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.fb-input-box') && !e.target.closest('.fb-item')) {
                    document.querySelectorAll('.fb-input-box').forEach(box => {
                        const kId = box.id.replace('box-', '');
                        if(kId) resetInputState(kId); 
                    });
                }
            });
        };

        // ================= ğŸ” æ ¸å¿ƒï¼šæƒé™å¤„ç† =================

        // å¤„ç†ç”¨æˆ·ä¿¡æ¯ + è¯»å–æƒé™
        async function handleUser(u) {
            currentUser = u;
            // è¯»å– profiles è¡¨é‡Œçš„ username å’Œ is_admin
            const {data} = await db.from('profiles').select('username, is_admin').eq('id',u.id).single();
            if(data) {
                currentUser.username = data.username;
                currentUser.is_admin = data.is_admin; // å­˜å‚¨å½“å‰ç”¨æˆ·çš„æƒé™
            }
            updateProfileUI();
        }

        // å°è¯•è¿›å…¥åå°ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        async function tryEnterAdmin() {
            if(!currentUser) return alert("è¯·å…ˆç™»å½•");

            // 1. å·²ç»æ˜¯ç®¡ç†å‘˜ -> ç›´æ¥è¿›
            if(currentUser.is_admin) {
                nav('admin');
                return;
            }

            // 2. ä¸æ˜¯ç®¡ç†å‘˜ -> è¾“å¯†ç 
            const input = prompt("ğŸ” è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯ï¼š");
            if(input === ADMIN_SECRET) {
                // å¯†ç æ­£ç¡® -> å‡çº§æ•°æ®åº“
                const { error } = await db.from('profiles').update({ is_admin: true }).eq('id', currentUser.id);
                if(error) {
                    alert("å‡çº§å¤±è´¥: " + error.message);
                } else {
                    alert("ğŸ‰ éªŒè¯æˆåŠŸï¼æ‚¨å·²å‡çº§ä¸ºç®¡ç†å‘˜è´¦å·ã€‚");
                    currentUser.is_admin = true; // æœ¬åœ°ç«‹å³æ›´æ–°
                    nav('admin');
                }
            } else if(input !== null) {
                alert("âŒ å¯†é’¥é”™è¯¯");
            }
        }

        // ================= ğŸ“š çŸ¥è¯†åº“ & æ¸²æŸ“ =================
        async function loadData() {
            const { data } = await db.from('submissions').select('*').eq('status', 'approved').order('created_at',{ascending:false});
            appData = data || [];
            renderKnowledge();
        }

        function renderKnowledge() {
            const kw = document.getElementById('search').value.toLowerCase();
            const list = appData.filter(i => i.t.toLowerCase().includes(kw));
            document.getElementById('list').innerHTML = list.map(i => `
                <div class="item card" style="padding:15px; margin-bottom:10px;">
                    <div onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer; display:flex; justify-content:space-between;">
                        <b>${i.t}</b> <span>ğŸ”½</span>
                    </div>
                    <div style="margin-top:10px; display:none;" class="detail-box">
                        <div style="color:#555; margin-bottom:15px;">${i.d}</div>
                        <div id="fb-container-${i.id}" class="fb-area">
                            <button class="small" onclick="loadComments('${i.id}')" style="background:#f3f4f6; color:#333; width:100%;">ğŸ’¬ å±•å¼€è®¨è®º</button>
                        </div>
                    </div>
                </div>
                <style>.open .detail-box { display:block; }</style>
            `).join('');
        }

        // ================= ğŸ’¬ è¯„è®ºç³»ç»Ÿ (å«ç®¡ç†å‘˜æ ‡ç­¾) =================
        async function loadComments(kId) {
            const container = document.getElementById(`fb-container-${kId}`);
            db.channel(`fb-${kId}`).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'feedbacks', filter: `knowledge_id=eq.${kId}` }, 
                () => refreshComments(kId)
            ).subscribe();
            await refreshComments(kId);
        }

        async function refreshComments(kId) {
            // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬selectå‡ºäº† is_admin å­—æ®µ
            const { data } = await db.from('feedbacks').select('*').eq('knowledge_id', kId).order('created_at');
            const container = document.getElementById(`fb-container-${kId}`);
            
            let html = `<div class="fb-list" id="list-${kId}">`;
            if(data && data.length) {
                html += data.map(f => {
                    // åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºæ ‡ç­¾
                    const adminTag = f.is_admin ? `<span class="admin-badge">ç®¡ç†å‘˜</span>` : '';
                    const presetTag = CODE_MAP[f.custom_text] ? `<span class="user-badge">å¿«æ·</span>` : '';
                    const content = CODE_MAP[f.custom_text] || f.custom_text;
                    
                    return `
                    <div class="fb-item d-${Math.min(f.depth||0,3)}" id="item-${f.id}" onclick="selectReplyTarget('${kId}', '${f.id}', '${f.user_name}')">
                        <div style="color:#888; font-size:11px; display:flex; align-items:center;">
                            <b>${f.user_name}</b> ${adminTag} ${presetTag}
                        </div>
                        <div style="margin-top:2px;">${content}</div>
                    </div>`;
                }).join('');
            } else { html += `<div style="text-align:center;color:#ccc;padding:10px;">æš‚æ— è¯„è®º</div>`; }
            html += `</div>`;

            // è¾“å…¥æ¡† (ä¿æŒä¸å˜)
            html += `
            <div class="fb-input-box" id="box-${kId}" onclick="event.stopPropagation()">
                <div class="status-bar">
                    <span id="st-${kId}">ğŸ“ æ–°è¯„è®º</span>
                    <span id="reset-${kId}" style="display:none; cursor:pointer; color:red;" onclick="resetInputState('${kId}')">Ã— é‡ç½®</span>
                </div>
                <div class="preset-chips">
                    ${Object.keys(CODE_MAP).map(k => `<span class="chip" id="chip-${kId}-${k.replace('/','_')}" onclick="togglePreset('${kId}', '${k}')">${CODE_MAP[k]}</span>`).join('')}
                </div>
                <div style="display:flex; gap:5px;">
                    <input id="in-${kId}" placeholder="è¾“å…¥..." autocomplete="off" oninput="handleUserTyping('${kId}')" onclick="unlockInput('${kId}')">
                    <button class="small" style="width:60px;" onclick="send('${kId}')">å‘é€</button>
                </div>
                <input type="hidden" id="pid-${kId}"><input type="hidden" id="pcode-${kId}">
            </div>`;
            container.innerHTML = html;
        }

        window.send = async function(kId) {
            if(!currentUser) return alert("è¯·å…ˆç™»å½•");
            const txt = document.getElementById(`in-${kId}`).value;
            const code = document.getElementById(`pcode-${kId}`).value;
            const pid = document.getElementById(`pid-${kId}`).value || null;
            const content = code ? code : txt;
            
            if(!content) return;

            // æ ¸å¿ƒï¼šå‘é€æ—¶å¸¦ä¸Šå½“å‰çš„ is_admin çŠ¶æ€
            await db.from('feedbacks').insert([{ 
                knowledge_id: kId, 
                user_name: currentUser.username, 
                parent_id: pid, 
                custom_text: content,
                is_admin: currentUser.is_admin // ğŸ‘ˆ è®°å½•èº«ä»½
            }]);
            resetInputState(kId);
        }

        // --- è¾…åŠ©äº¤äº’å‡½æ•° (ä¿æŒä¸å˜) ---
        window.selectReplyTarget = function(kId, cId, uName) {
            event.stopPropagation();
            document.querySelectorAll(`#list-${kId} .fb-item`).forEach(e => e.classList.remove('active-target'));
            document.getElementById(`item-${cId}`).classList.add('active-target');
            document.getElementById(`pid-${kId}`).value = cId;
            document.getElementById(`st-${kId}`).innerHTML = `å›å¤ <b>${uName}</b>`;
            document.getElementById(`reset-${kId}`).style.display = 'block';
            document.getElementById(`in-${kId}`).focus();
        }
        window.togglePreset = function(kId, code) {
            const input = document.getElementById(`in-${kId}`);
            document.getElementById(`pcode-${kId}`).value = code;
            document.querySelectorAll(`#box-${kId} .chip`).forEach(c => c.classList.remove('selected'));
            document.getElementById(`chip-${kId}-${code.replace('/','_')}`).classList.add('selected');
            input.value = ""; input.placeholder = `[å·²é€‰] ${CODE_MAP[code]}`; input.disabled = true;
            document.getElementById(`reset-${kId}`).style.display = 'block';
        }
        window.handleUserTyping = function(kId) {
            document.getElementById(`pcode-${kId}`).value = "";
            document.querySelectorAll(`#box-${kId} .chip`).forEach(c => c.classList.remove('selected'));
        }
        window.unlockInput = function(kId) {
            const input = document.getElementById(`in-${kId}`);
            if(input.disabled) { input.disabled = false; input.placeholder = "è¾“å…¥å†…å®¹..."; input.focus(); handleUserTyping(kId); }
        }
        window.resetInputState = function(kId) {
            document.getElementById(`pid-${kId}`).value = ""; document.getElementById(`pcode-${kId}`).value = "";
            const input = document.getElementById(`in-${kId}`);
            input.value = ""; input.disabled = false; input.placeholder = "è¾“å…¥å†…å®¹...";
            document.querySelectorAll(`#list-${kId} .fb-item`).forEach(e => e.classList.remove('active-target'));
            document.querySelectorAll(`#box-${kId} .chip`).forEach(c => c.classList.remove('selected'));
            document.getElementById(`st-${kId}`).innerHTML = "ğŸ“ æ–°è¯„è®º";
            document.getElementById(`reset-${kId}`).style.display = 'none';
        }

        // ================= âš–ï¸ ç®¡ç†å‘˜å®¡æ ¸ =================
        async function loadPending() {
            // åªæœ‰æƒé™ä¸º true æ‰èƒ½çœ‹
            if(!currentUser || !currentUser.is_admin) return alert("æ— æƒè®¿é—®");
            
            const { data } = await db.from('submissions').select('*').eq('status', 'pending');
            const list = document.getElementById('admin-list');
            if(!data || data.length === 0) { list.innerHTML = '<div style="color:#999;">æš‚æ— å¾…å®¡æ ¸å†…å®¹</div>'; return; }

            list.innerHTML = data.map(i => `
                <div class="card" style="padding:15px;">
                    <div><b>${i.t}</b> <span style="font-size:12px;color:#999">(${i.cat})</span></div>
                    <div style="font-size:12px;color:#666;margin:5px 0;">${i.d}</div>
                    <div style="display:flex; gap:10px;">
                        <button class="small btn-green" onclick="audit('${i.id}', 'approved')">âœ… é€šè¿‡</button>
                        <button class="small btn-red" onclick="audit('${i.id}', 'rejected')">âŒ æ‹’ç»</button>
                    </div>
                </div>
            `).join('');
        }

        async function audit(id, status) {
            await db.from('submissions').update({ status: status }).eq('id', id);
            loadPending();
            if(status === 'approved') loadData(); // å¦‚æœé€šè¿‡ï¼Œåˆ·æ–°ä¸»é¡µ
        }
        async function submitKnowledge() {
            if(!currentUser) return alert("è¯·å…ˆç™»å½•");
            const t = document.getElementById('sub-t').value;
            const d = document.getElementById('sub-d').value;
            const cat = document.getElementById('sub-cat').value;
            if(!t || !d) return alert("è¯·å¡«å†™å®Œæ•´");
            const { error } = await db.from('submissions').insert([{ t, d, cat, status: 'pending', user_id: currentUser.id }]);
            if(error) alert("å¤±è´¥: "+error.message); else { alert("æŠ•ç¨¿æˆåŠŸï¼Œå¾…å®¡æ ¸"); nav('home'); }
        }

        // ================= ğŸ” Auth & è·¯ç”± =================
        function updateProfileUI() {
            document.getElementById('u-name').innerText = currentUser ? `ğŸ‘‹ ${currentUser.username}` + (currentUser.is_admin?'(ç®¡)':'') : 'æœªç™»å½•';
            document.getElementById('btn-logout').style.display = currentUser ? 'block' : 'none';
        }
        async function doRegister() {
            const e=document.getElementById('auth-email').value, p=document.getElementById('auth-pass').value, u=document.getElementById('auth-user').value;
            if(!u) return alert("è¯·å¡«æ˜µç§°");
            const {error} = await auth.signUp({email:e, password:p, options:{data:{username:u}}});
            if(error) alert(error.message); else alert("æ³¨å†Œé‚®ä»¶å·²å‘é€");
        }
        async function doLogin() {
            const {error} = await auth.signInWithPassword({email:document.getElementById('auth-email').value, password:document.getElementById('auth-pass').value});
            if(!error) nav('home'); else alert(error.message);
        }
        async function doLogout() { await auth.signOut(); window.location.reload(); }
        
        function nav(id) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(id==='admin' && currentUser?.is_admin) loadPending();
            toggleSidebar();
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); }

        // ================= âš”ï¸ å¯¹æˆ˜ (çœç•¥ï¼ŒåŠŸèƒ½ä¸å˜) =================
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå‡è®¾ duel åŠŸèƒ½ä»£ç ä¸ v55 ç›¸åŒ...
        async function findMatch() { alert("å¯¹æˆ˜åŠŸèƒ½ä»£ç è§v55ï¼Œä¸ºäº†ç®€æ´æ­¤å¤„çœç•¥"); } 
    </script>
</body>
</html>
