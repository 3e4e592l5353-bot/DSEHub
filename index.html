<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DSE Hub v71 Ultimate</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================= è§†è§‰ç³»ç»Ÿ (Glassmorphism) ================= */
        :root {
            --primary: #2563eb; --accent: #0ea5e9; --danger: #ef4444; --success: #22c55e;
            --bg: #f8fafc; --text: #0f172a; --text-light: #64748b;
            --glass: rgba(255, 255, 255, 0.95);
            --border: 1px solid rgba(226, 232, 240, 0.8);
            --radius: 12px;
        }
        body { margin:0; font-family:-apple-system, sans-serif; background:var(--bg); color:var(--text); height:100vh; display:flex; overflow:hidden; }
        * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; outline:none; }

        /* ç»„ä»¶åº“ */
        .btn { padding:10px 16px; border-radius:8px; border:none; cursor:pointer; font-weight:600; font-size:14px; transition:0.2s; background:var(--primary); color:#fff; width:100%; }
        .btn:active { transform:scale(0.98); }
        .btn.ghost { background:transparent; color:var(--text); border:var(--border); }
        .btn.danger { background:var(--danger); }
        .btn.success { background:var(--success); }
        .btn.small { padding:4px 10px; font-size:12px; width:auto; }

        input, textarea, select { width:100%; padding:12px; border-radius:8px; border:var(--border); background:#fff; margin-bottom:10px; font-size:14px; }
        
        .card { background:var(--glass); border:var(--border); border-radius:var(--radius); padding:16px; margin-bottom:12px; box-shadow:0 2px 4px rgba(0,0,0,0.02); }
        
        /* å¸ƒå±€ */
        .sidebar { width:260px; background:#fff; border-right:var(--border); display:flex; flex-direction:column; padding:20px; z-index:100; transition:0.3s; }
        .main { flex:1; padding:20px; overflow-y:auto; position:relative; }
        .page { display:none; max-width:800px; margin:0 auto; padding-bottom:100px; animation:fadeIn 0.3s; }
        .page.active { display:block; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* å¯¼èˆªé¡¹ */
        .nav-item { padding:12px; margin-bottom:5px; border-radius:8px; cursor:pointer; color:var(--text-light); display:flex; align-items:center; gap:10px; font-weight:500; }
        .nav-item:hover { background:#f1f5f9; }
        .nav-item.active { background:var(--primary); color:#fff; }
        
        /* èƒ¶å›Šæ ‡ç­¾ */
        .capsule-row { display:flex; overflow-x:auto; gap:8px; margin-bottom:15px; padding-bottom:5px; }
        .capsule { padding:6px 14px; border-radius:20px; background:#e2e8f0; font-size:13px; cursor:pointer; white-space:nowrap; }
        .capsule.active { background:var(--primary); color:#fff; }

        /* çŠ¶æ€æ ‡ç­¾ */
        .tag { padding:2px 6px; border-radius:4px; font-size:11px; font-weight:bold; }
        .tag.admin { background:#f59e0b; color:#fff; }
        .tag.mod { background:#ef4444; color:#fff; }

        /* ç§»åŠ¨ç«¯ */
        .mobile-header { display:none; padding:10px 15px; background:#fff; border-bottom:var(--border); justify-content:space-between; align-items:center; }
        @media(max-width:768px) {
            .sidebar { position:fixed; left:-100%; height:100%; box-shadow:10px 0 30px rgba(0,0,0,0.1); }
            .sidebar.open { left:0; }
            .mobile-header { display:flex; }
            .main { padding-top:60px; }
        }

        /* æ¨¡æ€æ¡† */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px); }
        .modal-box { background:#fff; width:320px; padding:24px; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="modal" id="auth-layer">
        <div class="modal-box" style="text-align:center;">
            <h2 style="color:var(--primary); margin-top:0;">DSE HUB v71</h2>
            <p style="color:#666; font-size:13px;">å•†ä¸šé€»è¾‘å®Œæ•´æ¼”ç¤ºç‰ˆ</p>
            <input id="lg-email" placeholder="Email">
            <input id="lg-pwd" type="password" placeholder="Password">
            <button class="btn" onclick="auth('in')">ç™»å½•</button>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button class="btn ghost small" onclick="auth('up')" style="flex:1">æ³¨å†Œ</button>
                <button class="btn ghost small" id="resume-btn" onclick="resume()" style="flex:1; display:none;">æ¢å¤ç™»å½•</button>
            </div>
            <p id="lg-msg" style="color:red; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="mobile-header">
        <button class="btn ghost small" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <b>DSE Hub</b>
        <div style="width:20px"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <h2 style="margin:0 0 20px 10px; color:var(--primary);"><i class="fas fa-layer-group"></i> Hub v71</h2>
        
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('duel', this)"><i class="fas fa-bolt"></i> çº¿ä¸Šå¯¹å†³</div>
        <div class="nav-item" onclick="nav('rank', this)"><i class="fas fa-trophy"></i> æ’è¡Œæ¦œ</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        
        <div id="admin-link" class="nav-item" onclick="nav('admin', this)" style="display:none; color:#f59e0b;">
            <i class="fas fa-shield-alt"></i> ç®¡ç†åå°
        </div>

        <div style="flex:1"></div>
        <div class="card" style="margin-bottom:0; background:#f8fafc; border:none;">
            <div style="font-weight:bold;" id="u-name">Guest</div>
            <div style="font-size:12px; color:#64748b; margin:5px 0;">ç§¯åˆ†: <span id="u-score">0</span></div>
            <button class="btn small ghost danger" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <div class="main" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">

        <div id="view-home" class="page active">
            <h1>ğŸ“š çŸ¥è¯†åº“</h1>
            <div class="capsule-row" id="kb-cats"></div> <input id="kb-search" placeholder="ğŸ” æœç´¢å·²å®¡æ ¸é€šè¿‡çš„çŸ¥è¯†ç‚¹..." onkeyup="fetchHome()">
            <div id="kb-list"></div>
        </div>

        <div id="view-chat" class="page">
            <h1>ğŸ’¬ äº¤æµåŒº</h1>
            <div class="card" style="height:50vh; overflow-y:auto; display:flex; flex-direction:column-reverse;" id="chat-list"></div>
            
            <div class="capsule-row" style="margin-bottom:10px;">
                <div class="capsule" onclick="addTag('è°¢è°¢å¤§ä½¬ï¼')">ğŸ‘ è°¢è°¢</div>
                <div class="capsule" onclick="addTag('æ±‚è§£ç­”ï¼')">â“ æ±‚é—®</div>
                <div class="capsule" onclick="addTag('çº¦æˆ˜å—ï¼Ÿ')">âš”ï¸ çº¦æˆ˜</div>
            </div>
            
            <div id="reply-bar" style="display:none; background:#e0f2fe; padding:8px; border-radius:8px; margin-bottom:8px; font-size:12px; justify-content:space-between; align-items:center;">
                <span>â†ªï¸ æ­£åœ¨å›å¤: <b id="reply-user">User</b></span>
                <i class="fas fa-times" style="cursor:pointer;" onclick="cancelReply()"></i>
            </div>

            <div class="card">
                <textarea id="chat-in" rows="2" placeholder="è¾“å…¥å†…å®¹..."></textarea>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="chat-target" style="flex:1;">
                        <option value="public">ğŸŒ å…¬å¼€ç•™è¨€</option>
                        </select>
                    <button class="btn small" onclick="sendChat()" style="width:auto">å‘é€</button>
                </div>
            </div>
        </div>

        <div id="view-duel" class="page">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>âš¡ï¸ å¯¹å†³å¤§å…</h1>
                <button class="btn small" style="width:auto" onclick="createRoom()">â• åˆ›å»ºæˆ¿é—´</button>
            </div>
            <button class="btn ghost" onclick="fetchDuels()" style="margin-bottom:10px;">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <div id="duel-list"></div>
        </div>

        <div id="view-rank" class="page">
            <h1>ğŸ† ç§¯åˆ†æ’è¡Œ</h1>
            <div id="rank-list"></div>
        </div>

        <div id="view-submit" class="page">
            <h1>âœï¸ æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="card">
                <div class="capsule-row" id="sub-cats"></div>
                <input id="sub-t" placeholder="æ ‡é¢˜">
                <textarea id="sub-c" rows="5" placeholder="æ­£æ–‡å†…å®¹"></textarea>
                <p style="font-size:12px; color:#666;">* æäº¤åéœ€ç®¡ç†å‘˜å®¡æ ¸é€šè¿‡æ‰ä¼šåœ¨çŸ¥è¯†åº“æ˜¾ç¤ºã€‚</p>
                <button class="btn" onclick="submitPost()">æäº¤å®¡æ ¸</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1 style="color:#f59e0b">ğŸ›¡ ç®¡ç†åå°</h1>
            <div class="capsule-row">
                <div class="capsule active" onclick="switchAdminTab('kb')">å¾…å®¡çŸ¥è¯† (<span id="cnt-kb">0</span>)</div>
                <div class="capsule" onclick="switchAdminTab('chat')">ä¸¾æŠ¥å¤„ç† (<span id="cnt-chat">0</span>)</div>
            </div>
            
            <div id="adm-kb-list"></div>
            <div id="adm-chat-list" style="display:none;"></div>
        </div>

    </div>

    <script>
        // ==========================================
        // âš ï¸ å¿…å¡«ï¼šSupabase é…ç½®
        // ==========================================
        const SB_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SB_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        // å…¨å±€çŠ¶æ€
        let user = null;
        let profile = null;
        let replyingTo = null; // å›å¤ID
        let currentCat = 'chi';
        const cats = [
            {k:'chi', n:'ä¸­æ–‡'}, {k:'eng', n:'è‹±æ–‡'}, {k:'math', n:'æ•°å­¦'}, 
            {k:'cs', n:'å…¬ç¤¾ç§‘'}, {k:'bio', n:'ç”Ÿç‰©'}
        ];

        // 1. åˆå§‹åŒ– (æ£€æŸ¥Sessionä½†ä¸è‡ªåŠ¨è¿›)
        window.onload = async () => {
            initCats();
            const { data } = await sb.auth.getSession();
            if(data.session) {
                document.getElementById('resume-btn').style.display = 'block';
                document.getElementById('lg-msg').innerText = "æ£€æµ‹åˆ°ä¸Šæ¬¡ç™»å½•ï¼Œå¯ç‚¹å‡»æ¢å¤";
                document.getElementById('lg-msg').style.color = "blue";
            }
        };

        function initCats() {
            const html = cats.map(c => `<div class="capsule ${c.k==='chi'?'active':''}" onclick="setCat('${c.k}', this)">${c.n}</div>`).join('');
            document.getElementById('kb-cats').innerHTML = html;
            document.getElementById('sub-cats').innerHTML = html;
        }

        // ================= èº«ä»½è®¤è¯ & èµ„æ–™ =================
        async function auth(type) {
            const email = document.getElementById('lg-email').value;
            const pwd = document.getElementById('lg-pwd').value;
            let res;
            if(type === 'up') res = await sb.auth.signUp({email, password:pwd});
            else res = await sb.auth.signInWithPassword({email, password:pwd});
            
            if(res.error) {
                document.getElementById('lg-msg').innerText = res.error.message;
                document.getElementById('lg-msg').style.color = "red";
            } else {
                enter(res.data.user);
            }
        }

        async function resume() {
            const { data } = await sb.auth.getSession();
            enter(data.session.user);
        }

        async function enter(u) {
            user = u;
            // è·å–è¯¦ç»† Profile (ç§¯åˆ† + æƒé™)
            let { data } = await sb.from('profiles').select('*').eq('id', user.id).single();
            // å…œåº•ï¼šå¦‚æœæ²¡æœ‰ profileï¼Œæ–°å»ºä¸€ä¸ª
            if(!data) {
                const newP = { id: user.id, username: user.email.split('@')[0], score: 0, is_admin: false };
                await sb.from('profiles').insert(newP);
                data = newP;
            }
            profile = data;

            // UI æ›´æ–°
            document.getElementById('u-name').innerText = profile.username + (profile.is_admin ? ' (Admin)' : '');
            document.getElementById('u-score').innerText = profile.score;
            document.getElementById('auth-layer').style.display = 'none';

            // ç®¡ç†å‘˜å…¥å£æ§åˆ¶
            if(profile.is_admin) document.getElementById('admin-link').style.display = 'flex';

            // åŠ è½½ç§ä¿¡ç”¨æˆ·åˆ—è¡¨
            loadUsers();
            nav('home');
        }

        function logout() { sb.auth.signOut().then(() => location.reload()); }

        // ================= çŸ¥è¯†åº“ (View Logic) =================
        async function fetchHome() {
            const term = document.getElementById('kb-search').value;
            // å…³é”®é€»è¾‘ï¼šåªæŸ¥è¯¢ status = 'approved'
            let q = sb.from('submissions').select('*').eq('status', 'approved').eq('category', currentCat);
            if(term) q = q.ilike('title', `%${term}%`);
            
            const { data } = await q;
            document.getElementById('kb-list').innerHTML = (data||[]).map(i => `
                <div class="card">
                    <h3>${i.title}</h3>
                    <p style="white-space:pre-wrap;">${i.content}</p>
                    <div style="font-size:12px; color:#999;">By ${i.author_name}</div>
                </div>
            `).join('');
        }

        // ================= ç•™è¨€æ¿ (Chat Logic) =================
        async function loadUsers() {
            const { data } = await sb.from('profiles').select('id, username').limit(50);
            const sel = document.getElementById('chat-target');
            (data||[]).forEach(u => {
                if(u.id !== user.id) {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.text = `ğŸ”’ ç§ä¿¡ç»™: ${u.username}`;
                    sel.appendChild(opt);
                }
            });
        }

        async function loadChat() {
            // åªæŸ¥è¯¢ status != 'deleted'
            const { data } = await sb.from('feedbacks')
                .select('*')
                .neq('status', 'deleted')
                .order('created_at', {ascending:false})
                .limit(30);

            const el = document.getElementById('chat-list');
            el.innerHTML = '';

            (data||[]).forEach(m => {
                // éšç§é€»è¾‘
                const isPriv = m.target_id != null;
                const canSee = !isPriv || m.author_id === user.id || m.target_id === user.id;
                if(!canSee) return;

                // ä¸¾æŠ¥é€»è¾‘ï¼šå¦‚æœè¢«ä¸¾æŠ¥ä¸”ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºæŠ˜å 
                const isReported = m.status === 'reported';
                
                let contentHtml = `<div style="margin-top:5px;">${m.content}</div>`;
                if(isReported) {
                    contentHtml = `<div style="margin-top:5px; color:red; font-style:italic;">âš ï¸ æ­¤å†…å®¹è¢«ä¸¾æŠ¥ï¼Œæ­£åœ¨å®¡æ ¸ä¸­...</div>`;
                    if(profile.is_admin) contentHtml += `<div style="font-size:12px; color:#666;">(ç®¡ç†å‘˜å¯è§åŸå§‹å†…å®¹: ${m.content})</div>`;
                }

                const div = document.createElement('div');
                div.style = `padding:10px; border-bottom:1px solid #eee; ${m.parent_id?'margin-left:20px; border-left:2px solid #ddd; background:#f9f9f9;':''} ${isPriv?'background:#fff0f0;':''}`;
                
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-size:12px; color:#666;">
                        <span>${m.author_name} ${isPriv?'ğŸ”’':''}</span>
                        <div>
                            <span style="cursor:pointer; color:var(--primary); margin-right:10px;" onclick="setReply('${m.id}', '${m.author_name}')">å›å¤</span>
                            ${!isReported ? `<span style="cursor:pointer; color:red;" onclick="reportMsg('${m.id}')">ä¸¾æŠ¥</span>` : ''}
                        </div>
                    </div>
                    ${contentHtml}
                `;
                el.appendChild(div);
            });
        }

        async function sendChat() {
            const txt = document.getElementById('chat-in').value;
            const target = document.getElementById('chat-target').value;
            if(!txt) return;

            await sb.from('feedbacks').insert({
                author_id: user.id, author_name: profile.username,
                content: txt,
                target_id: target==='public'?null:target,
                parent_id: replyingTo,
                status: 'normal'
            });
            
            document.getElementById('chat-in').value = '';
            cancelReply();
            loadChat();
        }

        async function reportMsg(id) {
            if(!confirm("ç¡®å®šä¸¾æŠ¥æ­¤å†…å®¹ï¼Ÿ")) return;
            await sb.from('feedbacks').update({ status: 'reported' }).eq('id', id);
            alert("å·²æäº¤ä¸¾æŠ¥ï¼Œç­‰å¾…ç®¡ç†å‘˜å¤„ç†");
            loadChat();
        }

        // ================= çº¿ä¸Šå¯¹å†³ & ç»“ç®— (Duel Logic) =================
        async function fetchDuels() {
            // åªæ˜¾ç¤ºæœªç»“æŸçš„
            const { data } = await sb.from('duel_rooms').select('*').is('winner_id', null).order('created_at', {ascending:false});
            const el = document.getElementById('duel-list');
            
            el.innerHTML = (data||[]).map(r => {
                const isFull = r.player2_id != null;
                const amIPlayer = r.player1_id === user.id || r.player2_id === user.id;
                
                let btn = '';
                if(amIPlayer) {
                    // ç»“ç®—å…¥å£ï¼šåªæœ‰å‚ä¸è€…èƒ½çœ‹åˆ°ç»“ç®—æŒ‰é’® (ç®€å•æ¨¡æ‹Ÿ)
                    btn = `<button class="btn small success" onclick="endDuel(${r.id}, '${user.id}')">æˆ‘èµ¢äº†(+10åˆ†)</button>`;
                } else if(!isFull) {
                    btn = `<button class="btn small" onclick="joinDuel(${r.id})">åŠ å…¥</button>`;
                } else {
                    btn = `<button class="btn small ghost" disabled>è¿›è¡Œä¸­</button>`;
                }

                return `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>Room #${r.id}</b>
                        <div style="font-size:12px; color:#666;">P1: ${r.player1_name} vs P2: ${r.player2_name||'?'}</div>
                    </div>
                    ${btn}
                </div>`;
            }).join('');
        }

        async function createRoom() {
            await sb.from('duel_rooms').insert({ player1_id: user.id, player1_name: profile.username });
            fetchDuels();
        }

        async function joinDuel(id) {
            await sb.from('duel_rooms').update({ player2_id: user.id, player2_name: profile.username }).eq('id', id);
            fetchDuels();
        }

        async function endDuel(roomId, winnerId) {
            if(!confirm("ç¡®è®¤ä½ èµ¢äº†å—ï¼Ÿç§¯åˆ†å°†è®¡å…¥æ’è¡Œæ¦œã€‚")) return;
            
            // 1. ç»“æŸæˆ¿é—´
            await sb.from('duel_rooms').update({ winner_id: winnerId }).eq('id', roomId);
            
            // 2. å¢åŠ ç§¯åˆ† (ç®€å•å®ç°ï¼šå…ˆè¯»å†å†™ï¼Œç”Ÿäº§ç¯å¢ƒåº”ç”¨ RPC åŸå­æ“ä½œ)
            const { data: p } = await sb.from('profiles').select('score').eq('id', winnerId).single();
            await sb.from('profiles').update({ score: (p.score||0) + 10 }).eq('id', winnerId);
            
            alert("æ­å–œï¼ç§¯åˆ†å·²åˆ°è´¦ã€‚");
            // æ›´æ–°æœ¬åœ° UI
            document.getElementById('u-score').innerText = (p.score||0) + 10;
            fetchDuels();
        }

        // ================= æ’è¡Œæ¦œ (Leaderboard) =================
        async function fetchRank() {
            const { data } = await sb.from('profiles').select('username, score').order('score', {ascending:false}).limit(20);
            document.getElementById('rank-list').innerHTML = (data||[]).map((p, i) => `
                <div class="card" style="padding:10px; display:flex; justify-content:space-between;">
                    <span>#${i+1} <b>${p.username}</b></span>
                    <span style="color:var(--primary); font-weight:bold;">${p.score} pts</span>
                </div>
            `).join('');
        }

        // ================= ç®¡ç†åå° (Admin Logic) =================
        let admTab = 'kb';
        async function loadAdmin() {
            if(!profile.is_admin) return;
            
            // ç»Ÿè®¡æ•°é‡
            const { count: c1 } = await sb.from('submissions').select('*', {count: 'exact', head: true}).eq('status', 'pending');
            const { count: c2 } = await sb.from('feedbacks').select('*', {count: 'exact', head: true}).eq('status', 'reported');
            document.getElementById('cnt-kb').innerText = c1 || 0;
            document.getElementById('cnt-chat').innerText = c2 || 0;

            if(admTab === 'kb') {
                document.getElementById('adm-kb-list').style.display = 'block';
                document.getElementById('adm-chat-list').style.display = 'none';
                
                const { data } = await sb.from('submissions').select('*').eq('status', 'pending');
                document.getElementById('adm-kb-list').innerHTML = (data||[]).map(i => `
                    <div class="card">
                        <b>${i.title}</b>
                        <p style="font-size:12px;">${i.content}</p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn small success" onclick="auditKB(${i.id}, 'approved')">é€šè¿‡</button>
                            <button class="btn small danger" onclick="auditKB(${i.id}, 'rejected')">æ‹’ç»</button>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('adm-kb-list').style.display = 'none';
                document.getElementById('adm-chat-list').style.display = 'block';

                const { data } = await sb.from('feedbacks').select('*').eq('status', 'reported');
                document.getElementById('adm-chat-list').innerHTML = (data||[]).map(i => `
                    <div class="card">
                        <div style="font-size:12px; color:red;">ä¸¾æŠ¥å¯¹è±¡: ${i.author_name}</div>
                        <p>${i.content}</p>
                        <div style="display:flex; gap:10px;">
                            <button class="btn small success" onclick="auditMsg(${i.id}, 'normal')">æ— è¿è§„ (æ¢å¤)</button>
                            <button class="btn small danger" onclick="auditMsg(${i.id}, 'deleted')">ç¡®è®¤è¿è§„ (åˆ é™¤)</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function auditKB(id, status) {
            await sb.from('submissions').update({ status }).eq('id', id);
            loadAdmin();
        }
        async function auditMsg(id, status) {
            await sb.from('feedbacks').update({ status }).eq('id', id);
            loadAdmin();
        }
        function switchAdminTab(t) { admTab = t; loadAdmin(); }

        // ================= é€šç”¨è¾…åŠ© =================
        function submitPost() {
            const title = document.getElementById('sub-t').value;
            const content = document.getElementById('sub-c').value;
            sb.from('submissions').insert({
                category: currentCat, title, content, 
                author_id: user.id, author_name: profile.username, 
                status: 'pending' // å…³é”®ï¼šé»˜è®¤å¾…å®¡
            }).then(() => { alert("æäº¤æˆåŠŸï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸"); nav('home'); });
        }

        function setReply(id, name) {
            replyingTo = id;
            document.getElementById('reply-bar').style.display = 'flex';
            document.getElementById('reply-user').innerText = name;
        }
        function cancelReply() { replyingTo = null; document.getElementById('reply-bar').style.display = 'none'; }
        function addTag(txt) { document.getElementById('chat-in').value += txt + " "; }
        
        function nav(page, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('view-'+page).classList.add('active');
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
            if(el) { document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); el.classList.add('active'); }
            
            // åˆ·æ–°æ•°æ®
            if(page === 'home') fetchHome();
            if(page === 'chat') loadChat();
            if(page === 'duel') fetchDuels();
            if(page === 'rank') fetchRank();
            if(page === 'admin') loadAdmin();
        }
        function setCat(k, el) { currentCat = k; fetchHome(); document.querySelectorAll('.capsule').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>
