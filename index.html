<!DOCTYPE html>
<html lang="zh-HK" data-theme="dark" data-aurora="active">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSEhub · 香港DSE综合知识库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== 极光风CSS变量 ===== */
        :root {
            /* 极光主色 - 简化版 */
            --aurora-primary: #6366f1;
            --aurora-secondary: #8b5cf6;
            --aurora-accent: #ec4899;
            --aurora-cyan: #06d6a0;
            
            /* 背景色 - 深色主题更适合极光 */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-sidebar: #0f172a;
            --bg-toolbar: rgba(30, 41, 59, 0.9);
            
            /* 文字颜色 */
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            
            /* 极光渐变 - 简化版 */
            --aurora-gradient: linear-gradient(135deg, 
                var(--aurora-primary) 0%, 
                var(--aurora-secondary) 50%, 
                var(--aurora-accent) 100%);
            
            --aurora-subtle: linear-gradient(135deg, 
                rgba(99, 102, 241, 0.1) 0%, 
                rgba(139, 92, 246, 0.1) 50%, 
                rgba(236, 72, 153, 0.1) 100%);
            
            /* 布局 */
            --sidebar-width: 280px;
            --radius: 12px;
            --radius-lg: 16px;
            
            /* 过渡 */
            --transition: all 0.3s ease;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --bg-sidebar: #ffffff;
            --bg-toolbar: rgba(255, 255, 255, 0.9);
            
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'PingFang SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* ===== 极光背景 ===== */
        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .aurora-layer {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            animation: auroraFloat 20s ease-in-out infinite;
        }

        .aurora-layer:nth-child(1) {
            background: linear-gradient(45deg, var(--aurora-primary), var(--aurora-cyan));
            animation-delay: 0s;
            filter: blur(40px);
        }

        .aurora-layer:nth-child(2) {
            background: linear-gradient(135deg, var(--aurora-secondary), var(--aurora-accent));
            animation-delay: -5s;
            filter: blur(60px);
        }

        .aurora-layer:nth-child(3) {
            background: linear-gradient(225deg, var(--aurora-accent), var(--aurora-primary));
            animation-delay: -10s;
            filter: blur(80px);
        }

        @keyframes auroraFloat {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.1;
            }
            25% {
                transform: translate(20px, 20px) rotate(5deg);
                opacity: 0.15;
            }
            50% {
                transform: translate(-20px, 40px) rotate(-5deg);
                opacity: 0.2;
            }
            75% {
                transform: translate(40px, -20px) rotate(10deg);
                opacity: 0.15;
            }
        }

        /* ===== 顶部导航栏 ===== */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: var(--bg-toolbar);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--aurora-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--aurora-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .nav-btn:hover {
            background: var(--bg-hover);
            border-color: var(--aurora-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }

        .nav-btn.active {
            background: var(--aurora-gradient);
            color: white;
            border: none;
        }

        /* ===== 主内容区域 ===== */
        .main-content {
            margin-top: 80px;
            padding: 24px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ===== 搜索和筛选区 ===== */
        .search-section {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: var(--bg-hover);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--aurora-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .search-btn {
            padding: 12px 32px;
            background: var(--aurora-gradient);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .filters-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-hover);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:hover {
            border-color: var(--aurora-primary);
        }

        /* ===== 快速操作按钮 ===== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .quick-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .quick-btn:hover {
            background: var(--bg-hover);
            border-color: var(--aurora-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
        }

        .quick-icon {
            width: 48px;
            height: 48px;
            background: var(--aurora-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .quick-text h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .quick-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ===== 知识点列表 ===== */
        .knowledge-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .stats-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stats-icon {
            width: 40px;
            height: 40px;
            background: var(--aurora-subtle);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--aurora-primary);
        }

        .stats-text h3 {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }

        .stats-text p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .knowledge-list {
            display: grid;
            gap: 16px;
        }

        .knowledge-item {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(99, 102, 241, 0.2);
            overflow: hidden;
            transition: var(--transition);
        }

        .knowledge-item:hover {
            transform: translateY(-4px);
            border-color: var(--aurora-primary);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.2);
        }

        .item-header {
            padding: 20px;
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .item-tags {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .subject-tag {
            padding: 4px 12px;
            background: var(--aurora-subtle);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--aurora-primary);
        }

        .difficulty-tag {
            padding: 4px 12px;
            background: var(--bg-hover);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .item-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .item-preview {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-meta {
            display: flex;
            gap: 16px;
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            background: var(--bg-hover);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--aurora-subtle);
            border-color: var(--aurora-primary);
        }

        .action-btn.primary {
            background: var(--aurora-gradient);
            color: white;
            border: none;
        }

        .action-btn.primary:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .item-content {
            padding: 20px;
            background: var(--bg-hover);
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }

        .content-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--aurora-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key-points {
            display: grid;
            gap: 8px;
        }

        .key-point {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 6px;
            border-left: 3px solid var(--aurora-primary);
        }

        .example-card {
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            margin-bottom: 12px;
        }

        .example-question {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .example-answer {
            color: var(--text-secondary);
            font-size: 0.875rem;
            padding-left: 8px;
            border-left: 2px solid var(--aurora-primary);
        }

        /* ===== 分页 ===== */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 32px;
            padding: 20px;
        }

        .page-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-card);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-btn:hover {
            background: var(--bg-hover);
            border-color: var(--aurora-primary);
        }

        .page-btn.active {
            background: var(--aurora-gradient);
            color: white;
            border: none;
        }

        .page-info {
            margin: 0 16px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* ===== 浮动按钮 ===== */
        .floating-buttons {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .floating-btn {
            width: 56px;
            height: 56px;
            background: var(--aurora-gradient);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        .floating-btn.forum {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        .floating-btn.game {
            background: linear-gradient(135deg, #10b981, #06d6a0);
        }

        .floating-btn.submit {
            background: linear-gradient(135deg, #f59e0b, #ec4899);
        }

        .floating-btn.note {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
        }

        /* ===== 网站变量 ===== */
        .site-variables {
            display: none;
        }

        /* ===== 响应式 ===== */
        @media (max-width: 768px) {
            .top-nav {
                padding: 0 12px;
            }
            
            .nav-links {
                display: none;
            }
            
            .main-content {
                padding: 16px;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .filters-row {
                flex-direction: column;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .knowledge-stats {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .item-header {
                flex-direction: column;
                gap: 12px;
            }
            
            .item-actions {
                align-self: stretch;
                justify-content: flex-end;
            }
            
            .floating-buttons {
                bottom: 16px;
                right: 16px;
            }
        }

        /* ===== 通知 ===== */
        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            padding: 12px 24px;
            background: var(--bg-card);
            border-left: 4px solid var(--aurora-primary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- 极光背景 -->
    <div class="aurora-background">
        <div class="aurora-layer"></div>
        <div class="aurora-layer"></div>
        <div class="aurora-layer"></div>
    </div>

    <!-- 顶部导航栏 -->
    <nav class="top-nav">
        <a href="#" class="logo">
            <div class="logo-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="logo-text">DSEhub</div>
        </a>
        
        <div class="nav-links">
            <a href="#" class="nav-btn active">
                <i class="fas fa-book"></i> 知识库
            </a>
            <a href="#game-center" class="nav-btn">
                <i class="fas fa-gamepad"></i> 游戏中心
            </a>
            <a href="#submit-center" class="nav-btn">
                <i class="fas fa-paper-plane"></i> 投稿中心
            </a>
            <a href="#note-zone" class="nav-btn">
                <i class="fas fa-sticky-note"></i> 笔记专区
            </a>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="main-content">
        <!-- 搜索和筛选区 -->
        <section class="search-section">
            <div class="search-box">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="搜索知识点、科目、关键词..."
                       onkeypress="if(event.key === 'Enter') searchKnowledge()">
                <button class="search-btn" onclick="searchKnowledge()">
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
            
            <div class="filters-row">
                <div class="filter-group">
                    <label class="filter-label">科目</label>
                    <select class="filter-select" id="subjectFilter">
                        <option value="">全部科目</option>
                        <option value="CHI">中国语文</option>
                        <option value="ENG">英国语文</option>
                        <option value="MATH">数学</option>
                        <option value="LS">通识教育</option>
                        <option value="PHY">物理</option>
                        <option value="CHEM">化学</option>
                        <option value="BIO">生物</option>
                        <option value="CHIST">中国历史</option>
                        <option value="HIST">历史</option>
                        <option value="GEOG">地理</option>
                        <option value="ECON">经济</option>
                        <option value="CIT">资讯科技</option>
                        <option value="BAFS">企会财</option>
                        <option value="M1">数学M1</option>
                        <option value="M2">数学M2</option>
                        <option value="MUSIC">音乐</option>
                        <option value="VA">视觉艺术</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">难度</label>
                    <select class="filter-select" id="difficultyFilter">
                        <option value="">全部难度</option>
                        <option value="1">★ 初级</option>
                        <option value="2">★★ 中级</option>
                        <option value="3">★★★ 高级</option>
                        <option value="4">★★★★ 精通</option>
                        <option value="5">★★★★★ 专家</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">排序</label>
                    <select class="filter-select" id="sortFilter">
                        <option value="recent">最新优先</option>
                        <option value="difficulty">难度从低到高</option>
                        <option value="difficulty_desc">难度从高到低</option>
                        <option value="popular">最多收藏</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">每页显示</label>
                    <select class="filter-select" id="perPageFilter">
                        <option value="10">10条</option>
                        <option value="20">20条</option>
                        <option value="50">50条</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- 快速操作按钮 -->
        <div class="quick-actions">
            <a href="#" class="quick-btn" onclick="goToGameCenter()">
                <div class="quick-icon">
                    <i class="fas fa-gamepad"></i>
                </div>
                <div class="quick-text">
                    <h3>游戏中心</h3>
                    <p>趣味学习，挑战答题</p>
                </div>
            </a>
            
            <a href="#" class="quick-btn" onclick="goToSubmitCenter()">
                <div class="quick-icon">
                    <i class="fas fa-paper-plane"></i>
                </div>
                <div class="quick-text">
                    <h3>投稿中心</h3>
                    <p>分享你的学习成果</p>
                </div>
            </a>
            
            <a href="#" class="quick-btn" onclick="goToNoteZone()">
                <div class="quick-icon">
                    <i class="fas fa-sticky-note"></i>
                </div>
                <div class="quick-text">
                    <h3>笔记专区</h3>
                    <p>整理个人学习笔记</p>
                </div>
            </a>
        </div>

        <!-- 知识点统计 -->
        <div class="knowledge-stats">
            <div class="stats-item">
                <div class="stats-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stats-text">
                    <h3 id="totalCount">128</h3>
                    <p>总知识点</p>
                </div>
            </div>
            
            <div class="stats-item">
                <div class="stats-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stats-text">
                    <h3 id="subjectCount">18</h3>
                    <p>覆盖科目</p>
                </div>
            </div>
            
            <div class="stats-item">
                <div class="stats-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-text">
                    <h3 id="contributors">24</h3>
                    <p>贡献者</p>
                </div>
            </div>
        </div>

        <!-- 知识点列表 -->
        <div class="knowledge-list" id="knowledgeList">
            <!-- 知识点项目会动态加载 -->
        </div>

        <!-- 分页 -->
        <div class="pagination" id="pagination">
            <button class="page-btn" onclick="changePage(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="page-info" id="pageInfo">第 1 页 / 共 5 页</span>
            <button class="page-btn" onclick="changePage(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </main>

    <!-- 浮动按钮 -->
    <div class="floating-buttons">
        <button class="floating-btn forum" onclick="goToForum()" title="前往留言板">
            <i class="fas fa-comments"></i>
        </button>
        <button class="floating-btn game" onclick="goToGameCenter()" title="游戏中心">
            <i class="fas fa-gamepad"></i>
        </button>
        <button class="floating-btn submit" onclick="goToSubmitCenter()" title="投稿中心">
            <i class="fas fa-paper-plane"></i>
        </button>
        <button class="floating-btn note" onclick="goToNoteZone()" title="笔记专区">
            <i class="fas fa-sticky-note"></i>
        </button>
    </div>

    <!-- 网站变量 - 您需要在这里填写具体的URL -->
    <div class="site-variables">
        <!-- 
            请在这里设置您的网站URL：
            1. forumUrl: 留言板网址
            2. gameCenterUrl: 游戏中心网址  
            3. submitCenterUrl: 投稿中心网址
            4. noteZoneUrl: 笔记专区网址
        -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ===== 网站URL配置 =====
        // 请在这里填写您的网站URL
        const SITE_URLS = {
            forum: 'https://您的论坛网站.com',  // 留言板URL
            gameCenter: 'https://您的游戏中心.com',  // 游戏中心URL
            submitCenter: 'https://您的投稿中心.com',  // 投稿中心URL
            noteZone: 'https://您的笔记专区.com'  // 笔记专区URL
        };

        // ===== Supabase配置 =====
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        // ===== 全局状态 =====
        let currentUser = null;
        let supabaseClient = null;
        let currentPage = 1;
        let totalPages = 1;
        let perPage = 10;
        let currentFilters = {
            subject: '',
            difficulty: '',
            search: '',
            sort: 'recent'
        };

        // ===== 科目映射 =====
        const SUBJECT_MAP = {
            'CHI': '中国语文',
            'ENG': '英国语文',
            'MATH': '数学',
            'LS': '通识教育',
            'PHY': '物理',
            'CHEM': '化学',
            'BIO': '生物',
            'CHIST': '中国历史',
            'HIST': '历史',
            'GEOG': '地理',
            'ECON': '经济',
            'CIT': '资讯及通讯科技',
            'BAFS': '企业、会计与财务概论',
            'M1': '数学延伸单元一',
            'M2': '数学延伸单元二',
            'MUSIC': '音乐',
            'VA': '视觉艺术'
        };

        // ===== 初始化 =====
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 初始化Supabase
                if (window.supabase && window.supabase.createClient) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log('Supabase初始化成功');
                } else {
                    console.error('Supabase库加载失败');
                    // 使用模拟数据
                }
                
                // 检查用户会话
                await checkUserSession();
                
                // 初始化筛选器事件
                initFilters();
                
                // 加载知识列表
                loadKnowledgeList();
                
                // 更新统计信息
                updateStats();
                
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification('系统初始化失败', 'error');
                // 显示测试数据
                showTestData();
            }
        });

        // ===== 用户会话管理 =====
        async function checkUserSession() {
            const sessionToken = getCookie('cross_site_session');
            
            if (sessionToken && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('cross_site_sessions')
                        .select('*, profiles(*)')
                        .eq('session_token', sessionToken)
                        .gt('expires_at', new Date().toISOString())
                        .single();
                    
                    if (data && !error && data.profiles) {
                        currentUser = {
                            id: data.user_id,
                            ...data.profiles
                        };
                        console.log('用户已登录:', currentUser.username);
                        
                        // 显示用户相关的个性化内容
                        document.getElementById('contributors').textContent = '25';
                    }
                } catch (error) {
                    console.error('会话检查失败:', error);
                }
            }
        }

        // ===== 筛选器初始化 =====
        function initFilters() {
            // 筛选器变化监听
            document.getElementById('subjectFilter').addEventListener('change', (e) => {
                currentFilters.subject = e.target.value;
                currentPage = 1;
                loadKnowledgeList();
            });
            
            document.getElementById('difficultyFilter').addEventListener('change', (e) => {
                currentFilters.difficulty = e.target.value;
                currentPage = 1;
                loadKnowledgeList();
            });
            
            document.getElementById('sortFilter').addEventListener('change', (e) => {
                currentFilters.sort = e.target.value;
                currentPage = 1;
                loadKnowledgeList();
            });
            
            document.getElementById('perPageFilter').addEventListener('change', (e) => {
                perPage = parseInt(e.target.value);
                currentPage = 1;
                loadKnowledgeList();
            });
        }

        // ===== 搜索功能 =====
        function searchKnowledge() {
            const searchInput = document.getElementById('searchInput');
            currentFilters.search = searchInput.value.trim();
            currentPage = 1;
            loadKnowledgeList();
        }

        // ===== 加载知识列表 =====
        async function loadKnowledgeList() {
            if (!supabaseClient) {
                // 如果没有Supabase连接，显示测试数据
                showTestData();
                return;
            }
            
            try {
                let query = supabaseClient
                    .from('knowledge_points')
                    .select('*', { count: 'exact' });
                
                // 应用筛选条件
                if (currentFilters.subject) {
                    query = query.eq('subject', currentFilters.subject);
                }
                
                if (currentFilters.difficulty) {
                    query = query.eq('difficulty', parseInt(currentFilters.difficulty));
                }
                
                if (currentFilters.search) {
                    query = query.or(`title.ilike.%${currentFilters.search}%,content.ilike.%${currentFilters.search}%`);
                }
                
                // 应用排序
                switch(currentFilters.sort) {
                    case 'recent':
                        query = query.order('created_at', { ascending: false });
                        break;
                    case 'difficulty':
                        query = query.order('difficulty', { ascending: true });
                        break;
                    case 'difficulty_desc':
                        query = query.order('difficulty', { ascending: false });
                        break;
                    case 'popular':
                        // 这里可能需要一个收藏数字段
                        query = query.order('created_at', { ascending: false });
                        break;
                }
                
                // 分页
                const from = (currentPage - 1) * perPage;
                const to = from + perPage - 1;
                query = query.range(from, to);
                
                const { data, error, count } = await query;
                
                if (error) {
                    console.error('加载知识列表失败:', error);
                    showTestData();
                    return;
                }
                
                // 计算总页数
                totalPages = Math.ceil(count / perPage);
                
                // 渲染列表
                renderKnowledgeList(data || []);
                
                // 更新分页信息
                updatePagination();
                
                // 更新统计
                updateStats();
                
            } catch (error) {
                console.error('加载知识列表异常:', error);
                showTestData();
            }
        }

        function renderKnowledgeList(knowledgePoints) {
            const container = document.getElementById('knowledgeList');
            
            if (!knowledgePoints || knowledgePoints.length === 0) {
                container.innerHTML = `
                    <div class="knowledge-item" style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3rem; color: var(--text-muted); margin-bottom: 20px;">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 style="margin-bottom: 12px; color: var(--text-primary);">暂无相关知识点</h3>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">
                            尝试使用其他关键词搜索或筛选条件
                        </p>
                        <button class="action-btn primary" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> 重置筛选
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            knowledgePoints.forEach((point, index) => {
                const subjectName = SUBJECT_MAP[point.subject] || point.subject;
                
                // 解析内容
                let keyPoints = [];
                let examples = [];
                
                try {
                    if (point.content) {
                        const contentData = typeof point.content === 'string' ? JSON.parse(point.content) : point.content;
                        keyPoints = contentData.key_points || ['暂无关键点'];
                        examples = contentData.examples || [{ question: '暂无示例题目', answer: '暂无答案' }];
                    }
                } catch (e) {
                    keyPoints = ['暂无关键点'];
                    examples = [{ question: '暂无示例题目', answer: '暂无答案' }];
                }
                
                const item = document.createElement('div');
                item.className = 'knowledge-item';
                
                item.innerHTML = `
                    <div class="item-header">
                        <div style="flex: 1;">
                            <div class="item-tags">
                                <span class="subject-tag">${subjectName}</span>
                                <span class="difficulty-tag">难度: ${'★'.repeat(point.difficulty || 1)}</span>
                            </div>
                            <h3 class="item-title">${point.title || '未命名知识点'}</h3>
                            <p class="item-preview">${getContentPreview(point.content)}</p>
                            <div class="item-meta">
                                <span><i class="far fa-calendar"></i> ${formatDate(point.created_at)}</span>
                                <span><i class="fas fa-layer-group"></i> ${point.category_group || '未分类'}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn" onclick="toggleDetails(${index})">
                                <i class="fas fa-chevron-down"></i> 详情
                            </button>
                            <button class="action-btn" onclick="addToFavorites(${point.id})">
                                <i class="far fa-star"></i> 收藏
                            </button>
                        </div>
                    </div>
                    
                    <div class="item-content" id="details-${index}" style="display: none;">
                        <div class="content-section">
                            <div class="section-title">
                                <i class="fas fa-key"></i>
                                <span>关键知识点</span>
                            </div>
                            <div class="key-points">
                                ${keyPoints.map((kp, i) => `
                                    <div class="key-point">
                                        <span style="color: var(--aurora-primary); font-weight: 600;">${i + 1}.</span>
                                        <span>${kp}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${examples.length > 0 ? `
                        <div class="content-section">
                            <div class="section-title">
                                <i class="fas fa-question-circle"></i>
                                <span>示例题目</span>
                            </div>
                            ${examples.map((example, i) => `
                                <div class="example-card">
                                    <div class="example-question">
                                        <strong>示例 ${i + 1}:</strong> ${example.question || '题目'}
                                    </div>
                                    <div class="example-answer">
                                        ${example.answer || '答案'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>` : ''}
                        
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button class="action-btn" onclick="shareKnowledge(${point.id})">
                                <i class="fas fa-share-alt"></i> 分享
                            </button>
                            <button class="action-btn primary" onclick="editKnowledge(${point.id})">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        function toggleDetails(index) {
            const details = document.getElementById(`details-${index}`);
            const isVisible = details.style.display !== 'none';
            
            details.style.display = isVisible ? 'none' : 'block';
            
            // 更新按钮图标
            const buttons = document.querySelectorAll(`[onclick="toggleDetails(${index})"]`);
            buttons.forEach(btn => {
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                }
                btn.innerHTML = `<i class="${isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up'}"></i> ${isVisible ? '详情' : '收起'}`;
            });
        }

        // ===== 分页功能 =====
        function changePage(delta) {
            const newPage = currentPage + delta;
            
            if (newPage < 1 || newPage > totalPages) {
                return;
            }
            
            currentPage = newPage;
            loadKnowledgeList();
            
            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updatePagination() {
            const pageInfo = document.getElementById('pageInfo');
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
        }

        // ===== 统计信息 =====
        async function updateStats() {
            if (!supabaseClient) return;
            
            try {
                // 获取总知识点数
                const { count: total } = await supabaseClient
                    .from('knowledge_points')
                    .select('*', { count: 'exact', head: true });
                
                // 获取科目数
                const { data: subjects } = await supabaseClient
                    .from('knowledge_points')
                    .select('subject')
                    .limit(1000);
                
                const uniqueSubjects = new Set(subjects?.map(s => s.subject) || []);
                
                // 更新显示
                document.getElementById('totalCount').textContent = total || '128';
                document.getElementById('subjectCount').textContent = uniqueSubjects.size || '18';
                
            } catch (error) {
                console.error('更新统计信息失败:', error);
            }
        }

        // ===== 网站跳转功能 =====
        function goToForum() {
            // 保存当前会话到本地存储
            const sessionToken = getCookie('cross_site_session');
            if (sessionToken) {
                localStorage.setItem('forum_session_token', sessionToken);
            }
            
            // 跳转到留言板
            if (SITE_URLS.forum.startsWith('http')) {
                window.location.href = SITE_URLS.forum;
            } else {
                showNotification('请先设置留言板URL', 'warning');
            }
        }

        function goToGameCenter() {
            if (SITE_URLS.gameCenter.startsWith('http')) {
                window.location.href = SITE_URLS.gameCenter;
            } else {
                showNotification('请先设置游戏中心URL', 'warning');
            }
        }

        function goToSubmitCenter() {
            if (SITE_URLS.submitCenter.startsWith('http')) {
                window.location.href = SITE_URLS.submitCenter;
            } else {
                showNotification('请先设置投稿中心URL', 'warning');
            }
        }

        function goToNoteZone() {
            if (SITE_URLS.noteZone.startsWith('http')) {
                window.location.href = SITE_URLS.noteZone;
            } else {
                showNotification('请先设置笔记专区URL', 'warning');
            }
        }

        // ===== 工具函数 =====
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                
                if (days === 0) return '今天';
                if (days === 1) return '昨天';
                if (days < 7) return `${days}天前`;
                if (days < 30) return `${Math.floor(days / 7)}周前`;
                
                return date.toLocaleDateString('zh-HK', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function getContentPreview(content) {
            try {
                if (!content) return '暂无内容描述';
                
                // 如果是JSON，提取描述
                if (content.startsWith('{')) {
                    const data = JSON.parse(content);
                    if (data.description) return data.description;
                    if (data.key_points && data.key_points[0]) return data.key_points[0];
                }
                
                // 如果是普通文本，截取前100字符
                if (content.length > 100) {
                    return content.substring(0, 100) + '...';
                }
                
                return content;
            } catch (e) {
                return content ? content.substring(0, 100) + '...' : '暂无内容描述';
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('difficultyFilter').value = '';
            document.getElementById('sortFilter').value = 'recent';
            
            currentFilters = {
                subject: '',
                difficulty: '',
                search: '',
                sort: 'recent'
            };
            
            currentPage = 1;
            loadKnowledgeList();
        }

        function showNotification(message, type = 'info') {
            // 移除旧的通知
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) oldNotification.remove();
            
            // 创建新通知
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // 设置颜色
            if (type === 'error') {
                notification.style.borderLeftColor = '#ef4444';
            } else if (type === 'success') {
                notification.style.borderLeftColor = '#10b981';
            } else if (type === 'warning') {
                notification.style.borderLeftColor = '#f59e0b';
            }
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ===== 测试数据 =====
        function showTestData() {
            const testData = [
                {
                    id: 1,
                    title: 'DSE中文：阅读理解技巧',
                    subject: 'CHI',
                    category_group: '卷一：阅读能力',
                    difficulty: 3,
                    content: JSON.stringify({
                        description: '掌握记叙文、描写文、说明文、议论文四种文体的阅读策略',
                        key_points: ['记叙文六要素', '描写手法分析', '论证方法识别', '主旨归纳技巧'],
                        examples: [
                            { question: '文中第三段运用了什么描写手法？有什么作用？', answer: '运用了比喻和拟人手法，生动形象地表现了人物的内心世界。' }
                        ]
                    }),
                    created_at: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 2,
                    title: '数学：二次函数图像与性质',
                    subject: 'MATH',
                    category_group: '代数',
                    difficulty: 4,
                    content: JSON.stringify({
                        description: '理解二次函数y=ax²+bx+c的图像特征，包括顶点坐标、对称轴方程、开口方向等',
                        key_points: ['顶点公式(-b/2a, f(-b/2a))', '判别式Δ=b²-4ac', '图像变换规律'],
                        examples: [
                            { question: '求函数y=2x²-4x+1的顶点坐标和对称轴', answer: '顶点(1, -1)，对称轴x=1' }
                        ]
                    }),
                    created_at: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 3,
                    title: '物理：牛顿运动定律',
                    subject: 'PHY',
                    category_group: '力学',
                    difficulty: 3,
                    content: JSON.stringify({
                        description: '掌握牛顿三定律的内容和应用，包括惯性、加速度、作用力与反作用力',
                        key_points: ['第一定律：惯性定律', '第二定律：F=ma', '第三定律：作用与反作用'],
                        examples: [
                            { question: '质量为2kg的物体受到10N的力，求加速度', answer: 'a = F/m = 10/2 = 5 m/s²' }
                        ]
                    }),
                    created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];
            
            renderKnowledgeList(testData);
            
            // 更新分页信息
            document.getElementById('pageInfo').textContent = '第 1 页 / 共 1 页';
        }

        // ===== 占位功能函数 =====
        function addToFavorites(knowledgeId) {
            if (!currentUser) {
                showNotification('请先登录以收藏内容', 'warning');
                return;
            }
            showNotification('已添加到收藏夹', 'success');
        }

        function shareKnowledge(knowledgeId) {
            const shareUrl = `${window.location.origin}/knowledge/${knowledgeId}`;
            if (navigator.share) {
                navigator.share({
                    title: 'DSEhub知识分享',
                    text: '我发现一个不错的DSE学习资料，分享给你！',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showNotification('链接已复制到剪贴板', 'success');
            }
        }

        function editKnowledge(knowledgeId) {
            if (!currentUser) {
                showNotification('请先登录以编辑内容', 'warning');
                return;
            }
            showNotification('即将打开编辑界面...', 'info');
        }
    </script>
</body>
</html>

