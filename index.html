<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DSE Hub v55</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ================= ğŸ¨ 5-Color System ================= */
        :root {
            --hue: 210; --sat: 100%; --lig: 50%;
            --accent: hsl(var(--hue), var(--sat), var(--lig));
            --accent-soft: hsl(var(--hue), var(--sat), 90%);
            --bg-grad-1: hsla(var(--hue), 80%, 60%, 0.2);
            --bg-grad-2: hsla(calc(var(--hue) + 40), 80%, 60%, 0.2);
            --bg-color: #F5F5F7; --card-bg: rgba(255, 255, 255, 0.75); --sidebar-bg: rgba(255, 255, 255, 0.65);
            --text-main: #1D1D1F; --text-sub: #86868B;
            --radius: 18px; --shadow: 0 10px 40px -10px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --bg-color: #000000; --card-bg: rgba(30, 30, 32, 0.8); --sidebar-bg: rgba(20, 20, 22, 0.7);
            --text-main: #F5F5F7; --text-sub: #98989D;
            --accent-soft: hsla(var(--hue), var(--sat), 20%, 0.5); --shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }
        /* Themes */
        body.theme-purple { --hue: 260; }
        body.theme-green { --hue: 150; --sat: 60%; --lig: 45%; }
        body.theme-orange { --hue: 25; }
        body.theme-graphite { --hue: 200; --sat: 10%; --lig: 40%; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; transition: background 0.5s; }
        
        /* Aurora BG */
        .aurora-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: radial-gradient(at 0% 0%, var(--bg-grad-1) 0px, transparent 50%), radial-gradient(at 100% 100%, var(--bg-grad-2) 0px, transparent 50%); filter: blur(40px); opacity: 0.8; }

        /* Sidebar */
        .sidebar { width: 260px; height: 100%; display: flex; flex-direction: column; background: var(--sidebar-bg); backdrop-filter: blur(30px); border-right: 1px solid rgba(0,0,0,0.05); padding: 25px 16px; z-index: 100; transition: transform 0.3s; }
        .brand { font-size: 22px; font-weight: 800; margin-bottom: 30px; padding-left: 12px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 12px 16px; margin-bottom: 4px; border-radius: 12px; cursor: pointer; font-size: 15px; color: var(--text-sub); display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .nav-item:hover { background: rgba(0,0,0,0.03); color: var(--text-main); }
        .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--bg-grad-1); }
        
        .user-card { margin-top: auto; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 14px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Main */
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 40px 8%; position: relative; scroll-behavior: smooth; }
        .page { display: none; animation: fadeUp 0.4s ease; max-width: 900px; margin: 0 auto; }
        .page.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }

        /* Components */
        .card { background: var(--card-bg); backdrop-filter: blur(25px); border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); border: 1px solid rgba(255,255,255,0.2); margin-bottom: 24px; }
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; background: rgba(0,0,0,0.04); border: 1px solid transparent; font-size: 15px; color: var(--text-main); }
        input:focus, textarea:focus { background: transparent; border-color: var(--accent); }
        button { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; width: 100%; cursor: pointer; }
        button.ghost { background: transparent; color: var(--accent); }
        button.danger { background: #FF3B30; }

        /* List Items */
        .list-item { padding: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .badge { font-size: 11px; padding: 4px 8px; border-radius: 6px; font-weight: 700; margin-right: 8px; }

        /* Mobile */
        .mobile-bar { display: none; padding: 15px; background: var(--sidebar-bg); backdrop-filter: blur(20px); position: fixed; top:0; width:100%; z-index: 200; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.05); }
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); width: 80%; box-shadow: 10px 0 40px rgba(0,0,0,0.2); }
            .sidebar.open { transform: translateX(0); }
            .mobile-bar { display: flex; }
            .main-content { padding: 80px 20px 40px 20px; }
        }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(10px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: all; }
        .modal { width: 90%; max-width: 360px; background: var(--bg-color); padding: 30px; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="theme-blue">
    <div class="aurora-bg"></div>

    <div class="mobile-bar">
        <i class="fas fa-bars" onclick="document.getElementById('sidebar').classList.toggle('open')"></i>
        <div style="font-weight:800;">DSE Hub v55</div>
        <div class="avatar" style="width:28px; height:28px; font-size:12px;" onclick="checkAuth()">?</div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="brand"><i class="fas fa-rocket"></i> DSE HUB</div>
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-book"></i> çŸ¥è¯†åº“</div>
        <div class="nav-item" onclick="nav('chat', this)"><i class="fas fa-comments"></i> ç•™è¨€æ¿</div>
        <div class="nav-item" onclick="nav('submit', this)"><i class="fas fa-pen-nib"></i> æŠ•ç¨¿ä¸­å¿ƒ</div>
        <div class="nav-item" onclick="nav('game', this)"><i class="fas fa-gamepad"></i> è¿è¿çœ‹</div>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="nav('admin', this)" id="btn-admin" style="display:none;"><i class="fas fa-shield-alt"></i> ç®¡ç†åå°</div>
        <div class="nav-item" onclick="nav('settings', this)"><i class="fas fa-cog"></i> è®¾ç½®</div>
        <div class="user-card" onclick="checkAuth()">
            <div class="avatar" id="sb-av">?</div>
            <div style="flex:1; margin-left:10px;"><div style="font-weight:600;" id="sb-nm">æœªç™»å½•</div></div>
        </div>
    </div>

    <div class="main-content" onclick="if(window.innerWidth<768)document.getElementById('sidebar').classList.remove('open')">
        
        <div id="view-home" class="page active">
            <h1>çŸ¥è¯†å®åº“</h1>
            <div class="card" style="display:flex; gap:10px;">
                <input placeholder="æœç´¢..." onkeyup="renderHome()" id="s-kw" style="margin:0;">
                <select id="s-cat" onchange="renderHome()" style="width:auto; margin:0;"><option value="all">å…¨ç§‘</option><option value="chi">ä¸­æ–‡</option><option value="eng">Eng</option></select>
            </div>
            <div id="list-home"></div>
        </div>

        <div id="view-chat" class="page">
            <div style="display:flex; justify-content:space-between;"><h1>ç•™è¨€æ¿</h1><button class="ghost" style="width:auto;" onclick="renderChat()">ğŸ”„</button></div>
            <div class="card" style="height:60vh; overflow-y:auto; display:flex; flex-direction:column-reverse;" id="list-chat"></div>
            <div class="card" style="display:flex; gap:10px;"><input id="chat-in" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."><button onclick="sendChat()" style="width:auto;">ğŸš€</button></div>
        </div>

        <div id="view-submit" class="page">
            <h1>æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="card">
                <select id="sub-type" onchange="toggleSub()">
                    <option value="knowledge">ğŸ“š æŠ•ç¨¿çŸ¥è¯†ç‚¹ (éœ€å®¡æ ¸)</option>
                    <option value="chat">ğŸ’¬ å‘é€ç•™è¨€ (å³æ—¶å‘å¸ƒ)</option>
                </select>
                
                <div id="field-know">
                    <select id="sub-cat"><option value="chi">ä¸­æ–‡</option><option value="eng">Eng</option></select>
                    <input id="sub-t" placeholder="æ ‡é¢˜ (e.g. å€Ÿä»£)">
                    <textarea id="sub-d" rows="4" placeholder="è§£é‡Š..."></textarea>
                    <input id="sub-ex" placeholder="ä¾‹å­ (ç”¨äºæ¸¸æˆ): A // B">
                </div>
                
                <div id="field-chat" style="display:none;">
                    <textarea id="sub-msg" rows="3" placeholder="æƒ³è¯´ä»€ä¹ˆï¼Ÿ"></textarea>
                </div>

                <button onclick="doSubmit()">æäº¤</button>
            </div>
        </div>

        <div id="view-admin" class="page">
            <h1>åå°</h1>
            <div class="card" style="padding:0;">
                <div style="display:flex; border-bottom:1px solid #eee;">
                    <button class="ghost" onclick="renderAdmin('knowledge')">ğŸ“š å¾…å®¡çŸ¥è¯†</button>
                    <button class="ghost" onclick="renderAdmin('chat')">ğŸ’¬ ç•™è¨€/ä¸¾æŠ¥</button>
                </div>
                <div id="admin-list" style="padding:10px;"></div>
            </div>
        </div>

        <div id="view-settings" class="page">
            <h1>è®¾ç½®</h1>
            <div class="card">
                <h3>ä¸»é¢˜è‰²</h3>
                <div style="display:flex; gap:10px;">
                    <div style="width:30px;height:30px;border-radius:50%;background:#007AFF" onclick="setTheme('theme-blue')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#AF52DE" onclick="setTheme('theme-purple')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#34C759" onclick="setTheme('theme-green')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#FF9500" onclick="setTheme('theme-orange')"></div>
                    <div style="width:30px;height:30px;border-radius:50%;background:#444" onclick="setTheme('theme-graphite')"></div>
                </div>
                <br><button class="ghost" onclick="toggleDark()">ğŸŒ— æ·±è‰²æ¨¡å¼</button>
                <br><br><button class="danger" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
        
        <div id="view-game" class="page"><h1>æ¸¸æˆ</h1><div class="card">éœ€æ›´å¤šçŸ¥è¯†ç‚¹æ•°æ®æ¿€æ´»æ¸¸æˆã€‚</div></div>
    </div>

    <div class="modal-overlay" id="auth-modal">
        <div class="modal">
            <h2>æ¬¢è¿</h2>
            <input id="au-u" placeholder="ç”¨æˆ·å">
            <input id="au-p" type="password" placeholder="å¯†ç  (admin)">
            <button onclick="login()">ç™»å½•</button>
            <button class="ghost" onclick="document.getElementById('auth-modal').classList.remove('show')">æš‚ä¸ç™»å½•</button>
        </div>
    </div>

    <script>
        // ============================================
        // âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ URL å’Œ Key
        // ============================================
        const CONFIG = {
            URL: "https://alsalyskulozwakhmzoa.supabase.co", 
            KEY: "sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr" 
        };
        // ============================================

        let db = null;
        let currentUser = null;
        let localData = [
            {id:1, type:'knowledge', status:'approved', cat:'chi', t:'æ˜å–»', d:'æœ¬ä½“å–»ä½“éƒ½å‡ºç°', ex:'è„¸åƒçº¢è‹¹æœ'},
            {id:2, type:'chat', status:'approved', author:'System', d:'æ¬¢è¿æ¥åˆ° v55', time:'12:00'}
        ];

        // Init
        window.onload = async () => {
            // 1. åˆå§‹åŒ– Supabase
            if(CONFIG.URL.includes('https://') && CONFIG.KEY.length > 20) {
                db = supabase.createClient(CONFIG.URL, CONFIG.KEY);
                await loadRemoteData();
            } else {
                console.log('âš ï¸ ä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ•°æ® (æœªå¡« Key)');
            }

            // 2. æ¢å¤ Session (ä½¿ç”¨ sessionStorage é˜²æ­¢è·¨æ ‡ç­¾é¡µè‡ªåŠ¨ç™»å…¥)
            const savedUser = sessionStorage.getItem('dse-user');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserUI();
            } else {
                checkAuth(true);
            }

            const th = localStorage.getItem('dse-theme');
            if(th) document.body.className = th;
            renderHome(); renderChat();
        };

        async function loadRemoteData() {
            // è¿™é‡Œè¿æ¥çœŸå®æ•°æ®åº“é€»è¾‘ï¼Œç®€åŒ–èµ·è§å…ˆè·³è¿‡å…·ä½“ fetch
            // const { data } = await db.from('items').select('*');
            // if(data) localData = data;
        }

        // ================= Auth (Session Storage) =================
        function checkAuth(silent=false) {
            if(currentUser) return;
            if(!silent) document.getElementById('auth-modal').classList.add('show');
        }
        function login() {
            const u = document.getElementById('au-u').value;
            const p = document.getElementById('au-p').value;
            if(!u) return alert('è¯·è¾“å…¥ç”¨æˆ·å');
            
            currentUser = { name: u, isAdmin: (p === 'admin') };
            sessionStorage.setItem('dse-user', JSON.stringify(currentUser)); // ğŸ‘ˆ å…³é”®ï¼šä»…å½“å‰ä¼šè¯æœ‰æ•ˆ
            
            updateUserUI();
            document.getElementById('auth-modal').classList.remove('show');
        }
        function logout() {
            sessionStorage.removeItem('dse-user');
            location.reload();
        }
        function updateUserUI() {
            document.getElementById('sb-nm').innerText = currentUser.name;
            document.getElementById('sb-av').innerText = currentUser.name[0].toUpperCase();
            if(currentUser.isAdmin) document.getElementById('btn-admin').style.display = 'flex';
        }

        // ================= Navigation =================
        function nav(id, el) {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById('view-'+id).classList.add('active');
            if(el) {
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                el.classList.add('active');
            }
            if(window.innerWidth<768) document.getElementById('sidebar').classList.remove('open');
            if(id==='admin') renderAdmin('knowledge');
        }
        function setTheme(c) { document.body.className=c; localStorage.setItem('dse-theme',c); }
        function toggleDark() { 
            const d = document.documentElement; 
            d.setAttribute('data-theme', d.getAttribute('data-theme')==='dark'?'light':'dark'); 
        }

        // ================= Logic: Home & Chat =================
        function renderHome() {
            const k = document.getElementById('s-kw').value.toLowerCase();
            const c = document.getElementById('s-cat').value;
            const list = localData.filter(i => i.type==='knowledge' && i.status==='approved' && (c==='all'||i.cat===c) && (i.t.includes(k)||i.d.includes(k)));
            document.getElementById('list-home').innerHTML = list.map(i=>`
                <div class="card" style="padding:15px;margin-bottom:15px;">
                    <div style="color:var(--accent);font-weight:700;">[${i.cat.toUpperCase()}] ${i.t}</div>
                    <div style="margin-top:5px;">${i.d}</div>
                </div>`).join('') || '<div style="text-align:center;color:#999">æ— å†…å®¹</div>';
        }

        function renderChat() {
            const list = localData.filter(i => i.type==='chat' && i.status==='approved');
            document.getElementById('list-chat').innerHTML = list.map(i=>`
                <div style="padding:10px;background:rgba(0,0,0,0.03);border-radius:12px;margin-bottom:10px;">
                    <div style="display:flex;justify-content:space-between;font-size:12px;color:#888">
                        <b>${i.author}</b> <span onclick="report(${i.id})">âš ï¸ ä¸¾æŠ¥</span>
                    </div>
                    <div style="margin-top:4px;">${i.d}</div>
                </div>`).join('');
        }
        function sendChat() {
            if(!currentUser) return checkAuth();
            const t = document.getElementById('chat-in').value;
            if(!t) return;
            localData.push({id:Date.now(), type:'chat', author:currentUser.name, status:'approved', d:t});
            document.getElementById('chat-in').value='';
            renderChat();
        }
        function report(id) {
            if(!currentUser) return checkAuth();
            if(confirm('ä¸¾æŠ¥æ­¤æ¡æ¶ˆæ¯ï¼Ÿ')) {
                const it = localData.find(i=>i.id==id);
                if(it) { it.status='reported'; renderChat(); alert('å·²ä¸¾æŠ¥ï¼Œè¿›å…¥å®¡æ ¸'); }
            }
        }

        // ================= Logic: Submit =================
        function toggleSub() {
            const t = document.getElementById('sub-type').value;
            // éšè—é€»è¾‘ï¼šChat ä¸éœ€è¦æ ‡é¢˜å’Œä¾‹å­
            document.getElementById('field-know').style.display = t==='knowledge'?'block':'none';
            document.getElementById('field-chat').style.display = t==='chat'?'block':'none';
        }
        function doSubmit() {
            if(!currentUser) return checkAuth();
            const type = document.getElementById('sub-type').value;
            
            if(type === 'knowledge') {
                localData.push({
                    id:Date.now(), type:'knowledge', author:currentUser.name, status:'pending',
                    cat:document.getElementById('sub-cat').value,
                    t:document.getElementById('sub-t').value,
                    d:document.getElementById('sub-d').value,
                    ex:document.getElementById('sub-ex').value
                });
                alert('âœ… çŸ¥è¯†ç‚¹å·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸');
            } else {
                localData.push({
                    id:Date.now(), type:'chat', author:currentUser.name, status:'approved',
                    d:document.getElementById('sub-msg').value
                });
                alert('âœ… ç•™è¨€å·²å‘å¸ƒ');
            }
            nav(type==='knowledge'?'home':'chat');
        }

        // ================= Logic: Admin =================
        let admTab = 'knowledge';
        function renderAdmin(tab) {
            if(!currentUser?.isAdmin) return;
            admTab = tab;
            let list = [];
            if(tab==='knowledge') list = localData.filter(i=>i.type==='knowledge' && i.status==='pending');
            else list = localData.filter(i=>i.type==='chat' && i.status!=='deleted').sort((a,b)=>(a.status==='reported'?-1:1));
            
            document.getElementById('admin-list').innerHTML = list.map(i=>`
                <div class="list-item" style="${i.status==='reported'?'background:rgba(255,59,48,0.1);border:1px solid red':''}">
                    <div>
                        ${i.status==='reported'?'<b style="color:red">å·²ä¸¾æŠ¥:</b> ':''}
                        <b>${i.t||'ç•™è¨€'}</b> <span style="font-size:12px">${i.d.substr(0,15)}...</span>
                    </div>
                    <div>
                        ${(tab==='knowledge'||i.status==='reported')?`<button class="ghost" style="width:auto" onclick="audit(${i.id},'approved')">âœ”</button>`:''}
                        <button class="ghost" style="color:red;width:auto" onclick="audit(${i.id},'deleted')">âœ˜</button>
                    </div>
                </div>`).join('') || '<div style="padding:20px;text-align:center">æ— å¾…åŠ</div>';
        }
        function audit(id, s) {
            const it = localData.find(i=>i.id==id);
            if(it) it.status = s;
            renderAdmin(admTab);
        }
    </script>
</body>
</html>
