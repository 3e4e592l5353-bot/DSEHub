<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¯†å¯¹æˆ˜å¹³å° - ä¸‰åˆä¸€æ¸¸æˆ</title>
    
    <!-- Supabaseå®¢æˆ·ç«¯åº“ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        /* ğŸ¨ ä½¿ç”¨å®Œæ•´çš„è®¾è®¡ç³»ç»Ÿ */
        :root {
            /* è“ç´«ä¸»é¢˜ (é»˜è®¤) */
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --accent-color: #5a67d8;
            --accent-light: rgba(90, 103, 216, 0.1);
            --accent-dark: #4c51bf;
            --text-color: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --card-bg: rgba(255, 255, 255, 0.98);
            --border-color: rgba(102, 126, 234, 0.15);
            --hover-color: rgba(102, 126, 234, 0.06);
            
            /* ğŸ“ é—´è·ç³»ç»Ÿ */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            
            /* ğŸ”² åœ†è§’ç³»ç»Ÿ */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            
            /* ğŸŒˆ é˜´å½±ç³»ç»Ÿ */
            --shadow-sm: 0 2px 8px rgba(102, 126, 234, 0.08);
            --shadow-md: 0 4px 16px rgba(102, 126, 234, 0.12);
            --shadow-lg: 0 8px 32px rgba(102, 126, 234, 0.16);
            --shadow-xl: 0 12px 48px rgba(102, 126, 234, 0.2);
            
            /* âš¡ åŠ¨ç”»ç³»ç»Ÿ */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            /* ğŸ§­ å¸ƒå±€ç³»ç»Ÿ */
            --container-width: 1200px;
            --side-nav-width: 280px;
        }
        
        /* ğŸ¨ ç»¿é’ä¸»é¢˜ */
        .theme-green-teal {
            --primary-start: #48bb78;
            --primary-end: #319795;
            --accent-color: #38a169;
            --accent-light: rgba(56, 161, 105, 0.1);
            --accent-dark: #2f855a;
            --border-color: rgba(72, 187, 120, 0.15);
            --hover-color: rgba(72, 187, 120, 0.06);
        }
        
        /* ğŸ¨ æ©™çº¢ä¸»é¢˜ */
        .theme-orange-red {
            --primary-start: #ff8c00;
            --primary-end: #ff4500;
            --accent-color: #ff4500;
            --accent-light: rgba(255, 69, 0, 0.1);
            --accent-dark: #e03e00;
            --border-color: rgba(255, 140, 0, 0.15);
            --hover-color: rgba(255, 140, 0, 0.06);
        }
        
        /* ğŸ¨ æ·±è‰²ä¸»é¢˜ */
        .theme-dark {
            --primary-start: #4a5568;
            --primary-end: #2d3748;
            --accent-color: #4299e1;
            --accent-light: rgba(66, 153, 225, 0.15);
            --accent-dark: #3182ce;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #4a5568;
            --hover-color: rgba(66, 153, 225, 0.1);
        }
        
        .dark-mode {
            background: #1a202c !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            line-height: 1.6;
            transition: all var(--transition-normal);
        }
        
        /* ğŸ§­ ä¸»å®¹å™¨ */
        .container {
            max-width: var(--container-width);
            margin: 0 auto;
            padding: var(--spacing-xl);
        }
        
        /* ğŸ¯ å¤´éƒ¨åŒºåŸŸ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg) var(--spacing-xl);
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }
        
        .logo {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .score-display {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-color);
            background: var(--accent-light);
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
        }
        
        /* ğŸ“± ä¸»è¦å†…å®¹åŒºåŸŸ */
        .content-area {
            display: flex;
            gap: var(--spacing-xl);
            min-height: 600px;
            align-items: flex-start;
        }
        
        /* ğŸ® æ¸¸æˆç±»å‹é€‰æ‹©ä¾§è¾¹æ  */
        .side-nav {
            width: var(--side-nav-width);
            position: sticky;
            top: var(--spacing-xl);
            align-self: flex-start;
            flex-shrink: 0;
        }
        
        .game-nav {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        
        .game-nav-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            color: var(--text-color);
            padding-bottom: var(--spacing-sm);
            border-bottom: 2px solid var(--border-color);
        }
        
        .game-nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            margin: var(--spacing-sm) 0;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 2px solid transparent;
        }
        
        .game-nav-item:hover {
            background: var(--hover-color);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
            border-color: var(--border-color);
        }
        
        .game-nav-item.active {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            border-color: var(--accent-color);
            box-shadow: var(--shadow-md);
        }
        
        .game-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* âš”ï¸ è”æœºå¯¹æˆ˜é¢æ¿ */
        .duel-panel {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--accent-light);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
        }
        
        .duel-panel h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            color: var(--text-color);
        }
        
        .room-input-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .room-input-group input {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        .game-mode-selector {
            margin: var(--spacing-md) 0;
        }
        
        .mode-options {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .mode-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .mode-option:hover {
            background: var(--hover-color);
            border-color: var(--accent-color);
        }
        
        .mode-option.selected {
            background: var(--accent-light);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        
        /* ğŸ² æ¸¸æˆä¸»åŒºåŸŸ */
        .game-main {
            flex: 1;
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            min-height: 600px;
        }
        
        .game-header {
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 2px solid var(--border-color);
        }
        
        .game-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--text-color);
        }
        
        .game-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* ğŸ”— è¿è¿çœ‹æ¸¸æˆåŒºåŸŸ */
        .linkup-container {
            display: none;
        }
        
        .linkup-container.active {
            display: block;
        }
        
        .linkup-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--spacing-lg);
            margin: var(--spacing-xl) 0;
            justify-items: center;
        }
        
        .linkup-card {
            width: 100%;
            min-height: 140px;
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .linkup-card.knowledge {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08), rgba(118, 75, 162, 0.08));
            border-color: rgba(102, 126, 234, 0.25);
        }
        
        .linkup-card.question {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.08), rgba(49, 151, 149, 0.08));
            border-color: rgba(72, 187, 120, 0.25);
        }
        
        .linkup-card:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-lg);
        }
        
        .linkup-card.selected {
            transform: translateY(-4px);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-light), var(--shadow-lg);
        }
        
        .linkup-card.matched {
            opacity: 0.4;
            pointer-events: none;
            transform: scale(0.95);
        }
        
        .card-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }
        
        .card-content {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
            line-height: 1.4;
        }
        
        /* âœ… å¯¹é”™åˆ¤æ–­æ¸¸æˆåŒºåŸŸ */
        .truefalse-container {
            display: none;
        }
        
        .truefalse-container.active {
            display: block;
        }
        
        .question-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            margin: var(--spacing-xl) 0;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        
        .question-text {
            font-size: 18px;
            margin-bottom: var(--spacing-xl);
            line-height: 1.7;
            color: var(--text-color);
        }
        
        .answer-options {
            display: flex;
            gap: var(--spacing-lg);
            justify-content: center;
            margin-top: var(--spacing-xl);
        }
        
        /* â“ çŒœçŸ¥è¯†ç‚¹æ¸¸æˆåŒºåŸŸ */
        .guess-container {
            display: none;
        }
        
        .guess-container.active {
            display: block;
        }
        
        .clue-card {
            background: linear-gradient(135deg, var(--accent-light), transparent);
            border-left: 4px solid var(--accent-color);
            padding: var(--spacing-xl);
            margin: var(--spacing-xl) 0;
            border-radius: var(--border-radius-md);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-lg);
            margin: var(--spacing-xl) 0;
        }
        
        .option-card {
            padding: var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: center;
            font-size: 15px;
            background: var(--card-bg);
            color: var(--text-color);
        }
        
        .option-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
            box-shadow: var(--shadow-sm);
        }
        
        /* ğŸ¯ æŒ‰é’®ç³»ç»Ÿ */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            min-height: 44px;
            font-size: 14px;
            border-radius: var(--border-radius-lg);
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--hover-color);
            border-color: var(--accent-color);
        }
        
        /* ğŸ“Š æ¸¸æˆæ§åˆ¶åŒºåŸŸ */
        .game-controls {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }
        
        .result-message {
            text-align: center;
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            border-radius: var(--border-radius-lg);
            font-size: 16px;
            font-weight: 600;
        }
        
        .success {
            background: rgba(72, 187, 120, 0.1);
            color: #38a169;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        
        .error {
            background: rgba(245, 101, 101, 0.1);
            color: #e53e3e;
            border: 1px solid rgba(245, 101, 101, 0.3);
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .error-message {
            color: #e53e3e;
            background: rgba(245, 101, 101, 0.1);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(245, 101, 101, 0.3);
            text-align: center;
            margin: var(--spacing-md) 0;
        }
        
        /* ğŸ“± å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .content-area {
                flex-direction: column;
            }
            
            .side-nav {
                width: 100%;
                position: static;
            }
            
            .linkup-board {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-lg);
            }
            
            .linkup-board {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
            
            .answer-options {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                gap: var(--spacing-md);
                text-align: center;
            }
            
            .user-info {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .linkup-board {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .logo {
                font-size: 24px;
            }
            
            .game-main {
                padding: var(--spacing-lg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <div class="header">
            <div class="logo">ğŸ§  çŸ¥è¯†å¯¹æˆ˜å¹³å°</div>
            <div class="user-info">
                <div class="score-display">
                    å¾—åˆ†: <span id="global-score">0</span>
                </div>
                <button class="btn btn-secondary" onclick="showThemeSelector()">
                    ğŸ¨ ä¸»é¢˜
                </button>
            </div>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <!-- å·¦ä¾§æ¸¸æˆå¯¼èˆª -->
            <div class="side-nav">
                <div class="game-nav">
                    <div class="game-nav-header">ğŸ® æ¸¸æˆç±»å‹</div>
                    
                    <div class="game-nav-item active" onclick="switchGame('linkup')">
                        <div class="game-icon">ğŸ”—</div>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">è¿è¿çœ‹</div>
                            <div style="font-size: 12px; color: inherit; opacity: 0.8;">åŒ¹é…çŸ¥è¯†ç‚¹ä¸é¢˜ç›®</div>
                        </div>
                    </div>
                    
                    <div class="game-nav-item" onclick="switchGame('truefalse')">
                        <div class="game-icon">âœ…</div>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">å¯¹é”™åˆ¤æ–­</div>
                            <div style="font-size: 12px; color: inherit; opacity: 0.8;">åˆ¤æ–­é¢˜ç›®æ­£è¯¯</div>
                        </div>
                    </div>
                    
                    <div class="game-nav-item" onclick="switchGame('guess')">
                        <div class="game-icon">â“</div>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">çŒœçŸ¥è¯†ç‚¹</div>
                            <div style="font-size: 12px; color: inherit; opacity: 0.8;">æ ¹æ®çº¿ç´¢çŒœçŸ¥è¯†ç‚¹</div>
                        </div>
                    </div>
                    
                    <!-- âš”ï¸ è”æœºå¯¹æˆ˜é¢æ¿ -->
                    <div class="duel-panel">
                        <h3>âš”ï¸ è”æœºå¯¹æˆ˜</h3>
                        
                        <div class="game-mode-selector">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: var(--spacing-xs);">
                                é€‰æ‹©å¯¹æˆ˜æ¨¡å¼ï¼š
                            </div>
                            <div class="mode-options">
                                <label class="mode-option selected" data-mode="linkup" onclick="selectDuelMode('linkup', this)">
                                    <input type="radio" name="duelMode" value="linkup" style="margin-right: 8px;" checked>
                                    <span>ğŸ”— è¿è¿çœ‹</span>
                                </label>
                                <label class="mode-option" data-mode="truefalse" onclick="selectDuelMode('truefalse', this)">
                                    <input type="radio" name="duelMode" value="truefalse" style="margin-right: 8px;">
                                    <span>âœ… å¯¹é”™åˆ¤æ–­</span>
                                </label>
                                <label class="mode-option" data-mode="guess" onclick="selectDuelMode('guess', this)">
                                    <input type="radio" name="duelMode" value="guess" style="margin-right: 8px;">
                                    <span>â“ çŒœçŸ¥è¯†ç‚¹</span>
                                </label>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="createDuelRoom()" style="width: 100%; margin-top: var(--spacing-md);">
                            ğŸ  åˆ›å»ºæˆ¿é—´
                        </button>
                        
                        <div class="room-input-group">
                            <input type="text" id="roomIdInput" placeholder="è¾“å…¥æˆ¿é—´ID" 
                                   style="flex: 1; padding: var(--spacing-sm); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background: var(--card-bg); color: var(--text-color);">
                            <button class="btn btn-secondary" onclick="joinDuelRoom()">
                                åŠ å…¥
                            </button>
                        </div>
                        
                        <div id="duel-status" style="margin-top: var(--spacing-md); font-size: 12px; color: var(--text-muted); text-align: center;">
                            é€‰æ‹©æ¨¡å¼ååˆ›å»ºæˆ¿é—´
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§æ¸¸æˆä¸»åŒºåŸŸ -->
            <div class="game-main">
                <!-- è¿è¿çœ‹æ¸¸æˆ -->
                <div id="linkup-game" class="linkup-container active">
                    <div class="game-header">
                        <h2>ğŸ”— çŸ¥è¯†ç‚¹è¿è¿çœ‹</h2>
                        <p class="game-description">ç‚¹å‡»åŒ¹é…å¯¹åº”çš„çŸ¥è¯†ç‚¹å’Œé¢˜ç›®ï¼Œæ¯ä¸ªçŸ¥è¯†ç‚¹å¯èƒ½å¯¹åº”å¤šä¸ªé¢˜ç›®ã€‚åŒ¹é…æˆåŠŸè·å¾—10åˆ†ã€‚</p>
                    </div>
                    
                    <div id="linkup-board" class="linkup-board">
                        <!-- å¡ç‰‡é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div class="game-controls">
                        <button class="btn btn-secondary" onclick="restartLinkUp()">
                            ğŸ”„ é‡æ–°å¼€å§‹
                        </button>
                        <button class="btn btn-primary" onclick="loadMoreLinkUpCards()">
                            â• åŠ è½½æ›´å¤šå¡ç‰‡
                        </button>
                    </div>
                    
                    <div id="linkup-result" class="result-message" style="display: none;"></div>
                </div>
                
                <!-- å¯¹é”™åˆ¤æ–­æ¸¸æˆ -->
                <div id="truefalse-game" class="truefalse-container">
                    <div class="game-header">
                        <h2>âœ… å¯¹é”™åˆ¤æ–­</h2>
                        <p class="game-description">åˆ¤æ–­ä»¥ä¸‹é¢˜ç›®é™ˆè¿°çš„æ­£ç¡®æ€§ã€‚ç­”å¯¹è·å¾—5åˆ†ã€‚</p>
                    </div>
                    
                    <div class="question-card">
                        <div id="tf-question-text" class="question-text">
                            é¢˜ç›®åŠ è½½ä¸­...
                        </div>
                        
                        <div class="answer-options">
                            <button class="btn btn-success" onclick="answerTrueFalse(true)">
                                âœ… æ­£ç¡®
                            </button>
                            <button class="btn btn-danger" onclick="answerTrueFalse(false)">
                                âŒ é”™è¯¯
                            </button>
                        </div>
                    </div>
                    
                    <div id="tf-result" class="result-message" style="display: none;"></div>
                    
                    <div class="game-controls">
                        <button class="btn btn-secondary" onclick="nextTrueFalse()">
                            â­ï¸ ä¸‹ä¸€é¢˜
                        </button>
                        <button class="btn btn-primary" onclick="showExplanation()">
                            ğŸ“– æŸ¥çœ‹è§£æ
                        </button>
                    </div>
                </div>
                
                <!-- çŒœçŸ¥è¯†ç‚¹æ¸¸æˆ -->
                <div id="guess-game" class="guess-container">
                    <div class="game-header">
                        <h2>â“ çŒœçŸ¥è¯†ç‚¹</h2>
                        <p class="game-description">æ ¹æ®é¢˜ç›®çº¿ç´¢é€‰æ‹©æ­£ç¡®çš„çŸ¥è¯†ç‚¹ã€‚ç­”å¯¹è·å¾—10åˆ†ã€‚</p>
                    </div>
                    
                    <div class="clue-card">
                        <div id="guess-clue-text" class="question-text">
                            çº¿ç´¢åŠ è½½ä¸­...
                        </div>
                    </div>
                    
                    <div id="guess-options" class="options-grid">
                        <!-- é€‰é¡¹é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    
                    <div id="guess-result" class="result-message" style="display: none;"></div>
                    
                    <div class="game-controls">
                        <button class="btn btn-secondary" onclick="nextGuess()">
                            â­ï¸ ä¸‹ä¸€é¢˜
                        </button>
                        <button class="btn btn-primary" onclick="skipGuess()">
                            â­ï¸ è·³è¿‡æ­¤é¢˜
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»é¢˜é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="themeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--card-bg); padding: var(--spacing-xl); border-radius: var(--border-radius-xl); max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: var(--spacing-lg);">ğŸ¨ é€‰æ‹©ä¸»é¢˜</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
                <button class="btn btn-secondary" onclick="changeTheme('blue-purple')" style="justify-content: flex-start;">
                    <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 4px; margin-right: 8px;"></div>
                    è“ç´«ä¸»é¢˜
                </button>
                <button class="btn btn-secondary" onclick="changeTheme('green-teal')" style="justify-content: flex-start;">
                    <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #48bb78, #319795); border-radius: 4px; margin-right: 8px;"></div>
                    ç»¿é’ä¸»é¢˜
                </button>
                <button class="btn btn-secondary" onclick="changeTheme('orange-red')" style="justify-content: flex-start;">
                    <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #ff8c00, #ff4500); border-radius: 4px; margin-right: 8px;"></div>
                    æ©™çº¢ä¸»é¢˜
                </button>
                <button class="btn btn-secondary" onclick="changeTheme('dark')" style="justify-content: flex-start;">
                    <div style="width: 20px; height: 20px; background: linear-gradient(135deg, #4a5568, #2d3748); border-radius: 4px; margin-right: 8px;"></div>
                    æ·±è‰²ä¸»é¢˜
                </button>
            </div>
            <div style="margin-top: var(--spacing-lg); text-align: right;">
                <button class="btn btn-secondary" onclick="closeThemeModal()">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        // ğŸ”§ å…¨å±€é…ç½®
        let supabaseClient = null;
        let currentGame = 'linkup';
        let globalScore = 0;
        let selectedDuelMode = 'linkup';
        
        // ğŸ® æ¸¸æˆçŠ¶æ€
        let linkupState = {
            pairs: [],
            selectedCards: [],
            matchedPairs: 0
        };
        
        // ğŸ¨ ä¸»é¢˜ç®¡ç†å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰
        const ThemeManager = {
            themes: {
                'blue-purple': 'theme-blue-purple',
                'green-teal': 'theme-green-teal',
                'orange-red': 'theme-orange-red',
                'dark': 'theme-dark'
            },
            
            init() {
                // ä»localStorageåŠ è½½ä¿å­˜çš„ä¸»é¢˜
                const savedTheme = localStorage.getItem('game-theme') || 'blue-purple';
                this.applyTheme(savedTheme);
            },
            
            applyTheme(themeName) {
                // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
                Object.values(this.themes).forEach(themeClass => {
                    document.body.classList.remove(themeClass);
                });
                
                // åº”ç”¨æ–°ä¸»é¢˜
                const themeClass = this.themes[themeName] || this.themes['blue-purple'];
                document.body.classList.add(themeClass);
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('game-theme', themeName);
            }
        };
        
        // ğŸ“¦ åˆå§‹åŒ–å‡½æ•°
        async function initApp() {
            // åˆå§‹åŒ–ä¸»é¢˜
            ThemeManager.init();
            
            // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
            supabaseClient = supabase.createClient(
                'https://alsalyskulozwakhmzoa.supabase.co',
                'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr'
            );
            
            // æµ‹è¯•æ•°æ®åº“è¿æ¥
            await testDatabaseConnection();
            
            // åˆå§‹åŒ–æ¸¸æˆ
            await initLinkUpGame();
            
            // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
            updateScoreDisplay();
            
            // è®¾ç½®é»˜è®¤è”æœºæ¨¡å¼
            setDefaultDuelMode();
            
            console.log('æ¸¸æˆå¹³å°åˆå§‹åŒ–å®Œæˆ');
        }
        
        // ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testDatabaseConnection() {
            try {
                // å°è¯•ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢æ¥æµ‹è¯•è¿æ¥
                const { error } = await supabaseClient
                    .from('questions')
                    .select('count')
                    .limit(1);
                
                if (error && error.code === '42501') {
                    showPermissionError();
                    return false;
                }
                
                return true;
            } catch (error) {
                console.warn('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                showPermissionError();
                return false;
            }
        }
        
        // âš ï¸ æ˜¾ç¤ºæƒé™é”™è¯¯
        function showPermissionError() {
            const board = document.getElementById('linkup-board');
            if (board) {
                board.innerHTML = `
                    <div class="error-message" style="grid-column: 1/-1;">
                        <h4>âš ï¸ æ•°æ®åº“æƒé™ä¸è¶³</h4>
                        <p style="font-size: 14px; margin: var(--spacing-sm) 0;">
                            è¯·åœ¨ä½ çš„Supabaseé¡¹ç›®ä¸­è¿è¡Œä»¥ä¸‹SQLï¼š
                        </p>
                        <pre style="background: var(--accent-light); padding: var(--spacing-sm); border-radius: var(--border-radius-sm); font-size: 12px; text-align: left; margin: var(--spacing-sm) 0;">
ALTER TABLE knowledge_points ENABLE ROW LEVEL SECURITY;
CREATE POLICY "å…è®¸åŒ¿åè®¿é—®" ON knowledge_points FOR SELECT USING (true);

ALTER TABLE questions ENABLE ROW LEVEL SECURITY;
CREATE POLICY "å…è®¸åŒ¿åè®¿é—®" ON questions FOR SELECT USING (true);
                        </pre>
                        <p style="font-size: 14px; margin-top: var(--spacing-sm);">
                            æˆ–ä½¿ç”¨æµ‹è¯•æ•°æ®è¿›è¡Œæ¸¸æˆï¼š
                        </p>
                        <button class="btn btn-secondary" onclick="useDemoData()" style="margin-top: var(--spacing-sm);">
                            ä½¿ç”¨æ¼”ç¤ºæ•°æ®
                        </button>
                    </div>
                `;
            }
        }
        
        // ğŸ® ä½¿ç”¨æ¼”ç¤ºæ•°æ®
        function useDemoData() {
            // åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼
            window.demoMode = true;
            
            // é‡æ–°åˆå§‹åŒ–æ¸¸æˆ
            if (currentGame === 'linkup') {
                initLinkUpGame();
            } else if (currentGame === 'truefalse') {
                loadTrueFalseQuestion();
            } else if (currentGame === 'guess') {
                loadGuessQuestion();
            }
            
            // æ›´æ–°çŠ¶æ€
            updateDuelStatus('æ¼”ç¤ºæ¨¡å¼å·²å¯ç”¨');
        }
        
        // ğŸ”„ åˆ‡æ¢æ¸¸æˆ
        function switchGame(gameType) {
            if (currentGame === gameType) return;
            
            // æ›´æ–°å¯¼èˆªé¡¹çŠ¶æ€
            document.querySelectorAll('.game-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // éšè—æ‰€æœ‰æ¸¸æˆå®¹å™¨
            document.querySelectorAll('.linkup-container, .truefalse-container, .guess-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç›®æ ‡æ¸¸æˆ
            document.getElementById(`${gameType}-game`).classList.add('active');
            
            // æ›´æ–°å½“å‰æ¸¸æˆçŠ¶æ€
            currentGame = gameType;
            
            // åˆå§‹åŒ–å¯¹åº”æ¸¸æˆ
            if (gameType === 'linkup') {
                initLinkUpGame();
            } else if (gameType === 'truefalse') {
                loadTrueFalseQuestion();
            } else if (gameType === 'guess') {
                loadGuessQuestion();
            }
        }
        
        // ğŸ”— è¿è¿çœ‹æ¸¸æˆå‡½æ•°
        async function initLinkUpGame() {
            const board = document.getElementById('linkup-board');
            if (!board) return;
            
            board.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            linkupState.selectedCards = [];
            linkupState.matchedPairs = 0;
            
            // æ¸…ç©ºç»“æœæ¶ˆæ¯
            const resultMsg = document.getElementById('linkup-result');
            if (resultMsg) {
                resultMsg.style.display = 'none';
                resultMsg.textContent = '';
            }
            
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ¼”ç¤ºæ•°æ®
            if (window.demoMode) {
                useDemoLinkUpData();
                return;
            }
            
            try {
                // ä»æ•°æ®åº“è·å–çŸ¥è¯†ç‚¹
                const { data: knowledgePoints, error: kpError } = await supabaseClient
                    .from('knowledge_points')
                    .select('id, title')
                    .limit(6);
                
                if (kpError) {
                    console.warn('è·å–çŸ¥è¯†ç‚¹å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®:', kpError);
                    useDemoLinkUpData();
                    return;
                }
                
                if (!knowledgePoints || knowledgePoints.length === 0) {
                    useDemoLinkUpData();
                    return;
                }
                
                linkupState.pairs = [];
                
                // ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹è·å–ç›¸å…³é¢˜ç›®
                for (const kp of knowledgePoints) {
                    const { data: questions, error: qError } = await supabaseClient
                        .from('questions')
                        .select('id, title')
                        .eq('knowledge_id', kp.id)
                        .eq('game_type', 'linkup')
                        .limit(2);
                    
                    if (qError) {
                        console.warn(`æœªæ‰¾åˆ°çŸ¥è¯†ç‚¹ ${kp.title} çš„é¢˜ç›®:`, qError);
                        continue;
                    }
                    
                    if (questions && questions.length > 0) {
                        // æ·»åŠ çŸ¥è¯†ç‚¹å¤´å¡ç‰‡
                        linkupState.pairs.push({
                            id: `k-${kp.id}`,
                            type: 'knowledge',
                            text: kp.title,
                            pairId: kp.id
                        });
                        
                        // æ·»åŠ é¢˜ç›®å¡ç‰‡
                        questions.forEach((q) => {
                            linkupState.pairs.push({
                                id: `q-${q.id}`,
                                type: 'question',
                                text: q.title.length > 40 ? q.title.substring(0, 40) + '...' : q.title,
                                pairId: kp.id
                            });
                        });
                    }
                }
                
                // å¦‚æœæ²¡æœ‰è·å–åˆ°è¶³å¤Ÿçš„æ•°æ®ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®
                if (linkupState.pairs.length === 0) {
                    useDemoLinkUpData();
                    return;
                }
                
                generateLinkUpBoard();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–è¿è¿çœ‹æ¸¸æˆå¤±è´¥:', error);
                useDemoLinkUpData();
            }
        }
        
        // ğŸ® ä½¿ç”¨æ¼”ç¤ºè¿è¿çœ‹æ•°æ®
        function useDemoLinkUpData() {
            const demoData = {
                knowledgePoints: [
                    { id: 1, title: 'ç‰›é¡¿ç¬¬ä¸€å®šå¾‹' },
                    { id: 2, title: 'å‹¾è‚¡å®šç†' },
                    { id: 3, title: 'åŒ–å­¦æ–¹ç¨‹å¼' },
                    { id: 4, title: 'ç»†èƒç»“æ„' }
                ],
                questions: [
                    { id: 1, knowledge_id: 1, title: 'ç‰©ä½“åœ¨æ²¡æœ‰å¤–åŠ›ä½œç”¨æ—¶ä¼šæ€æ ·è¿åŠ¨ï¼Ÿ' },
                    { id: 2, knowledge_id: 1, title: 'ä»€ä¹ˆæ˜¯æƒ¯æ€§å®šå¾‹ï¼Ÿ' },
                    { id: 3, knowledge_id: 2, title: 'ç›´è§’ä¸‰è§’å½¢çš„è¾¹é•¿å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ' },
                    { id: 4, knowledge_id: 2, title: 'aÂ² + bÂ² = cÂ² æ˜¯ä»€ä¹ˆå®šç†ï¼Ÿ' },
                    { id: 5, knowledge_id: 3, title: 'Hâ‚‚O æ˜¯ä»€ä¹ˆåŒ–å­¦å¼ï¼Ÿ' },
                    { id: 6, knowledge_id: 3, title: 'é…¸ç¢±ä¸­å’Œååº”ä¼šäº§ç”Ÿä»€ä¹ˆï¼Ÿ' },
                    { id: 7, knowledge_id: 4, title: 'ç»†èƒçš„èƒ½é‡å·¥å‚æ˜¯ä»€ä¹ˆï¼Ÿ' },
                    { id: 8, knowledge_id: 4, title: 'ç»†èƒæ ¸çš„ä¸»è¦åŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ' }
                ]
            };
            
            linkupState.pairs = [];
            
            // ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹æ·»åŠ å¡ç‰‡
            demoData.knowledgePoints.forEach(kp => {
                // æ·»åŠ çŸ¥è¯†ç‚¹å¤´å¡ç‰‡
                linkupState.pairs.push({
                    id: `k-${kp.id}`,
                    type: 'knowledge',
                    text: kp.title,
                    pairId: kp.id
                });
                
                // æ·»åŠ å¯¹åº”çš„é¢˜ç›®å¡ç‰‡
                demoData.questions
                    .filter(q => q.knowledge_id === kp.id)
                    .forEach(q => {
                        linkupState.pairs.push({
                            id: `q-${q.id}`,
                            type: 'question',
                            text: q.title,
                            pairId: kp.id
                        });
                    });
            });
            
            generateLinkUpBoard();
        }
        
        // ğŸ² ç”Ÿæˆè¿è¿çœ‹æ£‹ç›˜
        function generateLinkUpBoard() {
            const board = document.getElementById('linkup-board');
            if (!board) return;
            
            // æ´—ç‰Œ
            linkupState.pairs.sort(() => Math.random() - 0.5);
            
            // æ¸…ç©ºå¹¶ç”Ÿæˆå¡ç‰‡
            board.innerHTML = '';
            linkupState.pairs.forEach(item => {
                const card = document.createElement('div');
                card.className = `linkup-card ${item.type}`;
                card.dataset.id = item.id;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                
                card.innerHTML = `
                    <div class="card-label">${item.type === 'knowledge' ? 'ğŸ“š çŸ¥è¯†ç‚¹' : 'â“ é¢˜ç›®'}</div>
                    <div class="card-content">${item.text}</div>
                `;
                
                card.onclick = () => handleCardClick(card);
                board.appendChild(card);
            });
        }
        
        function handleCardClick(card) {
            if (card.classList.contains('matched') || card.classList.contains('selected')) return;
            
            card.classList.add('selected');
            linkupState.selectedCards.push(card);
            
            if (linkupState.selectedCards.length === 2) {
                const [card1, card2] = linkupState.selectedCards;
                const isMatch = card1.dataset.pairId === card2.dataset.pairId && 
                               card1.dataset.type !== card2.dataset.type;
                
                if (isMatch) {
                    // åŒ¹é…æˆåŠŸ
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        card1.classList.remove('selected');
                        card2.classList.remove('selected');
                        
                        linkupState.matchedPairs++;
                        updateGlobalScore(10);
                        
                        // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰é…å¯¹
                        if (linkupState.matchedPairs >= linkupState.pairs.length / 2) {
                            const resultMsg = document.getElementById('linkup-result');
                            if (resultMsg) {
                                resultMsg.textContent = 'ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é…å¯¹ï¼';
                                resultMsg.className = 'result-message success';
                                resultMsg.style.display = 'block';
                            }
                        }
                    }, 300);
                } else {
                    // åŒ¹é…å¤±è´¥
                    setTimeout(() => {
                        card1.classList.remove('selected');
                        card2.classList.remove('selected');
                    }, 800);
                }
                
                linkupState.selectedCards = [];
            }
        }
        
        function restartLinkUp() {
            initLinkUpGame();
        }
        
        function loadMoreLinkUpCards() {
            const resultMsg = document.getElementById('linkup-result');
            if (resultMsg) {
                resultMsg.textContent = 'æ›´å¤šå¡ç‰‡åŠŸèƒ½å¼€å‘ä¸­...';
                resultMsg.className = 'result-message';
                resultMsg.style.display = 'block';
                setTimeout(() => {
                    resultMsg.style.display = 'none';
                }, 2000);
            }
        }
        
        // âœ… å¯¹é”™åˆ¤æ–­æ¸¸æˆå‡½æ•°
        async function loadTrueFalseQuestion() {
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ¼”ç¤ºæ•°æ®
            if (window.demoMode) {
                useDemoTrueFalseData();
                return;
            }
            
            try {
                const { data: question, error } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .eq('game_type', 'truefalse')
                    .limit(1)
                    .single();
                
                if (error) {
                    console.warn('è·å–é¢˜ç›®å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®:', error);
                    useDemoTrueFalseData();
                    return;
                }
                
                if (!question) {
                    useDemoTrueFalseData();
                    return;
                }
                
                displayTrueFalseQuestion(question);
                
            } catch (error) {
                console.error('åŠ è½½å¯¹é”™åˆ¤æ–­é¢˜å¤±è´¥:', error);
                useDemoTrueFalseData();
            }
        }
        
        // ğŸ® ä½¿ç”¨æ¼”ç¤ºå¯¹é”™åˆ¤æ–­æ•°æ®
        function useDemoTrueFalseData() {
            const demoQuestions = [
                {
                    id: 1,
                    title: 'åœ°çƒæ˜¯å¹³çš„',
                    content: 'åœ°çƒæ˜¯ä¸€ä¸ªå¹³é¢ï¼Œè€Œä¸æ˜¯çƒä½“',
                    correct_answer: false,
                    explanation: 'åœ°çƒæ˜¯ä¸€ä¸ªè¿‘ä¼¼çƒä½“çš„è¡Œæ˜Ÿ'
                },
                {
                    id: 2,
                    title: 'æ°´åœ¨100Â°Cæ²¸è…¾',
                    content: 'åœ¨æ ‡å‡†å¤§æ°”å‹ä¸‹ï¼Œæ°´çš„æ²¸ç‚¹æ˜¯100Â°C',
                    correct_answer: true,
                    explanation: 'è¿™æ˜¯æ°´çš„æ ‡å‡†æ²¸ç‚¹'
                },
                {
                    id: 3,
                    title: 'å¤ªé˜³ç»•åœ°çƒè½¬',
                    content: 'å¤ªé˜³æ¯å¤©ç»•åœ°çƒæ—‹è½¬ä¸€å‘¨',
                    correct_answer: false,
                    explanation: 'åœ°çƒç»•å¤ªé˜³å…¬è½¬ï¼ŒåŒæ—¶è‡ªè½¬'
                }
            ];
            
            const randomQuestion = demoQuestions[Math.floor(Math.random() * demoQuestions.length)];
            displayTrueFalseQuestion(randomQuestion);
        }
        
        function displayTrueFalseQuestion(question) {
            window.currentTFQuestion = {
                id: question.id,
                content: question.content || question.title,
                actualAnswer: question.correct_answer,
                explanation: question.explanation
            };
            
            // éšæœºå†³å®šæ˜¯å¦é¢ å€’æ˜¾ç¤º
            const shouldFlip = Math.random() > 0.5;
            const displayAnswer = shouldFlip ? !question.correct_answer : question.correct_answer;
            window.currentTFQuestion.displayedAnswer = displayAnswer;
            
            // æ˜¾ç¤ºé¢˜ç›®
            const questionText = document.getElementById('tf-question-text');
            if (questionText) {
                questionText.innerHTML = `
                    <div style="margin-bottom: var(--spacing-md);">
                        <strong>é¢˜ç›®ï¼š</strong>${question.content || question.title}
                    </div>
                    <div style="padding: var(--spacing-md); background: var(--accent-light); border-radius: var(--border-radius-md); margin-top: var(--spacing-md);">
                        <strong>é™ˆè¿°ï¼š</strong><span style="color: ${displayAnswer ? '#38a169' : '#e53e3e'}; font-weight: 600;">
                        ${displayAnswer ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}</span>
                    </div>
                `;
            }
            
            // æ¸…ç©ºç»“æœæ¶ˆæ¯
            const resultMsg = document.getElementById('tf-result');
            if (resultMsg) {
                resultMsg.style.display = 'none';
                resultMsg.textContent = '';
            }
        }
        
        function answerTrueFalse(userAnswer) {
            if (!window.currentTFQuestion) return;
            
            const question = window.currentTFQuestion;
            const isCorrect = (userAnswer === question.actualAnswer);
            
            const resultMsg = document.getElementById('tf-result');
            if (resultMsg) {
                if (isCorrect) {
                    resultMsg.textContent = `âœ… å›ç­”æ­£ç¡®ï¼ ${question.explanation ? 'è§£æï¼š' + question.explanation : ''}`;
                    resultMsg.className = 'result-message success';
                    updateGlobalScore(5);
                } else {
                    resultMsg.textContent = `âŒ å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š${question.actualAnswer ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}ã€‚${question.explanation ? 'è§£æï¼š' + question.explanation : ''}`;
                    resultMsg.className = 'result-message error';
                }
                resultMsg.style.display = 'block';
            }
        }
        
        function nextTrueFalse() {
            loadTrueFalseQuestion();
        }
        
        function showExplanation() {
            if (!window.currentTFQuestion) return;
            
            const explanation = window.currentTFQuestion.explanation || 'æš‚æ— è¯¦ç»†è§£æ';
            const resultMsg = document.getElementById('tf-result');
            if (resultMsg) {
                resultMsg.textContent = `ğŸ“– è§£æï¼š${explanation}`;
                resultMsg.className = 'result-message';
                resultMsg.style.display = 'block';
            }
        }
        
        // â“ çŒœçŸ¥è¯†ç‚¹æ¸¸æˆå‡½æ•°
        async function loadGuessQuestion() {
            // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ¼”ç¤ºæ•°æ®
            if (window.demoMode) {
                useDemoGuessData();
                return;
            }
            
            try {
                const { data: question, error: questionError } = await supabaseClient
                    .from('questions')
                    .select('*')
                    .eq('game_type', 'guess')
                    .limit(1)
                    .single();
                
                if (questionError || !question) {
                    console.warn('è·å–é¢˜ç›®å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºæ•°æ®:', questionError);
                    useDemoGuessData();
                    return;
                }
                
                // è·å–å¯¹åº”çš„çŸ¥è¯†ç‚¹
                const { data: knowledge, error: knowledgeError } = await supabaseClient
                    .from('knowledge_points')
                    .select('title, subject')
                    .eq('id', question.knowledge_id)
                    .single();
                
                if (knowledgeError) {
                    console.warn('è·å–çŸ¥è¯†ç‚¹å¤±è´¥:', knowledgeError);
                    // ä½¿ç”¨é»˜è®¤å€¼
                    window.currentGuessQuestion = {
                        ...question,
                        knowledge_title: 'æœªçŸ¥çŸ¥è¯†ç‚¹'
                    };
                } else {
                    window.currentGuessQuestion = {
                        ...question,
                        knowledge_title: knowledge.title
                    };
                }
                
                // è·å–3ä¸ªé”™è¯¯é€‰é¡¹
                const { data: wrongOptions, error: optionsError } = await supabaseClient
                    .from('knowledge_points')
                    .select('id, title')
                    .neq('id', question.knowledge_id)
                    .limit(3);
                
                if (optionsError) {
                    console.warn('è·å–é”™è¯¯é€‰é¡¹å¤±è´¥:', optionsError);
                    useDemoGuessData();
                    return;
                }
                
                displayGuessQuestion(question, wrongOptions);
                
            } catch (error) {
                console.error('åŠ è½½çŒœçŸ¥è¯†ç‚¹é¢˜ç›®å¤±è´¥:', error);
                useDemoGuessData();
            }
        }
        
        // ğŸ® ä½¿ç”¨æ¼”ç¤ºçŒœçŸ¥è¯†ç‚¹æ•°æ®
        function useDemoGuessData() {
            const demoData = {
                clue: "è¿™ä¸ªå…¬å¼æè¿°äº†ç‰©ä½“åœ¨æ²¡æœ‰å¤–åŠ›ä½œç”¨æ—¶çš„è¿åŠ¨çŠ¶æ€",
                correctAnswer: "ç‰›é¡¿ç¬¬ä¸€å®šå¾‹",
                wrongOptions: [
                    "ç‰›é¡¿ç¬¬äºŒå®šå¾‹",
                    "èƒ½é‡å®ˆæ’å®šå¾‹",
                    "ä¸‡æœ‰å¼•åŠ›å®šå¾‹"
                ]
            };
            
            // æ˜¾ç¤ºçº¿ç´¢
            const clueText = document.getElementById('guess-clue-text');
            if (clueText) {
                clueText.textContent = demoData.clue;
            }
            
            // ç”Ÿæˆé€‰é¡¹
            const options = [
                { text: demoData.correctAnswer, correct: true },
                ...demoData.wrongOptions.map(text => ({ text, correct: false }))
            ].sort(() => Math.random() - 0.5);
            
            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            const optionsContainer = document.getElementById('guess-options');
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                options.forEach((opt, index) => {
                    const optionCard = document.createElement('div');
                    optionCard.className = 'option-card';
                    optionCard.dataset.correct = opt.correct;
                    optionCard.textContent = `${String.fromCharCode(65 + index)}. ${opt.text}`;
                    optionCard.onclick = () => checkGuessAnswer(opt.correct, optionCard);
                    optionsContainer.appendChild(optionCard);
                });
            }
            
            // æ¸…ç©ºç»“æœæ¶ˆæ¯
            const resultMsg = document.getElementById('guess-result');
            if (resultMsg) {
                resultMsg.style.display = 'none';
                resultMsg.textContent = '';
            }
        }
        
        function displayGuessQuestion(question, wrongOptions) {
            // æ˜¾ç¤ºçº¿ç´¢
            const clueText = document.getElementById('guess-clue-text');
            if (clueText) {
                clueText.textContent = question.content || question.title || 'é¢˜ç›®å†…å®¹åŠ è½½ä¸­...';
            }
            
            // åˆå¹¶é€‰é¡¹
            const options = [
                { 
                    text: window.currentGuessQuestion.knowledge_title, 
                    correct: true 
                },
                ...wrongOptions.map(opt => ({ 
                    text: opt.title, 
                    correct: false 
                }))
            ].sort(() => Math.random() - 0.5);
            
            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            const optionsContainer = document.getElementById('guess-options');
            if (optionsContainer) {
                optionsContainer.innerHTML = '';
                
                options.forEach((opt, index) => {
                    const optionCard = document.createElement('div');
                    optionCard.className = 'option-card';
                    optionCard.dataset.correct = opt.correct;
                    optionCard.textContent = `${String.fromCharCode(65 + index)}. ${opt.text}`;
                    optionCard.onclick = () => checkGuessAnswer(opt.correct, optionCard);
                    optionsContainer.appendChild(optionCard);
                });
            }
            
            // æ¸…ç©ºç»“æœæ¶ˆæ¯
            const resultMsg = document.getElementById('guess-result');
            if (resultMsg) {
                resultMsg.style.display = 'none';
                resultMsg.textContent = '';
            }
        }
        
        function checkGuessAnswer(isCorrect, optionCard) {
            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
            document.querySelectorAll('.option-card').forEach(card => {
                card.style.pointerEvents = 'none';
                card.style.opacity = '0.7';
            });
            
            // æ ‡è®°æ­£ç¡®/é”™è¯¯
            if (isCorrect) {
                optionCard.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                optionCard.style.color = 'white';
                optionCard.style.borderColor = '#38a169';
                optionCard.style.opacity = '1';
                
                updateGlobalScore(10);
            } else {
                optionCard.style.background = 'linear-gradient(135deg, #f56565, #e53e3e)';
                optionCard.style.color = 'white';
                optionCard.style.borderColor = '#e53e3e';
                
                // æ‰¾åˆ°æ­£ç¡®çš„é€‰é¡¹å¹¶é«˜äº®
                const correctCard = document.querySelector('.option-card[data-correct="true"]');
                if (correctCard) {
                    correctCard.style.background = 'linear-gradient(135deg, #48bb78, #38a169)';
                    correctCard.style.color = 'white';
                    correctCard.style.borderColor = '#38a169';
                    correctCard.style.opacity = '1';
                }
            }
            
            // æ˜¾ç¤ºç»“æœæ¶ˆæ¯
            const resultMsg = document.getElementById('guess-result');
            if (resultMsg) {
                resultMsg.textContent = isCorrect ? 'âœ… ç­”å¯¹äº†ï¼' : 'âŒ ç­”é”™äº†';
                resultMsg.className = `result-message ${isCorrect ? 'success' : 'error'}`;
                resultMsg.style.display = 'block';
            }
        }
        
        function nextGuess() {
            loadGuessQuestion();
        }
        
        function skipGuess() {
            updateGlobalScore(-2);
            loadGuessQuestion();
        }
        
        // âš”ï¸ è”æœºå¯¹æˆ˜å‡½æ•°
        function setDefaultDuelMode() {
            // è®¾ç½®é»˜è®¤é€‰ä¸­çš„æ¨¡å¼
            const defaultOption = document.querySelector('.mode-option[data-mode="linkup"]');
            if (defaultOption) {
                defaultOption.classList.add('selected');
                defaultOption.querySelector('input').checked = true;
            }
            selectedDuelMode = 'linkup';
            updateDuelStatus('å·²é€‰æ‹© è¿è¿çœ‹ æ¨¡å¼');
        }
        
        function selectDuelMode(mode, element) {
            selectedDuelMode = mode;
            
            // æ›´æ–°UI
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (element) {
                element.classList.add('selected');
                // æ›´æ–°radioé€‰ä¸­çŠ¶æ€
                const radio = element.querySelector('input[type="radio"]');
                if (radio) {
                    radio.checked = true;
                }
            }
            
            updateDuelStatus(`å·²é€‰æ‹© ${getModeName(mode)} æ¨¡å¼`);
        }
        
        function getModeName(mode) {
            const names = {
                'linkup': 'è¿è¿çœ‹',
                'truefalse': 'å¯¹é”™åˆ¤æ–­',
                'guess': 'çŒœçŸ¥è¯†ç‚¹'
            };
            return names[mode] || mode;
        }
        
        function createDuelRoom() {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            const modeName = getModeName(selectedDuelMode);
            
            updateDuelStatus(`æˆ¿é—´åˆ›å»ºæˆåŠŸï¼`);
            
            setTimeout(() => {
                alert(`ğŸ  æˆ¿é—´åˆ›å»ºæˆåŠŸï¼\n\næˆ¿é—´å·ï¼š${roomId}\næ¸¸æˆæ¨¡å¼ï¼š${modeName}\n\nè¯·åˆ†äº«æ­¤æˆ¿é—´å·ç»™å¯¹æ‰‹è¿›è¡Œè”æœºå¯¹æˆ˜`);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„Supabaseæˆ¿é—´åˆ›å»ºé€»è¾‘
                // createDuelRoomInDatabase(roomId);
            }, 100);
        }
        
        function joinDuelRoom() {
            const roomIdInput = document.getElementById('roomIdInput');
            const roomId = roomIdInput.value.trim();
            
            if (!roomId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }
            
            const modeName = getModeName(selectedDuelMode);
            updateDuelStatus(`æ­£åœ¨åŠ å…¥æˆ¿é—´ ${roomId}...`);
            
            setTimeout(() => {
                updateDuelStatus(`å·²åŠ å…¥æˆ¿é—´ ${roomId}`);
                alert(`æˆåŠŸåŠ å…¥æˆ¿é—´ ${roomId}\n\næ¸¸æˆæ¨¡å¼ï¼š${modeName}\n\nç­‰å¾…æˆ¿ä¸»å¼€å§‹æ¸¸æˆ...`);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„Supabaseæˆ¿é—´åŠ å…¥é€»è¾‘
                // joinDuelRoomInDatabase(roomId);
            }, 1000);
        }
        
        function updateDuelStatus(message) {
            const statusElement = document.getElementById('duel-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = 'var(--accent-color)';
            }
        }
        
        // ğŸ¨ ä¸»é¢˜ç®¡ç†å‡½æ•°
        function showThemeSelector() {
            const modal = document.getElementById('themeModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }
        
        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        function changeTheme(themeName) {
            ThemeManager.applyTheme(themeName);
            closeThemeModal();
        }
        
        // ğŸ“Š é€šç”¨å‡½æ•°
        function updateGlobalScore(points) {
            globalScore += points;
            if (globalScore < 0) globalScore = 0;
            updateScoreDisplay();
        }
        
        function updateScoreDisplay() {
            const scoreElement = document.getElementById('global-score');
            if (scoreElement) {
                scoreElement.textContent = globalScore;
            }
        }
        
        // ğŸš€ å¯åŠ¨åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('themeModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeThemeModal();
            }
        });
    </script>
</body>
</html>

