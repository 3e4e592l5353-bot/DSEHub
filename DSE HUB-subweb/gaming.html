<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰åˆä¸€çŸ¥è¯†å¯¹æˆ˜</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --accent-color: #5a67d8;
            --text-color: #2d3748;
            --spacing-xl: 24px;
            --border-radius-xl: 20px;
            --shadow-lg: 0 8px 32px rgba(102, 126, 234, 0.16);
        }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin: 0;
            padding: var(--spacing-xl);
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--spacing-xl);
        }
        
        /* æ¸¸æˆç±»å‹ä¾§è¾¹æ  */
        .game-sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            height: fit-content;
            position: sticky;
            top: var(--spacing-xl);
        }
        
        .game-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin: 12px 0;
            background: white;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .game-option:hover {
            transform: translateX(4px);
            border-color: var(--accent-color);
        }
        
        .game-option.active {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            box-shadow: var(--shadow-lg);
        }
        
        .game-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        /* æ¸¸æˆä¸»åŒºåŸŸ */
        .game-main {
            background: rgba(255, 255, 255, 0.98);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
            min-height: 600px;
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }
        
        .score-display {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-end);
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        /* è¿è¿çœ‹ç½‘æ ¼ */
        .linkup-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .linkup-card {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .linkup-card.knowledge {
            background: linear-gradient(135deg, #48bb7815, #31979515);
            border-color: rgba(72, 187, 120, 0.3);
        }
        
        .linkup-card.selected {
            transform: scale(1.05);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.2);
        }
        
        .linkup-card.matched {
            opacity: 0.3;
            transform: scale(0.95);
        }
        
        .card-label {
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 4px;
        }
        
        /* å¯¹é”™åˆ¤æ–­æ ·å¼ */
        .question-card {
            max-width: 600px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .truefalse-options {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }
        
        .truefalse-btn {
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 160px;
        }
        
        .true-btn {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .false-btn {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        /* çŒœçŸ¥è¯†ç‚¹æ ·å¼ */
        .guess-clue {
            font-size: 1.3em;
            line-height: 1.6;
            padding: 30px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 16px;
            margin: 30px 0;
            border-left: 4px solid var(--accent-color);
        }
        
        .guess-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .guess-option {
            padding: 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
        }
        
        .guess-option:hover {
            transform: translateY(-2px);
            border-color: var(--accent-color);
        }
        
        .guess-option.correct {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }
        
        .guess-option.wrong {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }
        
        /* è”æœºå¯¹æˆ˜é¢æ¿ */
        .duel-panel {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 16px;
            padding: 24px;
            margin-top: 30px;
        }
        
        .player-status {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        
        .player {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            min-width: 180px;
        }
        
        .player.active {
            box-shadow: 0 0 0 3px var(--accent-color);
        }
        
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
            }
            
            .game-sidebar {
                position: static;
            }
            
            .linkup-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .guess-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- å·¦ä¾§æ¸¸æˆç±»å‹é€‰æ‹© -->
        <div class="game-sidebar">
            <h2>ğŸ® æ¸¸æˆç±»å‹</h2>
            <div class="game-option active" onclick="switchGame('linkup')">
                <div class="game-icon">ğŸ”—</div>
                <div>
                    <h3>è¿è¿çœ‹</h3>
                    <p style="font-size: 12px; opacity: 0.7;">åŒ¹é…çŸ¥è¯†ç‚¹ä¸é¢˜ç›®</p>
                </div>
            </div>
            
            <div class="game-option" onclick="switchGame('truefalse')">
                <div class="game-icon">âœ…</div>
                <div>
                    <h3>å¯¹é”™åˆ¤æ–­</h3>
                    <p style="font-size: 12px; opacity: 0.7;">åˆ¤æ–­é¢˜ç›®æ­£è¯¯</p>
                </div>
            </div>
            
            <div class="game-option" onclick="switchGame('guess')">
                <div class="game-icon">â“</div>
                <div>
                    <h3>çŒœçŸ¥è¯†ç‚¹</h3>
                    <p style="font-size: 12px; opacity: 0.7;">æ ¹æ®çº¿ç´¢çŒœçŸ¥è¯†ç‚¹</p>
                </div>
            </div>
            
            <div class="duel-panel">
                <h3>âš”ï¸ è”æœºå¯¹æˆ˜</h3>
                <button onclick="startDuel()" style="width: 100%; margin-top: 12px;">
                    åˆ›å»ºå¯¹æˆ˜æˆ¿é—´
                </button>
                <div style="margin-top: 16px; font-size: 14px;">
                    <input type="text" placeholder="è¾“å…¥æˆ¿é—´ID" id="roomIdInput" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                    <button onclick="joinDuel()" style="width: 100%; margin-top: 8px;">åŠ å…¥æˆ¿é—´</button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æ¸¸æˆä¸»åŒºåŸŸ -->
        <div class="game-main">
            <div class="game-header">
                <h1 id="game-title">çŸ¥è¯†ç‚¹è¿è¿çœ‹</h1>
                <div class="score-display">
                    å¾—åˆ†: <span id="current-score">0</span>
                </div>
            </div>
            
            <!-- è¿è¿çœ‹æ¸¸æˆåŒºåŸŸ -->
            <div id="linkup-game" class="game-area active">
                <p style="text-align: center; color: #666; margin-bottom: 30px;">
                    ç‚¹å‡»åŒ¹é…å¯¹åº”çš„çŸ¥è¯†ç‚¹å’Œé¢˜ç›®ï¼Œæ¯ä¸ªçŸ¥è¯†ç‚¹å¯èƒ½å¯¹åº”å¤šä¸ªé¢˜ç›®
                </p>
                <div id="linkup-board" class="linkup-grid">
                    <!-- å¡ç‰‡é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button onclick="restartLinkUp()" style="padding: 12px 24px;">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
            
            <!-- å¯¹é”™åˆ¤æ–­æ¸¸æˆåŒºåŸŸ -->
            <div id="truefalse-game" class="game-area" style="display: none;">
                <div class="question-card">
                    <p id="tf-question-text">åŠ è½½é¢˜ç›®ä¸­...</p>
                    <div class="truefalse-options">
                        <button class="truefalse-btn true-btn" onclick="answerTrueFalse(true)">âœ… æ­£ç¡®</button>
                        <button class="truefalse-btn false-btn" onclick="answerTrueFalse(false)">âŒ é”™è¯¯</button>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p id="tf-result" style="font-size: 1.2em;"></p>
                    <button onclick="nextTrueFalse()" style="margin-top: 16px;">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
            
            <!-- çŒœçŸ¥è¯†ç‚¹æ¸¸æˆåŒºåŸŸ -->
            <div id="guess-game" class="game-area" style="display: none;">
                <div class="question-card">
                    <p class="guess-clue" id="guess-clue-text">çº¿ç´¢åŠ è½½ä¸­...</p>
                    <div id="guess-options-container" class="guess-options">
                        <!-- é€‰é¡¹é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p id="guess-result"></p>
                    <button onclick="nextGuess()" style="margin-top: 16px;">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // æ¸¸æˆçŠ¶æ€
        let currentGame = 'linkup';
        let score = 0;
        let linkupPairs = [];
        let selectedCards = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await initLinkUpGame();
        });
        
        // åˆ‡æ¢æ¸¸æˆ
        function switchGame(gameType) {
            // æ›´æ–°UI
            document.querySelectorAll('.game-option').forEach(opt => {
                opt.classList.remove('active');
            });
            document.querySelectorAll('.game-area').forEach(area => {
                area.style.display = 'none';
            });
            
            event.currentTarget.classList.add('active');
            
            // æ›´æ–°æ¸¸æˆçŠ¶æ€
            currentGame = gameType;
            
            // æ›´æ–°æ ‡é¢˜
            const titles = {
                'linkup': 'çŸ¥è¯†ç‚¹è¿è¿çœ‹',
                'truefalse': 'å¯¹é”™åˆ¤æ–­æŒ‘æˆ˜',
                'guess': 'çŒœçŸ¥è¯†ç‚¹'
            };
            document.getElementById('game-title').textContent = titles[gameType];
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ¸¸æˆåŒºåŸŸ
            document.getElementById(`${gameType}-game`).style.display = 'block';
            
            // åˆå§‹åŒ–æ¸¸æˆ
            if (gameType === 'linkup') {
                initLinkUpGame();
            } else if (gameType === 'truefalse') {
                loadTrueFalseQuestion();
            } else if (gameType === 'guess') {
                loadGuessQuestion();
            }
        }
        
        // ==================== è¿è¿çœ‹æ¸¸æˆ ====================
        async function initLinkUpGame() {
            const board = document.getElementById('linkup-board');
            board.innerHTML = '';
            selectedCards = [];
            
            // ä»æ•°æ®åº“è·å–æ•°æ®
            const { data: knowledgePoints } = await supabase
                .from('knowledge_points')
                .select('id, title')
                .limit(6);
            
            linkupPairs = [];
            
            // ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹æ‰¾2-3ä¸ªç›¸å…³é¢˜ç›®
            for (const kp of knowledgePoints) {
                const { data: questions } = await supabase
                    .from('questions')
                    .select('id, title, content')
                    .eq('knowledge_id', kp.id)
                    .eq('game_type', 'linkup')
                    .limit(3);
                
                if (questions && questions.length > 0) {
                    // æ·»åŠ çŸ¥è¯†ç‚¹å¤´
                    linkupPairs.push({
                        type: 'knowledge',
                        text: kp.title,
                        pairId: kp.id,
                        id: `k-${kp.id}`
                    });
                    
                    // æ·»åŠ ç›¸å…³é¢˜ç›®
                    questions.forEach((q, idx) => {
                        linkupPairs.push({
                            type: 'question',
                            text: q.title.length > 30 ? q.title.substring(0, 30) + '...' : q.title,
                            pairId: kp.id,
                            id: `q-${q.id}`
                        });
                    });
                }
            }
            
            // æ´—ç‰Œ
            linkupPairs.sort(() => Math.random() - 0.5);
            
            // ç”Ÿæˆå¡ç‰‡
            linkupPairs.forEach(item => {
                const card = document.createElement('div');
                card.className = `linkup-card ${item.type}`;
                card.innerHTML = `
                    <div class="card-label">${item.type === 'knowledge' ? 'ğŸ“š çŸ¥è¯†ç‚¹' : 'â“ é¢˜ç›®'}</div>
                    <div style="font-weight: bold;">${item.text}</div>
                `;
                card.dataset.id = item.id;
                card.dataset.pairId = item.pairId;
                card.dataset.type = item.type;
                card.onclick = () => handleCardClick(card);
                board.appendChild(card);
            });
        }
        
        function handleCardClick(card) {
            if (card.classList.contains('matched') || card.classList.contains('selected')) return;
            
            card.classList.add('selected');
            selectedCards.push(card);
            
            if (selectedCards.length === 2) {
                const [card1, card2] = selectedCards;
                const isMatch = card1.dataset.pairId === card2.dataset.pairId && 
                               card1.dataset.type !== card2.dataset.type;
                
                if (isMatch) {
                    setTimeout(() => {
                        card1.classList.add('matched');
                        card2.classList.add('matched');
                        updateScore(10);
                        checkLinkUpCompletion();
                    }, 500);
                } else {
                    setTimeout(() => {
                        card1.classList.remove('selected');
                        card2.classList.remove('selected');
                    }, 1000);
                }
                
                selectedCards = [];
            }
        }
        
        function checkLinkUpCompletion() {
            const matchedCards = document.querySelectorAll('.linkup-card.matched').length;
            if (matchedCards === linkupPairs.length) {
                setTimeout(() => {
                    alert('ğŸ‰ æ­å–œï¼ä½ å®Œæˆäº†æ‰€æœ‰é…å¯¹ï¼');
                }, 300);
            }
        }
        
        function restartLinkUp() {
            initLinkUpGame();
            score = 0;
            updateScore(0);
        }
        
        // ==================== å¯¹é”™åˆ¤æ–­æ¸¸æˆ ====================
        async function loadTrueFalseQuestion() {
            const { data } = await supabase
                .from('questions')
                .select(`
                    id, title, content, correct_answer, explanation,
                    knowledge_points!inner (title)
                `)
                .eq('game_type', 'truefalse')
                .limit(1)
                .single();
            
            if (data) {
                // å­˜å‚¨æ­£ç¡®ç­”æ¡ˆ
                window.currentTFQuestion = {
                    id: data.id,
                    actualAnswer: data.correct_answer,
                    explanation: data.explanation
                };
                
                // éšæœºå†³å®šæ˜¯å¦é¢ å€’æ˜¾ç¤º
                const shouldFlip = Math.random() > 0.5;
                const displayAnswer = shouldFlip ? !data.correct_answer : data.correct_answer;
                
                // æ˜¾ç¤ºé¢˜ç›®
                document.getElementById('tf-question-text').innerHTML = `
                    <strong>é¢˜ç›®ï¼š</strong>${data.content || data.title}<br><br>
                    <strong>é™ˆè¿°ï¼š</strong>${data.knowledge_points.title}<br><br>
                    <strong>ç­”æ¡ˆï¼š</strong><span style="color: ${displayAnswer ? '#48bb78' : '#f56565'}">
                    ${displayAnswer ? 'æ­£ç¡®' : 'é”™è¯¯'}</span>
                `;
                
                // å­˜å‚¨æ˜¾ç¤ºç­”æ¡ˆ
                window.currentTFQuestion.displayedAnswer = displayAnswer;
                
                document.getElementById('tf-result').textContent = '';
            }
        }
        
        function answerTrueFalse(userAnswer) {
            const question = window.currentTFQuestion;
            const isCorrect = (userAnswer === question.actualAnswer);
            
            if (isCorrect) {
                document.getElementById('tf-result').innerHTML = `
                    <span style="color: #48bb78;">âœ… å›ç­”æ­£ç¡®ï¼</span>
                    <br><small>${question.explanation || 'å¤ªæ£’äº†ï¼'}</small>
                `;
                updateScore(5);
            } else {
                document.getElementById('tf-result').innerHTML = `
                    <span style="color: #f56565;">âŒ å›ç­”é”™è¯¯ï¼</span>
                    <br><small>æ­£ç¡®ç­”æ¡ˆï¼š${question.actualAnswer ? 'æ­£ç¡®' : 'é”™è¯¯'}</small>
                    <br><small>${question.explanation || ''}</small>
                `;
            }
        }
        
        function nextTrueFalse() {
            loadTrueFalseQuestion();
        }
        
        // ==================== çŒœçŸ¥è¯†ç‚¹æ¸¸æˆ ====================
        async function loadGuessQuestion() {
            // è·å–ä¸€é“é¢˜ç›®ä½œä¸ºçº¿ç´¢
            const { data: clueQuestion } = await supabase
                .from('questions')
                .select(`
                    id, content, knowledge_id,
                    knowledge_points!inner (title, subject)
                `)
                .eq('game_type', 'guess')
                .limit(1)
                .single();
            
            if (!clueQuestion) return;
            
            // æ˜¾ç¤ºçº¿ç´¢
            document.getElementById('guess-clue-text').textContent = clueQuestion.content;
            
            // è·å–3ä¸ªé”™è¯¯é€‰é¡¹
            const { data: wrongOptions } = await supabase
                .from('knowledge_points')
                .select('id, title')
                .neq('id', clueQuestion.knowledge_id)
                .limit(3);
            
            // åˆå¹¶é€‰é¡¹
            const options = [
                { id: clueQuestion.knowledge_id, text: clueQuestion.knowledge_points.title, correct: true },
                ...wrongOptions.map(opt => ({ id: opt.id, text: opt.title, correct: false }))
            ].sort(() => Math.random() - 0.5);
            
            // ç”Ÿæˆé€‰é¡¹æŒ‰é’®
            const container = document.getElementById('guess-options-container');
            container.innerHTML = '';
            
            options.forEach(opt => {
                const button = document.createElement('div');
                button.className = 'guess-option';
                button.textContent = opt.text;
                button.onclick = () => checkGuessAnswer(opt.correct, button);
                container.appendChild(button);
            });
            
            document.getElementById('guess-result').textContent = '';
        }
        
        function checkGuessAnswer(isCorrect, button) {
            document.querySelectorAll('.guess-option').forEach(opt => {
                opt.style.pointerEvents = 'none';
            });
            
            if (isCorrect) {
                button.classList.add('correct');
                document.getElementById('guess-result').innerHTML = 
                    '<span style="color: #48bb78;">âœ… ç­”å¯¹äº†ï¼</span>';
                updateScore(10);
            } else {
                button.classList.add('wrong');
                document.getElementById('guess-result').innerHTML = 
                    '<span style="color: #f56565;">âŒ ç­”é”™äº†</span>';
            }
        }
        
        function nextGuess() {
            loadGuessQuestion();
        }
        
        // ==================== é€šç”¨å‡½æ•° ====================
        function updateScore(points = 0) {
            score += points;
            document.getElementById('current-score').textContent = score;
        }
        
        // è”æœºå¯¹æˆ˜åŠŸèƒ½ï¼ˆç®€ç‰ˆï¼‰
        function startDuel() {
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            alert(`åˆ›å»ºæˆ¿é—´æˆåŠŸï¼æˆ¿é—´å·ï¼š${roomId}\n\nåˆ†äº«æ­¤æˆ¿é—´å·ç»™å¯¹æ‰‹å³å¯å¼€å§‹å¯¹æˆ˜`);
        }
        
        function joinDuel() {
            const roomId = document.getElementById('roomIdInput').value;
            if (roomId) {
                alert(`æ­£åœ¨åŠ å…¥æˆ¿é—´ ${roomId}...`);
                // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„Supabaseæˆ¿é—´åŠ å…¥é€»è¾‘
            }
        }
    </script>
</body>
</html>
