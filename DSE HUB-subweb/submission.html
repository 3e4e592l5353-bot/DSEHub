<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¨¿ä¸­å¿ƒ - DSEHub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(-45deg, #667eea, #764ba2, #48bb78, #319795, #ff8c00, #ff4500);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
            color: #2d3748;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* å¤´éƒ¨æ ·å¼ */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 15px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ */
        .user-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-item {
            padding: 10px 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            border-left: 3px solid #667eea;
            min-width: 120px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #667eea;
        }

        /* æŠ•ç¨¿ç±»å‹åˆ‡æ¢ */
        .submission-type {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .type-btn {
            flex: 1;
            min-width: 180px;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .type-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* æŠ•ç¨¿è¡¨å•æ ·å¼ */
        .submission-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* ç§‘ç›®é€‰æ‹© - å°å‹æŒ‰é’® */
        .subject-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .subject-btn {
            padding: 6px 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .subject-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .subject-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        /* æ ‡ç­¾é€‰æ‹© - å°å‹æŒ‰é’® */
        .tag-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-btn {
            padding: 6px 12px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .tag-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tag-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
        }

        /* æ¸¸æˆç±»å‹é€‰æ‹© */
        .game-type-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .game-type-btn {
            padding: 10px 20px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .game-type-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .game-type-btn.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* æäº¤æŒ‰é’® */
        .submit-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-stats {
                width: 100%;
            }
            
            .stat-item {
                flex: 1;
                min-width: 100px;
            }
            
            .subject-buttons {
                gap: 6px;
            }
            
            .subject-btn {
                font-size: 0.85rem;
                padding: 5px 10px;
            }
        }

        @media (max-width: 480px) {
            .game-type-buttons {
                flex-direction: column;
            }
            
            .game-type-btn {
                justify-content: center;
            }
            
            .type-btn {
                min-width: 100%;
            }
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
        }

        .message.success {
            border-left: 4px solid #48bb78;
            color: #2f855a;
        }

        .message.error {
            border-left: 4px solid #f56565;
            color: #c53030;
        }

        .message.warning {
            border-left: 4px solid #ed8936;
            color: #c05621;
        }

        .hidden {
            display: none !important;
        }

        /* å­—æ•°ç»Ÿè®¡ */
        .word-count {
            font-size: 0.85rem;
            color: #718096;
            text-align: right;
            margin-top: 5px;
        }

        .word-count.warning {
            color: #ed8936;
        }

        .word-count.error {
            color: #f56565;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <div class="header">
            <h1>ğŸ“š DSEHub æŠ•ç¨¿ä¸­å¿ƒ</h1>
            <div class="nav-buttons">
                <a href="https://3e4e592l5353-bot.github.io/DSEHub/" class="nav-btn">
                    <i class="fas fa-home"></i> è¿”å›ä¸»ç«™
                </a>
                <button class="nav-btn" onclick="openGames()">
                    <i class="fas fa-gamepad"></i> å°æ¸¸æˆ
                </button>
                <button class="nav-btn" onclick="openNotes()">
                    <i class="fas fa-sticky-note"></i> ç¬”è®°
                </button>
            </div>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div class="user-card">
            <div class="user-info">
                <div>
                    <h2 id="username">åŠ è½½ä¸­...</h2>
                    <p id="userEmail">æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...</p>
                </div>
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-label">å­¦ä¹ ç§¯åˆ†</div>
                        <div class="stat-value" id="userScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æ¸¸æˆæ¬¡æ•°</div>
                        <div class="stat-value" id="gamesPlayed">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">æœ€é«˜åˆ†</div>
                        <div class="stat-value" id="highScore">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">å¯¹æˆ˜èƒœåˆ©</div>
                        <div class="stat-value" id="duelWins">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ•ç¨¿ç±»å‹åˆ‡æ¢ -->
        <div class="submission-type">
            <button class="type-btn active" onclick="switchType('knowledge')">
                <i class="fas fa-graduation-cap"></i> çŸ¥è¯†ç‚¹æŠ•ç¨¿
            </button>
            <button class="type-btn" onclick="switchType('game')">
                <i class="fas fa-gamepad"></i> å°æ¸¸æˆæŠ•ç¨¿
            </button>
        </div>

        <!-- çŸ¥è¯†ç‚¹æŠ•ç¨¿è¡¨å• -->
        <div id="knowledgeForm" class="submission-form">
            <div id="knowledgeMessage" class="message hidden"></div>
            <form id="knowledgeSubmissionForm">
                <!-- ç§‘ç›®é€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©ç§‘ç›® *</label>
                    <div class="subject-buttons" id="subjectSelection">
                        <!-- ç§‘ç›®æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ ‡ç­¾é€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="tag-buttons" id="tagSelection">
                        <!-- æ ‡ç­¾æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å†…å®¹ -->
                <div class="form-group">
                    <label class="form-label">çŸ¥è¯†ç‚¹ç®€è¿° (50-100å­—) *</label>
                    <textarea class="form-control textarea" id="knowledgeContent" 
                              placeholder="è¯·ç®€è¦æè¿°çŸ¥è¯†ç‚¹å†…å®¹ï¼Œ50-100å­—..." 
                              maxlength="200"></textarea>
                    <div class="word-count" id="knowledgeWordCount">0/200 å­—</div>
                </div>

                <!-- æ ‡é¢˜ -->
                <div class="form-group">
                    <label class="form-label">çŸ¥è¯†ç‚¹åç§° *</label>
                    <input type="text" class="form-control" id="knowledgeTitle" 
                           placeholder="è¯·è¾“å…¥çŸ¥è¯†ç‚¹åç§°" required>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> æäº¤çŸ¥è¯†ç‚¹æŠ•ç¨¿
                </button>
            </form>
        </div>

        <!-- å°æ¸¸æˆæŠ•ç¨¿è¡¨å• -->
        <div id="gameForm" class="submission-form" style="display: none;">
            <div id="gameMessage" class="message hidden"></div>
            <form id="gameSubmissionForm">
                <!-- æ¸¸æˆç±»å‹é€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ¸¸æˆç±»å‹ *</label>
                    <div class="game-type-buttons" id="gameTypeSelection">
                        <!-- æ¸¸æˆç±»å‹æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æ¸¸æˆå†…å®¹åŒºåŸŸ -->
                <div id="matchGameContent" class="form-group" style="display: none;">
                    <label class="form-label">é…å¯¹é¡¹ç›® *</label>
                    <textarea class="form-control textarea" id="matchExamples" 
                              placeholder="è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å…¥é…å¯¹é¡¹ç›®ï¼ˆæ¯è¡Œä¸€å¯¹ï¼Œç”¨ // åˆ†éš”ï¼‰ï¼š&#10;é¡¹ç›®A // å¯¹åº”çš„é¡¹ç›®B&#10;ä¾‹å¦‚ï¼š&#10;å‹¾è‚¡å®šç† // aÂ²+bÂ²=cÂ²" 
                              required></textarea>
                </div>

                <div id="trueFalseContent" class="form-group" style="display: none;">
                    <label class="form-label">é—®é¢˜é™ˆè¿° *</label>
                    <textarea class="form-control textarea" id="tfQuestion" 
                              placeholder="è¯·è¾“å…¥éœ€è¦åˆ¤æ–­æ­£è¯¯çš„é™ˆè¿°..." 
                              required></textarea>
                    
                    <div style="margin-top: 15px;">
                        <label class="form-label">æ­£ç¡®ç­”æ¡ˆ *</label>
                        <div class="tag-buttons" style="margin-top: 8px;">
                            <button type="button" class="tag-btn tf-answer" data-value="true">
                                <i class="fas fa-check"></i> æ­£ç¡®
                            </button>
                            <button type="button" class="tag-btn tf-answer" data-value="false">
                                <i class="fas fa-times"></i> é”™è¯¯
                            </button>
                        </div>
                        <input type="hidden" id="tfAnswer" required>
                    </div>
                </div>

                <div id="guessContent" class="form-group" style="display: none;">
                    <label class="form-label">æè¿°/æç¤º *</label>
                    <textarea class="form-control textarea" id="guessDescription" 
                              placeholder="è¯·æè¿°è¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œä½†ä¸ç›´æ¥è¯´å‡ºåç§°..." 
                              required></textarea>
                </div>

                <!-- éš¾åº¦é€‰æ‹© -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©éš¾åº¦ *</label>
                    <div class="tag-buttons">
                        <button type="button" class="tag-btn difficulty-btn" data-value="easy">ç®€å•</button>
                        <button type="button" class="tag-btn difficulty-btn" data-value="medium">ä¸­ç­‰</button>
                        <button type="button" class="tag-btn difficulty-btn" data-value="hard">å›°éš¾</button>
                    </div>
                    <input type="hidden" id="gameDifficulty" required>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-paper-plane"></i> æäº¤æ¸¸æˆæŠ•ç¨¿
                </button>
            </form>
        </div>
    </div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';

        // ç§‘ç›®åˆ—è¡¨
        const subjects = [
            { id: 'chinese', name: 'ä¸­å›½è¯­æ–‡' },
            { id: 'english', name: 'è‹±å›½è¯­æ–‡' },
            { id: 'math', name: 'æ•°å­¦' },
            { id: 'math_extended1', name: 'æ•°å­¦å»¶ä¼¸å•å…ƒä¸€' },
            { id: 'math_extended2', name: 'æ•°å­¦å»¶ä¼¸å•å…ƒäºŒ' },
            { id: 'ls', name: 'å…¬æ°‘ä¸ç¤¾ä¼šå‘å±•' },
            { id: 'biology', name: 'ç”Ÿç‰©' },
            { id: 'chemistry', name: 'åŒ–å­¦' },
            { id: 'physics', name: 'ç‰©ç†' },
            { id: 'chinese_history', name: 'ä¸­å›½å†å²' },
            { id: 'history', name: 'å†å²' },
            { id: 'geography', name: 'åœ°ç†' },
            { id: 'economics', name: 'ç»æµ' },
            { id: 'chinese_literature', name: 'ä¸­å›½æ–‡å­¦' },
            { id: 'english_literature', name: 'è‹±å›½æ–‡å­¦' },
            { id: 'bafs', name: 'ä¼ä¸šã€ä¼šè®¡ä¸è´¢åŠ¡æ¦‚è®º' },
            { id: 'ict', name: 'èµ„è®¯åŠé€šè®¯æŠ€æœ¯' },
            { id: 'ers', name: 'ä¼¦ç†ä¸å®—æ•™' },
            { id: 'th', name: 'æ—…æ¸¸ä¸æ¬¾å¾…' },
            { id: 'da', name: 'è®¾è®¡ä¸åº”ç”¨' },
            { id: 'health', name: 'ç§‘æŠ€ä¸å¥åº·' },
            { id: 'management', name: 'ç®¡ç†ä¸ç¤¾ä¼šç§‘å­¦' },
            { id: 'technology_life', name: 'ç§‘æŠ€ä¸ç”Ÿæ´»' },
            { id: 'music', name: 'éŸ³ä¹' },
            { id: 'visual_arts', name: 'è§†è§‰è‰ºæœ¯' },
            { id: 'pe', name: 'ä½“è‚²' }
        ];

        // æ ‡ç­¾åˆ—è¡¨
        const tags = [
            { id: 'formula', name: 'å…¬å¼' },
            { id: 'grammar', name: 'è¯­æ³•' },
            { id: 'quote', name: 'åè¨€é‡‘å¥' },
            { id: 'idiom', name: 'æˆè¯­' },
            { id: 'term', name: 'æœ¯è¯­' },
            { id: 'basic', name: 'åŸºç¡€' },
            { id: 'advanced', name: 'è¿›é˜¶' }
        ];

        // æ¸¸æˆç±»å‹
        const gameTypes = [
            {
                id: 'matching',
                name: 'è¿è¿çœ‹',
                icon: 'fas fa-link',
                description: 'é…å¯¹ç›¸å…³çš„çŸ¥è¯†ç‚¹'
            },
            {
                id: 'true_false',
                name: 'å¯¹é”™åˆ¤æ–­',
                icon: 'fas fa-check-circle',
                description: 'åˆ¤æ–­é™ˆè¿°çš„æ­£è¯¯'
            },
            {
                id: 'guess',
                name: 'çŒœçŸ¥è¯†ç‚¹',
                icon: 'fas fa-lightbulb',
                description: 'æ ¹æ®æè¿°çŒœçŸ¥è¯†ç‚¹'
            }
        ];

        // ç”¨æˆ·æ•°æ®
        let currentUser = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            loadUserData();
            setupEventListeners();
        });

        function initializePage() {
            // åŠ è½½ç”¨æˆ·ä¸»é¢˜
            loadUserTheme();
            
            // åˆå§‹åŒ–ç§‘ç›®é€‰æ‹©
            const subjectSelection = document.getElementById('subjectSelection');
            subjects.forEach(subject => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'subject-btn';
                btn.dataset.id = subject.id;
                btn.textContent = subject.name;
                btn.onclick = () => toggleSelection(btn, subjectSelection);
                subjectSelection.appendChild(btn);
            });

            // åˆå§‹åŒ–æ ‡ç­¾é€‰æ‹©
            const tagSelection = document.getElementById('tagSelection');
            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'tag-btn';
                btn.dataset.id = tag.id;
                btn.textContent = tag.name;
                btn.onclick = () => toggleMultiSelection(btn);
                tagSelection.appendChild(btn);
            });

            // åˆå§‹åŒ–æ¸¸æˆç±»å‹é€‰æ‹©
            const gameTypeSelection = document.getElementById('gameTypeSelection');
            gameTypes.forEach(game => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'game-type-btn';
                btn.dataset.type = game.id;
                btn.innerHTML = `<i class="${game.icon}"></i> ${game.name}`;
                btn.onclick = () => {
                    document.querySelectorAll('.game-type-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    showGameContent(game.id);
                };
                gameTypeSelection.appendChild(btn);
            });

            // å­—æ•°ç»Ÿè®¡
            document.getElementById('knowledgeContent').addEventListener('input', updateWordCount);
        }

        function loadUserTheme() {
            // ä»localStorageè·å–ç”¨æˆ·ä¸»é¢˜
            try {
                const userData = JSON.parse(localStorage.getItem('dsehub_user') || '{}');
                if (userData.theme_colors) {
                    // åº”ç”¨ä¸»é¢˜é¢œè‰²
                    applyThemeColors(userData.theme_colors);
                } else if (userData.theme_color) {
                    // åº”ç”¨é¢„è®¾ä¸»é¢˜
                    applyPresetTheme(userData.theme_color);
                }
            } catch (error) {
                console.log('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
            }
        }

        function applyThemeColors(colors) {
            // ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¿å­˜çš„é¢œè‰²
            const root = document.documentElement;
            
            if (colors.primary_start && colors.primary_end) {
                // æ›´æ–°æ¸å˜æŒ‰é’®
                const btnGradient = `linear-gradient(135deg, ${colors.primary_start}, ${colors.primary_end})`;
                
                // æ›´æ–°CSS
                document.querySelectorAll('.subject-btn.selected, .tag-btn.selected, .game-type-btn.selected, .type-btn.active, .submit-btn').forEach(btn => {
                    btn.style.background = btnGradient;
                });
                
                // æ›´æ–°ç»Ÿè®¡é¡¹è¾¹æ¡†é¢œè‰²
                document.querySelectorAll('.stat-item').forEach(item => {
                    item.style.borderLeftColor = colors.primary_start || colors.accent_color || '#667eea';
                });
            }
        }

        function applyPresetTheme(themeName) {
            // åº”ç”¨é¢„è®¾ä¸»é¢˜
            const themes = {
                'theme-blue-purple': { start: '#667eea', end: '#764ba2' },
                'theme-green-teal': { start: '#48bb78', end: '#319795' },
                'theme-orange-red': { start: '#ff8c00', end: '#ff4500' },
                'theme-dark': { start: '#4a5568', end: '#2d3748' }
            };
            
            if (themes[themeName]) {
                const theme = themes[themeName];
                const btnGradient = `linear-gradient(135deg, ${theme.start}, ${theme.end})`;
                
                document.querySelectorAll('.subject-btn.selected, .tag-btn.selected, .game-type-btn.selected, .type-btn.active, .submit-btn').forEach(btn => {
                    btn.style.background = btnGradient;
                });
                
                document.querySelectorAll('.stat-item').forEach(item => {
                    item.style.borderLeftColor = theme.start;
                });
            }
        }

        function loadUserData() {
            // ä»localStorageè·å–ç”¨æˆ·ä¿¡æ¯
            try {
                const userData = JSON.parse(localStorage.getItem('dsehub_user') || '{}');
                if (userData && userData.id) {
                    currentUser = userData;
                    updateUserDisplay(userData);
                    fetchUserStats(userData.id);
                    return;
                }
            } catch (e) {
                console.log('æ— æ³•è¯»å–ç”¨æˆ·æ•°æ®');
            }
            
            // æœªç™»å½•çŠ¶æ€
            document.getElementById('username').textContent = 'æœªç™»å½•';
            document.getElementById('userEmail').textContent = 'è¯·å…ˆç™»å½•ä¸»ç«™';
            
            // ç¦ç”¨è¡¨å•
            document.querySelectorAll('form').forEach(form => {
                form.querySelectorAll('input, textarea, button, select').forEach(element => {
                    element.disabled = true;
                });
            });
        }

        async function fetchUserStats(userId) {
            try {
                // ä»profilesè¡¨è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
                const response = await fetch(`${SUPABASE_URL}/rest/v1/profiles?select=score,games_played,high_score,duel_wins&id=eq.${userId}`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const profiles = await response.json();
                    if (profiles && profiles.length > 0) {
                        const profile = profiles[0];
                        updateStatsDisplay({
                            score: profile.score || 0,
                            games_played: profile.games_played || 0,
                            high_score: profile.high_score || 0,
                            duel_wins: profile.duel_wins || 0
                        });
                        return;
                    }
                }
            } catch (error) {
                console.log('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
            
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            updateStatsDisplay({
                score: Math.floor(Math.random() * 1000),
                games_played: Math.floor(Math.random() * 50),
                high_score: Math.floor(Math.random() * 100),
                duel_wins: Math.floor(Math.random() * 20)
            });
        }

        function updateUserDisplay(user) {
            document.getElementById('username').textContent = user.username || 'ç”¨æˆ·';
            document.getElementById('userEmail').textContent = user.email || '';
        }

        function updateStatsDisplay(stats) {
            document.getElementById('userScore').textContent = stats.score;
            document.getElementById('gamesPlayed').textContent = stats.games_played;
            document.getElementById('highScore').textContent = stats.high_score;
            document.getElementById('duelWins').textContent = stats.duel_wins;
        }

        function setupEventListeners() {
            // çŸ¥è¯†ç‚¹è¡¨å•æäº¤
            document.getElementById('knowledgeSubmissionForm').addEventListener('submit', submitKnowledge);
            
            // æ¸¸æˆè¡¨å•æäº¤
            document.getElementById('gameSubmissionForm').addEventListener('submit', submitGame);
            
            // å¯¹é”™åˆ¤æ–­ç­”æ¡ˆé€‰æ‹©
            document.querySelectorAll('.tf-answer').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tf-answer').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('tfAnswer').value = this.dataset.value;
                });
            });
            
            // éš¾åº¦é€‰æ‹©
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('gameDifficulty').value = this.dataset.value;
                });
            });
        }

        function switchType(type) {
            const knowledgeBtn = document.querySelector('.type-btn:nth-child(1)');
            const gameBtn = document.querySelector('.type-btn:nth-child(2)');
            const knowledgeForm = document.getElementById('knowledgeForm');
            const gameForm = document.getElementById('gameForm');
            
            if (type === 'knowledge') {
                knowledgeBtn.classList.add('active');
                gameBtn.classList.remove('active');
                knowledgeForm.style.display = 'block';
                gameForm.style.display = 'none';
            } else {
                gameBtn.classList.add('active');
                knowledgeBtn.classList.remove('active');
                knowledgeForm.style.display = 'none';
                gameForm.style.display = 'block';
            }
        }

        function toggleSelection(element, container) {
            // å•é€‰é€‰æ‹©
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function toggleMultiSelection(element) {
            // å¤šé€‰é€‰æ‹©
            element.classList.toggle('selected');
        }

        function showGameContent(gameType) {
            // éšè—æ‰€æœ‰æ¸¸æˆå†…å®¹
            document.getElementById('matchGameContent').style.display = 'none';
            document.getElementById('trueFalseContent').style.display = 'none';
            document.getElementById('guessContent').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ¸¸æˆå†…å®¹
            switch(gameType) {
                case 'matching':
                    document.getElementById('matchGameContent').style.display = 'block';
                    break;
                case 'true_false':
                    document.getElementById('trueFalseContent').style.display = 'block';
                    break;
                case 'guess':
                    document.getElementById('guessContent').style.display = 'block';
                    break;
            }
        }

        function updateWordCount() {
            const textarea = document.getElementById('knowledgeContent');
            const wordCount = document.getElementById('knowledgeWordCount');
            const length = textarea.value.length;
            
            wordCount.textContent = `${length}/200 å­—`;
            
            if (length < 50) {
                wordCount.className = 'word-count warning';
            } else if (length > 200) {
                wordCount.className = 'word-count error';
            } else {
                wordCount.className = 'word-count';
            }
        }

        function showMessage(type, message, formId) {
            const messageDiv = document.getElementById(formId + 'Message');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-triangle'}"></i>
                <div>${message}</div>
            `;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        async function submitKnowledge(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('error', 'è¯·å…ˆç™»å½•', 'knowledge');
                return;
            }
            
            // æ”¶é›†æ•°æ®
            const selectedSubject = document.querySelector('#subjectSelection .subject-btn.selected');
            const selectedTags = Array.from(document.querySelectorAll('#tagSelection .tag-btn.selected'))
                .map(btn => btn.dataset.id).join(',');
            
            const content = document.getElementById('knowledgeContent').value.trim();
            const title = document.getElementById('knowledgeTitle').value.trim();
            
            if (!selectedSubject) {
                showMessage('error', 'è¯·é€‰æ‹©ç§‘ç›®', 'knowledge');
                return;
            }
            
            if (!title) {
                showMessage('error', 'è¯·è¾“å…¥çŸ¥è¯†ç‚¹åç§°', 'knowledge');
                return;
            }
            
            if (!content) {
                showMessage('error', 'è¯·è¾“å…¥çŸ¥è¯†ç‚¹ç®€è¿°', 'knowledge');
                return;
            }
            
            if (content.length < 50) {
                showMessage('error', 'ç®€è¿°è‡³å°‘éœ€è¦50å­—', 'knowledge');
                return;
            }
            
            if (content.length > 200) {
                showMessage('error', 'ç®€è¿°ä¸èƒ½è¶…è¿‡200å­—', 'knowledge');
                return;
            }
            
            const formData = {
                title: title,
                content: content,
                user_id: currentUser.id,
                author_name: currentUser.username || currentUser.email?.split('@')[0] || 'åŒ¿åç”¨æˆ·',
                status: 'pending_review',
                category: 'knowledge',
                subject: selectedSubject.dataset.id,
                tags: selectedTags,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // æäº¤
            const submitBtn = e.target.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showMessage('success', 'çŸ¥è¯†ç‚¹æŠ•ç¨¿æäº¤æˆåŠŸï¼ç­‰å¾…å®¡æ ¸ä¸­...', 'knowledge');
                    
                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    document.querySelectorAll('#subjectSelection .selected, #tagSelection .selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    updateWordCount();
                    
                } else {
                    throw new Error('æŠ•ç¨¿å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showMessage('error', 'æŠ•ç¨¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'knowledge');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function submitGame(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showMessage('error', 'è¯·å…ˆç™»å½•', 'game');
                return;
            }
            
            const selectedGameType = document.querySelector('.game-type-btn.selected');
            if (!selectedGameType) {
                showMessage('error', 'è¯·é€‰æ‹©æ¸¸æˆç±»å‹', 'game');
                return;
            }
            
            const selectedDifficulty = document.getElementById('gameDifficulty').value;
            if (!selectedDifficulty) {
                showMessage('error', 'è¯·é€‰æ‹©éš¾åº¦', 'game');
                return;
            }
            
            const gameType = selectedGameType.dataset.type;
            let gameData = {};
            let isValid = true;
            
            switch(gameType) {
                case 'matching':
                    const examples = document.getElementById('matchExamples').value.trim();
                    if (!examples) {
                        showMessage('error', 'è¯·å¡«å†™é…å¯¹é¡¹ç›®', 'game');
                        isValid = false;
                    } else {
                        gameData = { examples: examples };
                    }
                    break;
                    
                case 'true_false':
                    const question = document.getElementById('tfQuestion').value.trim();
                    const answer = document.getElementById('tfAnswer').value;
                    if (!question || !answer) {
                        showMessage('error', 'è¯·å¡«å†™é—®é¢˜å’Œé€‰æ‹©ç­”æ¡ˆ', 'game');
                        isValid = false;
                    } else {
                        gameData = { question: question, answer: answer };
                    }
                    break;
                    
                case 'guess':
                    const description = document.getElementById('guessDescription').value.trim();
                    if (!description) {
                        showMessage('error', 'è¯·å¡«å†™æè¿°', 'game');
                        isValid = false;
                    } else {
                        gameData = { description: description };
                    }
                    break;
            }
            
            if (!isValid) return;
            
            const formData = {
                title: `æ¸¸æˆæŠ•ç¨¿ - ${selectedGameType.textContent}`, // ä½¿ç”¨æ¸¸æˆç±»å‹ä½œä¸ºæ ‡é¢˜
                content: JSON.stringify(gameData),
                user_id: currentUser.id,
                author_name: currentUser.username || currentUser.email?.split('@')[0] || 'åŒ¿åç”¨æˆ·',
                status: 'pending_review',
                category: 'game',
                game_type: gameType,
                difficulty: selectedDifficulty,
                question_data: JSON.stringify(gameData),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // æäº¤
            const submitBtn = e.target.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
            submitBtn.disabled = true;
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/submissions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    showMessage('success', 'æ¸¸æˆæŠ•ç¨¿æäº¤æˆåŠŸï¼ç­‰å¾…å®¡æ ¸ä¸­...', 'game');
                    
                    // é‡ç½®è¡¨å•
                    e.target.reset();
                    document.querySelectorAll('.game-type-btn.selected, .difficulty-btn.selected, .tf-answer.selected').forEach(el => {
                        el.classList.remove('selected');
                    });
                    document.getElementById('gameDifficulty').value = '';
                    document.getElementById('tfAnswer').value = '';
                    
                    // éšè—æ¸¸æˆå†…å®¹
                    document.querySelectorAll('[id$="Content"]').forEach(el => {
                        el.style.display = 'none';
                    });
                    
                } else {
                    throw new Error('æŠ•ç¨¿å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showMessage('error', 'æŠ•ç¨¿å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'game');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        function openGames() {
            window.open('https://3e4e592l5353-bot.github.io/DSEHub/games', '_blank');
        }

        function openNotes() {
            window.open('https://3e4e592l5353-bot.github.io/DSEHub/notes', '_blank');
        }
    </script>
</body>
</html>

