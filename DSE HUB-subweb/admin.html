<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Hub - 管理员中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 基础CSS变量 - 会被主题管理器覆盖 */
        :root {
            /* 蓝紫主题 (默认) */
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --accent-color: #5a67d8;
            --accent-light: rgba(90, 103, 216, 0.1);
            --accent-dark: #4c51bf;
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-color: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --border-color: rgba(102, 126, 234, 0.15);
            --hover-color: rgba(102, 126, 234, 0.06);
            --success-color: #38a169;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            
            /* 间距系统 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            
            /* 圆角系统 */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            
            /* 阴影系统 */
            --shadow-sm: 0 2px 8px rgba(102, 126, 234, 0.08);
            --shadow-md: 0 4px 16px rgba(102, 126, 234, 0.12);
            --shadow-lg: 0 8px 32px rgba(102, 126, 234, 0.16);
            --shadow-xl: 0 12px 48px rgba(102, 126, 234, 0.2);
            
            /* 动画系统 */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        /* 主题类 */
        body.theme-green-teal {
            --primary-start: #48bb78;
            --primary-end: #319795;
            --accent-color: #38a169;
            --accent-light: rgba(56, 161, 105, 0.1);
            --accent-dark: #2f855a;
            --border-color: rgba(72, 187, 120, 0.15);
            --hover-color: rgba(72, 187, 120, 0.06);
        }
        
        body.theme-orange-red {
            --primary-start: #ff8c00;
            --primary-end: #ff4500;
            --accent-color: #ff4500;
            --accent-light: rgba(255, 69, 0, 0.1);
            --accent-dark: #e03e00;
            --border-color: rgba(255, 140, 0, 0.15);
            --hover-color: rgba(255, 140, 0, 0.06);
        }
        
        body.theme-dark {
            --primary-start: #4a5568;
            --primary-end: #2d3748;
            --accent-color: #4299e1;
            --accent-light: rgba(66, 153, 225, 0.15);
            --accent-dark: #3182ce;
            --card-bg: #2d3748;
            --text-color: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-muted: #718096;
            --border-color: #4a5568;
            --hover-color: rgba(66, 153, 225, 0.1);
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: var(--text-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
            transition: all var(--transition-normal);
        }

        /* 管理员登录容器 */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--spacing-xl);
        }

        .login-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-2xl);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
        }

        .login-title {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .login-title h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .login-title p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .login-input {
            margin-bottom: var(--spacing-lg);
        }

        .login-input label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
        }

        .login-input input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-md);
            font-size: 14px;
            transition: all var(--transition-normal);
            background: rgba(255, 255, 255, 0.9);
        }

        .login-input input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .login-btn {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            margin-top: var(--spacing-lg);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .login-error {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            font-size: 14px;
            margin-top: var(--spacing-lg);
            display: none;
        }

        /* 主管理员界面 */
        .admin-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* 顶部导航栏 */
        .top-nav {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .admin-badge {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 14px;
        }

        .logout-btn {
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
            border: none;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logout-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        /* 主内容区域 */
        .main-content {
            padding: var(--spacing-xl);
        }

        .page-header {
            margin-bottom: var(--spacing-2xl);
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* 内容卡片网格 */
        .content-grid {
            display: grid;
            gap: var(--spacing-xl);
        }

        .content-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }

        .content-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-lg);
        }

        .card-title h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .card-meta {
            display: flex;
            gap: var(--spacing-lg);
            color: var(--text-secondary);
            font-size: 14px;
            flex-wrap: wrap;
        }

        .card-meta span {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .card-content {
            margin-bottom: var(--spacing-lg);
            line-height: 1.6;
        }

        .card-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        /* 状态标签 */
        .status-tag {
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d69e2e;
        }

        .status-approved {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
        }

        .status-rejected {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
        }

        /* 按钮样式 */
        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius-lg);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-height: 44px;
        }

        .btn-approve {
            background: linear-gradient(135deg, #48bb78, #319795);
            color: white;
        }

        .btn-reject {
            background: linear-gradient(135deg, #f56565, #ed8936);
            color: white;
        }

        .btn-review {
            background: linear-gradient(135deg, #4299e1, #667eea);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* 控制栏 */
        .control-bar {
            background: var(--card-bg);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-xl);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-lg);
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg) var(--spacing-md) 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            font-size: 14px;
            transition: all var(--transition-normal);
            background: rgba(255, 255, 255, 0.9);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .search-box i {
            position: absolute;
            left: var(--spacing-lg);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .filter-group {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }

        .filter-select {
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            background: white;
            color: var(--text-color);
            min-width: 140px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .quick-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-left: auto;
        }

        /* 标签页导航 */
        .tab-nav {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xl);
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .tab-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            border-color: transparent;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .control-bar {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .card-header {
                flex-direction: column;
                gap: var(--spacing-md);
            }
            
            .card-actions {
                justify-content: flex-start;
            }
            
            .tab-nav {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: var(--spacing-md);
            }
            
            .tab-btn {
                flex: 1;
                justify-content: center;
            }
            
            .filter-select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body class="theme-blue-purple">
    <!-- 登录界面 -->
    <div class="login-container" id="loginContainer">
        <div class="login-card">
            <div class="login-title">
                <h1>管理员登录</h1>
                <p>请输入管理员账号和密码</p>
            </div>
            <div class="login-input">
                <label for="adminEmail">管理员邮箱</label>
                <input type="email" id="adminEmail" placeholder="admin@example.com" value="admin@example.com">
            </div>
            <div class="login-input">
                <label for="adminPassword">密码</label>
                <input type="password" id="adminPassword" placeholder="********">
            </div>
            <button class="login-btn" onclick="loginAsAdmin()">
                <i class="fas fa-sign-in-alt"></i>
                登录管理员账号
            </button>
            <div class="login-error" id="loginError">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorMessage">登录失败</span>
            </div>
            <div style="margin-top: var(--spacing-xl); text-align: center; color: var(--text-secondary); font-size: 12px;">
                <p>当前仅支持管理员账号登录，确保profiles表中is_admin=true</p>
            </div>
        </div>
    </div>

    <!-- 主管理员界面 -->
    <div class="admin-container" id="adminContainer">
        <!-- 顶部导航栏 -->
        <nav class="top-nav">
            <div class="logo">
                <i class="fas fa-crown"></i>
                <span>DSE Hub 管理员中心</span>
            </div>
            <div class="nav-controls">
                <div class="admin-badge" id="adminBadge">
                    <i class="fas fa-user-shield"></i>
                    <span>加载中...</span>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    退出
                </button>
            </div>
        </nav>

        <!-- 主内容区域 -->
        <main class="main-content">
            <header class="page-header">
                <h1>全权内容审核中心</h1>
                <p>管理所有数据库内容 - 无限复审权限 · 独断裁决 · 无理由审核</p>
            </header>

            <!-- 标签页导航 -->
            <div class="tab-nav">
                <button class="tab-btn active" data-type="knowledge">
                    <i class="fas fa-book"></i>
                    知识点
                </button>
                <button class="tab-btn" data-type="notes">
                    <i class="fas fa-sticky-note"></i>
                    笔记
                </button>
                <button class="tab-btn" data-type="messages">
                    <i class="fas fa-comment"></i>
                    留言
                </button>
                <button class="tab-btn" data-type="questions">
                    <i class="fas fa-question-circle"></i>
                    题目
                </button>
            </div>

            <!-- 控制栏 -->
            <div class="control-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="搜索内容、用户、关键词..." onkeyup="handleSearch()">
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="all">所有状态</option>
                        <option value="pending">待审核</option>
                        <option value="approved">已通过</option>
                        <option value="rejected">已拒绝</option>
                    </select>
                    <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                        <option value="newest">最新优先</option>
                        <option value="oldest">最早优先</option>
                        <option value="popular">最受欢迎</option>
                    </select>
                </div>
                <div class="quick-actions">
                    <button class="btn" onclick="refreshData()" style="background: var(--accent-light); color: var(--accent-color);">
                        <i class="fas fa-sync-alt"></i>
                        刷新
                    </button>
                    <button class="btn btn-approve" onclick="batchApprove()">
                        <i class="fas fa-check-double"></i>
                        批量通过
                    </button>
                </div>
            </div>

            <!-- 内容展示区 -->
            <div class="content-grid" id="contentContainer">
                <div class="content-card" style="text-align: center; padding: 48px;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--accent-color); margin-bottom: 16px;"></i>
                    <h3>正在加载审核数据...</h3>
                    <p style="color: var(--text-secondary);">请稍候</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 主题管理模块 -->
    <script>
        class ThemeManager {
            constructor() {
                this.supabase = null;
                this.currentUser = null;
                this.themeConfig = null;
                this.pollingInterval = null;
                this.isInitialized = false;
                
                this.defaultTheme = 'blue-purple';
                this.themes = {
                    'blue-purple': {
                        primaryStart: '#667eea',
                        primaryEnd: '#764ba2',
                        accentColor: '#5a67d8',
                        accentLight: 'rgba(90, 103, 216, 0.1)',
                        accentDark: '#4c51bf',
                        cardBg: 'rgba(255, 255, 255, 0.98)',
                        textColor: '#2d3748',
                        textSecondary: '#718096',
                        textMuted: '#a0aec0',
                        borderColor: 'rgba(102, 126, 234, 0.15)',
                        hoverColor: 'rgba(102, 126, 234, 0.06)'
                    },
                    'green-teal': {
                        primaryStart: '#48bb78',
                        primaryEnd: '#319795',
                        accentColor: '#38a169',
                        accentLight: 'rgba(56, 161, 105, 0.1)',
                        accentDark: '#2f855a',
                        cardBg: 'rgba(255, 255, 255, 0.98)',
                        textColor: '#2d3748',
                        textSecondary: '#718096',
                        textMuted: '#a0aec0',
                        borderColor: 'rgba(72, 187, 120, 0.15)',
                        hoverColor: 'rgba(72, 187, 120, 0.06)'
                    },
                    'orange-red': {
                        primaryStart: '#ff8c00',
                        primaryEnd: '#ff4500',
                        accentColor: '#ff4500',
                        accentLight: 'rgba(255, 69, 0, 0.1)',
                        accentDark: '#e03e00',
                        cardBg: 'rgba(255, 255, 255, 0.98)',
                        textColor: '#2d3748',
                        textSecondary: '#718096',
                        textMuted: '#a0aec0',
                        borderColor: 'rgba(255, 140, 0, 0.15)',
                        hoverColor: 'rgba(255, 140, 0, 0.06)'
                    },
                    'dark': {
                        primaryStart: '#4a5568',
                        primaryEnd: '#2d3748',
                        accentColor: '#4299e1',
                        accentLight: 'rgba(66, 153, 225, 0.15)',
                        accentDark: '#3182ce',
                        cardBg: '#2d3748',
                        textColor: '#e2e8f0',
                        textSecondary: '#a0aec0',
                        textMuted: '#718096',
                        borderColor: '#4a5568',
                        hoverColor: 'rgba(66, 153, 225, 0.1)'
                    }
                };
            }
            
            async init(supabaseUrl, supabaseKey) {
                if (this.isInitialized) return;
                
                try {
                    this.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    
                    const { data: { user } } = await this.supabase.auth.getUser();
                    this.currentUser = user;
                    
                    this.supabase.auth.onAuthStateChange((event, session) => {
                        if (event === 'SIGNED_IN' || event === 'USER_UPDATED') {
                            this.currentUser = session?.user || null;
                            this.loadUserTheme();
                        } else if (event === 'SIGNED_OUT') {
                            this.currentUser = null;
                            this.applyDefaultTheme();
                        }
                    });
                    
                    await this.loadUserTheme();
                    this.startPolling();
                    
                    this.isInitialized = true;
                    
                } catch (error) {
                    console.error('主题管理器初始化失败:', error);
                    this.applyDefaultTheme();
                }
            }
            
            async loadUserTheme() {
                if (!this.currentUser) {
                    this.applyDefaultTheme();
                    return;
                }
                
                try {
                    const { data: profile, error } = await this.supabase
                        .from('profiles')
                        .select('theme, theme_colors, selected_colors, dark_mode')
                        .eq('id', this.currentUser.id)
                        .single();
                    
                    if (error) throw error;
                    
                    this.applyTheme(profile);
                    
                } catch (error) {
                    console.warn('加载用户主题失败:', error);
                    this.applyDefaultTheme();
                }
            }
            
            applyTheme(profile) {
                if (!profile) {
                    this.applyDefaultTheme();
                    return;
                }
                
                let themeName = (profile.theme || profile.theme_colors || this.defaultTheme)
                    .toLowerCase()
                    .replace(/\s+/g, '-');
                
                if (themeName.includes('blue') && themeName.includes('purple')) {
                    themeName = 'blue-purple';
                } else if (themeName.includes('green') && themeName.includes('teal')) {
                    themeName = 'green-teal';
                } else if (themeName.includes('orange') && themeName.includes('red')) {
                    themeName = 'orange-red';
                }
                
                const themeConfig = this.themes[themeName] || this.themes[this.defaultTheme];
                
                this.themeConfig = {
                    ...themeConfig,
                    isDark: Boolean(profile.dark_mode),
                    customColors: profile.selected_colors || null
                };
                
                this.applyThemeToPage();
            }
            
            applyThemeToPage() {
                const root = document.documentElement;
                const config = this.themeConfig || this.themes[this.defaultTheme];
                
                const themeClasses = Array.from(document.body.classList)
                    .filter(cls => cls.startsWith('theme-'));
                themeClasses.forEach(cls => document.body.classList.remove(cls));
                
                const themeName = this.getCurrentThemeName();
                document.body.classList.add(`theme-${themeName}`);
                
                if (config.isDark) {
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                }
                
                if (config.customColors) {
                    this.applyCustomColors(config.customColors);
                }
                
                this.applyCSSVariables(config);
                this.emitThemeChange();
            }
            
            getCurrentThemeName() {
                if (!this.themeConfig) return this.defaultTheme;
                
                for (const [name, config] of Object.entries(this.themes)) {
                    if (this.themeConfig.primaryStart === config.primaryStart &&
                        this.themeConfig.primaryEnd === config.primaryEnd) {
                        return name;
                    }
                }
                return this.defaultTheme;
            }
            
            applyCustomColors(customColors) {
                const root = document.documentElement;
                let colors;
                
                try {
                    colors = typeof customColors === 'string' ? JSON.parse(customColors) : customColors;
                } catch (e) {
                    console.warn('无法解析自定义颜色:', e);
                    return;
                }
                
                Object.entries(colors).forEach(([key, value]) => {
                    if (value) {
                        const cssVar = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                        root.style.setProperty(cssVar, value);
                    }
                });
            }
            
            applyCSSVariables(config) {
                const root = document.documentElement;
                
                Object.entries(config).forEach(([key, value]) => {
                    if (key !== 'isDark' && key !== 'customColors' && value != null) {
                        const cssVar = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                        
                        if (key.includes('Start') || key.includes('End') || key.includes('Color')) {
                            root.style.setProperty(cssVar, value);
                        } else if (key === 'cardBg' || key === 'borderColor' || key === 'hoverColor') {
                            root.style.setProperty(cssVar, value);
                        } else if (key.startsWith('text')) {
                            root.style.setProperty(cssVar, value);
                        }
                    }
                });
            }
            
            applyDefaultTheme() {
                this.themeConfig = this.themes[this.defaultTheme];
                this.applyThemeToPage();
            }
            
            startPolling() {
                this.pollingInterval = setInterval(async () => {
                    if (this.currentUser) {
                        try {
                            await this.loadUserTheme();
                        } catch (error) {
                            console.warn('轮询更新主题失败:', error);
                        }
                    }
                }, 30000);
                
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.currentUser) {
                        this.loadUserTheme();
                    }
                });
            }
            
            stopPolling() {
                if (this.pollingInterval) {
                    clearInterval(this.pollingInterval);
                    this.pollingInterval = null;
                }
            }
            
            emitThemeChange() {
                try {
                    const event = new CustomEvent('themechange', {
                        detail: {
                            theme: this.getCurrentThemeName(),
                            config: this.themeConfig
                        }
                    });
                    document.dispatchEvent(event);
                } catch (error) {
                    console.warn('触发主题变化事件失败:', error);
                }
            }
            
            getCurrentTheme() {
                return {
                    name: this.getCurrentThemeName(),
                    config: this.themeConfig
                };
            }
            
            async updateTheme() {
                try {
                    await this.loadUserTheme();
                } catch (error) {
                    console.error('手动更新主题失败:', error);
                }
            }
            
            destroy() {
                this.stopPolling();
                this.isInitialized = false;
                this.currentUser = null;
                this.themeConfig = null;
                document.removeEventListener('visibilitychange', () => {});
            }
        }

        // 创建全局主题管理器
        window.themeManager = new ThemeManager();
    </script>

    <!-- 主应用逻辑 -->
    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        // 全局变量
        let supabase = null;
        let currentUser = null;
        let currentDataType = 'knowledge';
        let allItems = [];
        let filteredItems = [];
        let selectedItems = new Set();

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeSupabase();
            setupEventListeners();
        });

        // 初始化Supabase
        async function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // 初始化主题管理器
                await window.themeManager.init(SUPABASE_URL, SUPABASE_KEY);
                
                // 检查是否已登录
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    await verifyAdminStatus();
                }
                
            } catch (error) {
                console.error('初始化失败:', error);
                showError('系统初始化失败，请刷新页面');
            }
        }

        // 管理员登录
        async function loginAsAdmin() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!email || !password) {
                showLoginError('请输入邮箱和密码');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                await verifyAdminStatus();
                
            } catch (error) {
                console.error('登录失败:', error);
                showLoginError('登录失败: ' + error.message);
            }
        }

        // 验证管理员状态
        async function verifyAdminStatus() {
            try {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('is_admin, username, email')
                    .eq('auth_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                if (!profile.is_admin) {
                    showLoginError('此账号不是管理员');
                    await logout();
                    return;
                }
                
                // 登录成功，显示管理员界面
                showAdminInterface(profile);
                await loadData(currentDataType);
                
            } catch (error) {
                console.error('验证管理员状态失败:', error);
                showLoginError('验证管理员权限失败');
            }
        }

        // 显示管理员界面
        function showAdminInterface(profile) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            const adminBadge = document.getElementById('adminBadge');
            adminBadge.innerHTML = `
                <i class="fas fa-user-shield"></i>
                <span>管理员: ${profile.username || profile.email}</span>
            `;
        }

        // 退出登录
        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                
                document.getElementById('adminContainer').style.display = 'none';
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('adminPassword').value = '';
                
                // 清空数据
                allItems = [];
                filteredItems = [];
                selectedItems.clear();
                
            } catch (error) {
                console.error('退出失败:', error);
            }
        }

        // 加载数据（根据类型查询不同表）
        async function loadData(dataType) {
            showLoading();
            
            try {
                let query = null;
                
                switch(dataType) {
                    case 'knowledge': // 知识点
                        query = supabase
                            .from('knowledge_points')
                            .select('*')
                            .order('created_at', { ascending: false });
                        break;
                        
                    case 'notes': // 笔记（从submissions中筛选notes=TRUE）
                        query = supabase
                            .from('submissions')
                            .select('*')
                            .eq('game_type', 'notes')
                            .order('created_at', { ascending: false });
                        break;
                        
                    case 'messages': // 留言（从chat_messages）
                        query = supabase
                            .from('chat_messages')
                            .select('*')
                            .order('created_at', { ascending: false });
                        break;
                        
                    case 'questions': // 题目（从questions表）
                        query = supabase
                            .from('questions')
                            .select('*')
                            .order('created_at', { ascending: false });
                        break;
                }
                
                if (!query) {
                    throw new Error('未知的数据类型');
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                allItems = data || [];
                applyFilters();
                
            } catch (error) {
                console.error('加载数据时出错:', error);
                showError(`无法加载${getDataTypeName(dataType)}数据: ${error.message}`);
                allItems = [];
                applyFilters();
            }
        }

        // 应用筛选
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const sortFilter = document.getElementById('sortFilter').value;
            
            // 筛选数据
            filteredItems = allItems.filter(item => {
                // 状态筛选（不同表的status字段可能不同）
                if (statusFilter !== 'all') {
                    const itemStatus = getItemStatus(item);
                    if (itemStatus !== statusFilter) {
                        return false;
                    }
                }
                
                // 搜索筛选
                if (searchQuery) {
                    const searchableText = [
                        item.title || '',
                        item.content || '',
                        item.author_name || '',
                        item.username || '',
                        item.subject || '',
                        item.tags || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchQuery)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // 排序数据
            filteredItems.sort((a, b) => {
                switch(sortFilter) {
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'popular':
                        return (b.like_count || 0) - (a.like_count || 0);
                    default:
                        return 0;
                }
            });
            
            renderItems();
        }

        // 获取项目状态
        function getItemStatus(item) {
            // 不同表的status字段名称可能不同
            return item.status || item.review_status || 'pending';
        }

        // 渲染项目
        function renderItems() {
            const container = document.getElementById('contentContainer');
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="content-card" style="text-align: center; padding: 48px;">
                        <i class="fas fa-inbox fa-3x" style="color: var(--text-muted); margin-bottom: 16px;"></i>
                        <h3>没有找到内容</h3>
                        <p style="color: var(--text-secondary);">当前筛选条件下没有匹配的内容</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            filteredItems.forEach(item => {
                const status = getItemStatus(item);
                const statusText = getStatusText(status);
                const statusClass = getStatusClass(status);
                const createdAt = formatDate(item.created_at);
                const previewContent = (item.content || '').substring(0, 200) + ((item.content || '').length > 200 ? '...' : '');
                const itemId = item.id;
                const isSelected = selectedItems.has(itemId);
                
                html += `
                    <div class="content-card" data-id="${itemId}">
                        <div class="card-header">
                            <div class="card-title">
                                <h3>${item.title || '未命名内容'}</h3>
                                <div class="card-meta">
                                    <span><i class="far fa-user"></i> ${item.author_name || item.username || '匿名用户'}</span>
                                    <span><i class="far fa-calendar"></i> ${createdAt}</span>
                                    ${item.subject ? `<span><i class="fas fa-tag"></i> ${item.subject}</span>` : ''}
                                </div>
                            </div>
                            <div class="status-tag ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="card-content">
                            <p>${previewContent}</p>
                            ${item.difficulty ? `<p><strong>难度:</strong> ${item.difficulty}</p>` : ''}
                            ${item.like_count !== undefined ? `<p><strong>点赞数:</strong> ${item.like_count}</p>` : ''}
                        </div>
                        
                        <div class="card-actions">
                            <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                                <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelection('${itemId}')">
                                <span>选择</span>
                            </label>
                            
                            ${status !== 'approved' ? `
                                <button class="btn btn-approve" onclick="approveItem('${itemId}')">
                                    <i class="fas fa-check"></i> 通过
                                </button>
                            ` : ''}
                            
                            ${status !== 'rejected' ? `
                                <button class="btn btn-reject" onclick="rejectItem('${itemId}')">
                                    <i class="fas fa-times"></i> 拒绝
                                </button>
                            ` : ''}
                            
                            <button class="btn btn-review" onclick="reviewItem('${itemId}')">
                                <i class="fas fa-redo"></i> 复审
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // 切换选择
        function toggleSelection(itemId) {
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
            } else {
                selectedItems.add(itemId);
            }
        }

        // 批准项目
        async function approveItem(itemId) {
            if (!confirm('确定要通过此内容吗？')) return;
            
            try {
                const tableName = getTableName(currentDataType);
                const { error } = await supabase
                    .from(tableName)
                    .update({ 
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', itemId);
                
                if (error) throw error;
                
                showSuccess('内容已通过审核');
                await loadData(currentDataType);
                
            } catch (error) {
                console.error('批准内容时出错:', error);
                showError('操作失败: ' + error.message);
            }
        }

        // 拒绝项目
        async function rejectItem(itemId) {
            if (!confirm('确定要拒绝此内容吗？')) return;
            
            try {
                const tableName = getTableName(currentDataType);
                const { error } = await supabase
                    .from(tableName)
                    .update({ 
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', itemId);
                
                if (error) throw error;
                
                showSuccess('内容已拒绝');
                await loadData(currentDataType);
                
            } catch (error) {
                console.error('拒绝内容时出错:', error);
                showError('操作失败: ' + error.message);
            }
        }

        // 复审项目
        async function reviewItem(itemId) {
            if (!confirm('确定要重新审核此内容吗？内容将恢复为待审核状态。')) return;
            
            try {
                const tableName = getTableName(currentDataType);
                const { error } = await supabase
                    .from(tableName)
                    .update({ 
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', itemId);
                
                if (error) throw error;
                
                showSuccess('内容已标记为待复审');
                await loadData(currentDataType);
                
            } catch (error) {
                console.error('复审内容时出错:', error);
                showError('操作失败: ' + error.message);
            }
        }

        // 批量通过
        async function batchApprove() {
            if (selectedItems.size === 0) {
                alert('请先选择要操作的内容');
                return;
            }
            
            if (!confirm(`确定要通过选中的 ${selectedItems.size} 个内容吗？`)) return;
            
            try {
                const tableName = getTableName(currentDataType);
                const itemIds = Array.from(selectedItems);
                
                const { error } = await supabase
                    .from(tableName)
                    .update({ 
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    })
                    .in('id', itemIds);
                
                if (error) throw error;
                
                showSuccess(`已通过 ${itemIds.length} 个内容`);
                selectedItems.clear();
                await loadData(currentDataType);
                
            } catch (error) {
                console.error('批量通过时出错:', error);
                showError('批量操作失败: ' + error.message);
            }
        }

        // 获取表名
        function getTableName(dataType) {
            const tableMap = {
                'knowledge': 'knowledge_points',
                'notes': 'submissions',
                'messages': 'chat_messages',
                'questions': 'questions'
            };
            return tableMap[dataType];
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 标签页点击
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', async () => {
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentDataType = button.dataset.type;
                    selectedItems.clear();
                    await loadData(currentDataType);
                });
            });
            
            // 搜索输入防抖
            let searchTimeout;
            function handleSearch() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 500);
            }
            
            window.handleSearch = handleSearch;
        }

        // 刷新数据
        async function refreshData() {
            selectedItems.clear();
            await loadData(currentDataType);
            showSuccess('数据已刷新');
        }

        // 辅助函数
        function getDataTypeName(type) {
            const names = {
                'knowledge': '知识点',
                'notes': '笔记',
                'messages': '留言',
                'questions': '题目'
            };
            return names[type] || '内容';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待审核',
                'approved': '已通过',
                'rejected': '已拒绝',
                'published': '已发布',
                'draft': '草稿'
            };
            return statusMap[status] || status || '未知状态';
        }

        function getStatusClass(status) {
            const classMap = {
                'pending': 'status-pending',
                'approved': 'status-approved',
                'rejected': 'status-rejected',
                'published': 'status-approved',
                'draft': 'status-pending'
            };
            return classMap[status] || 'status-pending';
        }

        function formatDate(dateString) {
            if (!dateString) return '未知日期';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins}分钟前`;
            } else if (diffHours < 24) {
                return `${diffHours}小时前`;
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 显示加载状态
        function showLoading() {
            const container = document.getElementById('contentContainer');
            container.innerHTML = `
                <div class="content-card" style="text-align: center; padding: 48px;">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--accent-color); margin-bottom: 16px;"></i>
                    <h3>正在加载数据...</h3>
                    <p style="color: var(--text-secondary);">请稍候</p>
                </div>
            `;
        }

        // 显示错误消息
        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            const errorMsg = document.getElementById('errorMessage');
            
            errorMsg.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // 显示成功消息
        function showSuccess(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            `;
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 显示错误消息
        function showError(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--danger-color);
                color: white;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            `;
            notification.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // 添加CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

