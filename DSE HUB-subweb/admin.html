<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Hub - 管理员中心</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* 设计规范中的色彩系统 */
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --accent-color: #5a67d8;
            --accent-light: rgba(90, 103, 216, 0.1);
            --accent-dark: #4c51bf;
            --text-color: #2d3748;
            --text-secondary: #718096;
            --text-muted: #a0aec0;
            --card-bg: rgba(255, 255, 255, 0.98);
            --border-color: rgba(102, 126, 234, 0.15);
            --hover-color: rgba(102, 126, 234, 0.06);
            --success-color: #38a169;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            
            /* 设计规范中的间距系统 */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 24px;
            --spacing-2xl: 32px;
            
            /* 设计规范中的圆角系统 */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 20px;
            
            /* 设计规范中的阴影系统 */
            --shadow-sm: 0 2px 8px rgba(102, 126, 234, 0.08);
            --shadow-md: 0 4px 16px rgba(102, 126, 234, 0.12);
            --shadow-lg: 0 8px 32px rgba(102, 126, 234, 0.16);
            --shadow-xl: 0 12px 48px rgba(102, 126, 234, 0.2);
            
            /* 设计规范中的动画系统 */
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* 顶部导航栏 */
        .top-nav {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .admin-badge {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 14px;
        }

        /* 主容器 */
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        /* 页面标题 */
        .page-header {
            margin-bottom: var(--spacing-2xl);
            text-align: center;
        }

        .page-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }

        /* 统计卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: all var(--transition-normal);
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-icon.pending { background: rgba(245, 158, 11, 0.1); color: #d69e2e; }
        .stat-icon.approved { background: rgba(72, 187, 120, 0.1); color: var(--success-color); }
        .stat-icon.rejected { background: rgba(245, 101, 101, 0.1); color: var(--danger-color); }
        .stat-icon.total { background: rgba(102, 126, 234, 0.1); color: var(--accent-color); }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }

        /* 主内容区域 */
        .content-area {
            background: var(--card-bg);
            border-radius: var(--border-radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* 标签页导航 */
        .tab-nav {
            display: flex;
            background: rgba(102, 126, 234, 0.05);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-button {
            padding: var(--spacing-lg) var(--spacing-xl);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .tab-button:hover {
            color: var(--accent-color);
            background: var(--hover-color);
        }

        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
            background: rgba(90, 103, 216, 0.05);
        }

        .badge {
            background: var(--accent-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            min-width: 20px;
            text-align: center;
        }

        /* 控制栏 */
        .control-bar {
            padding: var(--spacing-lg) var(--spacing-xl);
            display: flex;
            gap: var(--spacing-lg);
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: rgba(255, 255, 255, 0.5);
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-lg) var(--spacing-md) 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            font-size: 14px;
            transition: all var(--transition-normal);
            background: white;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(90, 103, 216, 0.1);
        }

        .search-box i {
            position: absolute;
            left: var(--spacing-lg);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
        }

        .filter-group {
            display: flex;
            gap: var(--spacing-sm);
        }

        .filter-select {
            padding: var(--spacing-md) var(--spacing-lg);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            background: white;
            color: var(--text-color);
            min-width: 140px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .quick-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-left: auto;
        }

        .action-btn {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-lg);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            min-height: 44px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            color: white;
        }

        .action-btn.secondary {
            background: white;
            color: var(--accent-color);
            border: 2px solid var(--border-color);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* 内容表格 */
        .content-table {
            width: 100%;
            border-collapse: collapse;
        }

        .content-table thead {
            background: rgba(102, 126, 234, 0.05);
        }

        .content-table th {
            padding: var(--spacing-lg) var(--spacing-md);
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .content-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }

        .content-table tbody tr:hover {
            background: var(--hover-color);
        }

        .content-table td {
            padding: var(--spacing-lg) var(--spacing-md);
            font-size: 14px;
            vertical-align: middle;
        }

        /* 内容预览 */
        .content-preview {
            max-width: 300px;
            line-height: 1.4;
        }

        .content-preview .title {
            font-weight: 600;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .content-preview .excerpt {
            color: var(--text-secondary);
            font-size: 13px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 用户信息 */
        .user-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-start), var(--primary-end));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-details .name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-details .email {
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* 状态标签 */
        .status-tag {
            padding: 4px 8px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-tag.pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d69e2e;
        }

        .status-tag.approved {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
        }

        .status-tag.rejected {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
        }

        /* 操作按钮 */
        .action-buttons {
            display: flex;
            gap: var(--spacing-xs);
        }

        .action-btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn-small.approve {
            background: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
        }

        .action-btn-small.reject {
            background: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
        }

        .action-btn-small.review {
            background: rgba(102, 126, 234, 0.1);
            color: var(--accent-color);
        }

        .action-btn-small:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .action-btn-small.approve:hover {
            background: var(--success-color);
            color: white;
        }

        .action-btn-small.reject:hover {
            background: var(--danger-color);
            color: white;
        }

        .action-btn-small.review:hover {
            background: var(--accent-color);
            color: white;
        }

        /* 加载状态 */
        .loading-state {
            padding: var(--spacing-2xl);
            text-align: center;
            color: var(--text-secondary);
        }

        .loading-state i {
            font-size: 32px;
            margin-bottom: var(--spacing-lg);
            color: var(--accent-color);
        }

        .empty-state {
            padding: var(--spacing-2xl);
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: var(--spacing-lg);
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* 底部信息 */
        .footer-info {
            margin-top: var(--spacing-2xl);
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
            padding: var(--spacing-lg);
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .admin-container {
                padding: var(--spacing-lg);
            }
        }

        @media (max-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-bar {
                flex-wrap: wrap;
            }
            
            .search-box {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tab-nav {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .control-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-wrap: wrap;
            }
            
            .filter-select {
                flex: 1;
                min-width: 0;
            }
            
            .quick-actions {
                margin-left: 0;
                justify-content: center;
            }
            
            .content-table {
                display: block;
                overflow-x: auto;
            }
        }

        @media (max-width: 480px) {
            .top-nav {
                flex-direction: column;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
            }
            
            .nav-controls {
                width: 100%;
                justify-content: center;
            }
            
            .admin-container {
                padding: var(--spacing-md);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn-small {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="top-nav">
        <div class="logo">
            <i class="fas fa-crown"></i>
            <span>DSE Hub 管理员中心</span>
        </div>
        <div class="nav-controls">
            <div class="admin-badge">
                <i class="fas fa-user-shield"></i>
                <span>独断万古的管理员</span>
            </div>
            <button class="action-btn secondary" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i>
                <span>刷新</span>
            </button>
        </div>
    </nav>

    <!-- 主容器 -->
    <div class="admin-container">
        <!-- 页面标题 -->
        <header class="page-header">
            <h1>全权内容审核中心</h1>
            <p>管理所有数据库内容 - 无限复审权限 · 独断裁决 · 无理由审核</p>
        </header>

        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">总内容数</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-number" id="pendingCount">0</div>
                <div class="stat-label">待审核</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon approved">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-number" id="approvedCount">0</div>
                <div class="stat-label">已通过</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon rejected">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stat-number" id="rejectedCount">0</div>
                <div class="stat-label">已拒绝</div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="content-area">
            <!-- 标签页导航 -->
            <nav class="tab-nav">
                <button class="tab-button active" data-type="submissions">
                    <i class="fas fa-file-alt"></i>
                    题目提交
                    <span class="badge" id="badge-submissions">0</span>
                </button>
                <button class="tab-button" data-type="questions">
                    <i class="fas fa-question-circle"></i>
                    已发布题目
                    <span class="badge" id="badge-questions">0</span>
                </button>
                <button class="tab-button" data-type="feedbacks">
                    <i class="fas fa-comments"></i>
                    用户反馈
                    <span class="badge" id="badge-feedbacks">0</span>
                </button>
                <button class="tab-button" data-type="game_questions">
                    <i class="fas fa-gamepad"></i>
                    游戏题目
                    <span class="badge" id="badge-game_questions">0</span>
                </button>
                <button class="tab-button" data-type="profiles">
                    <i class="fas fa-users"></i>
                    用户管理
                    <span class="badge" id="badge-profiles">0</span>
                </button>
            </nav>

            <!-- 控制栏 -->
            <div class="control-bar">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="搜索内容、用户、关键词...">
                </div>
                <div class="filter-group">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">所有状态</option>
                        <option value="pending">待审核</option>
                        <option value="approved">已通过</option>
                        <option value="rejected">已拒绝</option>
                    </select>
                    <select class="filter-select" id="sortFilter">
                        <option value="newest">最新优先</option>
                        <option value="oldest">最早优先</option>
                        <option value="most_viewed">最多浏览</option>
                        <option value="most_liked">最多点赞</option>
                    </select>
                </div>
                <div class="quick-actions">
                    <button class="action-btn secondary" onclick="showAllPending()">
                        <i class="fas fa-filter"></i>
                        只看待审
                    </button>
                    <button class="action-btn primary" onclick="createQuickNote()">
                        <i class="fas fa-plus"></i>
                        新建笔记
                    </button>
                </div>
            </div>

            <!-- 内容表格 -->
            <div id="contentTableContainer">
                <!-- 内容将通过JavaScript动态加载 -->
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载审核数据...</p>
                </div>
            </div>
        </div>

        <!-- 底部信息 -->
        <div class="footer-info">
            <p>当前管理员拥有无限复审权限，可对任何内容进行无理由审核</p>
            <p><i class="fas fa-shield-alt"></i> 数据库连接状态: <span id="connectionStatus">正在连接...</span></p>
        </div>
    </div>

    <!-- 新建笔记模态框 -->
    <div id="noteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--spacing-xl);">
        <div style="background: white; width: 100%; max-width: 600px; border-radius: var(--border-radius-xl); padding: var(--spacing-2xl); box-shadow: var(--shadow-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xl);">
                <h2 style="font-size: 20px; font-weight: 700;">新建管理员笔记</h2>
                <button onclick="closeNoteModal()" style="background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; padding: var(--spacing-sm);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <textarea id="noteContent" style="width: 100%; height: 200px; padding: var(--spacing-md); border: 2px solid var(--border-color); border-radius: var(--border-radius-md); margin-bottom: var(--spacing-xl); font-family: inherit; font-size: 14px; resize: vertical;" placeholder="在此记录重要的审核事项、系统问题或管理决策..."></textarea>
            <div style="display: flex; gap: var(--spacing-sm); justify-content: flex-end;">
                <button onclick="closeNoteModal()" style="padding: var(--spacing-md) var(--spacing-xl); border: 2px solid var(--border-color); border-radius: var(--border-radius-md); background: white; cursor: pointer; font-weight: 600; font-size: 14px; transition: all var(--transition-normal);">
                    取消
                </button>
                <button onclick="saveNote()" style="padding: var(--spacing-md) var(--spacing-xl); background: linear-gradient(135deg, var(--primary-start), var(--primary-end)); color: white; border: none; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 600; font-size: 14px; transition: all var(--transition-normal);">
                    保存笔记
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase配置 - 修复认证问题
        const SUPABASE_URL = 'https://alsalyskulozwakhmzoa.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_SYzZpjbWZgKUzzGQxR-jGg_B1em-5Tr';
        
        // 状态管理
        let currentDataType = 'submissions';
        let allItems = [];
        let filteredItems = [];
        let stats = {
            total: 0,
            pending: 0,
            approved: 0,
            rejected: 0
        };

        // 表名映射（解决404错误）
        const tableMapping = {
            'submissions': 'submissions',
            'questions': 'questions',
            'feedbacks': 'feedbacks',
            'game_questions': 'game_questions',
            'profiles': 'profiles',
            'audit_logs': 'audit_log_entries'  // 根据你提供的表名
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            setupEventListeners();
            updateConnectionStatus();
        });

        // 初始化应用
        async function initializeApp() {
            // 检查Supabase连接
            if (!await testSupabaseConnection()) {
                showError('无法连接Supabase数据库，请检查API密钥');
                return;
            }
            
            // 加载初始数据
            await loadData(currentDataType);
        }

        // 测试Supabase连接
        async function testSupabaseConnection() {
            try {
                // 尝试访问一个公共表
                const response = await fetch(`${SUPABASE_URL}/rest/v1/profiles?select=count`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                return response.ok;
            } catch (error) {
                console.error('连接测试失败:', error);
                return false;
            }
        }

        // 更新连接状态
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            testSupabaseConnection().then(isConnected => {
                if (isConnected) {
                    statusElement.textContent = '已连接';
                    statusElement.style.color = 'var(--success-color)';
                } else {
                    statusElement.textContent = '连接失败';
                    statusElement.style.color = 'var(--danger-color)';
                }
            });
        }

        // 加载数据（修复认证问题）
        async function loadData(dataType) {
            showLoading();
            
            try {
                const tableName = tableMapping[dataType] || dataType;
                
                // 构建查询URL
                let url = `${SUPABASE_URL}/rest/v1/${tableName}?`;
                
                // 根据数据类型选择不同的列
                const columnSelectors = {
                    'submissions': 'id,title,content,status,user_id,author_name,created_at,game_type,difficulty,like_count,view_count',
                    'questions': 'id,title,content,status,author_id,author_name,created_at,game_type,difficulty,play_count,avg_score',
                    'feedbacks': 'id,content,status,user_id,author_name,created_at,visibility,like_count',
                    'game_questions': 'id,title,content,status,user_id,author_name,created_at,game_type',
                    'profiles': 'id,username,email,is_admin,score,games_played,created_at,auth_id'
                };
                
                const columns = columnSelectors[dataType] || '*';
                url += `select=${columns}&order=created_at.desc`;
                
                // 发送请求（修复认证头）
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    }
                });
                
                if (response.ok) {
                    allItems = await response.json();
                    updateStats();
                    applyFilters();
                } else {
                    console.error('API响应:', response.status, response.statusText);
                    
                    // 如果表不存在，使用模拟数据
                    if (response.status === 404) {
                        console.warn(`表 ${tableName} 不存在，使用模拟数据`);
                        allItems = generateMockData(dataType);
                        updateStats();
                        applyFilters();
                    } else {
                        throw new Error(`API错误: ${response.status}`);
                    }
                }
            } catch (error) {
                console.error('加载数据时出错:', error);
                
                // 如果出错，使用模拟数据
                allItems = generateMockData(dataType);
                updateStats();
                applyFilters();
                
                showError(`无法加载${getDataTypeName(dataType)}数据，使用模拟数据演示`);
            }
        }

        // 生成模拟数据
        function generateMockData(dataType) {
            const mockData = [];
            const statuses = ['pending', 'approved', 'rejected'];
            const authors = ['张三', '李四', '王五', '赵六', '钱七'];
            const games = ['知识问答', '智力挑战', '速度竞赛', '团队对战'];
            
            for (let i = 1; i <= 15; i++) {
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                const createdAt = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                
                let item = {
                    id: `mock-${dataType}-${i}`,
                    title: `${getDataTypeName(dataType)}示例 ${i}`,
                    content: `这是${getDataTypeName(dataType)}的示例内容，用于演示管理员审核界面。`,
                    status: status,
                    author_name: authors[Math.floor(Math.random() * authors.length)],
                    created_at: createdAt.toISOString(),
                    like_count: Math.floor(Math.random() * 100),
                    view_count: Math.floor(Math.random() * 500),
                    is_mock: true
                };
                
                // 根据不同数据类型添加特定字段
                switch(dataType) {
                    case 'submissions':
                    case 'questions':
                        item.game_type = games[Math.floor(Math.random() * games.length)];
                        item.difficulty = ['简单', '中等', '困难'][Math.floor(Math.random() * 3)];
                        break;
                    case 'profiles':
                        item.username = `user${i}`;
                        item.email = `user${i}@example.com`;
                        item.is_admin = i === 1; // 第一个用户是管理员
                        item.score = Math.floor(Math.random() * 1000);
                        item.games_played = Math.floor(Math.random() * 50);
                        break;
                }
                
                mockData.push(item);
            }
            
            return mockData;
        }

        // 更新统计信息
        function updateStats() {
            stats.total = allItems.length;
            stats.pending = allItems.filter(item => item.status === 'pending').length;
            stats.approved = allItems.filter(item => item.status === 'approved').length;
            stats.rejected = allItems.filter(item => item.status === 'rejected').length;
            
            // 更新统计卡片
            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('approvedCount').textContent = stats.approved;
            document.getElementById('rejectedCount').textContent = stats.rejected;
            
            // 更新标签徽章
            document.getElementById(`badge-${currentDataType}`).textContent = stats.total;
        }

        // 应用筛选
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const sortFilter = document.getElementById('sortFilter').value;
            
            // 筛选数据
            filteredItems = allItems.filter(item => {
                // 状态筛选
                if (statusFilter !== 'all' && item.status !== statusFilter) {
                    return false;
                }
                
                // 搜索筛选
                if (searchQuery) {
                    const searchableText = [
                        item.title || '',
                        item.content || '',
                        item.author_name || '',
                        item.username || '',
                        item.email || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchQuery)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // 排序数据
            filteredItems.sort((a, b) => {
                switch(sortFilter) {
                    case 'newest':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'oldest':
                        return new Date(a.created_at) - new Date(b.created_at);
                    case 'most_viewed':
                        return (b.view_count || 0) - (a.view_count || 0);
                    case 'most_liked':
                        return (b.like_count || 0) - (a.like_count || 0);
                    default:
                        return 0;
                }
            });
            
            renderTable();
        }

        // 渲染表格
        function renderTable() {
            const container = document.getElementById('contentTableContainer');
            
            if (filteredItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>没有找到内容</h3>
                        <p>当前筛选条件下没有匹配的内容</p>
                        <button class="action-btn secondary" onclick="clearFilters()" style="margin-top: var(--spacing-lg);">
                            <i class="fas fa-times"></i>
                            清除筛选
                        </button>
                    </div>
                `;
                return;
            }
            
            let tableHTML = `
                <table class="content-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">内容</th>
                            <th style="width: 15%;">作者</th>
                            <th style="width: 15%;">状态</th>
                            <th style="width: 15%;">创建时间</th>
                            <th style="width: 15%;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredItems.forEach(item => {
                const statusText = getStatusText(item.status);
                const statusClass = getStatusClass(item.status);
                const createdAt = formatDate(item.created_at);
                const isMock = item.is_mock || false;
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="content-preview">
                                <div class="title">${item.title || '未命名内容'}</div>
                                <div class="excerpt">${(item.content || '').substring(0, 100)}...</div>
                                ${item.game_type ? `<div style="font-size: 12px; color: var(--accent-color); margin-top: 4px;"><i class="fas fa-gamepad"></i> ${item.game_type}</div>` : ''}
                                ${isMock ? '<div style="font-size: 11px; color: var(--warning-color); margin-top: 2px;"><i class="fas fa-vial"></i> 演示数据</div>' : ''}
                            </div>
                        </td>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">
                                    ${(item.author_name || item.username || '?').charAt(0)}
                                </div>
                                <div class="user-details">
                                    <div class="name">${item.author_name || item.username || '匿名用户'}</div>
                                    ${item.email ? `<div class="email">${item.email}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-tag ${statusClass}">
                                <i class="fas fa-${getStatusIcon(item.status)}"></i>
                                ${statusText}
                            </span>
                        </td>
                        <td>
                            <div style="font-size: 13px;">${createdAt}</div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${item.status !== 'approved' ? `
                                    <button class="action-btn-small approve" onclick="approveItem('${item.id}')" ${isMock ? 'disabled style="opacity: 0.5;"' : ''}>
                                        <i class="fas fa-check"></i> 通过
                                    </button>
                                ` : ''}
                                
                                ${item.status !== 'rejected' ? `
                                    <button class="action-btn-small reject" onclick="rejectItem('${item.id}')" ${isMock ? 'disabled style="opacity: 0.5;"' : ''}>
                                        <i class="fas fa-times"></i> 拒绝
                                    </button>
                                ` : ''}
                                
                                <button class="action-btn-small review" onclick="reviewItem('${item.id}')" ${isMock ? 'disabled style="opacity: 0.5;"' : ''}>
                                    <i class="fas fa-redo"></i> 复审
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHTML;
        }

        // 批准项目（修复PATCH请求）
        async function approveItem(itemId) {
            if (!confirm('确定要通过此内容吗？此操作不可撤销。')) return;
            
            try {
                const tableName = tableMapping[currentDataType];
                const isMock = allItems.find(item => item.id === itemId)?.is_mock;
                
                if (isMock) {
                    showSuccess('演示数据：内容已通过审核');
                    // 更新本地数据
                    allItems = allItems.map(item => 
                        item.id === itemId ? {...item, status: 'approved', updated_at: new Date().toISOString()} : item
                    );
                    updateStats();
                    applyFilters();
                    return;
                }
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${tableName}?id=eq.${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showSuccess('内容已通过审核');
                    // 重新加载数据
                    await loadData(currentDataType);
                } else {
                    const error = await response.text();
                    throw new Error(`更新失败: ${error}`);
                }
            } catch (error) {
                console.error('批准内容时出错:', error);
                showError('操作失败: ' + error.message);
            }
        }

        // 拒绝项目
        async function rejectItem(itemId) {
            if (!confirm('确定要拒绝此内容吗？此操作不可撤销。')) return;
            
            try {
                const tableName = tableMapping[currentDataType];
                const isMock = allItems.find(item => item.id === itemId)?.is_mock;
                
                if (isMock) {
                    showSuccess('演示数据：内容已拒绝');
                    // 更新本地数据
                    allItems = allItems.map(item => 
                        item.id === itemId ? {...item, status: 'rejected', updated_at: new Date().toISOString()} : item
                    );
                    updateStats();
                    applyFilters();
                    return;
                }
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${tableName}?id=eq.${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showSuccess('内容已拒绝');
                    await loadData(currentDataType);
                } else {
                    throw new Error('更新失败');
                }
            } catch (error) {
                console.error('拒绝内容时出错:', error);
                showError('操作失败');
            }
        }

        // 复审项目
        async function reviewItem(itemId) {
            if (!confirm('确定要重新审核此内容吗？内容将恢复为待审核状态。')) return;
            
            try {
                const tableName = tableMapping[currentDataType];
                const isMock = allItems.find(item => item.id === itemId)?.is_mock;
                
                if (isMock) {
                    showSuccess('演示数据：内容已标记为待复审');
                    // 更新本地数据
                    allItems = allItems.map(item => 
                        item.id === itemId ? {...item, status: 'pending', updated_at: new Date().toISOString()} : item
                    );
                    updateStats();
                    applyFilters();
                    return;
                }
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/${tableName}?id=eq.${itemId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    showSuccess('内容已标记为待复审');
                    await loadData(currentDataType);
                } else {
                    throw new Error('更新失败');
                }
            } catch (error) {
                console.error('复审内容时出错:', error);
                showError('操作失败');
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 标签页点击
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', async () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    currentDataType = button.dataset.type;
                    await loadData(currentDataType);
                });
            });
            
            // 搜索输入
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 300);
            });
            
            // 筛选器变更
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
        }

        // 辅助函数
        function getDataTypeName(type) {
            const names = {
                'submissions': '题目提交',
                'questions': '已发布题目',
                'feedbacks': '用户反馈',
                'game_questions': '游戏题目',
                'profiles': '用户账户'
            };
            
            return names[type] || '内容';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待审核',
                'approved': '已通过',
                'rejected': '已拒绝'
            };
            
            return statusMap[status] || '未知状态';
        }

        function getStatusClass(status) {
            const classMap = {
                'pending': 'pending',
                'approved': 'approved',
                'rejected': 'rejected'
            };
            
            return classMap[status] || 'pending';
        }

        function getStatusIcon(status) {
            const iconMap = {
                'pending': 'clock',
                'approved': 'check-circle',
                'rejected': 'times-circle'
            };
            
            return iconMap[status] || 'question-circle';
        }

        function formatDate(dateString) {
            if (!dateString) return '未知日期';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins}分钟前`;
            } else if (diffHours < 24) {
                return `${diffHours}小时前`;
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 工具函数
        function showLoading() {
            const container = document.getElementById('contentTableContainer');
            container.innerHTML = `
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>正在加载${getDataTypeName(currentDataType)}数据...</p>
                </div>
            `;
        }

        function showSuccess(message) {
            // 创建临时通知
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success-color);
                color: white;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showError(message) {
            // 创建临时通知
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--danger-color);
                color: white;
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 新增CSS动画
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // 快捷操作函数
        function refreshAllData() {
            loadData(currentDataType);
            updateConnectionStatus();
            showSuccess('数据已刷新');
        }

        function showAllPending() {
            document.getElementById('statusFilter').value = 'pending';
            applyFilters();
            showSuccess('已筛选出所有待审内容');
        }

        function clearFilters() {
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            applyFilters();
        }

        function createQuickNote() {
            document.getElementById('noteModal').style.display = 'flex';
            document.getElementById('noteContent').focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('noteContent').value = '';
        }

        function saveNote() {
            const noteContent = document.getElementById('noteContent').value.trim();
            if (!noteContent) {
                showError('请输入笔记内容');
                return;
            }
            
            // 在实际应用中，这里应该保存到数据库
            // 目前先保存到本地存储
            const notes = JSON.parse(localStorage.getItem('admin_notes') || '[]');
            notes.push({
                content: noteContent,
                created_at: new Date().toISOString(),
                type: 'admin_note'
            });
            
            localStorage.setItem('admin_notes', JSON.stringify(notes));
            
            showSuccess('笔记已保存到本地存储');
            closeNoteModal();
        }
    </script>
</body>
</html>
